<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title> - Aphros的个人博客</title><meta name="Description" content="This is my cool site"><meta property="og:title" content="" />
<meta property="og:description" content="第 11 章 时间序列 时间序列（time series）数据是一种重要的结构化数据形式，应用于多个领域，包括金融学、经济学、生态学、神经科学、物理学等" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/pyda-2e-zh/11/" /><meta property="article:section" content="posts" />

<meta property="og:site_name" content="Aphros的博客" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content=""/>
<meta name="twitter:description" content="第 11 章 时间序列 时间序列（time series）数据是一种重要的结构化数据形式，应用于多个领域，包括金融学、经济学、生态学、神经科学、物理学等"/>
<meta name="application-name" content="Aphros的博客">
<meta name="apple-mobile-web-app-title" content="Aphros的博客"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://localhost:1313/posts/pyda-2e-zh/11/" /><link rel="prev" href="http://localhost:1313/posts/pyda-2e-zh/12/" /><link rel="next" href="http://localhost:1313/posts/pyda-2e-zh/10/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/localhost:1313\/posts\/pyda-2e-zh\/11\/"
        },"genre": "posts","wordcount":  13494 ,
        "url": "http:\/\/localhost:1313\/posts\/pyda-2e-zh\/11\/","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "Aphros"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Aphros的个人博客">Aphros的博客</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Aphros的个人博客">Aphros的博客</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX"></h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Aphros</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="0001-01-01">0001-01-01</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;13494 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;27 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#字符串和datetime的相互转换">字符串和<code>datetime</code>的相互转换</a></li>
  </ul>

  <ul>
    <li><a href="#索引选取子集构造">索引、选取、子集构造</a></li>
    <li><a href="#带有重复索引的时间序列">带有重复索引的时间序列</a></li>
  </ul>

  <ul>
    <li><a href="#生成日期范围">生成日期范围</a></li>
    <li><a href="#频率和日期偏移量">频率和日期偏移量</a></li>
    <li><a href="#wom-日期">WOM 日期</a></li>
    <li><a href="#移动超前和滞后数据">移动（超前和滞后）数据</a></li>
    <li><a href="#通过偏移量对日期进行位移">通过偏移量对日期进行位移</a></li>
  </ul>

  <ul>
    <li><a href="#操作时区意识型timestamp对象">操作时区意识型<code>Timestamp</code>对象</a></li>
    <li><a href="#不同时区之间的运算">不同时区之间的运算</a></li>
  </ul>

  <ul>
    <li><a href="#时期的频率转换">时期的频率转换</a></li>
    <li><a href="#按季度计算的时期频率">按季度计算的时期频率</a></li>
    <li><a href="#将timestamp转换为period及其反向过程">将<code>Timestamp</code>转换为<code>Period</code>（及其反向过程）</a></li>
    <li><a href="#通过数组创建periodindex">通过数组创建<code>PeriodIndex</code></a></li>
  </ul>

  <ul>
    <li><a href="#降采样">降采样</a></li>
    <li><a href="#ohlc-重采样">OHLC 重采样</a></li>
    <li><a href="#升采样和插值">升采样和插值</a></li>
    <li><a href="#通过时期进行重采样">通过时期进行重采样</a></li>
  </ul>

  <ul>
    <li><a href="#指数加权函数">指数加权函数</a></li>
    <li><a href="#二元移动窗口函数">二元移动窗口函数</a></li>
    <li><a href="#用户定义的移动窗口函数">用户定义的移动窗口函数</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="第-11-章-时间序列">第 11 章 时间序列</h1>
<p>时间序列（time series）数据是一种重要的结构化数据形式，应用于多个领域，包括金融学、经济学、生态学、神经科学、物理学等。在多个时间点观察或测量到的任何事物都可以形成一段时间序列。很多时间序列是固定频率的，也就是说，数据点是根据某种规律定期出现的（比如每 15 秒、每 5 分钟、每月出现一次）。时间序列也可以是不定期的，没有固定的时间单位或单位之间的偏移量。时间序列数据的意义取决于具体的应用场景，主要有以下几种：</p>
<ul>
<li>时间戳（timestamp），特定的时刻。</li>
<li>固定时期（period），如 2007 年 1 月或 2010 年全年。</li>
<li>时间间隔（interval），由起始和结束时间戳表示。时期（period）可以被看做间隔（interval）的特例。</li>
<li>实验或过程时间，每个时间点都是相对于特定起始时间的一个度量。例如，从放入烤箱时起，每秒钟饼干的直径。</li>
</ul>
<p>本章主要讲解前 3 种时间序列。许多技术都可用于处理实验型时间序列，其索引可能是一个整数或浮点数（表示从实验开始算起已经过去的时间）。最简单也最常见的时间序列都是用时间戳进行索引的。</p>
<blockquote>
<p>提示：pandas 也支持基于<code>timedeltas</code>的指数，它可以有效代表实验或经过的时间。这本书不涉及<code>timedelta</code>指数，但你可以学习 <a href="http://pandas.pydata.org/" target="_blank" rel="noopener noreffer ">pandas 的文档</a>。</p>
</blockquote>
<p>pandas 提供了许多内置的时间序列处理工具和数据算法。因此，你可以高效处理非常大的时间序列，轻松地进行切片/切块、聚合、对定期/不定期的时间序列进行重采样等。有些工具特别适合金融和经济应用，你当然也可以用它们来分析服务器日志数据。</p>
<h1 id="111-日期和时间数据类型及工具">11.1 日期和时间数据类型及工具</h1>
<p>Python 标准库包含用于日期（date）和时间（time）数据的数据类型，而且还有日历方面的功能。我们主要会用到<code>datetime</code>、<code>time</code>以及<code>calendar</code>模块。<code>datetime.datetime</code>（也可以简写为<code>datetime</code>）是用得最多的数据类型：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">10</span><span class="p">]:</span> <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">11</span><span class="p">]:</span> <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">12</span><span class="p">]:</span> <span class="n">now</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">12</span><span class="p">]:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2017</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">72973</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">13</span><span class="p">]:</span> <span class="n">now</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">now</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">now</span><span class="o">.</span><span class="n">day</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">13</span><span class="p">]:</span> <span class="p">(</span><span class="mi">2017</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
</span></span></code></pre></div><p><code>datetime</code>以毫秒形式存储日期和时间。<code>timedelta</code>表示两个<code>datetime</code>对象之间的时间差：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">14</span><span class="p">]:</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2011</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">-</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">15</span><span class="p">]:</span> <span class="n">delta</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">15</span><span class="p">]:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="mi">926</span><span class="p">,</span> <span class="mi">56700</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">16</span><span class="p">]:</span> <span class="n">delta</span><span class="o">.</span><span class="n">days</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">16</span><span class="p">]:</span> <span class="mi">926</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">17</span><span class="p">]:</span> <span class="n">delta</span><span class="o">.</span><span class="n">seconds</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">17</span><span class="p">]:</span> <span class="mi">56700</span>
</span></span></code></pre></div><p>可以给<code>datetime</code>对象加上（或减去）一个或多个<code>timedelta</code>，这样会产生一个新对象：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">18</span><span class="p">]:</span> <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">19</span><span class="p">]:</span> <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2011</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">20</span><span class="p">]:</span> <span class="n">start</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">20</span><span class="p">]:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2011</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">21</span><span class="p">]:</span> <span class="n">start</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">21</span><span class="p">]:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2010</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span></code></pre></div><p><code>datetime</code>模块中的数据类型参见表 10-1。虽然本章主要讲的是 pandas 数据类型和高级时间序列处理，但你肯定会在 Python 的其他地方遇到有关<code>datetime</code>的数据类型。</p>
<p>表 11-1 <code>datetime</code>模块中的数据类型</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-4af261a305a70aeb.png"
        data-srcset="img/7178691-4af261a305a70aeb.png, img/7178691-4af261a305a70aeb.png 1.5x, img/7178691-4af261a305a70aeb.png 2x"
        data-sizes="auto"
        alt="img/7178691-4af261a305a70aeb.png"
        title="img/7178691-4af261a305a70aeb.png" /></p>
<p><code>tzinfo</code>存储时区信息的基本类型</p>
<h2 id="字符串和datetime的相互转换">字符串和<code>datetime</code>的相互转换</h2>
<p>利用<code>str</code>或<code>strftime</code>方法（传入一个格式化字符串），<code>datetime</code>对象和 pandas 的 <code>Timestamp</code>对象（稍后就会介绍）可以被格式化为字符串：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">22</span><span class="p">]:</span> <span class="n">stamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2011</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">23</span><span class="p">]:</span> <span class="nb">str</span><span class="p">(</span><span class="n">stamp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">23</span><span class="p">]:</span> <span class="s1">&#39;2011-01-03 00:00:00&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">24</span><span class="p">]:</span> <span class="n">stamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">24</span><span class="p">]:</span> <span class="s1">&#39;2011-01-03&#39;</span>
</span></span></code></pre></div><p>表 11-2 列出了全部的格式化编码。</p>
<p>表 11-2 <code>datetime</code>格式定义（兼容 ISO C89）</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-50c751823754df58.png"
        data-srcset="img/7178691-50c751823754df58.png, img/7178691-50c751823754df58.png 1.5x, img/7178691-50c751823754df58.png 2x"
        data-sizes="auto"
        alt="img/7178691-50c751823754df58.png"
        title="img/7178691-50c751823754df58.png" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-de0181e1f6b45eaf.png"
        data-srcset="img/7178691-de0181e1f6b45eaf.png, img/7178691-de0181e1f6b45eaf.png 1.5x, img/7178691-de0181e1f6b45eaf.png 2x"
        data-sizes="auto"
        alt="img/7178691-de0181e1f6b45eaf.png"
        title="img/7178691-de0181e1f6b45eaf.png" /></p>
<p><code>datetime.strptime</code>可以用这些格式化编码将字符串转换为日期：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">25</span><span class="p">]:</span> <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;2011-01-03&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">26</span><span class="p">]:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">26</span><span class="p">]:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2011</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">27</span><span class="p">]:</span> <span class="n">datestrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;7/6/2011&#39;</span><span class="p">,</span> <span class="s1">&#39;8/6/2011&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">28</span><span class="p">]:</span> <span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">datestrs</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">28</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2011</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2011</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
</span></span></code></pre></div><p><code>datetime.strptime</code>是通过已知格式进行日期解析的最佳方式。但是每次都要编写格式定义是很麻烦的事情，尤其是对于一些常见的日期格式。这种情况下，你可以用<code>dateutil</code>这个第三方包中的 <code>parser.parse</code>方法（pandas 中已经自动安装好了）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">29</span><span class="p">]:</span> <span class="kn">from</span> <span class="nn">dateutil.parser</span> <span class="kn">import</span> <span class="n">parse</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">30</span><span class="p">]:</span> <span class="n">parse</span><span class="p">(</span><span class="s1">&#39;2011-01-03&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">30</span><span class="p">]:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2011</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span></code></pre></div><p><code>dateutil</code>可以解析几乎所有人类能够理解的日期表示形式：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">31</span><span class="p">]:</span> <span class="n">parse</span><span class="p">(</span><span class="s1">&#39;Jan 31, 1997 10:45 PM&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">31</span><span class="p">]:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1997</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">45</span><span class="p">)</span>
</span></span></code></pre></div><p>在国际通用的格式中，日出现在月的前面很普遍，传入<code>dayfirst=True</code>即可解决这个问题：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">32</span><span class="p">]:</span> <span class="n">parse</span><span class="p">(</span><span class="s1">&#39;6/12/2011&#39;</span><span class="p">,</span> <span class="n">dayfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">32</span><span class="p">]:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2011</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span></code></pre></div><p>pandas 通常是用于处理成组日期的，不管这些日期是<code>DataFrame</code>的轴索引还是列。<code>to_datetime</code>方法可以解析多种不同的日期表示形式。对标准日期格式（如 ISO8601）的解析非常快：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">33</span><span class="p">]:</span> <span class="n">datestrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;2011-07-06 12:00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2011-08-06 00:00:00&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">34</span><span class="p">]:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">datestrs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">34</span><span class="p">]:</span> <span class="n">DatetimeIndex</span><span class="p">([</span><span class="s1">&#39;2011-07-06 12:00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2011-08-06 00:00:00&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;dat</span>
</span></span><span class="line"><span class="cl"><span class="n">etime64</span><span class="p">[</span><span class="n">ns</span><span class="p">]</span><span class="s1">&#39;, freq=None)</span>
</span></span></code></pre></div><p>它还可以处理缺失值（<code>None</code>、空字符串等）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">35</span><span class="p">]:</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">datestrs</span> <span class="o">+</span> <span class="p">[</span><span class="kc">None</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">36</span><span class="p">]:</span> <span class="n">idx</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">36</span><span class="p">]:</span> <span class="n">DatetimeIndex</span><span class="p">([</span><span class="s1">&#39;2011-07-06 12:00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2011-08-06 00:00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;NaT&#39;</span><span class="p">],</span> <span class="n">dty</span>
</span></span><span class="line"><span class="cl"><span class="n">pe</span><span class="o">=</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">37</span><span class="p">]:</span> <span class="n">idx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">37</span><span class="p">]:</span> <span class="n">NaT</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">38</span><span class="p">]:</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">38</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>  <span class="kc">True</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
</span></span></code></pre></div><p><code>NaT</code>（Not a Time）是 pandas 中时间戳数据的<code>null</code>值。</p>
<blockquote>
<p>注意：<code>dateutil.parser</code>是一个实用但不完美的工具。比如说，它会把一些原本不是日期的字符串认作是日期（比如<code>&quot;42&quot;</code>会被解析为 2042 年的今天）。</p>
</blockquote>
<p><code>datetime</code>对象还有一些特定于当前环境（位于不同国家或使用不同语言的系统）的格式化选项。例如，德语或法语系统所用的月份简写就与英语系统所用的不同。表 11-3 进行了总结。</p>
<p>表 11-3 特定于当前环境的日期格式</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-cf0119398273e2b0.png"
        data-srcset="img/7178691-cf0119398273e2b0.png, img/7178691-cf0119398273e2b0.png 1.5x, img/7178691-cf0119398273e2b0.png 2x"
        data-sizes="auto"
        alt="img/7178691-cf0119398273e2b0.png"
        title="img/7178691-cf0119398273e2b0.png" /></p>
<h1 id="112-时间序列基础">11.2 时间序列基础</h1>
<p>pandas 最基本的时间序列类型就是以时间戳（通常以 Python 字符串或<code>datatime</code>对象表示）为索引的<code>Series</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">39</span><span class="p">]:</span> <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">40</span><span class="p">]:</span> <span class="n">dates</span> <span class="o">=</span> <span class="p">[</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2011</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2011</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">   <span class="o">....</span><span class="p">:</span>          <span class="n">datetime</span><span class="p">(</span><span class="mi">2011</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2011</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">   <span class="o">....</span><span class="p">:</span>          <span class="n">datetime</span><span class="p">(</span><span class="mi">2011</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2011</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">41</span><span class="p">]:</span> <span class="n">ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">42</span><span class="p">]:</span> <span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">42</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span>   <span class="o">-</span><span class="mf">0.204708</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">05</span>    <span class="mf">0.478943</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">07</span>   <span class="o">-</span><span class="mf">0.519439</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">08</span>   <span class="o">-</span><span class="mf">0.555730</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">10</span>    <span class="mf">1.965781</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">12</span>    <span class="mf">1.393406</span>
</span></span><span class="line"><span class="cl"><span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span></code></pre></div><p>这些<code>datetime</code>对象实际上是被放在一个<code>DatetimeIndex</code>中的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">43</span><span class="p">]:</span> <span class="n">ts</span><span class="o">.</span><span class="n">index</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">43</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">DatetimeIndex</span><span class="p">([</span><span class="s1">&#39;2011-01-02&#39;</span><span class="p">,</span> <span class="s1">&#39;2011-01-05&#39;</span><span class="p">,</span> <span class="s1">&#39;2011-01-07&#39;</span><span class="p">,</span> <span class="s1">&#39;2011-01-08&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2011-01-10&#39;</span><span class="p">,</span> <span class="s1">&#39;2011-01-12&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">              <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span></span></code></pre></div><p>跟其他<code>Series</code>一样，不同索引的时间序列之间的算术运算会自动按日期对齐：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">44</span><span class="p">]:</span> <span class="n">ts</span> <span class="o">+</span> <span class="n">ts</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">44</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span>   <span class="o">-</span><span class="mf">0.409415</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">05</span>         <span class="n">NaN</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">07</span>   <span class="o">-</span><span class="mf">1.038877</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">08</span>         <span class="n">NaN</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">10</span>    <span class="mf">3.931561</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">12</span>         <span class="n">NaN</span>
</span></span><span class="line"><span class="cl"><span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span></code></pre></div><p><code>ts[::2]</code>是每隔两个取一个。</p>
<p>pandas 用 NumPy 的<code>datetime64</code>数据类型以纳秒形式存储时间戳：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">45</span><span class="p">]:</span> <span class="n">ts</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dtype</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">45</span><span class="p">]:</span> <span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;&lt;M8[ns]&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p><code>DatetimeIndex</code>中的各个标量值是 pandas 的<code>Timestamp</code>对象：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">46</span><span class="p">]:</span> <span class="n">stamp</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">47</span><span class="p">]:</span> <span class="n">stamp</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">47</span><span class="p">]:</span> <span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2011-01-02 00:00:00&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>只要有需要，<code>TimeStamp</code>可以随时自动转换为<code>datetime</code>对象。此外，它还可以存储频率信息（如果有的话），且知道如何执行时区转换以及其他操作。稍后将对此进行详细讲解。</p>
<h2 id="索引选取子集构造">索引、选取、子集构造</h2>
<p>当你根据标签索引选取数据时，时间序列和其它的<code>pandas.Series</code>很像：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">48</span><span class="p">]:</span> <span class="n">stamp</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">49</span><span class="p">]:</span> <span class="n">ts</span><span class="p">[</span><span class="n">stamp</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">49</span><span class="p">]:</span> <span class="o">-</span><span class="mf">0.51943871505673811</span>
</span></span></code></pre></div><p>还有一种更为方便的用法：传入一个可以被解释为日期的字符串：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">50</span><span class="p">]:</span> <span class="n">ts</span><span class="p">[</span><span class="s1">&#39;1/10/2011&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">50</span><span class="p">]:</span> <span class="mf">1.9657805725027142</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">51</span><span class="p">]:</span> <span class="n">ts</span><span class="p">[</span><span class="s1">&#39;20110110&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">51</span><span class="p">]:</span> <span class="mf">1.9657805725027142</span>
</span></span></code></pre></div><p>对于较长的时间序列，只需传入“年”或“年月”即可轻松选取数据的切片：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">52</span><span class="p">]:</span> <span class="n">longer_ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">   <span class="o">....</span><span class="p">:</span>                       <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;1/1/2000&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">53</span><span class="p">]:</span> <span class="n">longer_ts</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">53</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span>    <span class="mf">0.092908</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span>    <span class="mf">0.281746</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span>    <span class="mf">0.769023</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">04</span>    <span class="mf">1.246435</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">05</span>    <span class="mf">1.007189</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span>   <span class="o">-</span><span class="mf">1.296221</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">07</span>    <span class="mf">0.274992</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">08</span>    <span class="mf">0.228913</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">09</span>    <span class="mf">1.352917</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">10</span>    <span class="mf">0.886429</span>
</span></span><span class="line"><span class="cl">                <span class="o">...</span>   
</span></span><span class="line"><span class="cl"><span class="mi">2002</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">17</span>   <span class="o">-</span><span class="mf">0.139298</span>
</span></span><span class="line"><span class="cl"><span class="mi">2002</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">18</span>   <span class="o">-</span><span class="mf">1.159926</span>
</span></span><span class="line"><span class="cl"><span class="mi">2002</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">19</span>    <span class="mf">0.618965</span>
</span></span><span class="line"><span class="cl"><span class="mi">2002</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">20</span>    <span class="mf">1.373890</span>
</span></span><span class="line"><span class="cl"><span class="mi">2002</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">21</span>   <span class="o">-</span><span class="mf">0.983505</span>
</span></span><span class="line"><span class="cl"><span class="mi">2002</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">22</span>    <span class="mf">0.930944</span>
</span></span><span class="line"><span class="cl"><span class="mi">2002</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">23</span>   <span class="o">-</span><span class="mf">0.811676</span>
</span></span><span class="line"><span class="cl"><span class="mi">2002</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">24</span>   <span class="o">-</span><span class="mf">1.830156</span>
</span></span><span class="line"><span class="cl"><span class="mi">2002</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">25</span>   <span class="o">-</span><span class="mf">0.138730</span>
</span></span><span class="line"><span class="cl"><span class="mi">2002</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">26</span>    <span class="mf">0.334088</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="n">D</span><span class="p">,</span> <span class="n">Length</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">54</span><span class="p">]:</span> <span class="n">longer_ts</span><span class="p">[</span><span class="s1">&#39;2001&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">54</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span>    <span class="mf">1.599534</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span>    <span class="mf">0.474071</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span>    <span class="mf">0.151326</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">04</span>   <span class="o">-</span><span class="mf">0.542173</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">05</span>   <span class="o">-</span><span class="mf">0.475496</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span>    <span class="mf">0.106403</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">07</span>   <span class="o">-</span><span class="mf">1.308228</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">08</span>    <span class="mf">2.173185</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">09</span>    <span class="mf">0.564561</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">10</span>   <span class="o">-</span><span class="mf">0.190481</span>
</span></span><span class="line"><span class="cl">                <span class="o">...</span>   
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">22</span>    <span class="mf">0.000369</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">23</span>    <span class="mf">0.900885</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">24</span>   <span class="o">-</span><span class="mf">0.454869</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">25</span>   <span class="o">-</span><span class="mf">0.864547</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">26</span>    <span class="mf">1.129120</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">27</span>    <span class="mf">0.057874</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">28</span>   <span class="o">-</span><span class="mf">0.433739</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span>    <span class="mf">0.092698</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">30</span>   <span class="o">-</span><span class="mf">1.397820</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span>    <span class="mf">1.457823</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="n">D</span><span class="p">,</span> <span class="n">Length</span><span class="p">:</span> <span class="mi">365</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span></code></pre></div><p>这里，字符串<code>&quot;2001&quot;</code>被解释成年，并根据它选取时间区间。指定月也同样奏效：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">55</span><span class="p">]:</span> <span class="n">longer_ts</span><span class="p">[</span><span class="s1">&#39;2001-05&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">55</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">01</span>   <span class="o">-</span><span class="mf">0.622547</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">02</span>    <span class="mf">0.936289</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">03</span>    <span class="mf">0.750018</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">04</span>   <span class="o">-</span><span class="mf">0.056715</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">05</span>    <span class="mf">2.300675</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">06</span>    <span class="mf">0.569497</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">07</span>    <span class="mf">1.489410</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">08</span>    <span class="mf">1.264250</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">09</span>   <span class="o">-</span><span class="mf">0.761837</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">10</span>   <span class="o">-</span><span class="mf">0.331617</span>
</span></span><span class="line"><span class="cl">                <span class="o">...</span>   
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">22</span>    <span class="mf">0.503699</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">23</span>   <span class="o">-</span><span class="mf">1.387874</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">24</span>    <span class="mf">0.204851</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">25</span>    <span class="mf">0.603705</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">26</span>    <span class="mf">0.545680</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">27</span>    <span class="mf">0.235477</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">28</span>    <span class="mf">0.111835</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">29</span>   <span class="o">-</span><span class="mf">1.251504</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">30</span>   <span class="o">-</span><span class="mf">2.949343</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span>    <span class="mf">0.634634</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="n">D</span><span class="p">,</span> <span class="n">Length</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span></code></pre></div><p><code>datetime</code>对象也可以进行切片：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">56</span><span class="p">]:</span> <span class="n">ts</span><span class="p">[</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2011</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">):]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">56</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">07</span>   <span class="o">-</span><span class="mf">0.519439</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">08</span>   <span class="o">-</span><span class="mf">0.555730</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">10</span>    <span class="mf">1.965781</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">12</span>    <span class="mf">1.393406</span>
</span></span><span class="line"><span class="cl"><span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span></code></pre></div><p>由于大部分时间序列数据都是按照时间先后排序的，因此你也可以用不存在于该时间序列中的时间戳对其进行切片（即范围查询）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">57</span><span class="p">]:</span> <span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">57</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span>   <span class="o">-</span><span class="mf">0.204708</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">05</span>    <span class="mf">0.478943</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">07</span>   <span class="o">-</span><span class="mf">0.519439</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">08</span>   <span class="o">-</span><span class="mf">0.555730</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">10</span>    <span class="mf">1.965781</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">12</span>    <span class="mf">1.393406</span>
</span></span><span class="line"><span class="cl"><span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">58</span><span class="p">]:</span> <span class="n">ts</span><span class="p">[</span><span class="s1">&#39;1/6/2011&#39;</span><span class="p">:</span><span class="s1">&#39;1/11/2011&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">58</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">07</span>   <span class="o">-</span><span class="mf">0.519439</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">08</span>   <span class="o">-</span><span class="mf">0.555730</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">10</span>    <span class="mf">1.965781</span>
</span></span><span class="line"><span class="cl"><span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span></code></pre></div><p>跟之前一样，你可以传入字符串日期、<code>datetime</code>或<code>Timestamp</code>。注意，这样切片所产生的是原时间序列的视图，跟 NumPy 数组的切片运算是一样的。</p>
<p>这意味着，没有数据被复制，对切片进行修改会反映到原始数据上。</p>
<p>此外，还有一个等价的实例方法也可以截取两个日期之间<code>TimeSeries</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">59</span><span class="p">]:</span> <span class="n">ts</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">after</span><span class="o">=</span><span class="s1">&#39;1/9/2011&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">59</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span>   <span class="o">-</span><span class="mf">0.204708</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">05</span>    <span class="mf">0.478943</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">07</span>   <span class="o">-</span><span class="mf">0.519439</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">08</span>   <span class="o">-</span><span class="mf">0.555730</span>
</span></span><span class="line"><span class="cl"><span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span></code></pre></div><p>面这些操作对<code>DataFrame</code>也有效。例如，对<code>DataFrame</code>的行进行索引：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">60</span><span class="p">]:</span> <span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;1/1/2000&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;W-WED&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">61</span><span class="p">]:</span> <span class="n">long_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">   <span class="o">....</span><span class="p">:</span>                        <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="o">....</span><span class="p">:</span>                        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Colorado&#39;</span><span class="p">,</span> <span class="s1">&#39;Texas&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="o">....</span><span class="p">:</span>                                 <span class="s1">&#39;New York&#39;</span><span class="p">,</span> <span class="s1">&#39;Ohio&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">62</span><span class="p">]:</span> <span class="n">long_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;5-2001&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">62</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl">            <span class="n">Colorado</span>     <span class="n">Texas</span>  <span class="n">New</span> <span class="n">York</span>      <span class="n">Ohio</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">02</span> <span class="o">-</span><span class="mf">0.006045</span>  <span class="mf">0.490094</span> <span class="o">-</span><span class="mf">0.277186</span> <span class="o">-</span><span class="mf">0.707213</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">09</span> <span class="o">-</span><span class="mf">0.560107</span>  <span class="mf">2.735527</span>  <span class="mf">0.927335</span>  <span class="mf">1.513906</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">16</span>  <span class="mf">0.538600</span>  <span class="mf">1.273768</span>  <span class="mf">0.667876</span> <span class="o">-</span><span class="mf">0.969206</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">23</span>  <span class="mf">1.676091</span> <span class="o">-</span><span class="mf">0.817649</span>  <span class="mf">0.050188</span>  <span class="mf">1.951312</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">30</span>  <span class="mf">3.260383</span>  <span class="mf">0.963301</span>  <span class="mf">1.201206</span> <span class="o">-</span><span class="mf">1.852001</span>
</span></span></code></pre></div><h2 id="带有重复索引的时间序列">带有重复索引的时间序列</h2>
<p>在某些应用场景中，可能会存在多个观测数据落在同一个时间点上的情况。下面就是一个例子：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">63</span><span class="p">]:</span> <span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">([</span><span class="s1">&#39;1/1/2000&#39;</span><span class="p">,</span> <span class="s1">&#39;1/2/2000&#39;</span><span class="p">,</span> <span class="s1">&#39;1/2/2000&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="o">....</span><span class="p">:</span>                           <span class="s1">&#39;1/2/2000&#39;</span><span class="p">,</span> <span class="s1">&#39;1/3/2000&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">64</span><span class="p">]:</span> <span class="n">dup_ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">65</span><span class="p">]:</span> <span class="n">dup_ts</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">65</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span>    <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span>    <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span>    <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span>    <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span>    <span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</span></span></code></pre></div><p>通过检查索引的<code>is_unique</code>属性，我们就可以知道它是不是唯一的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">66</span><span class="p">]:</span> <span class="n">dup_ts</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_unique</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">66</span><span class="p">]:</span> <span class="kc">False</span>
</span></span></code></pre></div><p>对这个时间序列进行索引，要么产生标量值，要么产生切片，具体要看所选的时间点是否重复：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">67</span><span class="p">]:</span> <span class="n">dup_ts</span><span class="p">[</span><span class="s1">&#39;1/3/2000&#39;</span><span class="p">]</span>  <span class="c1"># not duplicated</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">67</span><span class="p">]:</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">68</span><span class="p">]:</span> <span class="n">dup_ts</span><span class="p">[</span><span class="s1">&#39;1/2/2000&#39;</span><span class="p">]</span>  <span class="c1"># duplicated</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">68</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span>    <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span>    <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span>    <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</span></span></code></pre></div><p>假设你想要对具有非唯一时间戳的数据进行聚合。一个办法是使用<code>groupby</code>，并传入<code>level=0</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">69</span><span class="p">]:</span> <span class="n">grouped</span> <span class="o">=</span> <span class="n">dup_ts</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">70</span><span class="p">]:</span> <span class="n">grouped</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">70</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span>    <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span>    <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span>    <span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">71</span><span class="p">]:</span> <span class="n">grouped</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">71</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span>    <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span>    <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span>    <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</span></span></code></pre></div><h1 id="113-日期的范围频率以及移动">11.3 日期的范围、频率以及移动</h1>
<p>pandas 中的原生时间序列一般被认为是不规则的，也就是说，它们没有固定的频率。对于大部分应用程序而言，这是无所谓的。但是，它常常需要以某种相对固定的频率进行分析，比如每日、每月、每 15 分钟等（这样自然会在时间序列中引入缺失值）。幸运的是，pandas 有一整套标准时间序列频率以及用于重采样、频率推断、生成固定频率日期范围的工具。例如，我们可以将之前那个时间序列转换为一个具有固定频率（每日）的时间序列，只需调用<code>resample</code>即可：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">72</span><span class="p">]:</span> <span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">72</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span>   <span class="o">-</span><span class="mf">0.204708</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">05</span>    <span class="mf">0.478943</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">07</span>   <span class="o">-</span><span class="mf">0.519439</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">08</span>   <span class="o">-</span><span class="mf">0.555730</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">10</span>    <span class="mf">1.965781</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">12</span>    <span class="mf">1.393406</span>
</span></span><span class="line"><span class="cl"><span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">73</span><span class="p">]:</span> <span class="n">resampler</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>字符串<code>D</code>是每天的意思。</p>
<p>频率的转换（或重采样）是一个比较大的主题，稍后将专门用一节来进行讨论（11.6 小节）。这里，我将告诉你如何使用基本的频率和它的倍数。</p>
<h2 id="生成日期范围">生成日期范围</h2>
<p>虽然我之前用的时候没有明说，但你可能已经猜到<code>pandas.date_range</code>可用于根据指定的频率生成指定长度的<code>DatetimeIndex</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">74</span><span class="p">]:</span> <span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2012-04-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-06-01&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">75</span><span class="p">]:</span> <span class="n">index</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">75</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">DatetimeIndex</span><span class="p">([</span><span class="s1">&#39;2012-04-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-02&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-03&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-04&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-04-05&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-06&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-07&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-08&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-04-09&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-10&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-11&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-12&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-04-13&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-14&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-15&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-16&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-04-17&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-18&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-19&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-20&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-04-21&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-22&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-23&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-24&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-04-25&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-26&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-27&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-28&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-04-29&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-30&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-02&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-05-03&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-04&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-05&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-06&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-05-07&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-08&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-09&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-10&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-05-11&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-12&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-13&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-14&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-05-15&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-16&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-17&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-18&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-05-19&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-20&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-21&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-22&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-05-23&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-24&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-25&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-26&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-05-27&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-28&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-29&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-30&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-05-31&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-06-01&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">              <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>默认情况下，<code>date_range</code>会产生按天计算的时间点。如果只传入起始或结束日期，那就还得传入一个表示一段时间的数字：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">76</span><span class="p">]:</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;2012-04-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">76</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">DatetimeIndex</span><span class="p">([</span><span class="s1">&#39;2012-04-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-02&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-03&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-04&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-04-05&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-06&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-07&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-08&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-04-09&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-10&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-11&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-12&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-04-13&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-14&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-15&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-16&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-04-17&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-18&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-19&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-04-20&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">              <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">77</span><span class="p">]:</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39;2012-06-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">77</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">DatetimeIndex</span><span class="p">([</span><span class="s1">&#39;2012-05-13&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-14&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-15&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-16&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-05-17&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-18&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-19&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-20&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-05-21&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-22&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-23&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-24&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-05-25&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-26&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-27&#39;</span><span class="p">,</span><span class="s1">&#39;2012-05-28&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-05-29&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-30&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-31&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-06-01&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">              <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>起始和结束日期定义了日期索引的严格边界。例如，如果你想要生成一个由每月最后一个工作日组成的日期索引，可以传入<code>&quot;BM&quot;</code>频率（表示商业月的末尾，表 11-4 是频率列表），这样就只会包含时间间隔内（或刚好在边界上的）符合频率要求的日期：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">78</span><span class="p">]:</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2000-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-12-01&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;BM&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">78</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">DatetimeIndex</span><span class="p">([</span><span class="s1">&#39;2000-01-31&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-02-29&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-03-31&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-04-28&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2000-05-31&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-06-30&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-07-31&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-08-31&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2000-09-29&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-10-31&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-11-30&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">              <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;BM&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>表 11-4 基本的时间序列频率（不完整）</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-c8614ddbd10793ca.png"
        data-srcset="img/7178691-c8614ddbd10793ca.png, img/7178691-c8614ddbd10793ca.png 1.5x, img/7178691-c8614ddbd10793ca.png 2x"
        data-sizes="auto"
        alt="img/7178691-c8614ddbd10793ca.png"
        title="img/7178691-c8614ddbd10793ca.png" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-8da46ba96544b071.png"
        data-srcset="img/7178691-8da46ba96544b071.png, img/7178691-8da46ba96544b071.png 1.5x, img/7178691-8da46ba96544b071.png 2x"
        data-sizes="auto"
        alt="img/7178691-8da46ba96544b071.png"
        title="img/7178691-8da46ba96544b071.png" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-3ca410609195edc4.png"
        data-srcset="img/7178691-3ca410609195edc4.png, img/7178691-3ca410609195edc4.png 1.5x, img/7178691-3ca410609195edc4.png 2x"
        data-sizes="auto"
        alt="img/7178691-3ca410609195edc4.png"
        title="img/7178691-3ca410609195edc4.png" /></p>
<p><code>date_range</code>默认会保留起始和结束时间戳的时间信息（如果有的话）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">79</span><span class="p">]:</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2012-05-02 12:56:31&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">79</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">DatetimeIndex</span><span class="p">([</span><span class="s1">&#39;2012-05-02 12:56:31&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-03 12:56:31&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-05-04 12:56:31&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-05 12:56:31&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-05-06 12:56:31&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">              <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>有时，虽然起始和结束日期带有时间信息，但你希望产生一组被规范化（normalize）到午夜的时间戳。<code>normalize</code>选项即可实现该功能：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">80</span><span class="p">]:</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2012-05-02 12:56:31&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">80</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">DatetimeIndex</span><span class="p">([</span><span class="s1">&#39;2012-05-02&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-03&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-04&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-05&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-05-06&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">              <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
</span></span></code></pre></div><h2 id="频率和日期偏移量">频率和日期偏移量</h2>
<p>pandas 中的频率是由一个基础频率（base frequency）和一个乘数组成的。基础频率通常以一个字符串别名表示，比如<code>&quot;M&quot;</code>表示每月，<code>&quot;H&quot;</code>表示每小时。对于每个基础频率，都有一个被称为日期偏移量（date offset）的对象与之对应。例如，按小时计算的频率可以用<code>Hour</code>类表示：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">81</span><span class="p">]:</span> <span class="kn">from</span> <span class="nn">pandas.tseries.offsets</span> <span class="kn">import</span> <span class="n">Hour</span><span class="p">,</span> <span class="n">Minute</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">82</span><span class="p">]:</span> <span class="n">hour</span> <span class="o">=</span> <span class="n">Hour</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">83</span><span class="p">]:</span> <span class="n">hour</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">83</span><span class="p">]:</span> <span class="o">&lt;</span><span class="n">Hour</span><span class="o">&gt;</span>
</span></span></code></pre></div><p>传入一个整数即可定义偏移量的倍数：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">84</span><span class="p">]:</span> <span class="n">four_hours</span> <span class="o">=</span> <span class="n">Hour</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">85</span><span class="p">]:</span> <span class="n">four_hours</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">85</span><span class="p">]:</span> <span class="o">&lt;</span><span class="mi">4</span> <span class="o">*</span> <span class="n">Hours</span><span class="o">&gt;</span>
</span></span></code></pre></div><p>一般来说，无需明确创建这样的对象，只需使用诸如&quot;H&quot;或&quot;4H&quot;这样的字符串别名即可。在基础频率前面放上一个整数即可创建倍数：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">86</span><span class="p">]:</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2000-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-01-03 23:59&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;4h&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">86</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">DatetimeIndex</span><span class="p">([</span><span class="s1">&#39;2000-01-01 00:00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-01-01 04:00:00&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2000-01-01 08:00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-01-01 12:00:00&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2000-01-01 16:00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-01-01 20:00:00&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2000-01-02 00:00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-01-02 04:00:00&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2000-01-02 08:00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-01-02 12:00:00&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2000-01-02 16:00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-01-02 20:00:00&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2000-01-03 00:00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-01-03 04:00:00&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2000-01-03 08:00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-01-03 12:00:00&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2000-01-03 16:00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-01-03 20:00:00&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">              <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;4H&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>大部分偏移量对象都可通过加法进行连接：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">87</span><span class="p">]:</span> <span class="n">Hour</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">Minute</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">87</span><span class="p">]:</span> <span class="o">&lt;</span><span class="mi">150</span> <span class="o">*</span> <span class="n">Minutes</span><span class="o">&gt;</span>
</span></span></code></pre></div><p>同理，你也可以传入频率字符串（如&quot;2h30min&quot;），这种字符串可以被高效地解析为等效的表达式：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">88</span><span class="p">]:</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2000-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;1h30min&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">88</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">DatetimeIndex</span><span class="p">([</span><span class="s1">&#39;2000-01-01 00:00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-01-01 01:30:00&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2000-01-01 03:00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-01-01 04:30:00&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2000-01-01 06:00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-01-01 07:30:00&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2000-01-01 09:00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-01-01 10:30:00&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2000-01-01 12:00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-01-01 13:30:00&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">              <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;90T&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>有些频率所描述的时间点并不是均匀分隔的。例如，<code>&quot;M&quot;</code>（日历月末）和<code>&quot;BM&quot;</code>（每月最后一个工作日）就取决于每月的天数，对于后者，还要考虑月末是不是周末。由于没有更好的术语，我将这些称为锚点偏移量（anchored offset）。</p>
<p>表 11-4 列出了 pandas 中的频率代码和日期偏移量类。</p>
<blockquote>
<p>笔记：用户可以根据实际需求自定义一些频率类以便提供 pandas 所没有的日期逻辑，但具体的细节超出了本书的范围。</p>
</blockquote>
<p>表 11-4 时间序列的基础频率</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-ff139312cd972204.png"
        data-srcset="img/7178691-ff139312cd972204.png, img/7178691-ff139312cd972204.png 1.5x, img/7178691-ff139312cd972204.png 2x"
        data-sizes="auto"
        alt="img/7178691-ff139312cd972204.png"
        title="img/7178691-ff139312cd972204.png" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-adfa57a998c0296e.png"
        data-srcset="img/7178691-adfa57a998c0296e.png, img/7178691-adfa57a998c0296e.png 1.5x, img/7178691-adfa57a998c0296e.png 2x"
        data-sizes="auto"
        alt="img/7178691-adfa57a998c0296e.png"
        title="img/7178691-adfa57a998c0296e.png" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-d09e577a10d0e6eb.png"
        data-srcset="img/7178691-d09e577a10d0e6eb.png, img/7178691-d09e577a10d0e6eb.png 1.5x, img/7178691-d09e577a10d0e6eb.png 2x"
        data-sizes="auto"
        alt="img/7178691-d09e577a10d0e6eb.png"
        title="img/7178691-d09e577a10d0e6eb.png" /></p>
<h2 id="wom-日期">WOM 日期</h2>
<p>WOM（Week Of Month）是一种非常实用的频率类，它以<code>WOM</code>开头。它使你能获得诸如“每月第 3 个星期五”之类的日期：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">89</span><span class="p">]:</span> <span class="n">rng</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2012-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-09-01&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;WOM-3FRI&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">90</span><span class="p">]:</span> <span class="nb">list</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">90</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2012-01-20 00:00:00&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;WOM-3FRI&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"> <span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2012-02-17 00:00:00&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;WOM-3FRI&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"> <span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2012-03-16 00:00:00&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;WOM-3FRI&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"> <span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2012-04-20 00:00:00&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;WOM-3FRI&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"> <span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2012-05-18 00:00:00&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;WOM-3FRI&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"> <span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2012-06-15 00:00:00&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;WOM-3FRI&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"> <span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2012-07-20 00:00:00&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;WOM-3FRI&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"> <span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2012-08-17 00:00:00&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;WOM-3FRI&#39;</span><span class="p">)]</span>
</span></span></code></pre></div><h2 id="移动超前和滞后数据">移动（超前和滞后）数据</h2>
<p>移动（shifting）指的是沿着时间轴将数据前移或后移。<code>Series</code>和<code>DataFrame</code>都有一个<code>shift</code>方法用于执行单纯的前移或后移操作，保持索引不变：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">91</span><span class="p">]:</span> <span class="n">ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">   <span class="o">....</span><span class="p">:</span>                <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;1/1/2000&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">92</span><span class="p">]:</span> <span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">92</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>   <span class="o">-</span><span class="mf">0.066748</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">29</span>    <span class="mf">0.838639</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span>   <span class="o">-</span><span class="mf">0.117388</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span>   <span class="o">-</span><span class="mf">0.517795</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="n">M</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">93</span><span class="p">]:</span> <span class="n">ts</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">93</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>         <span class="n">NaN</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">29</span>         <span class="n">NaN</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span>   <span class="o">-</span><span class="mf">0.066748</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span>    <span class="mf">0.838639</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="n">M</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">94</span><span class="p">]:</span> <span class="n">ts</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">94</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>   <span class="o">-</span><span class="mf">0.117388</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">29</span>   <span class="o">-</span><span class="mf">0.517795</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span>         <span class="n">NaN</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span>         <span class="n">NaN</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="n">M</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span></code></pre></div><p>当我们这样进行移动时，就会在时间序列的前面或后面产生缺失数据。</p>
<p><code>shift</code>通常用于计算一个时间序列或多个时间序列（如<code>DataFrame</code>的列）中的百分比变化。可以这样表达：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">ts</span> <span class="o">/</span> <span class="n">ts</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
</span></span></code></pre></div><p>由于单纯的移位操作不会修改索引，所以部分数据会被丢弃。因此，如果频率已知，则可以将其传给<code>shift</code>以便实现对时间戳进行位移而不是对数据进行简单位移：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">95</span><span class="p">]:</span> <span class="n">ts</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">95</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span>   <span class="o">-</span><span class="mf">0.066748</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span>    <span class="mf">0.838639</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span>   <span class="o">-</span><span class="mf">0.117388</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">30</span>   <span class="o">-</span><span class="mf">0.517795</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="n">M</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span></code></pre></div><p>这里还可以使用其他频率，于是你就能非常灵活地对数据进行超前和滞后处理了：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">96</span><span class="p">]:</span> <span class="n">ts</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">96</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">03</span>   <span class="o">-</span><span class="mf">0.066748</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">03</span>    <span class="mf">0.838639</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">03</span>   <span class="o">-</span><span class="mf">0.117388</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">03</span>   <span class="o">-</span><span class="mf">0.517795</span>
</span></span><span class="line"><span class="cl"><span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">97</span><span class="p">]:</span> <span class="n">ts</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;90T&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">97</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span> <span class="mi">01</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span>   <span class="o">-</span><span class="mf">0.066748</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">29</span> <span class="mi">01</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">0.838639</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span> <span class="mi">01</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span>   <span class="o">-</span><span class="mf">0.117388</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span> <span class="mi">01</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span>   <span class="o">-</span><span class="mf">0.517795</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="n">M</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span></code></pre></div><h2 id="通过偏移量对日期进行位移">通过偏移量对日期进行位移</h2>
<p>pandas 的日期偏移量还可以用在<code>datetime</code>或<code>Timestamp</code>对象上：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">98</span><span class="p">]:</span> <span class="kn">from</span> <span class="nn">pandas.tseries.offsets</span> <span class="kn">import</span> <span class="n">Day</span><span class="p">,</span> <span class="n">MonthEnd</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">99</span><span class="p">]:</span> <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2011</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">100</span><span class="p">]:</span> <span class="n">now</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">Day</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">100</span><span class="p">]:</span> <span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2011-11-20 00:00:00&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>如果加的是锚点偏移量（比如<code>MonthEnd</code>），第一次增量会将原日期向前滚动到符合频率规则的下一个日期：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">101</span><span class="p">]:</span> <span class="n">now</span> <span class="o">+</span> <span class="n">MonthEnd</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">101</span><span class="p">]:</span> <span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2011-11-30 00:00:00&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">102</span><span class="p">]:</span> <span class="n">now</span> <span class="o">+</span> <span class="n">MonthEnd</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">102</span><span class="p">]:</span> <span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2011-12-31 00:00:00&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>通过锚点偏移量的<code>rollforward</code>和<code>rollback</code>方法，可明确地将日期向前或向后“滚动”：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">103</span><span class="p">]:</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">MonthEnd</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">104</span><span class="p">]:</span> <span class="n">offset</span><span class="o">.</span><span class="n">rollforward</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">104</span><span class="p">]:</span> <span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2011-11-30 00:00:00&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">105</span><span class="p">]:</span> <span class="n">offset</span><span class="o">.</span><span class="n">rollback</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">105</span><span class="p">]:</span> <span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2011-10-31 00:00:00&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>日期偏移量还有一个巧妙的用法，即结合<code>groupby</code>使用这两个“滚动”方法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">106</span><span class="p">]:</span> <span class="n">ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">   <span class="o">.....</span><span class="p">:</span>                <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;1/15/2000&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;4d&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">107</span><span class="p">]:</span> <span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">107</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">15</span>   <span class="o">-</span><span class="mf">0.116696</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">19</span>    <span class="mf">2.389645</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">23</span>   <span class="o">-</span><span class="mf">0.932454</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">27</span>   <span class="o">-</span><span class="mf">0.229331</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>   <span class="o">-</span><span class="mf">1.140330</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">04</span>    <span class="mf">0.439920</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">08</span>   <span class="o">-</span><span class="mf">0.823758</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">12</span>   <span class="o">-</span><span class="mf">0.520930</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">16</span>    <span class="mf">0.350282</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">20</span>    <span class="mf">0.204395</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">24</span>    <span class="mf">0.133445</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">28</span>    <span class="mf">0.327905</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">03</span>    <span class="mf">0.072153</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">07</span>    <span class="mf">0.131678</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">11</span>   <span class="o">-</span><span class="mf">1.297459</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">15</span>    <span class="mf">0.997747</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">19</span>    <span class="mf">0.870955</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">23</span>   <span class="o">-</span><span class="mf">0.991253</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">27</span>    <span class="mf">0.151699</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span>    <span class="mf">1.266151</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="mi">4</span><span class="n">D</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">108</span><span class="p">]:</span> <span class="n">ts</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">offset</span><span class="o">.</span><span class="n">rollforward</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">108</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>   <span class="o">-</span><span class="mf">0.005833</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">29</span>    <span class="mf">0.015894</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span>    <span class="mf">0.150209</span>
</span></span><span class="line"><span class="cl"><span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span></code></pre></div><p>当然，更简单、更快速地实现该功能的办法是使用<code>resample</code>（11.6 小节将对此进行详细介绍）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">109</span><span class="p">]:</span> <span class="n">ts</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">109</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>   <span class="o">-</span><span class="mf">0.005833</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">29</span>    <span class="mf">0.015894</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span>    <span class="mf">0.150209</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="n">M</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span></code></pre></div><h1 id="114-时区处理">11.4 时区处理</h1>
<p>时间序列处理工作中最让人不爽的就是对时区的处理。许多人都选择以协调世界时（UTC，它是格林尼治标准时间（Greenwich Mean Time）的接替者，目前已经是国际标准了）来处理时间序列。时区是以 UTC 偏移量的形式表示的。例如，夏令时期间，纽约比 UTC 慢 4 小时，而在全年其他时间则比 UTC 慢 5 小时。</p>
<p>在 Python 中，时区信息来自第三方库<code>pytz</code>，它使 Python 可以使用 Olson 数据库（汇编了世界时区信息）。这对历史数据非常重要，这是因为由于各地政府的各种突发奇想，夏令时转变日期（甚至 UTC 偏移量）已经发生过多次改变了。就拿美国来说，DST 转变时间自 1900 年以来就改变过多次！</p>
<p>有关<code>pytz</code>库的更多信息，请查阅其文档。就本书而言，由于 pandas 包装了<code>pytz</code>的功能，因此你可以不用记忆其 API，只要记得时区的名称即可。时区名可以在 shell 中看到，也可以通过文档查看：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">110</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">pytz</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">111</span><span class="p">]:</span> <span class="n">pytz</span><span class="o">.</span><span class="n">common_timezones</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">111</span><span class="p">]:</span> <span class="p">[</span><span class="s1">&#39;US/Eastern&#39;</span><span class="p">,</span> <span class="s1">&#39;US/Hawaii&#39;</span><span class="p">,</span> <span class="s1">&#39;US/Mountain&#39;</span><span class="p">,</span> <span class="s1">&#39;US/Pacific&#39;</span><span class="p">,</span> <span class="s1">&#39;UTC&#39;</span><span class="p">]</span>
</span></span></code></pre></div><p>要从<code>pytz</code>中获取时区对象，使用<code>pytz.timezone</code>即可：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">112</span><span class="p">]:</span> <span class="n">tz</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="s1">&#39;America/New_York&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">113</span><span class="p">]:</span> <span class="n">tz</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">113</span><span class="p">]:</span> <span class="o">&lt;</span><span class="n">DstTzInfo</span> <span class="s1">&#39;America/New_York&#39;</span> <span class="n">LMT</span><span class="o">-</span><span class="mi">1</span> <span class="n">day</span><span class="p">,</span> <span class="mi">19</span><span class="p">:</span><span class="mi">04</span><span class="p">:</span><span class="mi">00</span> <span class="n">STD</span><span class="o">&gt;</span>
</span></span></code></pre></div><p>pandas 中的方法既可以接受时区名也可以接受这些对象。</p>
<h1 id="时区本地化和转换">时区本地化和转换</h1>
<p>默认情况下，pandas 中的时间序列是单纯（naive）的时区。看看下面这个时间序列：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">114</span><span class="p">]:</span> <span class="n">rng</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;3/9/2012 9:30&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">115</span><span class="p">]:</span> <span class="n">ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rng</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">116</span><span class="p">]:</span> <span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">116</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">09</span> <span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span>   <span class="o">-</span><span class="mf">0.202469</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">10</span> <span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">0.050718</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">11</span> <span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">0.639869</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">12</span> <span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">0.597594</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">13</span> <span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span>   <span class="o">-</span><span class="mf">0.797246</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">14</span> <span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">0.472879</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="n">D</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span></code></pre></div><p>其索引的<code>tz</code>字段为<code>None</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">117</span><span class="p">]:</span> <span class="nb">print</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kc">None</span>
</span></span></code></pre></div><p>可以用时区集生成日期范围：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">118</span><span class="p">]:</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;3/9/2012 9:30&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="s1">&#39;UTC&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">118</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">DatetimeIndex</span><span class="p">([</span><span class="s1">&#39;2012-03-09 09:30:00+00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-03-10 09:30:00+00:00&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-03-11 09:30:00+00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-03-12 09:30:00+00:00&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-03-13 09:30:00+00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-03-14 09:30:00+00:00&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-03-15 09:30:00+00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-03-16 09:30:00+00:00&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-03-17 09:30:00+00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-03-18 09:30:00+00:00&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">              <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;datetime64[ns, UTC]&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>从单纯到本地化的转换是通过<code>tz_localize</code>方法处理的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">119</span><span class="p">]:</span> <span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">119</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">09</span> <span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span>   <span class="o">-</span><span class="mf">0.202469</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">10</span> <span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">0.050718</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">11</span> <span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">0.639869</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">12</span> <span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">0.597594</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">13</span> <span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span>   <span class="o">-</span><span class="mf">0.797246</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">14</span> <span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">0.472879</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="n">D</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">120</span><span class="p">]:</span> <span class="n">ts_utc</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s1">&#39;UTC&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">121</span><span class="p">]:</span> <span class="n">ts_utc</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">121</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">09</span> <span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>   <span class="o">-</span><span class="mf">0.202469</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">10</span> <span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">0.050718</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">11</span> <span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">0.639869</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">12</span> <span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">0.597594</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">13</span> <span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>   <span class="o">-</span><span class="mf">0.797246</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">14</span> <span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">0.472879</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="n">D</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">122</span><span class="p">]:</span> <span class="n">ts_utc</span><span class="o">.</span><span class="n">index</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">122</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">DatetimeIndex</span><span class="p">([</span><span class="s1">&#39;2012-03-09 09:30:00+00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-03-10 09:30:00+00:00&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-03-11 09:30:00+00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-03-12 09:30:00+00:00&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-03-13 09:30:00+00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-03-14 09:30:00+00:00&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">              <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;datetime64[ns, UTC]&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>一旦时间序列被本地化到某个特定时区，就可以用<code>tz_convert</code>将其转换到别的时区了：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">123</span><span class="p">]:</span> <span class="n">ts_utc</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="s1">&#39;America/New_York&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">123</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">09</span> <span class="mi">04</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span><span class="o">-</span><span class="mi">05</span><span class="p">:</span><span class="mi">00</span>   <span class="o">-</span><span class="mf">0.202469</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">10</span> <span class="mi">04</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span><span class="o">-</span><span class="mi">05</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">0.050718</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">11</span> <span class="mi">05</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span><span class="o">-</span><span class="mi">04</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">0.639869</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">12</span> <span class="mi">05</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span><span class="o">-</span><span class="mi">04</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">0.597594</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">13</span> <span class="mi">05</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span><span class="o">-</span><span class="mi">04</span><span class="p">:</span><span class="mi">00</span>   <span class="o">-</span><span class="mf">0.797246</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">14</span> <span class="mi">05</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span><span class="o">-</span><span class="mi">04</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">0.472879</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="n">D</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span></code></pre></div><p>对于上面这种时间序列（它跨越了美国东部时区的夏令时转变期），我们可以将其本地化到 EST，然后转换为 UTC 或柏林时间：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">124</span><span class="p">]:</span> <span class="n">ts_eastern</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s1">&#39;America/New_York&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">125</span><span class="p">]:</span> <span class="n">ts_eastern</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="s1">&#39;UTC&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">125</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">09</span> <span class="mi">14</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>   <span class="o">-</span><span class="mf">0.202469</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">10</span> <span class="mi">14</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">0.050718</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">11</span> <span class="mi">13</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">0.639869</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">12</span> <span class="mi">13</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">0.597594</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">13</span> <span class="mi">13</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>   <span class="o">-</span><span class="mf">0.797246</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">14</span> <span class="mi">13</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">0.472879</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="n">D</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">126</span><span class="p">]:</span> <span class="n">ts_eastern</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="s1">&#39;Europe/Berlin&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">126</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">09</span> <span class="mi">15</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span><span class="o">+</span><span class="mi">01</span><span class="p">:</span><span class="mi">00</span>   <span class="o">-</span><span class="mf">0.202469</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">10</span> <span class="mi">15</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span><span class="o">+</span><span class="mi">01</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">0.050718</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">11</span> <span class="mi">14</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span><span class="o">+</span><span class="mi">01</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">0.639869</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">12</span> <span class="mi">14</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span><span class="o">+</span><span class="mi">01</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">0.597594</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">13</span> <span class="mi">14</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span><span class="o">+</span><span class="mi">01</span><span class="p">:</span><span class="mi">00</span>   <span class="o">-</span><span class="mf">0.797246</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">14</span> <span class="mi">14</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span><span class="o">+</span><span class="mi">01</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">0.472879</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="n">D</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span></code></pre></div><p><code>tz_localize</code>和<code>tz_convert</code>也是<code>DatetimeIndex</code>的实例方法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">127</span><span class="p">]:</span> <span class="n">ts</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s1">&#39;Asia/Shanghai&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">127</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">DatetimeIndex</span><span class="p">([</span><span class="s1">&#39;2012-03-09 09:30:00+08:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-03-10 09:30:00+08:00&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-03-11 09:30:00+08:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-03-12 09:30:00+08:00&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-03-13 09:30:00+08:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-03-14 09:30:00+08:00&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">              <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;datetime64[ns, Asia/Shanghai]&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
</span></span></code></pre></div><blockquote>
<p>注意：对单纯时间戳的本地化操作还会检查夏令时转变期附近容易混淆或不存在的时间。</p>
</blockquote>
<h2 id="操作时区意识型timestamp对象">操作时区意识型<code>Timestamp</code>对象</h2>
<p>跟时间序列和日期范围差不多，独立的<code>Timestamp</code>对象也能被从单纯型（naive）本地化为时区意识型（time zone-aware），并从一个时区转换到另一个时区：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">128</span><span class="p">]:</span> <span class="n">stamp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2011-03-12 04:00&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">129</span><span class="p">]:</span> <span class="n">stamp_utc</span> <span class="o">=</span> <span class="n">stamp</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s1">&#39;utc&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">130</span><span class="p">]:</span> <span class="n">stamp_utc</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="s1">&#39;America/New_York&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">130</span><span class="p">]:</span> <span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2011-03-11 23:00:00-0500&#39;</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="s1">&#39;America/New_York&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>在创建<code>Timestamp</code>时，还可以传入一个时区信息：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">131</span><span class="p">]:</span> <span class="n">stamp_moscow</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2011-03-12 04:00&#39;</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="s1">&#39;Europe/Moscow&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">132</span><span class="p">]:</span> <span class="n">stamp_moscow</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">132</span><span class="p">]:</span> <span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2011-03-12 04:00:00+0300&#39;</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="s1">&#39;Europe/Moscow&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>时区意识型<code>Timestamp</code>对象在内部保存了一个 UTC 时间戳值（自 UNIX 纪元（1970 年 1 月 1 日）算起的纳秒数）。这个 UTC 值在时区转换过程中是不会发生变化的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">133</span><span class="p">]:</span> <span class="n">stamp_utc</span><span class="o">.</span><span class="n">value</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">133</span><span class="p">]:</span> <span class="mi">1299902400000000000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">134</span><span class="p">]:</span> <span class="n">stamp_utc</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="s1">&#39;America/New_York&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">134</span><span class="p">]:</span> <span class="mi">1299902400000000000</span>
</span></span></code></pre></div><p>当使用 pandas 的<code>DateOffset</code>对象执行时间算术运算时，运算过程会自动关注是否存在夏令时转变期。这里，我们创建了在 DST 转变之前的时间戳。首先，来看夏令时转变前的 30 分钟：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">135</span><span class="p">]:</span> <span class="kn">from</span> <span class="nn">pandas.tseries.offsets</span> <span class="kn">import</span> <span class="n">Hour</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">136</span><span class="p">]:</span> <span class="n">stamp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2012-03-12 01:30&#39;</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="s1">&#39;US/Eastern&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">137</span><span class="p">]:</span> <span class="n">stamp</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">137</span><span class="p">]:</span> <span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2012-03-12 01:30:00-0400&#39;</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="s1">&#39;US/Eastern&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">138</span><span class="p">]:</span> <span class="n">stamp</span> <span class="o">+</span> <span class="n">Hour</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">138</span><span class="p">]:</span> <span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2012-03-12 02:30:00-0400&#39;</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="s1">&#39;US/Eastern&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>然后，夏令时转变前 90 分钟：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">139</span><span class="p">]:</span> <span class="n">stamp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2012-11-04 00:30&#39;</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="s1">&#39;US/Eastern&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">140</span><span class="p">]:</span> <span class="n">stamp</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">140</span><span class="p">]:</span> <span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2012-11-04 00:30:00-0400&#39;</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="s1">&#39;US/Eastern&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">141</span><span class="p">]:</span> <span class="n">stamp</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">Hour</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">141</span><span class="p">]:</span> <span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2012-11-04 01:30:00-0500&#39;</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="s1">&#39;US/Eastern&#39;</span><span class="p">)</span>
</span></span></code></pre></div><h2 id="不同时区之间的运算">不同时区之间的运算</h2>
<p>如果两个时间序列的时区不同，在将它们合并到一起时，最终结果就会是 UTC。由于时间戳其实是以 UTC 存储的，所以这是一个很简单的运算，并不需要发生任何转换：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">142</span><span class="p">]:</span> <span class="n">rng</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;3/7/2012 9:30&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">143</span><span class="p">]:</span> <span class="n">ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rng</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">144</span><span class="p">]:</span> <span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">144</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">07</span> <span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">0.522356</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">08</span> <span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span>   <span class="o">-</span><span class="mf">0.546348</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">09</span> <span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span>   <span class="o">-</span><span class="mf">0.733537</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">12</span> <span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">1.302736</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">13</span> <span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">0.022199</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">14</span> <span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">0.364287</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span>   <span class="o">-</span><span class="mf">0.922839</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">16</span> <span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">0.312656</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">19</span> <span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span>   <span class="o">-</span><span class="mf">1.128497</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span>   <span class="o">-</span><span class="mf">0.333488</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="n">B</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">145</span><span class="p">]:</span> <span class="n">ts1</span> <span class="o">=</span> <span class="n">ts</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s1">&#39;Europe/London&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">146</span><span class="p">]:</span> <span class="n">ts2</span> <span class="o">=</span> <span class="n">ts1</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="s1">&#39;Europe/Moscow&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">147</span><span class="p">]:</span> <span class="n">result</span> <span class="o">=</span> <span class="n">ts1</span> <span class="o">+</span> <span class="n">ts2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">148</span><span class="p">]:</span> <span class="n">result</span><span class="o">.</span><span class="n">index</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">148</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">DatetimeIndex</span><span class="p">([</span><span class="s1">&#39;2012-03-07 09:30:00+00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-03-08 09:30:00+00:00&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-03-09 09:30:00+00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-03-12 09:30:00+00:00&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-03-13 09:30:00+00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-03-14 09:30:00+00:00&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;2012-03-15 09:30:00+00:00&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">              <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;datetime64[ns, UTC]&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
</span></span></code></pre></div><h1 id="115-时期及其算术运算">11.5 时期及其算术运算</h1>
<p>时期（period）表示的是时间区间，比如数日、数月、数季、数年等。<code>Period</code>类所表示的就是这种数据类型，其构造函数需要用到一个字符串或整数，以及表 11-4 中的频率：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">149</span><span class="p">]:</span> <span class="n">p</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Period</span><span class="p">(</span><span class="mi">2007</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;A-DEC&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">150</span><span class="p">]:</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">150</span><span class="p">]:</span> <span class="n">Period</span><span class="p">(</span><span class="s1">&#39;2007&#39;</span><span class="p">,</span> <span class="s1">&#39;A-DEC&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>这里，这个<code>Period</code>对象表示的是从 2007 年 1 月 1 日到 2007 年 12 月 31 日之间的整段时间。只需对<code>Period</code>对象加上或减去一个整数即可达到根据其频率进行位移的效果：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">151</span><span class="p">]:</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">5</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">151</span><span class="p">]:</span> <span class="n">Period</span><span class="p">(</span><span class="s1">&#39;2012&#39;</span><span class="p">,</span> <span class="s1">&#39;A-DEC&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">152</span><span class="p">]:</span> <span class="n">p</span> <span class="o">-</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">152</span><span class="p">]:</span> <span class="n">Period</span><span class="p">(</span><span class="s1">&#39;2005&#39;</span><span class="p">,</span> <span class="s1">&#39;A-DEC&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>如果两个<code>Period</code>对象拥有相同的频率，则它们的差就是它们之间的单位数量：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">153</span><span class="p">]:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Period</span><span class="p">(</span><span class="s1">&#39;2014&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;A-DEC&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">153</span><span class="p">]:</span> <span class="mi">7</span>
</span></span></code></pre></div><p><code>period_range</code>函数可用于创建规则的时期范围：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">154</span><span class="p">]:</span> <span class="n">rng</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">period_range</span><span class="p">(</span><span class="s1">&#39;2000-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-06-30&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">155</span><span class="p">]:</span> <span class="n">rng</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">155</span><span class="p">]:</span> <span class="n">PeriodIndex</span><span class="p">([</span><span class="s1">&#39;2000-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-02&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-03&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-04&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-05&#39;</span><span class="p">,</span> <span class="s1">&#39;20</span>
</span></span><span class="line"><span class="cl"><span class="mi">00</span><span class="o">-</span><span class="mi">06</span><span class="s1">&#39;], dtype=&#39;</span><span class="n">period</span><span class="p">[</span><span class="n">M</span><span class="p">]</span><span class="s1">&#39;, freq=&#39;</span><span class="n">M</span><span class="s1">&#39;)</span>
</span></span></code></pre></div><p><code>PeriodIndex</code>类保存了一组<code>Period</code>，它可以在任何 pandas 数据结构中被用作轴索引：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">156</span><span class="p">]:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">156</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span>   <span class="o">-</span><span class="mf">0.514551</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">02</span>   <span class="o">-</span><span class="mf">0.559782</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">03</span>   <span class="o">-</span><span class="mf">0.783408</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">04</span>   <span class="o">-</span><span class="mf">1.797685</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">05</span>   <span class="o">-</span><span class="mf">0.172670</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">06</span>    <span class="mf">0.680215</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="n">M</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span></code></pre></div><p>如果你有一个字符串数组，你也可以使用<code>PeriodIndex</code>类：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">157</span><span class="p">]:</span> <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;2001Q3&#39;</span><span class="p">,</span> <span class="s1">&#39;2002Q2&#39;</span><span class="p">,</span> <span class="s1">&#39;2003Q1&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">158</span><span class="p">]:</span> <span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">PeriodIndex</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;Q-DEC&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">159</span><span class="p">]:</span> <span class="n">index</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">159</span><span class="p">]:</span> <span class="n">PeriodIndex</span><span class="p">([</span><span class="s1">&#39;2001Q3&#39;</span><span class="p">,</span> <span class="s1">&#39;2002Q2&#39;</span><span class="p">,</span> <span class="s1">&#39;2003Q1&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;period[Q-DEC]&#39;</span><span class="p">,</span> <span class="n">freq</span>
</span></span><span class="line"><span class="cl"><span class="o">=</span><span class="s1">&#39;Q-DEC&#39;</span><span class="p">)</span>
</span></span></code></pre></div><h2 id="时期的频率转换">时期的频率转换</h2>
<p><code>Period</code>和<code>PeriodIndex</code>对象都可以通过其<code>asfreq</code>方法被转换成别的频率。假设我们有一个年度时期，希望将其转换为当年年初或年末的一个月度时期。该任务非常简单：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">160</span><span class="p">]:</span> <span class="n">p</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Period</span><span class="p">(</span><span class="s1">&#39;2007&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;A-DEC&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">161</span><span class="p">]:</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">161</span><span class="p">]:</span> <span class="n">Period</span><span class="p">(</span><span class="s1">&#39;2007&#39;</span><span class="p">,</span> <span class="s1">&#39;A-DEC&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">162</span><span class="p">]:</span> <span class="n">p</span><span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;start&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">162</span><span class="p">]:</span> <span class="n">Period</span><span class="p">(</span><span class="s1">&#39;2007-01&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">163</span><span class="p">]:</span> <span class="n">p</span><span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;end&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">163</span><span class="p">]:</span> <span class="n">Period</span><span class="p">(</span><span class="s1">&#39;2007-12&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>你可以将<code>Period('2007','A-DEC')</code>看做一个被划分为多个月度时期的时间段中的游标。图 11-1 对此进行了说明。对于一个不以 12 月结束的财政年度，月度子时期的归属情况就不一样了：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">164</span><span class="p">]:</span> <span class="n">p</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Period</span><span class="p">(</span><span class="s1">&#39;2007&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;A-JUN&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">165</span><span class="p">]:</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">165</span><span class="p">]:</span> <span class="n">Period</span><span class="p">(</span><span class="s1">&#39;2007&#39;</span><span class="p">,</span> <span class="s1">&#39;A-JUN&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">166</span><span class="p">]:</span> <span class="n">p</span><span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">166</span><span class="p">]:</span> <span class="n">Period</span><span class="p">(</span><span class="s1">&#39;2006-07&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">167</span><span class="p">]:</span> <span class="n">p</span><span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">167</span><span class="p">]:</span> <span class="n">Period</span><span class="p">(</span><span class="s1">&#39;2007-06&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-d201200d0e65676f.png"
        data-srcset="img/7178691-d201200d0e65676f.png, img/7178691-d201200d0e65676f.png 1.5x, img/7178691-d201200d0e65676f.png 2x"
        data-sizes="auto"
        alt="img/7178691-d201200d0e65676f.png"
        title="图 11-1 Period 频率转换示例" /></p>
<p>在将高频率转换为低频率时，超时期（superperiod）是由子时期（subperiod）所属的位置决定的。例如，在<code>A-JUN</code>频率中，月份“2007 年 8 月”实际上是属于周期“2008 年”的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">168</span><span class="p">]:</span> <span class="n">p</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Period</span><span class="p">(</span><span class="s1">&#39;Aug-2007&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">169</span><span class="p">]:</span> <span class="n">p</span><span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="s1">&#39;A-JUN&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">169</span><span class="p">]:</span> <span class="n">Period</span><span class="p">(</span><span class="s1">&#39;2008&#39;</span><span class="p">,</span> <span class="s1">&#39;A-JUN&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>完整的<code>PeriodIndex</code>或<code>TimeSeries</code>的频率转换方式也是如此：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">170</span><span class="p">]:</span> <span class="n">rng</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">period_range</span><span class="p">(</span><span class="s1">&#39;2006&#39;</span><span class="p">,</span> <span class="s1">&#39;2009&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;A-DEC&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">171</span><span class="p">]:</span> <span class="n">ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rng</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">172</span><span class="p">]:</span> <span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">172</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2006</span>    <span class="mf">1.607578</span>
</span></span><span class="line"><span class="cl"><span class="mi">2007</span>    <span class="mf">0.200381</span>
</span></span><span class="line"><span class="cl"><span class="mi">2008</span>   <span class="o">-</span><span class="mf">0.834068</span>
</span></span><span class="line"><span class="cl"><span class="mi">2009</span>   <span class="o">-</span><span class="mf">0.302988</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="n">A</span><span class="o">-</span><span class="n">DEC</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">173</span><span class="p">]:</span> <span class="n">ts</span><span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;start&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">173</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2006</span><span class="o">-</span><span class="mi">01</span>    <span class="mf">1.607578</span>
</span></span><span class="line"><span class="cl"><span class="mi">2007</span><span class="o">-</span><span class="mi">01</span>    <span class="mf">0.200381</span>
</span></span><span class="line"><span class="cl"><span class="mi">2008</span><span class="o">-</span><span class="mi">01</span>   <span class="o">-</span><span class="mf">0.834068</span>
</span></span><span class="line"><span class="cl"><span class="mi">2009</span><span class="o">-</span><span class="mi">01</span>   <span class="o">-</span><span class="mf">0.302988</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="n">M</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span></code></pre></div><p>这里，根据年度时期的第一个月，每年的时期被取代为每月的时期。如果我们想要每年的最后一个工作日，我们可以使用<code>B</code>频率，并指明想要该时期的末尾：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">174</span><span class="p">]:</span> <span class="n">ts</span><span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;end&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">174</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2006</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span>    <span class="mf">1.607578</span>
</span></span><span class="line"><span class="cl"><span class="mi">2007</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span>    <span class="mf">0.200381</span>
</span></span><span class="line"><span class="cl"><span class="mi">2008</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span>   <span class="o">-</span><span class="mf">0.834068</span>
</span></span><span class="line"><span class="cl"><span class="mi">2009</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span>   <span class="o">-</span><span class="mf">0.302988</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="n">B</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span></code></pre></div><h2 id="按季度计算的时期频率">按季度计算的时期频率</h2>
<p>季度型数据在会计、金融等领域中很常见。许多季度型数据都会涉及“财年末”的概念，通常是一年 12 个月中某月的最后一个日历日或工作日。就这一点来说，时期<code>&quot;2012Q4&quot;</code>根据财年末的不同会有不同的含义。pandas 支持 12 种可能的季度型频率，即<code>Q-JAN</code>到<code>Q-DEC</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">175</span><span class="p">]:</span> <span class="n">p</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Period</span><span class="p">(</span><span class="s1">&#39;2012Q4&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;Q-JAN&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">176</span><span class="p">]:</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">176</span><span class="p">]:</span> <span class="n">Period</span><span class="p">(</span><span class="s1">&#39;2012Q4&#39;</span><span class="p">,</span> <span class="s1">&#39;Q-JAN&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>在以 1 月结束的财年中，<code>2012Q4</code>是从 11 月到 1 月（将其转换为日型频率就明白了）。图 11-2 对此进行了说明：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">177</span><span class="p">]:</span> <span class="n">p</span><span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">177</span><span class="p">]:</span> <span class="n">Period</span><span class="p">(</span><span class="s1">&#39;2011-11-01&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">178</span><span class="p">]:</span> <span class="n">p</span><span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">178</span><span class="p">]:</span> <span class="n">Period</span><span class="p">(</span><span class="s1">&#39;2012-01-31&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-e2e1d52c9766f6ff.png"
        data-srcset="img/7178691-e2e1d52c9766f6ff.png, img/7178691-e2e1d52c9766f6ff.png 1.5x, img/7178691-e2e1d52c9766f6ff.png 2x"
        data-sizes="auto"
        alt="img/7178691-e2e1d52c9766f6ff.png"
        title="图 11.2 不同季度型频率之间的转换" /></p>
<p>因此，<code>Period</code>之间的算术运算会非常简单。例如，要获取该季度倒数第二个工作日下午 4 点的时间戳，你可以这样：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">179</span><span class="p">]:</span> <span class="n">p4pm</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">60</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">180</span><span class="p">]:</span> <span class="n">p4pm</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">180</span><span class="p">]:</span> <span class="n">Period</span><span class="p">(</span><span class="s1">&#39;2012-01-30 16:00&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">181</span><span class="p">]:</span> <span class="n">p4pm</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">181</span><span class="p">]:</span> <span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2012-01-30 16:00:00&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p><code>period_range</code>可用于生成季度型范围。季度型范围的算术运算也跟上面是一样的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">182</span><span class="p">]:</span> <span class="n">rng</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">period_range</span><span class="p">(</span><span class="s1">&#39;2011Q3&#39;</span><span class="p">,</span> <span class="s1">&#39;2012Q4&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;Q-JAN&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">183</span><span class="p">]:</span> <span class="n">ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rng</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">184</span><span class="p">]:</span> <span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">184</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="n">Q3</span>    <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="n">Q4</span>    <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="n">Q1</span>    <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="n">Q2</span>    <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="n">Q3</span>    <span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="n">Q4</span>    <span class="mi">5</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="n">Q</span><span class="o">-</span><span class="n">JAN</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">185</span><span class="p">]:</span> <span class="n">new_rng</span> <span class="o">=</span> <span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">60</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">186</span><span class="p">]:</span> <span class="n">ts</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">new_rng</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">187</span><span class="p">]:</span> <span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">187</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl"><span class="mi">2010</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">28</span> <span class="mi">16</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>    <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">28</span> <span class="mi">16</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>    <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">28</span> <span class="mi">16</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>    <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">28</span> <span class="mi">16</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>    <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">28</span> <span class="mi">16</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>    <span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="mi">2012</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">30</span> <span class="mi">16</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>    <span class="mi">5</span>
</span></span><span class="line"><span class="cl"><span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</span></span></code></pre></div><h2 id="将timestamp转换为period及其反向过程">将<code>Timestamp</code>转换为<code>Period</code>（及其反向过程）</h2>
<p>通过使用<code>to_period</code>方法，可以将由时间戳索引的<code>Series</code>和<code>DataFrame</code>对象转换为以时期索引：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">188</span><span class="p">]:</span> <span class="n">rng</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2000-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">189</span><span class="p">]:</span> <span class="n">ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">190</span><span class="p">]:</span> <span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">190</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>    <span class="mf">1.663261</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">29</span>   <span class="o">-</span><span class="mf">0.996206</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span>    <span class="mf">1.521760</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="n">M</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">191</span><span class="p">]:</span> <span class="n">pts</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">to_period</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">192</span><span class="p">]:</span> <span class="n">pts</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">192</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span>    <span class="mf">1.663261</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">02</span>   <span class="o">-</span><span class="mf">0.996206</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">03</span>    <span class="mf">1.521760</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="n">M</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span></code></pre></div><p>由于时期指的是非重叠时间区间，因此对于给定的频率，一个时间戳只能属于一个时期。新<code>PeriodIndex</code>的频率默认是从时间戳推断而来的，你也可以指定任何别的频率。结果中允许存在重复时期：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">193</span><span class="p">]:</span> <span class="n">rng</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;1/29/2000&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">194</span><span class="p">]:</span> <span class="n">ts2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">195</span><span class="p">]:</span> <span class="n">ts2</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">195</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">29</span>    <span class="mf">0.244175</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">30</span>    <span class="mf">0.423331</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>   <span class="o">-</span><span class="mf">0.654040</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">01</span>    <span class="mf">2.089154</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">02</span>   <span class="o">-</span><span class="mf">0.060220</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">03</span>   <span class="o">-</span><span class="mf">0.167933</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="n">D</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">196</span><span class="p">]:</span> <span class="n">ts2</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">196</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span>    <span class="mf">0.244175</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span>    <span class="mf">0.423331</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span>   <span class="o">-</span><span class="mf">0.654040</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">02</span>    <span class="mf">2.089154</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">02</span>   <span class="o">-</span><span class="mf">0.060220</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">02</span>   <span class="o">-</span><span class="mf">0.167933</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="n">M</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span></code></pre></div><p>要转换回时间戳，使用<code>to_timestamp</code>即可：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">197</span><span class="p">]:</span> <span class="n">pts</span> <span class="o">=</span> <span class="n">ts2</span><span class="o">.</span><span class="n">to_period</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">198</span><span class="p">]:</span> <span class="n">pts</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">198</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">29</span>    <span class="mf">0.244175</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">30</span>    <span class="mf">0.423331</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>   <span class="o">-</span><span class="mf">0.654040</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">01</span>    <span class="mf">2.089154</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">02</span>   <span class="o">-</span><span class="mf">0.060220</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">03</span>   <span class="o">-</span><span class="mf">0.167933</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="n">D</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">199</span><span class="p">]:</span> <span class="n">pts</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;end&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">199</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">29</span>    <span class="mf">0.244175</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">30</span>    <span class="mf">0.423331</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>   <span class="o">-</span><span class="mf">0.654040</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">01</span>    <span class="mf">2.089154</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">02</span>   <span class="o">-</span><span class="mf">0.060220</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">03</span>   <span class="o">-</span><span class="mf">0.167933</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="n">D</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span></code></pre></div><h2 id="通过数组创建periodindex">通过数组创建<code>PeriodIndex</code></h2>
<p>固定频率的数据集通常会将时间信息分开存放在多个列中。例如，在下面这个宏观经济数据集中，年度和季度就分别存放在不同的列中：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">200</span><span class="p">]:</span> <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;examples/macrodata.csv&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">201</span><span class="p">]:</span> <span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">201</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl">     <span class="n">year</span>  <span class="n">quarter</span>   <span class="n">realgdp</span>  <span class="n">realcons</span>  <span class="n">realinv</span>  <span class="n">realgovt</span>  <span class="n">realdpi</span>    <span class="n">cpi</span>  \
</span></span><span class="line"><span class="cl"><span class="mi">0</span>  <span class="mf">1959.0</span>      <span class="mf">1.0</span>  <span class="mf">2710.349</span>    <span class="mf">1707.4</span>  <span class="mf">286.898</span>   <span class="mf">470.045</span>   <span class="mf">1886.9</span>  <span class="mf">28.98</span>   
</span></span><span class="line"><span class="cl"><span class="mi">1</span>  <span class="mf">1959.0</span>      <span class="mf">2.0</span>  <span class="mf">2778.801</span>    <span class="mf">1733.7</span>  <span class="mf">310.859</span>   <span class="mf">481.301</span>   <span class="mf">1919.7</span>  <span class="mf">29.15</span>   
</span></span><span class="line"><span class="cl"><span class="mi">2</span>  <span class="mf">1959.0</span>      <span class="mf">3.0</span>  <span class="mf">2775.488</span>    <span class="mf">1751.8</span>  <span class="mf">289.226</span>   <span class="mf">491.260</span>   <span class="mf">1916.4</span>  <span class="mf">29.35</span>   
</span></span><span class="line"><span class="cl"><span class="mi">3</span>  <span class="mf">1959.0</span>      <span class="mf">4.0</span>  <span class="mf">2785.204</span>    <span class="mf">1753.7</span>  <span class="mf">299.356</span>   <span class="mf">484.052</span>   <span class="mf">1931.3</span>  <span class="mf">29.37</span>   
</span></span><span class="line"><span class="cl"><span class="mi">4</span>  <span class="mf">1960.0</span>      <span class="mf">1.0</span>  <span class="mf">2847.699</span>    <span class="mf">1770.5</span>  <span class="mf">331.722</span>   <span class="mf">462.199</span>   <span class="mf">1955.5</span>  <span class="mf">29.54</span>   
</span></span><span class="line"><span class="cl">      <span class="n">m1</span>  <span class="n">tbilrate</span>  <span class="n">unemp</span>      <span class="n">pop</span>  <span class="n">infl</span>  <span class="n">realint</span>  
</span></span><span class="line"><span class="cl"><span class="mi">0</span>  <span class="mf">139.7</span>      <span class="mf">2.82</span>    <span class="mf">5.8</span>  <span class="mf">177.146</span>  <span class="mf">0.00</span>     <span class="mf">0.00</span>  
</span></span><span class="line"><span class="cl"><span class="mi">1</span>  <span class="mf">141.7</span>      <span class="mf">3.08</span>    <span class="mf">5.1</span>  <span class="mf">177.830</span>  <span class="mf">2.34</span>     <span class="mf">0.74</span>  
</span></span><span class="line"><span class="cl"><span class="mi">2</span>  <span class="mf">140.5</span>      <span class="mf">3.82</span>    <span class="mf">5.3</span>  <span class="mf">178.657</span>  <span class="mf">2.74</span>     <span class="mf">1.09</span>  
</span></span><span class="line"><span class="cl"><span class="mi">3</span>  <span class="mf">140.0</span>      <span class="mf">4.33</span>    <span class="mf">5.6</span>  <span class="mf">179.386</span>  <span class="mf">0.27</span>     <span class="mf">4.06</span>  
</span></span><span class="line"><span class="cl"><span class="mi">4</span>  <span class="mf">139.6</span>      <span class="mf">3.50</span>    <span class="mf">5.2</span>  <span class="mf">180.007</span>  <span class="mf">2.31</span>     <span class="mf">1.19</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">202</span><span class="p">]:</span> <span class="n">data</span><span class="o">.</span><span class="n">year</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">202</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">0</span>      <span class="mf">1959.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span>      <span class="mf">1959.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">2</span>      <span class="mf">1959.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">3</span>      <span class="mf">1959.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">4</span>      <span class="mf">1960.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">5</span>      <span class="mf">1960.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">6</span>      <span class="mf">1960.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">7</span>      <span class="mf">1960.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">8</span>      <span class="mf">1961.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">9</span>      <span class="mf">1961.0</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>  
</span></span><span class="line"><span class="cl"><span class="mi">193</span>    <span class="mf">2007.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">194</span>    <span class="mf">2007.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">195</span>    <span class="mf">2007.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">196</span>    <span class="mf">2008.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">197</span>    <span class="mf">2008.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">198</span>    <span class="mf">2008.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">199</span>    <span class="mf">2008.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">200</span>    <span class="mf">2009.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">201</span>    <span class="mf">2009.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">202</span>    <span class="mf">2009.0</span>
</span></span><span class="line"><span class="cl"><span class="n">Name</span><span class="p">:</span> <span class="n">year</span><span class="p">,</span> <span class="n">Length</span><span class="p">:</span> <span class="mi">203</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">203</span><span class="p">]:</span> <span class="n">data</span><span class="o">.</span><span class="n">quarter</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">203</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">0</span>      <span class="mf">1.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span>      <span class="mf">2.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">2</span>      <span class="mf">3.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">3</span>      <span class="mf">4.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">4</span>      <span class="mf">1.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">5</span>      <span class="mf">2.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">6</span>      <span class="mf">3.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">7</span>      <span class="mf">4.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">8</span>      <span class="mf">1.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">9</span>      <span class="mf">2.0</span>
</span></span><span class="line"><span class="cl">      <span class="o">...</span> 
</span></span><span class="line"><span class="cl"><span class="mi">193</span>    <span class="mf">2.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">194</span>    <span class="mf">3.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">195</span>    <span class="mf">4.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">196</span>    <span class="mf">1.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">197</span>    <span class="mf">2.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">198</span>    <span class="mf">3.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">199</span>    <span class="mf">4.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">200</span>    <span class="mf">1.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">201</span>    <span class="mf">2.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">202</span>    <span class="mf">3.0</span>
</span></span><span class="line"><span class="cl"><span class="n">Name</span><span class="p">:</span> <span class="n">quarter</span><span class="p">,</span> <span class="n">Length</span><span class="p">:</span> <span class="mi">203</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span></code></pre></div><p>通过将这些数组以及一个频率传入<code>PeriodIndex</code>，就可以将它们合并成<code>DataFrame</code>的一个索引：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">204</span><span class="p">]:</span> <span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">PeriodIndex</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">quarter</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">quarter</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="o">.....</span><span class="p">:</span>                        <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;Q-DEC&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">205</span><span class="p">]:</span> <span class="n">index</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">205</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">PeriodIndex</span><span class="p">([</span><span class="s1">&#39;1959Q1&#39;</span><span class="p">,</span> <span class="s1">&#39;1959Q2&#39;</span><span class="p">,</span> <span class="s1">&#39;1959Q3&#39;</span><span class="p">,</span> <span class="s1">&#39;1959Q4&#39;</span><span class="p">,</span> <span class="s1">&#39;1960Q1&#39;</span><span class="p">,</span> <span class="s1">&#39;1960Q2&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="s1">&#39;1960Q3&#39;</span><span class="p">,</span> <span class="s1">&#39;1960Q4&#39;</span><span class="p">,</span> <span class="s1">&#39;1961Q1&#39;</span><span class="p">,</span> <span class="s1">&#39;1961Q2&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="o">...</span>
</span></span><span class="line"><span class="cl">             <span class="s1">&#39;2007Q2&#39;</span><span class="p">,</span> <span class="s1">&#39;2007Q3&#39;</span><span class="p">,</span> <span class="s1">&#39;2007Q4&#39;</span><span class="p">,</span> <span class="s1">&#39;2008Q1&#39;</span><span class="p">,</span> <span class="s1">&#39;2008Q2&#39;</span><span class="p">,</span> <span class="s1">&#39;2008Q3&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="s1">&#39;2008Q4&#39;</span><span class="p">,</span> <span class="s1">&#39;2009Q1&#39;</span><span class="p">,</span> <span class="s1">&#39;2009Q2&#39;</span><span class="p">,</span> <span class="s1">&#39;2009Q3&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;period[Q-DEC]&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">203</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;Q-DEC&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">206</span><span class="p">]:</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">207</span><span class="p">]:</span> <span class="n">data</span><span class="o">.</span><span class="n">infl</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">207</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">1959</span><span class="n">Q1</span>    <span class="mf">0.00</span>
</span></span><span class="line"><span class="cl"><span class="mi">1959</span><span class="n">Q2</span>    <span class="mf">2.34</span>
</span></span><span class="line"><span class="cl"><span class="mi">1959</span><span class="n">Q3</span>    <span class="mf">2.74</span>
</span></span><span class="line"><span class="cl"><span class="mi">1959</span><span class="n">Q4</span>    <span class="mf">0.27</span>
</span></span><span class="line"><span class="cl"><span class="mi">1960</span><span class="n">Q1</span>    <span class="mf">2.31</span>
</span></span><span class="line"><span class="cl"><span class="mi">1960</span><span class="n">Q2</span>    <span class="mf">0.14</span>
</span></span><span class="line"><span class="cl"><span class="mi">1960</span><span class="n">Q3</span>    <span class="mf">2.70</span>
</span></span><span class="line"><span class="cl"><span class="mi">1960</span><span class="n">Q4</span>    <span class="mf">1.21</span>
</span></span><span class="line"><span class="cl"><span class="mi">1961</span><span class="n">Q1</span>   <span class="o">-</span><span class="mf">0.40</span>
</span></span><span class="line"><span class="cl"><span class="mi">1961</span><span class="n">Q2</span>    <span class="mf">1.47</span>
</span></span><span class="line"><span class="cl">          <span class="o">...</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2007</span><span class="n">Q2</span>    <span class="mf">2.75</span>
</span></span><span class="line"><span class="cl"><span class="mi">2007</span><span class="n">Q3</span>    <span class="mf">3.45</span>
</span></span><span class="line"><span class="cl"><span class="mi">2007</span><span class="n">Q4</span>    <span class="mf">6.38</span>
</span></span><span class="line"><span class="cl"><span class="mi">2008</span><span class="n">Q1</span>    <span class="mf">2.82</span>
</span></span><span class="line"><span class="cl"><span class="mi">2008</span><span class="n">Q2</span>    <span class="mf">8.53</span>
</span></span><span class="line"><span class="cl"><span class="mi">2008</span><span class="n">Q3</span>   <span class="o">-</span><span class="mf">3.16</span>
</span></span><span class="line"><span class="cl"><span class="mi">2008</span><span class="n">Q4</span>   <span class="o">-</span><span class="mf">8.79</span>
</span></span><span class="line"><span class="cl"><span class="mi">2009</span><span class="n">Q1</span>    <span class="mf">0.94</span>
</span></span><span class="line"><span class="cl"><span class="mi">2009</span><span class="n">Q2</span>    <span class="mf">3.37</span>
</span></span><span class="line"><span class="cl"><span class="mi">2009</span><span class="n">Q3</span>    <span class="mf">3.56</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="n">Q</span><span class="o">-</span><span class="n">DEC</span><span class="p">,</span> <span class="n">Name</span><span class="p">:</span> <span class="n">infl</span><span class="p">,</span> <span class="n">Length</span><span class="p">:</span> <span class="mi">203</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span></code></pre></div><h1 id="116-重采样及频率转换">11.6 重采样及频率转换</h1>
<p>重采样（resampling）指的是将时间序列从一个频率转换到另一个频率的处理过程。将高频率数据聚合到低频率称为降采样（downsampling），而将低频率数据转换到高频率则称为升采样（upsampling）。并不是所有的重采样都能被划分到这两个大类中。例如，将<code>W-WED</code>（每周三）转换为<code>W-FRI</code>既不是降采样也不是升采样。</p>
<p>pandas 对象都带有一个<code>resample</code>方法，它是各种频率转换工作的主力函数。<code>resample</code>有一个类似于<code>groupby</code>的 API，调用<code>resample</code>可以分组数据，然后会调用一个聚合函数：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">208</span><span class="p">]:</span> <span class="n">rng</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2000-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">209</span><span class="p">]:</span> <span class="n">ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rng</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">210</span><span class="p">]:</span> <span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">210</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span>    <span class="mf">0.631634</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span>   <span class="o">-</span><span class="mf">1.594313</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span>   <span class="o">-</span><span class="mf">1.519937</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">04</span>    <span class="mf">1.108752</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">05</span>    <span class="mf">1.255853</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span>   <span class="o">-</span><span class="mf">0.024330</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">07</span>   <span class="o">-</span><span class="mf">2.047939</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">08</span>   <span class="o">-</span><span class="mf">0.272657</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">09</span>   <span class="o">-</span><span class="mf">1.692615</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">10</span>    <span class="mf">1.423830</span>
</span></span><span class="line"><span class="cl">                <span class="o">...</span>   
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span>   <span class="o">-</span><span class="mf">0.007852</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">01</span>   <span class="o">-</span><span class="mf">1.638806</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">02</span>    <span class="mf">1.401227</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">03</span>    <span class="mf">1.758539</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">04</span>    <span class="mf">0.628932</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">05</span>   <span class="o">-</span><span class="mf">0.423776</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">06</span>    <span class="mf">0.789740</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">07</span>    <span class="mf">0.937568</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">08</span>   <span class="o">-</span><span class="mf">2.253294</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">09</span>   <span class="o">-</span><span class="mf">1.772919</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="n">D</span><span class="p">,</span> <span class="n">Length</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">211</span><span class="p">]:</span> <span class="n">ts</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">211</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">31</span>   <span class="o">-</span><span class="mf">0.165893</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">29</span>    <span class="mf">0.078606</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">31</span>    <span class="mf">0.223811</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">30</span>   <span class="o">-</span><span class="mf">0.063643</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="n">M</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">212</span><span class="p">]:</span> <span class="n">ts</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">212</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span>   <span class="o">-</span><span class="mf">0.165893</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">02</span>    <span class="mf">0.078606</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">03</span>    <span class="mf">0.223811</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">04</span>   <span class="o">-</span><span class="mf">0.063643</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="n">M</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span></code></pre></div><p><code>resample</code>是一个灵活高效的方法，可用于处理非常大的时间序列。我将通过一系列的示例说明其用法。表 11-5 总结它的一些选项。</p>
<p>表 11-5 <code>resample</code>方法的参数
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-b40a57086c904e83.png"
        data-srcset="img/7178691-b40a57086c904e83.png, img/7178691-b40a57086c904e83.png 1.5x, img/7178691-b40a57086c904e83.png 2x"
        data-sizes="auto"
        alt="img/7178691-b40a57086c904e83.png"
        title="img/7178691-b40a57086c904e83.png" /></p>
<h2 id="降采样">降采样</h2>
<p>将数据聚合到规律的低频率是一件非常普通的时间序列处理任务。待聚合的数据不必拥有固定的频率，期望的频率会自动定义聚合的面元边界，这些面元用于将时间序列拆分为多个片段。例如，要转换到月度频率（<code>'M'</code>或<code>'BM'</code>），数据需要被划分到多个单月时间段中。各时间段都是半开放的。一个数据点只能属于一个时间段，所有时间段的并集必须能组成整个时间帧。在用<code>resample</code>对数据进行降采样时，需要考虑两样东西：</p>
<ul>
<li>各区间哪边是闭合的。</li>
<li>如何标记各个聚合面元，用区间的开头还是末尾。</li>
</ul>
<p>为了说明，我们来看一些“1 分钟”数据：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">213</span><span class="p">]:</span> <span class="n">rng</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2000-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">214</span><span class="p">]:</span> <span class="n">ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">215</span><span class="p">]:</span> <span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">215</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>     <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mi">00</span>     <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="mi">00</span>     <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mi">00</span>     <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">04</span><span class="p">:</span><span class="mi">00</span>     <span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mi">00</span>     <span class="mi">5</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mi">00</span>     <span class="mi">6</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">00</span>     <span class="mi">7</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">08</span><span class="p">:</span><span class="mi">00</span>     <span class="mi">8</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">09</span><span class="p">:</span><span class="mi">00</span>     <span class="mi">9</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">00</span>    <span class="mi">10</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">00</span>    <span class="mi">11</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</span></span></code></pre></div><p>假设你想要通过求和的方式将这些数据聚合到“5 分钟”块中：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">216</span><span class="p">]:</span> <span class="n">ts</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;5min&#39;</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">216</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">1999</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span> <span class="mi">23</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="mi">00</span>     <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>    <span class="mi">15</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mi">00</span>    <span class="mi">40</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">00</span>    <span class="mi">11</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="mi">5</span><span class="n">T</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</span></span></code></pre></div><p>传入的频率将会以“5 分钟”的增量定义面元边界。默认情况下，面元的右边界是包含的，因此<code>00:00</code>到<code>00:05</code>的区间中是包含<code>00:05</code>的。传入<code>closed='left'</code>会让区间以左边界闭合：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">217</span><span class="p">]:</span> <span class="n">ts</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;5min&#39;</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">217</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">1999</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span> <span class="mi">23</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="mi">00</span>     <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>    <span class="mi">15</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mi">00</span>    <span class="mi">40</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">00</span>    <span class="mi">11</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="mi">5</span><span class="n">T</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</span></span></code></pre></div><p>如你所见，最终的时间序列是以各面元右边界的时间戳进行标记的。传入<code>label='right'</code>即可用面元的邮编界对其进行标记：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">218</span><span class="p">]:</span> <span class="n">ts</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;5min&#39;</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">218</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>     <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mi">00</span>    <span class="mi">15</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">00</span>    <span class="mi">40</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">00</span>    <span class="mi">11</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="mi">5</span><span class="n">T</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</span></span></code></pre></div><p>图 11-3 说明了“1 分钟”数据被转换为“5 分钟”数据的处理过程。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-7a77f47844f2ee8c.png"
        data-srcset="img/7178691-7a77f47844f2ee8c.png, img/7178691-7a77f47844f2ee8c.png 1.5x, img/7178691-7a77f47844f2ee8c.png 2x"
        data-sizes="auto"
        alt="img/7178691-7a77f47844f2ee8c.png"
        title="图 11-3 各种&lt;code&gt;closed&lt;/code&gt;、&lt;code&gt;label&lt;/code&gt;约定的“5 分钟”重采样演示" /></p>
<p>最后，你可能希望对结果索引做一些位移，比如从右边界减去一秒以便更容易明白该时间戳到底表示的是哪个区间。只需通过<code>loffset</code>设置一个字符串或日期偏移量即可实现这个目的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">219</span><span class="p">]:</span> <span class="n">ts</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;5min&#39;</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="o">.....</span><span class="p">:</span>             <span class="n">label</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">loffset</span><span class="o">=</span><span class="s1">&#39;-1s&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">219</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">1999</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span> <span class="mi">23</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">59</span>     <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">04</span><span class="p">:</span><span class="mi">59</span>    <span class="mi">15</span>
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">219</span><span class="p">]:</span> <span class="n">ts</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;5min&#39;</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="o">.....</span><span class="p">:</span>             <span class="n">label</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">loffset</span><span class="o">=</span><span class="s1">&#39;-1s&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">219</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">1999</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span> <span class="mi">23</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">59</span>     <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">04</span><span class="p">:</span><span class="mi">59</span>    <span class="mi">15</span>
</span></span></code></pre></div><p>此外，也可以通过调用结果对象的<code>shift</code>方法来实现该目的，这样就不需要设置<code>loffset</code>了。</p>
<h2 id="ohlc-重采样">OHLC 重采样</h2>
<p>金融领域中有一种无所不在的时间序列聚合方式，即计算各面元的四个值：第一个值（<code>open</code>，开盘）、最后一个值（<code>close</code>，收盘）、最大值（<code>high</code>，最高）以及最小值（<code>low</code>，最低）。传入<code>how='ohlc'</code>即可得到一个含有这四种聚合值的<code>DataFrame</code>。整个过程很高效，只需一次扫描即可计算出结果：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">220</span><span class="p">]:</span> <span class="n">ts</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;5min&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ohlc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">220</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl">                     <span class="nb">open</span>  <span class="n">high</span>  <span class="n">low</span>  <span class="n">close</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>     <span class="mi">0</span>     <span class="mi">4</span>    <span class="mi">0</span>      <span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mi">00</span>     <span class="mi">5</span>     <span class="mi">9</span>    <span class="mi">5</span>      <span class="mi">9</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">00</span>    <span class="mi">10</span>    <span class="mi">11</span>   <span class="mi">10</span>     <span class="mi">11</span>
</span></span></code></pre></div><h2 id="升采样和插值">升采样和插值</h2>
<p>在将数据从低频率转换到高频率时，就不需要聚合了。我们来看一个带有一些周型数据的<code>DataFrame</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">221</span><span class="p">]:</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">   <span class="o">.....</span><span class="p">:</span>                      <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;1/1/2000&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="o">.....</span><span class="p">:</span>                                          <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;W-WED&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">   <span class="o">.....</span><span class="p">:</span>                      <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Colorado&#39;</span><span class="p">,</span> <span class="s1">&#39;Texas&#39;</span><span class="p">,</span> <span class="s1">&#39;New York&#39;</span><span class="p">,</span> <span class="s1">&#39;Ohio&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">222</span><span class="p">]:</span> <span class="n">frame</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">222</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl">            <span class="n">Colorado</span>     <span class="n">Texas</span>  <span class="n">New</span> <span class="n">York</span>      <span class="n">Ohio</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">05</span> <span class="o">-</span><span class="mf">0.896431</span>  <span class="mf">0.677263</span>  <span class="mf">0.036503</span>  <span class="mf">0.087102</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">12</span> <span class="o">-</span><span class="mf">0.046662</span>  <span class="mf">0.927238</span>  <span class="mf">0.482284</span> <span class="o">-</span><span class="mf">0.867130</span>
</span></span></code></pre></div><p>当你对这个数据进行聚合，每组只有一个值，这样就会引入缺失值。我们使用<code>asfreq</code>方法转换成高频，不经过聚合：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">223</span><span class="p">]:</span> <span class="n">df_daily</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">asfreq</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">224</span><span class="p">]:</span> <span class="n">df_daily</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">224</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl">            <span class="n">Colorado</span>     <span class="n">Texas</span>  <span class="n">New</span> <span class="n">York</span>      <span class="n">Ohio</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">05</span> <span class="o">-</span><span class="mf">0.896431</span>  <span class="mf">0.677263</span>  <span class="mf">0.036503</span>  <span class="mf">0.087102</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span>       <span class="n">NaN</span>       <span class="n">NaN</span>       <span class="n">NaN</span>       <span class="n">NaN</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">07</span>       <span class="n">NaN</span>       <span class="n">NaN</span>       <span class="n">NaN</span>       <span class="n">NaN</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">08</span>       <span class="n">NaN</span>       <span class="n">NaN</span>       <span class="n">NaN</span>       <span class="n">NaN</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">09</span>       <span class="n">NaN</span>       <span class="n">NaN</span>       <span class="n">NaN</span>       <span class="n">NaN</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">10</span>       <span class="n">NaN</span>       <span class="n">NaN</span>       <span class="n">NaN</span>       <span class="n">NaN</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">11</span>       <span class="n">NaN</span>       <span class="n">NaN</span>       <span class="n">NaN</span>       <span class="n">NaN</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">12</span> <span class="o">-</span><span class="mf">0.046662</span>  <span class="mf">0.927238</span>  <span class="mf">0.482284</span> <span class="o">-</span><span class="mf">0.867130</span>
</span></span></code></pre></div><p>假设你想要用前面的周型值填充“非星期三”。<code>resample</code>的填充和插值方式跟<code>fillna</code>和<code>reindex</code>的一样：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">225</span><span class="p">]:</span> <span class="n">frame</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">225</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl">            <span class="n">Colorado</span>     <span class="n">Texas</span>  <span class="n">New</span> <span class="n">York</span>      <span class="n">Ohio</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">05</span> <span class="o">-</span><span class="mf">0.896431</span>  <span class="mf">0.677263</span>  <span class="mf">0.036503</span>  <span class="mf">0.087102</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span> <span class="o">-</span><span class="mf">0.896431</span>  <span class="mf">0.677263</span>  <span class="mf">0.036503</span>  <span class="mf">0.087102</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">07</span> <span class="o">-</span><span class="mf">0.896431</span>  <span class="mf">0.677263</span>  <span class="mf">0.036503</span>  <span class="mf">0.087102</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">08</span> <span class="o">-</span><span class="mf">0.896431</span>  <span class="mf">0.677263</span>  <span class="mf">0.036503</span>  <span class="mf">0.087102</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">09</span> <span class="o">-</span><span class="mf">0.896431</span>  <span class="mf">0.677263</span>  <span class="mf">0.036503</span>  <span class="mf">0.087102</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">10</span> <span class="o">-</span><span class="mf">0.896431</span>  <span class="mf">0.677263</span>  <span class="mf">0.036503</span>  <span class="mf">0.087102</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">11</span> <span class="o">-</span><span class="mf">0.896431</span>  <span class="mf">0.677263</span>  <span class="mf">0.036503</span>  <span class="mf">0.087102</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">12</span> <span class="o">-</span><span class="mf">0.046662</span>  <span class="mf">0.927238</span>  <span class="mf">0.482284</span> <span class="o">-</span><span class="mf">0.867130</span>
</span></span></code></pre></div><p>同样，这里也可以只填充指定的时期数（目的是限制前面的观测值的持续使用距离）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">226</span><span class="p">]:</span> <span class="n">frame</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ffill</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">226</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="n">Colorado</span>     <span class="n">Texas</span>  <span class="n">New</span> <span class="n">York</span>      <span class="n">Ohio</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">05</span> <span class="o">-</span><span class="mf">0.896431</span>  <span class="mf">0.677263</span>  <span class="mf">0.036503</span>  <span class="mf">0.087102</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span> <span class="o">-</span><span class="mf">0.896431</span>  <span class="mf">0.677263</span>  <span class="mf">0.036503</span>  <span class="mf">0.087102</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">07</span> <span class="o">-</span><span class="mf">0.896431</span>  <span class="mf">0.677263</span>  <span class="mf">0.036503</span>  <span class="mf">0.087102</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">08</span>       <span class="n">NaN</span>       <span class="n">NaN</span>       <span class="n">NaN</span>       <span class="n">NaN</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">09</span>       <span class="n">NaN</span>       <span class="n">NaN</span>       <span class="n">NaN</span>       <span class="n">NaN</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">10</span>       <span class="n">NaN</span>       <span class="n">NaN</span>       <span class="n">NaN</span>       <span class="n">NaN</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">11</span>       <span class="n">NaN</span>       <span class="n">NaN</span>       <span class="n">NaN</span>       <span class="n">NaN</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">12</span> <span class="o">-</span><span class="mf">0.046662</span>  <span class="mf">0.927238</span>  <span class="mf">0.482284</span> <span class="o">-</span><span class="mf">0.867130</span>
</span></span></code></pre></div><p>注意，新的日期索引完全没必要跟旧的重叠：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">227</span><span class="p">]:</span> <span class="n">frame</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;W-THU&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">227</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl">            <span class="n">Colorado</span>     <span class="n">Texas</span>  <span class="n">New</span> <span class="n">York</span>      <span class="n">Ohio</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span> <span class="o">-</span><span class="mf">0.896431</span>  <span class="mf">0.677263</span>  <span class="mf">0.036503</span>  <span class="mf">0.087102</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">13</span> <span class="o">-</span><span class="mf">0.046662</span>  <span class="mf">0.927238</span>  <span class="mf">0.482284</span> <span class="o">-</span><span class="mf">0.867130</span>
</span></span></code></pre></div><h2 id="通过时期进行重采样">通过时期进行重采样</h2>
<p>对那些使用时期索引的数据进行重采样与时间戳很像：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">228</span><span class="p">]:</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">   <span class="o">.....</span><span class="p">:</span>                      <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">period_range</span><span class="p">(</span><span class="s1">&#39;1-2000&#39;</span><span class="p">,</span> <span class="s1">&#39;12-2001&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="o">.....</span><span class="p">:</span>                                            <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">   <span class="o">.....</span><span class="p">:</span>                      <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Colorado&#39;</span><span class="p">,</span> <span class="s1">&#39;Texas&#39;</span><span class="p">,</span> <span class="s1">&#39;New York&#39;</span><span class="p">,</span> <span class="s1">&#39;Ohio&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">229</span><span class="p">]:</span> <span class="n">frame</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">229</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl">         <span class="n">Colorado</span>     <span class="n">Texas</span>  <span class="n">New</span> <span class="n">York</span>      <span class="n">Ohio</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">01</span>  <span class="mf">0.493841</span> <span class="o">-</span><span class="mf">0.155434</span>  <span class="mf">1.397286</span>  <span class="mf">1.507055</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">02</span> <span class="o">-</span><span class="mf">1.179442</span>  <span class="mf">0.443171</span>  <span class="mf">1.395676</span> <span class="o">-</span><span class="mf">0.529658</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">03</span>  <span class="mf">0.787358</span>  <span class="mf">0.248845</span>  <span class="mf">0.743239</span>  <span class="mf">1.267746</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">04</span>  <span class="mf">1.302395</span> <span class="o">-</span><span class="mf">0.272154</span> <span class="o">-</span><span class="mf">0.051532</span> <span class="o">-</span><span class="mf">0.467740</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="o">-</span><span class="mi">05</span> <span class="o">-</span><span class="mf">1.040816</span>  <span class="mf">0.426419</span>  <span class="mf">0.312945</span> <span class="o">-</span><span class="mf">1.115689</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">230</span><span class="p">]:</span> <span class="n">annual_frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;A-DEC&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">231</span><span class="p">]:</span> <span class="n">annual_frame</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">231</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl">      <span class="n">Colorado</span>     <span class="n">Texas</span>  <span class="n">New</span> <span class="n">York</span>      <span class="n">Ohio</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span>  <span class="mf">0.556703</span>  <span class="mf">0.016631</span>  <span class="mf">0.111873</span> <span class="o">-</span><span class="mf">0.027445</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span>  <span class="mf">0.046303</span>  <span class="mf">0.163344</span>  <span class="mf">0.251503</span> <span class="o">-</span><span class="mf">0.157276</span>
</span></span></code></pre></div><p>升采样要稍微麻烦一些，因为你必须决定在新频率中各区间的哪端用于放置原来的值，就像<code>asfreq</code>方法那样。<code>convention</code>参数默认为<code>'start'</code>，也可设置为<code>'end'</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Q-DEC: Quarterly, year ending in December</span>
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">232</span><span class="p">]:</span> <span class="n">annual_frame</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;Q-DEC&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">232</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl">        <span class="n">Colorado</span>     <span class="n">Texas</span>  <span class="n">New</span> <span class="n">York</span>      <span class="n">Ohio</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="n">Q1</span>  <span class="mf">0.556703</span>  <span class="mf">0.016631</span>  <span class="mf">0.111873</span> <span class="o">-</span><span class="mf">0.027445</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="n">Q2</span>  <span class="mf">0.556703</span>  <span class="mf">0.016631</span>  <span class="mf">0.111873</span> <span class="o">-</span><span class="mf">0.027445</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="n">Q3</span>  <span class="mf">0.556703</span>  <span class="mf">0.016631</span>  <span class="mf">0.111873</span> <span class="o">-</span><span class="mf">0.027445</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="n">Q4</span>  <span class="mf">0.556703</span>  <span class="mf">0.016631</span>  <span class="mf">0.111873</span> <span class="o">-</span><span class="mf">0.027445</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="n">Q1</span>  <span class="mf">0.046303</span>  <span class="mf">0.163344</span>  <span class="mf">0.251503</span> <span class="o">-</span><span class="mf">0.157276</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="n">Q2</span>  <span class="mf">0.046303</span>  <span class="mf">0.163344</span>  <span class="mf">0.251503</span> <span class="o">-</span><span class="mf">0.157276</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="n">Q3</span>  <span class="mf">0.046303</span>  <span class="mf">0.163344</span>  <span class="mf">0.251503</span> <span class="o">-</span><span class="mf">0.157276</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="n">Q4</span>  <span class="mf">0.046303</span>  <span class="mf">0.163344</span>  <span class="mf">0.251503</span> <span class="o">-</span><span class="mf">0.157276</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">233</span><span class="p">]:</span> <span class="n">annual_frame</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;Q-DEC&#39;</span><span class="p">,</span> <span class="n">convention</span><span class="o">=</span><span class="s1">&#39;end&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">233</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl">        <span class="n">Colorado</span>     <span class="n">Texas</span>  <span class="n">New</span> <span class="n">York</span>      <span class="n">Ohio</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="n">Q4</span>  <span class="mf">0.556703</span>  <span class="mf">0.016631</span>  <span class="mf">0.111873</span> <span class="o">-</span><span class="mf">0.027445</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="n">Q1</span>  <span class="mf">0.556703</span>  <span class="mf">0.016631</span>  <span class="mf">0.111873</span> <span class="o">-</span><span class="mf">0.027445</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="n">Q2</span>  <span class="mf">0.556703</span>  <span class="mf">0.016631</span>  <span class="mf">0.111873</span> <span class="o">-</span><span class="mf">0.027445</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="n">Q3</span>  <span class="mf">0.556703</span>  <span class="mf">0.016631</span>  <span class="mf">0.111873</span> <span class="o">-</span><span class="mf">0.027445</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="n">Q4</span>  <span class="mf">0.046303</span>  <span class="mf">0.163344</span>  <span class="mf">0.251503</span> <span class="o">-</span><span class="mf">0.157276</span>
</span></span></code></pre></div><p>由于时期指的是时间区间，所以升采样和降采样的规则就比较严格：</p>
<ul>
<li>在降采样中，目标频率必须是源频率的子时期（subperiod）。</li>
<li>在升采样中，目标频率必须是源频率的超时期（superperiod）。</li>
</ul>
<p>如果不满足这些条件，就会引发异常。这主要影响的是按季、年、周计算的频率。例如，由<code>Q-MAR</code>定义的时间区间只能升采样为<code>A-MAR</code>、<code>A-JUN</code>、<code>A-SEP</code>、<code>A-DEC</code>等：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">234</span><span class="p">]:</span> <span class="n">annual_frame</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;Q-MAR&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">234</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl">        <span class="n">Colorado</span>     <span class="n">Texas</span>  <span class="n">New</span> <span class="n">York</span>      <span class="n">Ohio</span>
</span></span><span class="line"><span class="cl"><span class="mi">2000</span><span class="n">Q4</span>  <span class="mf">0.556703</span>  <span class="mf">0.016631</span>  <span class="mf">0.111873</span> <span class="o">-</span><span class="mf">0.027445</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="n">Q1</span>  <span class="mf">0.556703</span>  <span class="mf">0.016631</span>  <span class="mf">0.111873</span> <span class="o">-</span><span class="mf">0.027445</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="n">Q2</span>  <span class="mf">0.556703</span>  <span class="mf">0.016631</span>  <span class="mf">0.111873</span> <span class="o">-</span><span class="mf">0.027445</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="n">Q3</span>  <span class="mf">0.556703</span>  <span class="mf">0.016631</span>  <span class="mf">0.111873</span> <span class="o">-</span><span class="mf">0.027445</span>
</span></span><span class="line"><span class="cl"><span class="mi">2001</span><span class="n">Q4</span>  <span class="mf">0.046303</span>  <span class="mf">0.163344</span>  <span class="mf">0.251503</span> <span class="o">-</span><span class="mf">0.157276</span>
</span></span><span class="line"><span class="cl"><span class="mi">2002</span><span class="n">Q1</span>  <span class="mf">0.046303</span>  <span class="mf">0.163344</span>  <span class="mf">0.251503</span> <span class="o">-</span><span class="mf">0.157276</span>
</span></span><span class="line"><span class="cl"><span class="mi">2002</span><span class="n">Q2</span>  <span class="mf">0.046303</span>  <span class="mf">0.163344</span>  <span class="mf">0.251503</span> <span class="o">-</span><span class="mf">0.157276</span>
</span></span><span class="line"><span class="cl"><span class="mi">2002</span><span class="n">Q3</span>  <span class="mf">0.046303</span>  <span class="mf">0.163344</span>  <span class="mf">0.251503</span> <span class="o">-</span><span class="mf">0.157276</span>
</span></span></code></pre></div><h1 id="117-移动窗口函数">11.7 移动窗口函数</h1>
<p>在移动窗口（可以带有指数衰减权数）上计算的各种统计函数也是一类常见于时间序列的数组变换。这样可以圆滑噪音数据或断裂数据。我将它们称为移动窗口函数（moving window function），其中还包括那些窗口不定长的函数（如指数加权移动平均）。跟其他统计函数一样，移动窗口函数也会自动排除缺失值。</p>
<p>开始之前，我们加载一些时间序列数据，将其重采样为工作日频率：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">235</span><span class="p">]:</span> <span class="n">close_px_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;examples/stock_px_2.csv&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="o">.....</span><span class="p">:</span>                            <span class="n">parse_dates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">236</span><span class="p">]:</span> <span class="n">close_px</span> <span class="o">=</span> <span class="n">close_px_all</span><span class="p">[[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;MSFT&#39;</span><span class="p">,</span> <span class="s1">&#39;XOM&#39;</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">237</span><span class="p">]:</span> <span class="n">close_px</span> <span class="o">=</span> <span class="n">close_px</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span>
</span></span></code></pre></div><p>现在引入<code>rolling</code>运算符，它与<code>resample</code>和<code>groupby</code>很像。可以在<code>TimeSeries</code>或<code>DataFrame</code>以及一个窗口（表示期数，见图 11-4）上调用它：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">238</span><span class="p">]:</span> <span class="n">close_px</span><span class="o">.</span><span class="n">AAPL</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">238</span><span class="p">]:</span> <span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">_subplots</span><span class="o">.</span><span class="n">AxesSubplot</span> <span class="n">at</span> <span class="mh">0x7f2f2570cf98</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">239</span><span class="p">]:</span> <span class="n">close_px</span><span class="o">.</span><span class="n">AAPL</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">250</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</span></span></code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-3327483eab730b09.png"
        data-srcset="img/7178691-3327483eab730b09.png, img/7178691-3327483eab730b09.png 1.5x, img/7178691-3327483eab730b09.png 2x"
        data-sizes="auto"
        alt="img/7178691-3327483eab730b09.png"
        title="图 11-4 苹果公司股价的 250 日均线" /></p>
<p>表达式<code>rolling(250)</code>与<code>groupby</code>很像，但不是对其进行分组，而是创建一个按照 250 天分组的滑动窗口对象。然后，我们就得到了苹果公司股价的 250 天的移动窗口。</p>
<p>默认情况下，<code>rolling</code>函数需要窗口中所有的值为非 NA 值。可以修改该行为以解决缺失数据的问题。其实，在时间序列开始处尚不足窗口期的那些数据就是个特例（见图 11-5）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">241</span><span class="p">]:</span> <span class="n">appl_std250</span> <span class="o">=</span> <span class="n">close_px</span><span class="o">.</span><span class="n">AAPL</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">250</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">242</span><span class="p">]:</span> <span class="n">appl_std250</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">12</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">242</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2003</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">09</span>         <span class="n">NaN</span>
</span></span><span class="line"><span class="cl"><span class="mi">2003</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">10</span>         <span class="n">NaN</span>
</span></span><span class="line"><span class="cl"><span class="mi">2003</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">13</span>         <span class="n">NaN</span>
</span></span><span class="line"><span class="cl"><span class="mi">2003</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">14</span>         <span class="n">NaN</span>
</span></span><span class="line"><span class="cl"><span class="mi">2003</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">15</span>    <span class="mf">0.077496</span>
</span></span><span class="line"><span class="cl"><span class="mi">2003</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">16</span>    <span class="mf">0.074760</span>
</span></span><span class="line"><span class="cl"><span class="mi">2003</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">17</span>    <span class="mf">0.112368</span>
</span></span><span class="line"><span class="cl"><span class="n">Freq</span><span class="p">:</span> <span class="n">B</span><span class="p">,</span> <span class="n">Name</span><span class="p">:</span> <span class="n">AAPL</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">243</span><span class="p">]:</span> <span class="n">appl_std250</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</span></span></code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-15f565bed1ccad09.png"
        data-srcset="img/7178691-15f565bed1ccad09.png, img/7178691-15f565bed1ccad09.png 1.5x, img/7178691-15f565bed1ccad09.png 2x"
        data-sizes="auto"
        alt="img/7178691-15f565bed1ccad09.png"
        title="图 11-5 苹果公司 250 日每日回报标准差" /></p>
<p>要计算扩展窗口平均（expanding window mean），可以使用<code>expanding</code>而不是<code>rolling</code>。“扩展”意味着，从时间序列的起始处开始窗口，增加窗口直到它超过所有的序列。<code>apple_std250</code>时间序列的扩展窗口平均如下所示：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">244</span><span class="p">]:</span> <span class="n">expanding_mean</span> <span class="o">=</span> <span class="n">appl_std250</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span></code></pre></div><p>对<code>DataFrame</code>调用<code>rolling_mean</code>（以及与之类似的函数）会将转换应用到所有的列上（见图 11-6）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">246</span><span class="p">]:</span> <span class="n">close_px</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">logy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-979f748052b2279f.png"
        data-srcset="img/7178691-979f748052b2279f.png, img/7178691-979f748052b2279f.png 1.5x, img/7178691-979f748052b2279f.png 2x"
        data-sizes="auto"
        alt="img/7178691-979f748052b2279f.png"
        title="图 11-6 各股价 60 日均线（对数 Y 轴）" /></p>
<p><code>rolling</code>函数也可以接受一个指定固定大小时间补偿字符串，而不是一组时期。这样可以方便处理不规律的时间序列。这些字符串也可以传递给<code>resample</code>。例如，我们可以计算 20 天的滚动均值，如下所示：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">247</span><span class="p">]:</span> <span class="n">close_px</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="s1">&#39;20D&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">247</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                  <span class="n">AAPL</span>       <span class="n">MSFT</span>        <span class="n">XOM</span>
</span></span><span class="line"><span class="cl"><span class="mi">2003</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span>    <span class="mf">7.400000</span>  <span class="mf">21.110000</span>  <span class="mf">29.220000</span>
</span></span><span class="line"><span class="cl"><span class="mi">2003</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span>    <span class="mf">7.425000</span>  <span class="mf">21.125000</span>  <span class="mf">29.230000</span>
</span></span><span class="line"><span class="cl"><span class="mi">2003</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">06</span>    <span class="mf">7.433333</span>  <span class="mf">21.256667</span>  <span class="mf">29.473333</span>
</span></span><span class="line"><span class="cl"><span class="mi">2003</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">07</span>    <span class="mf">7.432500</span>  <span class="mf">21.425000</span>  <span class="mf">29.342500</span>
</span></span><span class="line"><span class="cl"><span class="mi">2003</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">08</span>    <span class="mf">7.402000</span>  <span class="mf">21.402000</span>  <span class="mf">29.240000</span>
</span></span><span class="line"><span class="cl"><span class="mi">2003</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">09</span>    <span class="mf">7.391667</span>  <span class="mf">21.490000</span>  <span class="mf">29.273333</span>
</span></span><span class="line"><span class="cl"><span class="mi">2003</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">10</span>    <span class="mf">7.387143</span>  <span class="mf">21.558571</span>  <span class="mf">29.238571</span>
</span></span><span class="line"><span class="cl"><span class="mi">2003</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">13</span>    <span class="mf">7.378750</span>  <span class="mf">21.633750</span>  <span class="mf">29.197500</span>
</span></span><span class="line"><span class="cl"><span class="mi">2003</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">14</span>    <span class="mf">7.370000</span>  <span class="mf">21.717778</span>  <span class="mf">29.194444</span>
</span></span><span class="line"><span class="cl"><span class="mi">2003</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">15</span>    <span class="mf">7.355000</span>  <span class="mf">21.757000</span>  <span class="mf">29.152000</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>                <span class="o">...</span>        <span class="o">...</span>        <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">03</span>  <span class="mf">398.002143</span>  <span class="mf">25.890714</span>  <span class="mf">72.413571</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">04</span>  <span class="mf">396.802143</span>  <span class="mf">25.807857</span>  <span class="mf">72.427143</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">05</span>  <span class="mf">395.751429</span>  <span class="mf">25.729286</span>  <span class="mf">72.422857</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">06</span>  <span class="mf">394.099286</span>  <span class="mf">25.673571</span>  <span class="mf">72.375714</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">07</span>  <span class="mf">392.479333</span>  <span class="mf">25.712000</span>  <span class="mf">72.454667</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">10</span>  <span class="mf">389.351429</span>  <span class="mf">25.602143</span>  <span class="mf">72.527857</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">11</span>  <span class="mf">388.505000</span>  <span class="mf">25.674286</span>  <span class="mf">72.835000</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">12</span>  <span class="mf">388.531429</span>  <span class="mf">25.810000</span>  <span class="mf">73.400714</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">13</span>  <span class="mf">388.826429</span>  <span class="mf">25.961429</span>  <span class="mf">73.905000</span>
</span></span><span class="line"><span class="cl"><span class="mi">2011</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">14</span>  <span class="mf">391.038000</span>  <span class="mf">26.048667</span>  <span class="mf">74.185333</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">2292</span> <span class="n">rows</span> <span class="n">x</span> <span class="mi">3</span> <span class="n">columns</span><span class="p">]</span>
</span></span></code></pre></div><h2 id="指数加权函数">指数加权函数</h2>
<p>另一种使用固定大小窗口及相等权数观测值的办法是，定义一个衰减因子（decay factor）常量，以便使近期的观测值拥有更大的权数。衰减因子的定义方式有很多，比较流行的是使用时间间隔（span），它可以使结果兼容于窗口大小等于时间间隔的简单移动窗口（simple moving window）函数。</p>
<p>由于指数加权统计会赋予近期的观测值更大的权数，因此相对于等权统计，它能“适应”更快的变化。</p>
<p>除了<code>rolling</code>和<code>expanding</code>，pandas 还有<code>ewm</code>运算符。下面这个例子对比了苹果公司股价的 30 日移动平均和<code>span=30</code>的指数加权移动平均（如图 11-7 所示）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">249</span><span class="p">]:</span> <span class="n">aapl_px</span> <span class="o">=</span> <span class="n">close_px</span><span class="o">.</span><span class="n">AAPL</span><span class="p">[</span><span class="s1">&#39;2006&#39;</span><span class="p">:</span><span class="s1">&#39;2007&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">250</span><span class="p">]:</span> <span class="n">ma60</span> <span class="o">=</span> <span class="n">aapl_px</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">251</span><span class="p">]:</span> <span class="n">ewma60</span> <span class="o">=</span> <span class="n">aapl_px</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">252</span><span class="p">]:</span> <span class="n">ma60</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Simple MA&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">252</span><span class="p">]:</span> <span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">_subplots</span><span class="o">.</span><span class="n">AxesSubplot</span> <span class="n">at</span> <span class="mh">0x7f2f252161d0</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">253</span><span class="p">]:</span> <span class="n">ewma60</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;EW MA&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">253</span><span class="p">]:</span> <span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">_subplots</span><span class="o">.</span><span class="n">AxesSubplot</span> <span class="n">at</span> <span class="mh">0x7f2f252161d0</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">254</span><span class="p">]:</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span></span></code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-dae48defe3749fad.png"
        data-srcset="img/7178691-dae48defe3749fad.png, img/7178691-dae48defe3749fad.png 1.5x, img/7178691-dae48defe3749fad.png 2x"
        data-sizes="auto"
        alt="img/7178691-dae48defe3749fad.png"
        title="图 11-7 简单移动平均与指数加权移动平均" /></p>
<h2 id="二元移动窗口函数">二元移动窗口函数</h2>
<p>有些统计运算（如相关系数和协方差）需要在两个时间序列上执行。例如，金融分析师常常对某只股票对某个参考指数（如标准普尔 500 指数）的相关系数感兴趣。要进行说明，我们先计算我们感兴趣的时间序列的百分数变化：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">256</span><span class="p">]:</span> <span class="n">spx_px</span> <span class="o">=</span> <span class="n">close_px_all</span><span class="p">[</span><span class="s1">&#39;SPX&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">257</span><span class="p">]:</span> <span class="n">spx_rets</span> <span class="o">=</span> <span class="n">spx_px</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">258</span><span class="p">]:</span> <span class="n">returns</span> <span class="o">=</span> <span class="n">close_px</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
</span></span></code></pre></div><p>调用<code>rolling</code>之后，<code>corr</code>聚合函数开始计算与<code>spx_rets</code>滚动相关系数（结果见图 11-8）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">259</span><span class="p">]:</span> <span class="n">corr</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">AAPL</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">125</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">spx_rets</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">260</span><span class="p">]:</span> <span class="n">corr</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</span></span></code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-e81e0f602b4db0ed.png"
        data-srcset="img/7178691-e81e0f602b4db0ed.png, img/7178691-e81e0f602b4db0ed.png 1.5x, img/7178691-e81e0f602b4db0ed.png 2x"
        data-sizes="auto"
        alt="img/7178691-e81e0f602b4db0ed.png"
        title="图 11-8 &lt;code&gt;AAPL&lt;/code&gt; 6 个月的回报与标准普尔 500 指数的相关系数" /></p>
<p>假设你想要一次性计算多只股票与标准普尔 500 指数的相关系数。虽然编写一个循环并新建一个<code>DataFrame</code>不是什么难事，但比较啰嗦。其实，只需传入一个<code>TimeSeries</code>和一个<code>DataFrame</code>，<code>rolling_corr</code>就会自动计算<code>TimeSeries</code>（本例中就是<code>spx_rets</code>）与<code>DataFrame</code>各列的相关系数。结果如图 11-9 所示：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">262</span><span class="p">]:</span> <span class="n">corr</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">125</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">spx_rets</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">263</span><span class="p">]:</span> <span class="n">corr</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</span></span></code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-0a54a028a62b9b50.png"
        data-srcset="img/7178691-0a54a028a62b9b50.png, img/7178691-0a54a028a62b9b50.png 1.5x, img/7178691-0a54a028a62b9b50.png 2x"
        data-sizes="auto"
        alt="img/7178691-0a54a028a62b9b50.png"
        title="图 11-9 3 只股票 6 个月的回报与标准普尔 500 指数的相关系数" /></p>
<h2 id="用户定义的移动窗口函数">用户定义的移动窗口函数</h2>
<p><code>rolling_apply</code>函数使你能够在移动窗口上应用自己设计的数组函数。唯一要求的就是：该函数要能从数组的各个片段中产生单个值（即约简）。比如说，当我们用<code>rolling(...).quantile(q)</code>计算样本分位数时，可能对样本中特定值的百分等级感兴趣。<code>scipy.stats.percentileofscore</code>函数就能达到这个目的（结果见图 11-10）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">265</span><span class="p">]:</span> <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">percentileofscore</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">266</span><span class="p">]:</span> <span class="n">score_at_2percent</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">percentileofscore</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">267</span><span class="p">]:</span> <span class="n">result</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">AAPL</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">250</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">score_at_2percent</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">268</span><span class="p">]:</span> <span class="n">result</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</span></span></code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-af49e84a90c23c1e.png"
        data-srcset="img/7178691-af49e84a90c23c1e.png, img/7178691-af49e84a90c23c1e.png 1.5x, img/7178691-af49e84a90c23c1e.png 2x"
        data-sizes="auto"
        alt="img/7178691-af49e84a90c23c1e.png"
        title="图 11-10 &lt;code&gt;AAPL&lt;/code&gt; 2% 回报率的百分等级（一年窗口期）" /></p>
<p>如果你没安装 SciPy，可以使用<code>conda</code>或<code>pip</code>安装。</p>
<h1 id="118-总结">11.8 总结</h1>
<p>与前面章节接触的数据相比，时间序列数据要求不同类型的分析和数据转换工具。</p>
<p>在接下来的章节中，我们将学习一些高级的 pandas 方法和如何开始使用建模库 statsmodels 和 scikit-learn。</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 0001-01-01</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="http://localhost:1313/posts/pyda-2e-zh/11/" data-title=""><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://localhost:1313/posts/pyda-2e-zh/11/"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="http://localhost:1313/posts/pyda-2e-zh/11/" data-title=""><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="http://localhost:1313/posts/pyda-2e-zh/11/" data-title=""><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="http://localhost:1313/posts/pyda-2e-zh/11/" data-title=""><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/pyda-2e-zh/12/" class="prev" rel="prev" title=""><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i></a>
            <a href="/posts/pyda-2e-zh/10/" class="next" rel="next" title=""><i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.118.2">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2022 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Aphros</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>

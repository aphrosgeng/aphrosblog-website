<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title> - Aphros的个人博客</title><meta name="Description" content="This is my cool site"><meta property="og:title" content="" />
<meta property="og:description" content="第 14 章 数据分析案例 本书正文的最后一章，我们来看一些真实世界的数据集。对于每个数据集，我们会用之前介绍的方法，从原始数据中提取有意义的内容。展" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/pyda-2e-zh/14/" /><meta property="article:section" content="posts" />

<meta property="og:site_name" content="Aphros的博客" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content=""/>
<meta name="twitter:description" content="第 14 章 数据分析案例 本书正文的最后一章，我们来看一些真实世界的数据集。对于每个数据集，我们会用之前介绍的方法，从原始数据中提取有意义的内容。展"/>
<meta name="application-name" content="Aphros的博客">
<meta name="apple-mobile-web-app-title" content="Aphros的博客"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://localhost:1313/posts/pyda-2e-zh/14/" /><link rel="prev" href="http://localhost:1313/posts/pyda-2e-zh/2/" /><link rel="next" href="http://localhost:1313/posts/pyda-2e-zh/13/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/localhost:1313\/posts\/pyda-2e-zh\/14\/"
        },"genre": "posts","wordcount":  12353 ,
        "url": "http:\/\/localhost:1313\/posts\/pyda-2e-zh\/14\/","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "Aphros"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Aphros的个人博客">Aphros的博客</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Aphros的个人博客">Aphros的博客</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX"></h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Aphros</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="0001-01-01">0001-01-01</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;12353 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;25 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#用纯-python-代码对时区进行计数">用纯 Python 代码对时区进行计数</a></li>
    <li><a href="#用-pandas-对时区进行计数">用 pandas 对时区进行计数</a></li>
  </ul>

  <ul>
    <li><a href="#计算评分分歧">计算评分分歧</a></li>
  </ul>

  <ul>
    <li><a href="#分析命名趋势">分析命名趋势</a></li>
    <li><a href="#评估命名多样性的增长">评估命名多样性的增长</a></li>
    <li><a href="#最后一个字母的变革">“最后一个字母”的变革</a></li>
    <li><a href="#变成女孩名字的男孩名字以及相反的情况">变成女孩名字的男孩名字（以及相反的情况）</a></li>
  </ul>

  <ul>
    <li><a href="#根据职业和雇主统计赞助信息">根据职业和雇主统计赞助信息</a></li>
    <li><a href="#对出资额分组">对出资额分组</a></li>
    <li><a href="#根据州统计赞助信息">根据州统计赞助信息</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="第-14-章-数据分析案例">第 14 章 数据分析案例</h1>
<p>本书正文的最后一章，我们来看一些真实世界的数据集。对于每个数据集，我们会用之前介绍的方法，从原始数据中提取有意义的内容。展示的方法适用于其它数据集，也包括你的。本章包含了一些各种各样的案例数据集，可以用来练习。</p>
<p>案例数据集可以在 Github 仓库找到，见第一章。</p>
<h1 id="141-来自-bitly-的-usagov-数据">14.1 来自 Bitly 的 USA.gov 数据</h1>
<p>2011 年，URL 缩短服务 Bitly 跟美国政府网站 USA.gov 合作，提供了一份从生成<code>.gov</code>或<code>.mil</code>短链接的用户那里收集来的匿名数据。在 2011 年，除实时数据之外，还可以下载文本文件形式的每小时快照。写作此书时（2017 年），这项服务已经关闭，但我们保存一份数据用于本书的案例。</p>
<p>以每小时快照为例，文件中各行的格式为 JSON（即 JavaScript Object Notation，这是一种常用的 Web 数据格式）。例如，如果我们只读取某个文件中的第一行，那么所看到的结果应该是下面这样：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;datasets/bitly_usagov/example.txt&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="s1">&#39;{ &#34;a&#34;: &#34;Mozilla</span><span class="se">\\</span><span class="s1">/5.0 (Windows NT 6.1; WOW64) AppleWebKit</span><span class="se">\\</span><span class="s1">/535.11</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">KHTML</span><span class="p">,</span> <span class="n">like</span> <span class="n">Gecko</span><span class="p">)</span> <span class="n">Chrome</span>\\<span class="o">/</span><span class="mf">17.0.963.78</span> <span class="n">Safari</span>\\<span class="o">/</span><span class="mf">535.11</span><span class="s2">&#34;, &#34;</span><span class="n">c</span><span class="s2">&#34;: &#34;</span><span class="n">US</span><span class="s2">&#34;, &#34;</span><span class="n">nk</span><span class="s2">&#34;: 1,</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;tz&#34;</span><span class="p">:</span> <span class="s2">&#34;America</span><span class="se">\\</span><span class="s2">/New_York&#34;</span><span class="p">,</span> <span class="s2">&#34;gr&#34;</span><span class="p">:</span> <span class="s2">&#34;MA&#34;</span><span class="p">,</span> <span class="s2">&#34;g&#34;</span><span class="p">:</span> <span class="s2">&#34;A6qOVH&#34;</span><span class="p">,</span> <span class="s2">&#34;h&#34;</span><span class="p">:</span> <span class="s2">&#34;wfLQtf&#34;</span><span class="p">,</span> <span class="s2">&#34;l&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;orofrog&#34;</span><span class="p">,</span> <span class="s2">&#34;al&#34;</span><span class="p">:</span> <span class="s2">&#34;en-US,en;q=0.8&#34;</span><span class="p">,</span> <span class="s2">&#34;hh&#34;</span><span class="p">:</span> <span class="s2">&#34;1.usa.gov&#34;</span><span class="p">,</span> <span class="s2">&#34;r&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;http:</span><span class="se">\\</span><span class="s2">/</span><span class="se">\\</span><span class="s2">/www.facebook.com</span><span class="se">\\</span><span class="s2">/l</span><span class="se">\\</span><span class="s2">/7AQEFzjSi</span><span class="se">\\</span><span class="s2">/1.usa.gov</span><span class="se">\\</span><span class="s2">/wfLQtf&#34;</span><span class="p">,</span> <span class="s2">&#34;u&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;http:</span><span class="se">\\</span><span class="s2">/</span><span class="se">\\</span><span class="s2">/www.ncbi.nlm.nih.gov</span><span class="se">\\</span><span class="s2">/pubmed</span><span class="se">\\</span><span class="s2">/22415991&#34;</span><span class="p">,</span> <span class="s2">&#34;t&#34;</span><span class="p">:</span> <span class="mi">1331923247</span><span class="p">,</span> <span class="s2">&#34;hc&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="mi">1331822918</span><span class="p">,</span> <span class="s2">&#34;cy&#34;</span><span class="p">:</span> <span class="s2">&#34;Danvers&#34;</span><span class="p">,</span> <span class="s2">&#34;ll&#34;</span><span class="p">:</span> <span class="p">[</span> <span class="mf">42.576698</span><span class="p">,</span> <span class="o">-</span><span class="mf">70.954903</span> <span class="p">]</span> <span class="p">}</span>\<span class="n">n</span><span class="s1">&#39;</span>
</span></span></code></pre></div><p>Python 有内置或第三方模块可以将 JSON 字符串转换成 Python 字典对象。这里，我将使用<code>json</code>模块及其<code>loads</code>函数逐行加载已经下载好的数据文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;datasets/bitly_usagov/example.txt&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">records</span> <span class="o">=</span> <span class="p">[</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)]</span>
</span></span></code></pre></div><p>现在，<code>records</code>对象就成为一组 Python 字典了：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">18</span><span class="p">]:</span> <span class="n">records</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">18</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="s1">&#39;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/535.11 (KHTML, like Gecko)</span>
</span></span><span class="line"><span class="cl"><span class="n">Chrome</span><span class="o">/</span><span class="mf">17.0.963.78</span> <span class="n">Safari</span><span class="o">/</span><span class="mf">535.11</span><span class="s1">&#39;,</span>
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;al&#39;</span><span class="p">:</span> <span class="s1">&#39;en-US,en;q=0.8&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="s1">&#39;US&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;cy&#39;</span><span class="p">:</span> <span class="s1">&#39;Danvers&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;g&#39;</span><span class="p">:</span> <span class="s1">&#39;A6qOVH&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;gr&#39;</span><span class="p">:</span> <span class="s1">&#39;MA&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;h&#39;</span><span class="p">:</span> <span class="s1">&#39;wfLQtf&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;hc&#39;</span><span class="p">:</span> <span class="mi">1331822918</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;hh&#39;</span><span class="p">:</span> <span class="s1">&#39;1.usa.gov&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;l&#39;</span><span class="p">:</span> <span class="s1">&#39;orofrog&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;ll&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">42.576698</span><span class="p">,</span> <span class="o">-</span><span class="mf">70.954903</span><span class="p">],</span>
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;nk&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="s1">&#39;http://www.facebook.com/l/7AQEFzjSi/1.usa.gov/wfLQtf&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="mi">1331923247</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;tz&#39;</span><span class="p">:</span> <span class="s1">&#39;America/New_York&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;u&#39;</span><span class="p">:</span> <span class="s1">&#39;http://www.ncbi.nlm.nih.gov/pubmed/22415991&#39;</span><span class="p">}</span>
</span></span></code></pre></div><h2 id="用纯-python-代码对时区进行计数">用纯 Python 代码对时区进行计数</h2>
<p>假设我们想要知道该数据集中最常出现的是哪个时区（即<code>tz</code>字段），得到答案的办法有很多。首先，我们用列表推导式取出一组时区：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">12</span><span class="p">]:</span> <span class="n">time_zones</span> <span class="o">=</span> <span class="p">[</span><span class="n">rec</span><span class="p">[</span><span class="s1">&#39;tz&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">records</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="o">---------------------------------------------------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="ne">KeyError</span>                                  <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="n">db4fbd348da9</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="o">----&gt;</span> <span class="mi">1</span> <span class="n">time_zones</span> <span class="o">=</span> <span class="p">[</span><span class="n">rec</span><span class="p">[</span><span class="s1">&#39;tz&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">records</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="n">db4fbd348da9</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">listcomp</span><span class="o">&gt;</span><span class="p">(</span><span class="mf">.0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">----&gt;</span> <span class="mi">1</span> <span class="n">time_zones</span> <span class="o">=</span> <span class="p">[</span><span class="n">rec</span><span class="p">[</span><span class="s1">&#39;tz&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">records</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="ne">KeyError</span><span class="p">:</span> <span class="s1">&#39;tz&#39;</span>
</span></span></code></pre></div><p>晕！原来并不是所有记录都有时区字段。这个好办，只需在列表推导式末尾加上一个<code>if 'tz'in rec</code>判断即可：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">13</span><span class="p">]:</span> <span class="n">time_zones</span> <span class="o">=</span> <span class="p">[</span><span class="n">rec</span><span class="p">[</span><span class="s1">&#39;tz&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">records</span> <span class="k">if</span> <span class="s1">&#39;tz&#39;</span> <span class="ow">in</span> <span class="n">rec</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">14</span><span class="p">]:</span> <span class="n">time_zones</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">14</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="s1">&#39;America/New_York&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;America/Denver&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;America/New_York&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;America/Sao_Paulo&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;America/New_York&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;America/New_York&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;Europe/Warsaw&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;&#39;</span><span class="p">]</span>
</span></span></code></pre></div><p>只看前 10 个时区，我们发现有些是未知的（即空的）。虽然可以将它们过滤掉，但现在暂时先留着。接下来，为了对时区进行计数，这里介绍两个办法：一个较难（只使用标准 Python 库），另一个较简单（使用 pandas）。计数的办法之一是在遍历时区的过程中将计数值保存在字典中：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_counts</span><span class="p">(</span><span class="n">sequence</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">counts</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sequence</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">counts</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">counts</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">counts</span>
</span></span></code></pre></div><p>如果使用 Python 标准库的更高级工具，那么你可能会将代码写得更简洁一些：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_counts2</span><span class="p">(</span><span class="n">sequence</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">counts</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># values will initialize to 0</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sequence</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">counts</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">counts</span>
</span></span></code></pre></div><p>我将逻辑写到函数中是为了获得更高的复用性。要用它对时区进行处理，只需将<code>time_zones</code>传入即可：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">17</span><span class="p">]:</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">get_counts</span><span class="p">(</span><span class="n">time_zones</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">18</span><span class="p">]:</span> <span class="n">counts</span><span class="p">[</span><span class="s1">&#39;America/New_York&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">18</span><span class="p">]:</span> <span class="mi">1251</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">19</span><span class="p">]:</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_zones</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">19</span><span class="p">]:</span> <span class="mi">3440</span>
</span></span></code></pre></div><p>如果想要得到前 10 位的时区及其计数值，我们需要用到一些有关字典的处理技巧：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">top_counts</span><span class="p">(</span><span class="n">count_dict</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">value_key_pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">count</span><span class="p">,</span> <span class="n">tz</span><span class="p">)</span> <span class="k">for</span> <span class="n">tz</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">count_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
</span></span><span class="line"><span class="cl">    <span class="n">value_key_pairs</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">value_key_pairs</span><span class="p">[</span><span class="o">-</span><span class="n">n</span><span class="p">:]</span>
</span></span></code></pre></div><p>然后有：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">21</span><span class="p">]:</span> <span class="n">top_counts</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">21</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="p">[(</span><span class="mi">33</span><span class="p">,</span> <span class="s1">&#39;America/Sao_Paulo&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"> <span class="p">(</span><span class="mi">35</span><span class="p">,</span> <span class="s1">&#39;Europe/Madrid&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="s1">&#39;Pacific/Honolulu&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"> <span class="p">(</span><span class="mi">37</span><span class="p">,</span> <span class="s1">&#39;Asia/Tokyo&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"> <span class="p">(</span><span class="mi">74</span><span class="p">,</span> <span class="s1">&#39;Europe/London&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"> <span class="p">(</span><span class="mi">191</span><span class="p">,</span> <span class="s1">&#39;America/Denver&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"> <span class="p">(</span><span class="mi">382</span><span class="p">,</span> <span class="s1">&#39;America/Los_Angeles&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"> <span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="s1">&#39;America/Chicago&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"> <span class="p">(</span><span class="mi">521</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"> <span class="p">(</span><span class="mi">1251</span><span class="p">,</span> <span class="s1">&#39;America/New_York&#39;</span><span class="p">)]</span>
</span></span></code></pre></div><p>如果你搜索 Python 的标准库，你能找到<code>collections.Counter</code>类，它可以使这项工作更简单：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">22</span><span class="p">]:</span> <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">23</span><span class="p">]:</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">time_zones</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">24</span><span class="p">]:</span> <span class="n">counts</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">24</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="p">[(</span><span class="s1">&#39;America/New_York&#39;</span><span class="p">,</span> <span class="mi">1251</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">521</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"> <span class="p">(</span><span class="s1">&#39;America/Chicago&#39;</span><span class="p">,</span> <span class="mi">400</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"> <span class="p">(</span><span class="s1">&#39;America/Los_Angeles&#39;</span><span class="p">,</span> <span class="mi">382</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"> <span class="p">(</span><span class="s1">&#39;America/Denver&#39;</span><span class="p">,</span> <span class="mi">191</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"> <span class="p">(</span><span class="s1">&#39;Europe/London&#39;</span><span class="p">,</span> <span class="mi">74</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"> <span class="p">(</span><span class="s1">&#39;Asia/Tokyo&#39;</span><span class="p">,</span> <span class="mi">37</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"> <span class="p">(</span><span class="s1">&#39;Pacific/Honolulu&#39;</span><span class="p">,</span> <span class="mi">36</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"> <span class="p">(</span><span class="s1">&#39;Europe/Madrid&#39;</span><span class="p">,</span> <span class="mi">35</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"> <span class="p">(</span><span class="s1">&#39;America/Sao_Paulo&#39;</span><span class="p">,</span> <span class="mi">33</span><span class="p">)]</span>
</span></span></code></pre></div><h2 id="用-pandas-对时区进行计数">用 pandas 对时区进行计数</h2>
<p>从原始记录的集合创建<code>DateFrame</code>，与将记录列表传递到<code>pandas.DataFrame</code>一样简单：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">25</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">26</span><span class="p">]:</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">27</span><span class="p">]:</span> <span class="n">frame</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="s1">&#39;&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n">RangeIndex</span><span class="p">:</span> <span class="mi">3560</span> <span class="n">entries</span><span class="p">,</span> <span class="mi">0</span> <span class="n">to</span> <span class="mi">3559</span>
</span></span><span class="line"><span class="cl"><span class="n">Data</span> <span class="n">columns</span> <span class="p">(</span><span class="n">total</span> <span class="mi">18</span> <span class="n">columns</span><span class="p">):</span>
</span></span><span class="line"><span class="cl"><span class="n">_heartbeat_</span>    <span class="mi">120</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="n">float64</span>
</span></span><span class="line"><span class="cl"><span class="n">a</span>              <span class="mi">3440</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">al</span>             <span class="mi">3094</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">c</span>              <span class="mi">2919</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">cy</span>             <span class="mi">2919</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">g</span>              <span class="mi">3440</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">gr</span>             <span class="mi">2919</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">h</span>              <span class="mi">3440</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">hc</span>             <span class="mi">3440</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="n">float64</span>
</span></span><span class="line"><span class="cl"><span class="n">hh</span>             <span class="mi">3440</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">kw</span>             <span class="mi">93</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">l</span>              <span class="mi">3440</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">ll</span>             <span class="mi">2919</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">nk</span>             <span class="mi">3440</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="n">float64</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span>              <span class="mi">3440</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">t</span>              <span class="mi">3440</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="n">float64</span>
</span></span><span class="line"><span class="cl"><span class="n">tz</span>             <span class="mi">3440</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">u</span>              <span class="mi">3440</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">dtypes</span><span class="p">:</span> <span class="n">float64</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="nb">object</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">memory</span> <span class="n">usage</span><span class="p">:</span> <span class="mf">500.7</span><span class="o">+</span> <span class="n">KB</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">28</span><span class="p">]:</span> <span class="n">frame</span><span class="p">[</span><span class="s1">&#39;tz&#39;</span><span class="p">][:</span><span class="mi">10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">28</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">0</span>     <span class="n">America</span><span class="o">/</span><span class="n">New_York</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span>       <span class="n">America</span><span class="o">/</span><span class="n">Denver</span>
</span></span><span class="line"><span class="cl"><span class="mi">2</span>     <span class="n">America</span><span class="o">/</span><span class="n">New_York</span>
</span></span><span class="line"><span class="cl"><span class="mi">3</span>    <span class="n">America</span><span class="o">/</span><span class="n">Sao_Paulo</span>
</span></span><span class="line"><span class="cl"><span class="mi">4</span>     <span class="n">America</span><span class="o">/</span><span class="n">New_York</span>
</span></span><span class="line"><span class="cl"><span class="mi">5</span>     <span class="n">America</span><span class="o">/</span><span class="n">New_York</span>
</span></span><span class="line"><span class="cl"><span class="mi">6</span>        <span class="n">Europe</span><span class="o">/</span><span class="n">Warsaw</span>
</span></span><span class="line"><span class="cl"><span class="mi">7</span>                     
</span></span><span class="line"><span class="cl"><span class="mi">8</span>                     
</span></span><span class="line"><span class="cl"><span class="mi">9</span>                     
</span></span><span class="line"><span class="cl"><span class="n">Name</span><span class="p">:</span> <span class="n">tz</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">object</span>
</span></span></code></pre></div><p>这里<code>frame</code>的输出形式是摘要视图（summary view），主要用于较大的<code>DataFrame</code>对象。我们然后可以对<code>Series</code>使用<code>value_counts</code>方法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">29</span><span class="p">]:</span> <span class="n">tz_counts</span> <span class="o">=</span> <span class="n">frame</span><span class="p">[</span><span class="s1">&#39;tz&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">30</span><span class="p">]:</span> <span class="n">tz_counts</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">30</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">America</span><span class="o">/</span><span class="n">New_York</span>       <span class="mi">1251</span>
</span></span><span class="line"><span class="cl">                        <span class="mi">521</span>
</span></span><span class="line"><span class="cl"><span class="n">America</span><span class="o">/</span><span class="n">Chicago</span>         <span class="mi">400</span>
</span></span><span class="line"><span class="cl"><span class="n">America</span><span class="o">/</span><span class="n">Los_Angeles</span>     <span class="mi">382</span>
</span></span><span class="line"><span class="cl"><span class="n">America</span><span class="o">/</span><span class="n">Denver</span>          <span class="mi">191</span>
</span></span><span class="line"><span class="cl"><span class="n">Europe</span><span class="o">/</span><span class="n">London</span>            <span class="mi">74</span>
</span></span><span class="line"><span class="cl"><span class="n">Asia</span><span class="o">/</span><span class="n">Tokyo</span>               <span class="mi">37</span>
</span></span><span class="line"><span class="cl"><span class="n">Pacific</span><span class="o">/</span><span class="n">Honolulu</span>         <span class="mi">36</span>
</span></span><span class="line"><span class="cl"><span class="n">Europe</span><span class="o">/</span><span class="n">Madrid</span>            <span class="mi">35</span>
</span></span><span class="line"><span class="cl"><span class="n">America</span><span class="o">/</span><span class="n">Sao_Paulo</span>        <span class="mi">33</span>
</span></span><span class="line"><span class="cl"><span class="n">Name</span><span class="p">:</span> <span class="n">tz</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</span></span></code></pre></div><p>我们可以用 matplotlib 可视化这个数据。为此，我们先给记录中未知或缺失的时区填上一个替代值。<code>fillna</code>函数可以替换缺失值（NA），而未知值（空字符串）则可以通过布尔型数组索引加以替换：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">31</span><span class="p">]:</span> <span class="n">clean_tz</span> <span class="o">=</span> <span class="n">frame</span><span class="p">[</span><span class="s1">&#39;tz&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;Missing&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">32</span><span class="p">]:</span> <span class="n">clean_tz</span><span class="p">[</span><span class="n">clean_tz</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Unknown&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">33</span><span class="p">]:</span> <span class="n">tz_counts</span> <span class="o">=</span> <span class="n">clean_tz</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">34</span><span class="p">]:</span> <span class="n">tz_counts</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">34</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">America</span><span class="o">/</span><span class="n">New_York</span>       <span class="mi">1251</span>
</span></span><span class="line"><span class="cl"><span class="n">Unknown</span>                 <span class="mi">521</span>
</span></span><span class="line"><span class="cl"><span class="n">America</span><span class="o">/</span><span class="n">Chicago</span>         <span class="mi">400</span>
</span></span><span class="line"><span class="cl"><span class="n">America</span><span class="o">/</span><span class="n">Los_Angeles</span>     <span class="mi">382</span>
</span></span><span class="line"><span class="cl"><span class="n">America</span><span class="o">/</span><span class="n">Denver</span>          <span class="mi">191</span>
</span></span><span class="line"><span class="cl"><span class="n">Missing</span>                 <span class="mi">120</span>
</span></span><span class="line"><span class="cl"><span class="n">Europe</span><span class="o">/</span><span class="n">London</span>            <span class="mi">74</span>
</span></span><span class="line"><span class="cl"><span class="n">Asia</span><span class="o">/</span><span class="n">Tokyo</span>               <span class="mi">37</span>
</span></span><span class="line"><span class="cl"><span class="n">Pacific</span><span class="o">/</span><span class="n">Honolulu</span>         <span class="mi">36</span>
</span></span><span class="line"><span class="cl"><span class="n">Europe</span><span class="o">/</span><span class="n">Madrid</span>            <span class="mi">35</span>
</span></span><span class="line"><span class="cl"><span class="n">Name</span><span class="p">:</span> <span class="n">tz</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</span></span></code></pre></div><p>此时，我们可以用 seaborn 包创建水平柱状图（结果见图 14-1）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">36</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">37</span><span class="p">]:</span> <span class="n">subset</span> <span class="o">=</span> <span class="n">tz_counts</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">38</span><span class="p">]:</span> <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">subset</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">subset</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span></span></code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-aa267c1d399a78f0.png"
        data-srcset="img/7178691-aa267c1d399a78f0.png, img/7178691-aa267c1d399a78f0.png 1.5x, img/7178691-aa267c1d399a78f0.png 2x"
        data-sizes="auto"
        alt="img/7178691-aa267c1d399a78f0.png"
        title="图 14-1 usa.gov 示例数据中最常出现的时区" /></p>
<p><code>a</code>字段含有执行 URL 短缩操作的浏览器、设备、应用程序的相关信息：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">39</span><span class="p">]:</span> <span class="n">frame</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">39</span><span class="p">]:</span> <span class="s1">&#39;GoogleMaps/RochesterNY&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">40</span><span class="p">]:</span> <span class="n">frame</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">][</span><span class="mi">50</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">40</span><span class="p">]:</span> <span class="s1">&#39;Mozilla/5.0 (Windows NT 5.1; rv:10.0.2)</span>
</span></span><span class="line"><span class="cl"><span class="n">Gecko</span><span class="o">/</span><span class="mi">20100101</span> <span class="n">Firefox</span><span class="o">/</span><span class="mf">10.0.2</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">41</span><span class="p">]:</span> <span class="n">frame</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">][</span><span class="mi">51</span><span class="p">][:</span><span class="mi">50</span><span class="p">]</span>  <span class="c1"># long line</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">41</span><span class="p">]:</span> <span class="s1">&#39;Mozilla/5.0 (Linux; U; Android 2.2.2; en-us; LG-P9&#39;</span>
</span></span></code></pre></div><p>将这些&quot;agent&quot;字符串中的所有信息都解析出来是一件挺郁闷的工作。一种策略是将这种字符串的第一节（与浏览器大致对应）分离出来并得到另外一份用户行为摘要：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">42</span><span class="p">]:</span> <span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">dropna</span><span class="p">()])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">43</span><span class="p">]:</span> <span class="n">results</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">43</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">0</span>               <span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span>    <span class="n">GoogleMaps</span><span class="o">/</span><span class="n">RochesterNY</span>
</span></span><span class="line"><span class="cl"><span class="mi">2</span>               <span class="n">Mozilla</span><span class="o">/</span><span class="mf">4.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">3</span>               <span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">4</span>               <span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span>
</span></span><span class="line"><span class="cl"><span class="n">dtype</span><span class="p">:</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">44</span><span class="p">]:</span> <span class="n">results</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()[:</span><span class="mi">8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">44</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span>                 <span class="mi">2594</span>
</span></span><span class="line"><span class="cl"><span class="n">Mozilla</span><span class="o">/</span><span class="mf">4.0</span>                  <span class="mi">601</span>
</span></span><span class="line"><span class="cl"><span class="n">GoogleMaps</span><span class="o">/</span><span class="n">RochesterNY</span>       <span class="mi">121</span>
</span></span><span class="line"><span class="cl"><span class="n">Opera</span><span class="o">/</span><span class="mf">9.80</span>                    <span class="mi">34</span>
</span></span><span class="line"><span class="cl"><span class="n">TEST_INTERNET_AGENT</span>           <span class="mi">24</span>
</span></span><span class="line"><span class="cl"><span class="n">GoogleProducer</span>                <span class="mi">21</span>
</span></span><span class="line"><span class="cl"><span class="n">Mozilla</span><span class="o">/</span><span class="mf">6.0</span>                    <span class="mi">5</span>
</span></span><span class="line"><span class="cl"><span class="n">BlackBerry8520</span><span class="o">/</span><span class="mf">5.0.0.681</span>       <span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</span></span></code></pre></div><p>现在，假设你想按 Windows 和非 Windows 用户对时区统计信息进行分解。为了简单起见，我们假定只要<code>agent</code>字符串中含有<code>&quot;Windows&quot;</code>就认为该用户为 Windows 用户。由于有的<code>agent</code>缺失，所以首先将它们从数据中移除：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">45</span><span class="p">]:</span> <span class="n">cframe</span> <span class="o">=</span> <span class="n">frame</span><span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">notnull</span><span class="p">()]</span>
</span></span></code></pre></div><p>然后计算出各行是否含有 Windows 的值：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">47</span><span class="p">]:</span> <span class="n">cframe</span><span class="p">[</span><span class="s1">&#39;os&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cframe</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;Windows&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">   <span class="o">....</span><span class="p">:</span>                         <span class="s1">&#39;Windows&#39;</span><span class="p">,</span> <span class="s1">&#39;Not Windows&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">48</span><span class="p">]:</span> <span class="n">cframe</span><span class="p">[</span><span class="s1">&#39;os&#39;</span><span class="p">][:</span><span class="mi">5</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">48</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">0</span>        <span class="n">Windows</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span>    <span class="n">Not</span> <span class="n">Windows</span>
</span></span><span class="line"><span class="cl"><span class="mi">2</span>        <span class="n">Windows</span>
</span></span><span class="line"><span class="cl"><span class="mi">3</span>    <span class="n">Not</span> <span class="n">Windows</span>
</span></span><span class="line"><span class="cl"><span class="mi">4</span>        <span class="n">Windows</span>
</span></span><span class="line"><span class="cl"><span class="n">Name</span><span class="p">:</span> <span class="n">os</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">object</span>
</span></span></code></pre></div><p>接下来就可以根据时区和新得到的操作系统列表对数据进行分组了：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">49</span><span class="p">]:</span> <span class="n">by_tz_os</span> <span class="o">=</span> <span class="n">cframe</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;tz&#39;</span><span class="p">,</span> <span class="s1">&#39;os&#39;</span><span class="p">])</span>
</span></span></code></pre></div><p>分组计数，类似于<code>value_counts</code>函数，可以用<code>size</code>来计算。并利用<code>unstack</code>对计数结果进行重塑：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">50</span><span class="p">]:</span> <span class="n">agg_counts</span> <span class="o">=</span> <span class="n">by_tz_os</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">51</span><span class="p">]:</span> <span class="n">agg_counts</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">51</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">os</span>                              <span class="n">Not</span> <span class="n">Windows</span>  <span class="n">Windows</span>
</span></span><span class="line"><span class="cl"><span class="n">tz</span>                                                  
</span></span><span class="line"><span class="cl">                                      <span class="mf">245.0</span>    <span class="mf">276.0</span>
</span></span><span class="line"><span class="cl"><span class="n">Africa</span><span class="o">/</span><span class="n">Cairo</span>                            <span class="mf">0.0</span>      <span class="mf">3.0</span>
</span></span><span class="line"><span class="cl"><span class="n">Africa</span><span class="o">/</span><span class="n">Casablanca</span>                       <span class="mf">0.0</span>      <span class="mf">1.0</span>
</span></span><span class="line"><span class="cl"><span class="n">Africa</span><span class="o">/</span><span class="n">Ceuta</span>                            <span class="mf">0.0</span>      <span class="mf">2.0</span>
</span></span><span class="line"><span class="cl"><span class="n">Africa</span><span class="o">/</span><span class="n">Johannesburg</span>                     <span class="mf">0.0</span>      <span class="mf">1.0</span>
</span></span><span class="line"><span class="cl"><span class="n">Africa</span><span class="o">/</span><span class="n">Lusaka</span>                           <span class="mf">0.0</span>      <span class="mf">1.0</span>
</span></span><span class="line"><span class="cl"><span class="n">America</span><span class="o">/</span><span class="n">Anchorage</span>                       <span class="mf">4.0</span>      <span class="mf">1.0</span>
</span></span><span class="line"><span class="cl"><span class="n">America</span><span class="o">/</span><span class="n">Argentina</span><span class="o">/</span><span class="n">Buenos_Aires</span>          <span class="mf">1.0</span>      <span class="mf">0.0</span>
</span></span><span class="line"><span class="cl"><span class="n">America</span><span class="o">/</span><span class="n">Argentina</span><span class="o">/</span><span class="n">Cordoba</span>               <span class="mf">0.0</span>      <span class="mf">1.0</span>
</span></span><span class="line"><span class="cl"><span class="n">America</span><span class="o">/</span><span class="n">Argentina</span><span class="o">/</span><span class="n">Mendoza</span>               <span class="mf">0.0</span>      <span class="mf">1.0</span>
</span></span></code></pre></div><p>最后，我们来选取最常出现的时区。为了达到这个目的，我根据<code>agg_counts</code>中的行数构造了一个间接索引数组：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Use to sort in ascending order</span>
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">52</span><span class="p">]:</span> <span class="n">indexer</span> <span class="o">=</span> <span class="n">agg_counts</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">53</span><span class="p">]:</span> <span class="n">indexer</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">53</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">tz</span>
</span></span><span class="line"><span class="cl">                                  <span class="mi">24</span>
</span></span><span class="line"><span class="cl"><span class="n">Africa</span><span class="o">/</span><span class="n">Cairo</span>                      <span class="mi">20</span>
</span></span><span class="line"><span class="cl"><span class="n">Africa</span><span class="o">/</span><span class="n">Casablanca</span>                 <span class="mi">21</span>
</span></span><span class="line"><span class="cl"><span class="n">Africa</span><span class="o">/</span><span class="n">Ceuta</span>                      <span class="mi">92</span>
</span></span><span class="line"><span class="cl"><span class="n">Africa</span><span class="o">/</span><span class="n">Johannesburg</span>               <span class="mi">87</span>
</span></span><span class="line"><span class="cl"><span class="n">Africa</span><span class="o">/</span><span class="n">Lusaka</span>                     <span class="mi">53</span>
</span></span><span class="line"><span class="cl"><span class="n">America</span><span class="o">/</span><span class="n">Anchorage</span>                 <span class="mi">54</span>
</span></span><span class="line"><span class="cl"><span class="n">America</span><span class="o">/</span><span class="n">Argentina</span><span class="o">/</span><span class="n">Buenos_Aires</span>    <span class="mi">57</span>
</span></span><span class="line"><span class="cl"><span class="n">America</span><span class="o">/</span><span class="n">Argentina</span><span class="o">/</span><span class="n">Cordoba</span>         <span class="mi">26</span>
</span></span><span class="line"><span class="cl"><span class="n">America</span><span class="o">/</span><span class="n">Argentina</span><span class="o">/</span><span class="n">Mendoza</span>         <span class="mi">55</span>
</span></span><span class="line"><span class="cl"><span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</span></span></code></pre></div><p>然后我通过<code>take</code>按照这个顺序截取了最后 10 行最大值：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">54</span><span class="p">]:</span> <span class="n">count_subset</span> <span class="o">=</span> <span class="n">agg_counts</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">indexer</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">55</span><span class="p">]:</span> <span class="n">count_subset</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">55</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">os</span>                   <span class="n">Not</span> <span class="n">Windows</span>  <span class="n">Windows</span>
</span></span><span class="line"><span class="cl"><span class="n">tz</span>                                       
</span></span><span class="line"><span class="cl"><span class="n">America</span><span class="o">/</span><span class="n">Sao_Paulo</span>           <span class="mf">13.0</span>     <span class="mf">20.0</span>
</span></span><span class="line"><span class="cl"><span class="n">Europe</span><span class="o">/</span><span class="n">Madrid</span>               <span class="mf">16.0</span>     <span class="mf">19.0</span>
</span></span><span class="line"><span class="cl"><span class="n">Pacific</span><span class="o">/</span><span class="n">Honolulu</span>             <span class="mf">0.0</span>     <span class="mf">36.0</span>
</span></span><span class="line"><span class="cl"><span class="n">Asia</span><span class="o">/</span><span class="n">Tokyo</span>                   <span class="mf">2.0</span>     <span class="mf">35.0</span>
</span></span><span class="line"><span class="cl"><span class="n">Europe</span><span class="o">/</span><span class="n">London</span>               <span class="mf">43.0</span>     <span class="mf">31.0</span>
</span></span><span class="line"><span class="cl"><span class="n">America</span><span class="o">/</span><span class="n">Denver</span>             <span class="mf">132.0</span>     <span class="mf">59.0</span>
</span></span><span class="line"><span class="cl"><span class="n">America</span><span class="o">/</span><span class="n">Los_Angeles</span>        <span class="mf">130.0</span>    <span class="mf">252.0</span>
</span></span><span class="line"><span class="cl"><span class="n">America</span><span class="o">/</span><span class="n">Chicago</span>            <span class="mf">115.0</span>    <span class="mf">285.0</span>
</span></span><span class="line"><span class="cl">                           <span class="mf">245.0</span>    <span class="mf">276.0</span>
</span></span><span class="line"><span class="cl"><span class="n">America</span><span class="o">/</span><span class="n">New_York</span>           <span class="mf">339.0</span>    <span class="mf">912.0</span>
</span></span></code></pre></div><p>pandas 有一个简便方法<code>nlargest</code>，可以做同样的工作：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">56</span><span class="p">]:</span> <span class="n">agg_counts</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">56</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">tz</span>
</span></span><span class="line"><span class="cl"><span class="n">America</span><span class="o">/</span><span class="n">New_York</span>       <span class="mf">1251.0</span>
</span></span><span class="line"><span class="cl">                        <span class="mf">521.0</span>
</span></span><span class="line"><span class="cl"><span class="n">America</span><span class="o">/</span><span class="n">Chicago</span>         <span class="mf">400.0</span>
</span></span><span class="line"><span class="cl"><span class="n">America</span><span class="o">/</span><span class="n">Los_Angeles</span>     <span class="mf">382.0</span>
</span></span><span class="line"><span class="cl"><span class="n">America</span><span class="o">/</span><span class="n">Denver</span>          <span class="mf">191.0</span>
</span></span><span class="line"><span class="cl"><span class="n">Europe</span><span class="o">/</span><span class="n">London</span>            <span class="mf">74.0</span>
</span></span><span class="line"><span class="cl"><span class="n">Asia</span><span class="o">/</span><span class="n">Tokyo</span>               <span class="mf">37.0</span>
</span></span><span class="line"><span class="cl"><span class="n">Pacific</span><span class="o">/</span><span class="n">Honolulu</span>         <span class="mf">36.0</span>
</span></span><span class="line"><span class="cl"><span class="n">Europe</span><span class="o">/</span><span class="n">Madrid</span>            <span class="mf">35.0</span>
</span></span><span class="line"><span class="cl"><span class="n">America</span><span class="o">/</span><span class="n">Sao_Paulo</span>        <span class="mf">33.0</span>
</span></span><span class="line"><span class="cl"><span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span></code></pre></div><p>然后，如这段代码所示，可以用柱状图表示。我传递一个额外参数到 seaborn 的<code>barpolt</code>函数，来画一个堆积条形图（见图 14-2）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Rearrange the data for plotting</span>
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">58</span><span class="p">]:</span> <span class="n">count_subset</span> <span class="o">=</span> <span class="n">count_subset</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">59</span><span class="p">]:</span> <span class="n">count_subset</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;total&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">60</span><span class="p">]:</span> <span class="n">count_subset</span> <span class="o">=</span> <span class="n">count_subset</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">61</span><span class="p">]:</span> <span class="n">count_subset</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">61</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl">                  <span class="n">tz</span>           <span class="n">os</span>  <span class="n">total</span>
</span></span><span class="line"><span class="cl"><span class="mi">0</span>  <span class="n">America</span><span class="o">/</span><span class="n">Sao_Paulo</span>  <span class="n">Not</span> <span class="n">Windows</span>   <span class="mf">13.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span>  <span class="n">America</span><span class="o">/</span><span class="n">Sao_Paulo</span>      <span class="n">Windows</span>   <span class="mf">20.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">2</span>      <span class="n">Europe</span><span class="o">/</span><span class="n">Madrid</span>  <span class="n">Not</span> <span class="n">Windows</span>   <span class="mf">16.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">3</span>      <span class="n">Europe</span><span class="o">/</span><span class="n">Madrid</span>      <span class="n">Windows</span>   <span class="mf">19.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">4</span>   <span class="n">Pacific</span><span class="o">/</span><span class="n">Honolulu</span>  <span class="n">Not</span> <span class="n">Windows</span>    <span class="mf">0.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">5</span>   <span class="n">Pacific</span><span class="o">/</span><span class="n">Honolulu</span>      <span class="n">Windows</span>   <span class="mf">36.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">6</span>         <span class="n">Asia</span><span class="o">/</span><span class="n">Tokyo</span>  <span class="n">Not</span> <span class="n">Windows</span>    <span class="mf">2.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">7</span>         <span class="n">Asia</span><span class="o">/</span><span class="n">Tokyo</span>      <span class="n">Windows</span>   <span class="mf">35.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">8</span>      <span class="n">Europe</span><span class="o">/</span><span class="n">London</span>  <span class="n">Not</span> <span class="n">Windows</span>   <span class="mf">43.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">9</span>      <span class="n">Europe</span><span class="o">/</span><span class="n">London</span>      <span class="n">Windows</span>   <span class="mf">31.0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">62</span><span class="p">]:</span> <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;tz&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;os&#39;</span><span class="p">,</span>  <span class="n">data</span><span class="o">=</span><span class="n">count_subset</span><span class="p">)</span>
</span></span></code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-053612a5655b68d9.png"
        data-srcset="img/7178691-053612a5655b68d9.png, img/7178691-053612a5655b68d9.png 1.5x, img/7178691-053612a5655b68d9.png 2x"
        data-sizes="auto"
        alt="img/7178691-053612a5655b68d9.png"
        title="图 14-2 最常出现时区的 Windows 和非 Windows 用户" /></p>
<p>这张图不容易看出 Windows 用户在小分组中的相对比例，因此标准化分组百分比之和为 1：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">norm_total</span><span class="p">(</span><span class="n">group</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">group</span><span class="p">[</span><span class="s1">&#39;normed_total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">total</span> <span class="o">/</span> <span class="n">group</span><span class="o">.</span><span class="n">total</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">group</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">results</span> <span class="o">=</span> <span class="n">count_subset</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;tz&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">norm_total</span><span class="p">)</span>
</span></span></code></pre></div><p>再次画图，见图 14-3：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">65</span><span class="p">]:</span> <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;normed_total&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;tz&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;os&#39;</span><span class="p">,</span>  <span class="n">data</span><span class="o">=</span><span class="n">results</span><span class="p">)</span>
</span></span></code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-60ee355801daf412.png"
        data-srcset="img/7178691-60ee355801daf412.png, img/7178691-60ee355801daf412.png 1.5x, img/7178691-60ee355801daf412.png 2x"
        data-sizes="auto"
        alt="img/7178691-60ee355801daf412.png"
        title="图 14-3 最常出现时区的 Windows 和非 Windows 用户的百分比" /></p>
<p>我们还可以用<code>groupby</code>的<code>transform</code>方法，更高效的计算标准化的和：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">66</span><span class="p">]:</span> <span class="n">g</span> <span class="o">=</span> <span class="n">count_subset</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;tz&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">67</span><span class="p">]:</span> <span class="n">results2</span> <span class="o">=</span> <span class="n">count_subset</span><span class="o">.</span><span class="n">total</span> <span class="o">/</span> <span class="n">g</span><span class="o">.</span><span class="n">total</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;sum&#39;</span><span class="p">)</span>
</span></span></code></pre></div><h1 id="142-movielens-1m-数据集">14.2 MovieLens 1M 数据集</h1>
<p><a href="http://www.grouplens.org/node/73" target="_blank" rel="noopener noreffer ">GroupLens Research</a> 采集了一组从 20 世纪 90 年末到 21 世纪初由 MovieLens 用户提供的电影评分数据。这些数据中包括电影评分、电影元数据（风格类型和年代）以及关于用户的人口统计学数据（年龄、邮编、性别和职业等）。基于机器学习算法的推荐系统一般都会对此类数据感兴趣。虽然我不会在本书中详细介绍机器学习技术，但我会告诉你如何对这种数据进行切片切块以满足实际需求。</p>
<p>MovieLens 1M 数据集含有来自 6000 名用户对 4000 部电影的 100 万条评分数据。它分为三个表：评分、用户信息和电影信息。将该数据从 zip 文件中解压出来之后，可以通过<code>pandas.read_table</code>将各个表分别读到一个 pandas <code>DataFrame</code>对象中：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Make display smaller</span>
</span></span><span class="line"><span class="cl"><span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">max_rows</span> <span class="o">=</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">unames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;gender&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;occupation&#39;</span><span class="p">,</span> <span class="s1">&#39;zip&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">users</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="s1">&#39;datasets/movielens/users.dat&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;::&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">unames</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">rnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;movie_id&#39;</span><span class="p">,</span> <span class="s1">&#39;rating&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">ratings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="s1">&#39;datasets/movielens/ratings.dat&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;::&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">rnames</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">mnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;movie_id&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;genres&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">movies</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="s1">&#39;datasets/movielens/movies.dat&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;::&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">mnames</span><span class="p">)</span>
</span></span></code></pre></div><p>利用 Python 的切片语法，通过查看每个<code>DataFrame</code>的前几行即可验证数据加载工作是否一切顺利：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">69</span><span class="p">]:</span> <span class="n">users</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">69</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl">   <span class="n">user_id</span> <span class="n">gender</span>  <span class="n">age</span>  <span class="n">occupation</span>    <span class="nb">zip</span>
</span></span><span class="line"><span class="cl"><span class="mi">0</span>        <span class="mi">1</span>      <span class="n">F</span>    <span class="mi">1</span>          <span class="mi">10</span>  <span class="mi">48067</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span>        <span class="mi">2</span>      <span class="n">M</span>   <span class="mi">56</span>          <span class="mi">16</span>  <span class="mi">70072</span>
</span></span><span class="line"><span class="cl"><span class="mi">2</span>        <span class="mi">3</span>      <span class="n">M</span>   <span class="mi">25</span>          <span class="mi">15</span>  <span class="mi">55117</span>
</span></span><span class="line"><span class="cl"><span class="mi">3</span>        <span class="mi">4</span>      <span class="n">M</span>   <span class="mi">45</span>           <span class="mi">7</span>  <span class="mi">02460</span>
</span></span><span class="line"><span class="cl"><span class="mi">4</span>        <span class="mi">5</span>      <span class="n">M</span>   <span class="mi">25</span>          <span class="mi">20</span>  <span class="mi">55455</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">70</span><span class="p">]:</span> <span class="n">ratings</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">70</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl">   <span class="n">user_id</span>  <span class="n">movie_id</span>  <span class="n">rating</span>  <span class="n">timestamp</span>
</span></span><span class="line"><span class="cl"><span class="mi">0</span>        <span class="mi">1</span>      <span class="mi">1193</span>       <span class="mi">5</span>  <span class="mi">978300760</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span>        <span class="mi">1</span>       <span class="mi">661</span>       <span class="mi">3</span>  <span class="mi">978302109</span>
</span></span><span class="line"><span class="cl"><span class="mi">2</span>        <span class="mi">1</span>       <span class="mi">914</span>       <span class="mi">3</span>  <span class="mi">978301968</span>
</span></span><span class="line"><span class="cl"><span class="mi">3</span>        <span class="mi">1</span>      <span class="mi">3408</span>       <span class="mi">4</span>  <span class="mi">978300275</span>
</span></span><span class="line"><span class="cl"><span class="mi">4</span>        <span class="mi">1</span>      <span class="mi">2355</span>       <span class="mi">5</span>  <span class="mi">978824291</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">71</span><span class="p">]:</span> <span class="n">movies</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">71</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl">   <span class="n">movie_id</span>                               <span class="n">title</span>                        <span class="n">genres</span>
</span></span><span class="line"><span class="cl"><span class="mi">0</span>         <span class="mi">1</span>                    <span class="n">Toy</span> <span class="n">Story</span> <span class="p">(</span><span class="mi">1995</span><span class="p">)</span>   <span class="n">Animation</span><span class="o">|</span><span class="n">Children</span><span class="s1">&#39;s|Comedy</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span>         <span class="mi">2</span>                      <span class="n">Jumanji</span> <span class="p">(</span><span class="mi">1995</span><span class="p">)</span>  <span class="n">Adventure</span><span class="o">|</span><span class="n">Children</span><span class="s1">&#39;s|Fantasy</span>
</span></span><span class="line"><span class="cl"><span class="mi">2</span>         <span class="mi">3</span>             <span class="n">Grumpier</span> <span class="n">Old</span> <span class="n">Men</span> <span class="p">(</span><span class="mi">1995</span><span class="p">)</span>                <span class="n">Comedy</span><span class="o">|</span><span class="n">Romance</span>
</span></span><span class="line"><span class="cl"><span class="mi">3</span>         <span class="mi">4</span>            <span class="n">Waiting</span> <span class="n">to</span> <span class="n">Exhale</span> <span class="p">(</span><span class="mi">1995</span><span class="p">)</span>                  <span class="n">Comedy</span><span class="o">|</span><span class="n">Drama</span>
</span></span><span class="line"><span class="cl"><span class="mi">4</span>         <span class="mi">5</span>  <span class="n">Father</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Bride</span> <span class="n">Part</span> <span class="n">II</span> <span class="p">(</span><span class="mi">1995</span><span class="p">)</span>                        <span class="n">Comedy</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">72</span><span class="p">]:</span> <span class="n">ratings</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">72</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl">         <span class="n">user_id</span>  <span class="n">movie_id</span>  <span class="n">rating</span>  <span class="n">timestamp</span>
</span></span><span class="line"><span class="cl"><span class="mi">0</span>              <span class="mi">1</span>      <span class="mi">1193</span>       <span class="mi">5</span>  <span class="mi">978300760</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span>              <span class="mi">1</span>       <span class="mi">661</span>       <span class="mi">3</span>  <span class="mi">978302109</span>
</span></span><span class="line"><span class="cl"><span class="mi">2</span>              <span class="mi">1</span>       <span class="mi">914</span>       <span class="mi">3</span>  <span class="mi">978301968</span>
</span></span><span class="line"><span class="cl"><span class="mi">3</span>              <span class="mi">1</span>      <span class="mi">3408</span>       <span class="mi">4</span>  <span class="mi">978300275</span>
</span></span><span class="line"><span class="cl"><span class="mi">4</span>              <span class="mi">1</span>      <span class="mi">2355</span>       <span class="mi">5</span>  <span class="mi">978824291</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>          <span class="o">...</span>       <span class="o">...</span>     <span class="o">...</span>        <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="mi">1000204</span>     <span class="mi">6040</span>      <span class="mi">1091</span>       <span class="mi">1</span>  <span class="mi">956716541</span>
</span></span><span class="line"><span class="cl"><span class="mi">1000205</span>     <span class="mi">6040</span>      <span class="mi">1094</span>       <span class="mi">5</span>  <span class="mi">956704887</span>
</span></span><span class="line"><span class="cl"><span class="mi">1000206</span>     <span class="mi">6040</span>       <span class="mi">562</span>       <span class="mi">5</span>  <span class="mi">956704746</span>
</span></span><span class="line"><span class="cl"><span class="mi">1000207</span>     <span class="mi">6040</span>      <span class="mi">1096</span>       <span class="mi">4</span>  <span class="mi">956715648</span>
</span></span><span class="line"><span class="cl"><span class="mi">1000208</span>     <span class="mi">6040</span>      <span class="mi">1097</span>       <span class="mi">4</span>  <span class="mi">956715569</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">1000209</span> <span class="n">rows</span> <span class="n">x</span> <span class="mi">4</span> <span class="n">columns</span><span class="p">]</span>
</span></span></code></pre></div><p>注意，其中的年龄和职业是以编码形式给出的，它们的具体含义请参考该数据集的 README 文件。分析散布在三个表中的数据可不是一件轻松的事情。假设我们想要根据性别和年龄计算某部电影的平均得分，如果将所有数据都合并到一个表中的话问题就简单多了。我们先用 pandas 的<code>merge</code>函数将<code>ratings</code>跟<code>users</code>合并到一起，然后再将<code>movies</code>也合并进去。pandas 会根据列名的重叠情况推断出哪些列是合并（或连接）键：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">73</span><span class="p">]:</span> <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">users</span><span class="p">),</span> <span class="n">movies</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">74</span><span class="p">]:</span> <span class="n">data</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">74</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl">         <span class="n">user_id</span>  <span class="n">movie_id</span>  <span class="n">rating</span>  <span class="n">timestamp</span> <span class="n">gender</span>  <span class="n">age</span>  <span class="n">occupation</span>    <span class="nb">zip</span>  \
</span></span><span class="line"><span class="cl"><span class="mi">0</span>              <span class="mi">1</span>      <span class="mi">1193</span>       <span class="mi">5</span>  <span class="mi">978300760</span>      <span class="n">F</span>    <span class="mi">1</span>          <span class="mi">10</span>  <span class="mi">48067</span>   
</span></span><span class="line"><span class="cl"><span class="mi">1</span>              <span class="mi">2</span>      <span class="mi">1193</span>       <span class="mi">5</span>  <span class="mi">978298413</span>      <span class="n">M</span>   <span class="mi">56</span>          <span class="mi">16</span>  <span class="mi">70072</span>   
</span></span><span class="line"><span class="cl"><span class="mi">2</span>             <span class="mi">12</span>      <span class="mi">1193</span>       <span class="mi">4</span>  <span class="mi">978220179</span>      <span class="n">M</span>   <span class="mi">25</span>          <span class="mi">12</span>  <span class="mi">32793</span>   
</span></span><span class="line"><span class="cl"><span class="mi">3</span>             <span class="mi">15</span>      <span class="mi">1193</span>       <span class="mi">4</span>  <span class="mi">978199279</span>      <span class="n">M</span>   <span class="mi">25</span>           <span class="mi">7</span>  <span class="mi">22903</span>   
</span></span><span class="line"><span class="cl"><span class="mi">4</span>             <span class="mi">17</span>      <span class="mi">1193</span>       <span class="mi">5</span>  <span class="mi">978158471</span>      <span class="n">M</span>   <span class="mi">50</span>           <span class="mi">1</span>  <span class="mi">95350</span>   
</span></span><span class="line"><span class="cl"><span class="o">...</span>          <span class="o">...</span>       <span class="o">...</span>     <span class="o">...</span>        <span class="o">...</span>    <span class="o">...</span>  <span class="o">...</span>         <span class="o">...</span>    <span class="o">...</span>   
</span></span><span class="line"><span class="cl"><span class="mi">1000204</span>     <span class="mi">5949</span>      <span class="mi">2198</span>       <span class="mi">5</span>  <span class="mi">958846401</span>      <span class="n">M</span>   <span class="mi">18</span>          <span class="mi">17</span>  <span class="mi">47901</span>
</span></span><span class="line"><span class="cl"><span class="mi">1000205</span>     <span class="mi">5675</span>      <span class="mi">2703</span>       <span class="mi">3</span>  <span class="mi">976029116</span>      <span class="n">M</span>   <span class="mi">35</span>          <span class="mi">14</span>  <span class="mi">30030</span>   
</span></span><span class="line"><span class="cl"><span class="mi">1000206</span>     <span class="mi">5780</span>      <span class="mi">2845</span>       <span class="mi">1</span>  <span class="mi">958153068</span>      <span class="n">M</span>   <span class="mi">18</span>          <span class="mi">17</span>  <span class="mi">92886</span>   
</span></span><span class="line"><span class="cl"><span class="mi">1000207</span>     <span class="mi">5851</span>      <span class="mi">3607</span>       <span class="mi">5</span>  <span class="mi">957756608</span>      <span class="n">F</span>   <span class="mi">18</span>          <span class="mi">20</span>  <span class="mi">55410</span>   
</span></span><span class="line"><span class="cl"><span class="mi">1000208</span>     <span class="mi">5938</span>      <span class="mi">2909</span>       <span class="mi">4</span>  <span class="mi">957273353</span>      <span class="n">M</span>   <span class="mi">25</span>           <span class="mi">1</span>  <span class="mi">35401</span>   
</span></span><span class="line"><span class="cl">                                               <span class="n">title</span>                <span class="n">genres</span>  
</span></span><span class="line"><span class="cl"><span class="mi">0</span>             <span class="n">One</span> <span class="n">Flew</span> <span class="n">Over</span> <span class="n">the</span> <span class="n">Cuckoo</span><span class="s1">&#39;s Nest (1975)                 Drama  </span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span>             <span class="n">One</span> <span class="n">Flew</span> <span class="n">Over</span> <span class="n">the</span> <span class="n">Cuckoo</span><span class="s1">&#39;s Nest (1975)                 Drama  </span>
</span></span><span class="line"><span class="cl"><span class="mi">2</span>             <span class="n">One</span> <span class="n">Flew</span> <span class="n">Over</span> <span class="n">the</span> <span class="n">Cuckoo</span><span class="s1">&#39;s Nest (1975)                 Drama  </span>
</span></span><span class="line"><span class="cl"><span class="mi">3</span>             <span class="n">One</span> <span class="n">Flew</span> <span class="n">Over</span> <span class="n">the</span> <span class="n">Cuckoo</span><span class="s1">&#39;s Nest (1975)                 Drama  </span>
</span></span><span class="line"><span class="cl"><span class="mi">4</span>             <span class="n">One</span> <span class="n">Flew</span> <span class="n">Over</span> <span class="n">the</span> <span class="n">Cuckoo</span><span class="s1">&#39;s Nest (1975)                 Drama  </span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>                                              <span class="o">...</span>                   <span class="o">...</span>  
</span></span><span class="line"><span class="cl"><span class="mi">1000204</span>                           <span class="n">Modulations</span> <span class="p">(</span><span class="mi">1998</span><span class="p">)</span>           <span class="n">Documentary</span>  
</span></span><span class="line"><span class="cl"><span class="mi">1000205</span>                        <span class="n">Broken</span> <span class="n">Vessels</span> <span class="p">(</span><span class="mi">1998</span><span class="p">)</span>                 <span class="n">Drama</span>  
</span></span><span class="line"><span class="cl"><span class="mi">1000206</span>                            <span class="n">White</span> <span class="n">Boys</span> <span class="p">(</span><span class="mi">1999</span><span class="p">)</span>                 <span class="n">Drama</span>  
</span></span><span class="line"><span class="cl"><span class="mi">1000207</span>                     <span class="n">One</span> <span class="n">Little</span> <span class="n">Indian</span> <span class="p">(</span><span class="mi">1973</span><span class="p">)</span>  <span class="n">Comedy</span><span class="o">|</span><span class="n">Drama</span><span class="o">|</span><span class="n">Western</span>  
</span></span><span class="line"><span class="cl"><span class="mi">1000208</span>  <span class="n">Five</span> <span class="n">Wives</span><span class="p">,</span> <span class="n">Three</span> <span class="n">Secretaries</span> <span class="ow">and</span> <span class="n">Me</span> <span class="p">(</span><span class="mi">1998</span><span class="p">)</span>           <span class="n">Documentary</span>  
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">1000209</span> <span class="n">rows</span> <span class="n">x</span> <span class="mi">10</span> <span class="n">columns</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">75</span><span class="p">]:</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">75</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">user_id</span>                                            <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">movie_id</span>                                        <span class="mi">1193</span>
</span></span><span class="line"><span class="cl"><span class="n">rating</span>                                             <span class="mi">5</span>
</span></span><span class="line"><span class="cl"><span class="n">timestamp</span>                                  <span class="mi">978300760</span>
</span></span><span class="line"><span class="cl"><span class="n">gender</span>                                             <span class="n">F</span>
</span></span><span class="line"><span class="cl"><span class="n">age</span>                                                <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">occupation</span>                                        <span class="mi">10</span>
</span></span><span class="line"><span class="cl"><span class="nb">zip</span>                                            <span class="mi">48067</span>
</span></span><span class="line"><span class="cl"><span class="n">title</span>         <span class="n">One</span> <span class="n">Flew</span> <span class="n">Over</span> <span class="n">the</span> <span class="n">Cuckoo</span><span class="s1">&#39;s Nest (1975)</span>
</span></span><span class="line"><span class="cl"><span class="n">genres</span>                                         <span class="n">Drama</span>
</span></span><span class="line"><span class="cl"><span class="n">Name</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">object</span>
</span></span></code></pre></div><p>为了按性别计算每部电影的平均得分，我们可以使用<code>pivot_table</code>方法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">76</span><span class="p">]:</span> <span class="n">mean_ratings</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="s1">&#39;rating&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;title&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="o">....</span><span class="p">:</span>                                 <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;gender&#39;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">77</span><span class="p">]:</span> <span class="n">mean_ratings</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">77</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">gender</span>                                <span class="n">F</span>         <span class="n">M</span>
</span></span><span class="line"><span class="cl"><span class="n">title</span>                                            
</span></span><span class="line"><span class="cl"><span class="err">$</span><span class="mi">1</span><span class="p">,</span><span class="mi">000</span><span class="p">,</span><span class="mi">000</span> <span class="n">Duck</span> <span class="p">(</span><span class="mi">1971</span><span class="p">)</span>         <span class="mf">3.375000</span>  <span class="mf">2.761905</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;Night Mother (1986)           3.388889  3.352941</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;Til There Was You (1997)      2.675676  2.733333</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;burbs, The (1989)             2.793478  2.962085</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span><span class="n">And</span> <span class="n">Justice</span> <span class="k">for</span> <span class="n">All</span> <span class="p">(</span><span class="mi">1979</span><span class="p">)</span>  <span class="mf">3.828571</span>  <span class="mf">3.689024</span>
</span></span></code></pre></div><p>该操作产生了另一个<code>DataFrame</code>，其内容为电影平均得分，行标为电影名称（索引），列标为性别。现在，我打算过滤掉评分数据不够 250 条的电影（随便选的一个数字）。为了达到这个目的，我先对<code>title</code>进行分组，然后利用<code>size()</code>得到一个含有各电影分组大小的<code>Series</code>对象：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">78</span><span class="p">]:</span> <span class="n">ratings_by_title</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">79</span><span class="p">]:</span> <span class="n">ratings_by_title</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">79</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">title</span>
</span></span><span class="line"><span class="cl"><span class="err">$</span><span class="mi">1</span><span class="p">,</span><span class="mi">000</span><span class="p">,</span><span class="mi">000</span> <span class="n">Duck</span> <span class="p">(</span><span class="mi">1971</span><span class="p">)</span>                <span class="mi">37</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;Night Mother (1986)                  70</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;Til There Was You (1997)             52</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;burbs, The (1989)                   303</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span><span class="n">And</span> <span class="n">Justice</span> <span class="k">for</span> <span class="n">All</span> <span class="p">(</span><span class="mi">1979</span><span class="p">)</span>        <span class="mi">199</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span><span class="o">-</span><span class="mi">900</span> <span class="p">(</span><span class="mi">1994</span><span class="p">)</span>                           <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="mi">10</span> <span class="n">Things</span> <span class="n">I</span> <span class="n">Hate</span> <span class="n">About</span> <span class="n">You</span> <span class="p">(</span><span class="mi">1999</span><span class="p">)</span>    <span class="mi">700</span>
</span></span><span class="line"><span class="cl"><span class="mi">101</span> <span class="n">Dalmatians</span> <span class="p">(</span><span class="mi">1961</span><span class="p">)</span>                <span class="mi">565</span>
</span></span><span class="line"><span class="cl"><span class="mi">101</span> <span class="n">Dalmatians</span> <span class="p">(</span><span class="mi">1996</span><span class="p">)</span>                <span class="mi">364</span>
</span></span><span class="line"><span class="cl"><span class="mi">12</span> <span class="n">Angry</span> <span class="n">Men</span> <span class="p">(</span><span class="mi">1957</span><span class="p">)</span>                  <span class="mi">616</span>
</span></span><span class="line"><span class="cl"><span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">80</span><span class="p">]:</span> <span class="n">active_titles</span> <span class="o">=</span> <span class="n">ratings_by_title</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">ratings_by_title</span> <span class="o">&gt;=</span> <span class="mi">250</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">81</span><span class="p">]:</span> <span class="n">active_titles</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">81</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">Index</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="n">burbs</span><span class="p">,</span> <span class="n">The</span> <span class="p">(</span><span class="mi">1989</span><span class="p">)</span><span class="s1">&#39;, &#39;</span><span class="mi">10</span> <span class="n">Things</span> <span class="n">I</span> <span class="n">Hate</span> <span class="n">About</span> <span class="n">You</span> <span class="p">(</span><span class="mi">1999</span><span class="p">)</span><span class="s1">&#39;,</span>
</span></span><span class="line"><span class="cl">       <span class="s1">&#39;101 Dalmatians (1961)&#39;</span><span class="p">,</span> <span class="s1">&#39;101 Dalmatians (1996)&#39;</span><span class="p">,</span> <span class="s1">&#39;12 Angry Men (1957)&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="s1">&#39;13th Warrior, The (1999)&#39;</span><span class="p">,</span> <span class="s1">&#39;2 Days in the Valley (1996)&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="s1">&#39;20,000 Leagues Under the Sea (1954)&#39;</span><span class="p">,</span> <span class="s1">&#39;2001: A Space Odyssey (1968)&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="s1">&#39;2010 (1984)&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;X-Men (2000)&#39;</span><span class="p">,</span> <span class="s1">&#39;Year of Living Dangerously (1982)&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="s1">&#39;Yellow Submarine (1968)&#39;</span><span class="p">,</span> <span class="s1">&#39;You&#39;</span><span class="n">ve</span> <span class="n">Got</span> <span class="n">Mail</span> <span class="p">(</span><span class="mi">1998</span><span class="p">)</span><span class="s1">&#39;,</span>
</span></span><span class="line"><span class="cl">       <span class="s1">&#39;Young Frankenstein (1974)&#39;</span><span class="p">,</span> <span class="s1">&#39;Young Guns (1988)&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="s1">&#39;Young Guns II (1990)&#39;</span><span class="p">,</span> <span class="s1">&#39;Young Sherlock Holmes (1985)&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="s1">&#39;Zero Effect (1998)&#39;</span><span class="p">,</span> <span class="s1">&#39;eXistenZ (1999)&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;object&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">1216</span><span class="p">)</span>
</span></span></code></pre></div><p>标题索引中含有评分数据大于 250 条的电影名称，然后我们就可以据此从前面的<code>mean_ratings</code>中选取所需的行了：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Select rows on the index</span>
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">82</span><span class="p">]:</span> <span class="n">mean_ratings</span> <span class="o">=</span> <span class="n">mean_ratings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">active_titles</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">83</span><span class="p">]:</span> <span class="n">mean_ratings</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">83</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">gender</span>                                    <span class="n">F</span>         <span class="n">M</span>
</span></span><span class="line"><span class="cl"><span class="n">title</span>                                                
</span></span><span class="line"><span class="cl"><span class="s1">&#39;burbs, The (1989)                 2.793478  2.962085</span>
</span></span><span class="line"><span class="cl"><span class="mi">10</span> <span class="n">Things</span> <span class="n">I</span> <span class="n">Hate</span> <span class="n">About</span> <span class="n">You</span> <span class="p">(</span><span class="mi">1999</span><span class="p">)</span>  <span class="mf">3.646552</span>  <span class="mf">3.311966</span>
</span></span><span class="line"><span class="cl"><span class="mi">101</span> <span class="n">Dalmatians</span> <span class="p">(</span><span class="mi">1961</span><span class="p">)</span>              <span class="mf">3.791444</span>  <span class="mf">3.500000</span>
</span></span><span class="line"><span class="cl"><span class="mi">101</span> <span class="n">Dalmatians</span> <span class="p">(</span><span class="mi">1996</span><span class="p">)</span>              <span class="mf">3.240000</span>  <span class="mf">2.911215</span>
</span></span><span class="line"><span class="cl"><span class="mi">12</span> <span class="n">Angry</span> <span class="n">Men</span> <span class="p">(</span><span class="mi">1957</span><span class="p">)</span>                <span class="mf">4.184397</span>  <span class="mf">4.328421</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>                                     <span class="o">...</span>       <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">Young</span> <span class="n">Guns</span> <span class="p">(</span><span class="mi">1988</span><span class="p">)</span>                  <span class="mf">3.371795</span>  <span class="mf">3.425620</span>
</span></span><span class="line"><span class="cl"><span class="n">Young</span> <span class="n">Guns</span> <span class="n">II</span> <span class="p">(</span><span class="mi">1990</span><span class="p">)</span>               <span class="mf">2.934783</span>  <span class="mf">2.904025</span>
</span></span><span class="line"><span class="cl"><span class="n">Young</span> <span class="n">Sherlock</span> <span class="n">Holmes</span> <span class="p">(</span><span class="mi">1985</span><span class="p">)</span>       <span class="mf">3.514706</span>  <span class="mf">3.363344</span>
</span></span><span class="line"><span class="cl"><span class="n">Zero</span> <span class="n">Effect</span> <span class="p">(</span><span class="mi">1998</span><span class="p">)</span>                 <span class="mf">3.864407</span>  <span class="mf">3.723140</span>
</span></span><span class="line"><span class="cl"><span class="n">eXistenZ</span> <span class="p">(</span><span class="mi">1999</span><span class="p">)</span>                    <span class="mf">3.098592</span>  <span class="mf">3.289086</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">1216</span> <span class="n">rows</span> <span class="n">x</span> <span class="mi">2</span> <span class="n">columns</span><span class="p">]</span>
</span></span></code></pre></div><p>为了了解女性观众最喜欢的电影，我们可以对<code>F</code>列降序排列：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">85</span><span class="p">]:</span> <span class="n">top_female_ratings</span> <span class="o">=</span> <span class="n">mean_ratings</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">86</span><span class="p">]:</span> <span class="n">top_female_ratings</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">86</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">gender</span>                                                     <span class="n">F</span>         <span class="n">M</span>
</span></span><span class="line"><span class="cl"><span class="n">title</span>                                                                 
</span></span><span class="line"><span class="cl"><span class="n">Close</span> <span class="n">Shave</span><span class="p">,</span> <span class="n">A</span> <span class="p">(</span><span class="mi">1995</span><span class="p">)</span>                               <span class="mf">4.644444</span>  <span class="mf">4.473795</span>
</span></span><span class="line"><span class="cl"><span class="n">Wrong</span> <span class="n">Trousers</span><span class="p">,</span> <span class="n">The</span> <span class="p">(</span><span class="mi">1993</span><span class="p">)</span>                          <span class="mf">4.588235</span>  <span class="mf">4.478261</span>
</span></span><span class="line"><span class="cl"><span class="n">Sunset</span> <span class="n">Blvd</span><span class="o">.</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">a</span><span class="o">.</span> <span class="n">Sunset</span> <span class="n">Boulevard</span><span class="p">)</span> <span class="p">(</span><span class="mi">1950</span><span class="p">)</span>       <span class="mf">4.572650</span>  <span class="mf">4.464589</span>
</span></span><span class="line"><span class="cl"><span class="n">Wallace</span> <span class="o">&amp;</span> <span class="n">Gromit</span><span class="p">:</span> <span class="n">The</span> <span class="n">Best</span> <span class="n">of</span> <span class="n">Aardman</span> <span class="n">Animation</span><span class="o">...</span>  <span class="mf">4.563107</span>  <span class="mf">4.385075</span>
</span></span><span class="line"><span class="cl"><span class="n">Schindler</span><span class="s1">&#39;s List (1993)                             4.562602  4.491415</span>
</span></span><span class="line"><span class="cl"><span class="n">Shawshank</span> <span class="n">Redemption</span><span class="p">,</span> <span class="n">The</span> <span class="p">(</span><span class="mi">1994</span><span class="p">)</span>                    <span class="mf">4.539075</span>  <span class="mf">4.560625</span>
</span></span><span class="line"><span class="cl"><span class="n">Grand</span> <span class="n">Day</span> <span class="n">Out</span><span class="p">,</span> <span class="n">A</span> <span class="p">(</span><span class="mi">1992</span><span class="p">)</span>                             <span class="mf">4.537879</span>  <span class="mf">4.293255</span>
</span></span><span class="line"><span class="cl"><span class="n">To</span> <span class="n">Kill</span> <span class="n">a</span> <span class="n">Mockingbird</span> <span class="p">(</span><span class="mi">1962</span><span class="p">)</span>                        <span class="mf">4.536667</span>  <span class="mf">4.372611</span>
</span></span><span class="line"><span class="cl"><span class="n">Creature</span> <span class="n">Comforts</span> <span class="p">(</span><span class="mi">1990</span><span class="p">)</span>                            <span class="mf">4.513889</span>  <span class="mf">4.272277</span>
</span></span><span class="line"><span class="cl"><span class="n">Usual</span> <span class="n">Suspects</span><span class="p">,</span> <span class="n">The</span> <span class="p">(</span><span class="mi">1995</span><span class="p">)</span>                          <span class="mf">4.513317</span>  <span class="mf">4.518248</span>
</span></span></code></pre></div><h2 id="计算评分分歧">计算评分分歧</h2>
<p>假设我们想要找出男性和女性观众分歧最大的电影。一个办法是给<code>mean_ratings</code>加上一个用于存放平均得分之差的列，并对其进行排序：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">87</span><span class="p">]:</span> <span class="n">mean_ratings</span><span class="p">[</span><span class="s1">&#39;diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_ratings</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">mean_ratings</span><span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">]</span>
</span></span></code></pre></div><p>按&quot;diff&quot;排序即可得到分歧最大且女性观众更喜欢的电影：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">88</span><span class="p">]:</span> <span class="n">sorted_by_diff</span> <span class="o">=</span> <span class="n">mean_ratings</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;diff&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">89</span><span class="p">]:</span> <span class="n">sorted_by_diff</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">89</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">gender</span>                                        <span class="n">F</span>         <span class="n">M</span>      <span class="n">diff</span>
</span></span><span class="line"><span class="cl"><span class="n">title</span>                                                              
</span></span><span class="line"><span class="cl"><span class="n">Dirty</span> <span class="n">Dancing</span> <span class="p">(</span><span class="mi">1987</span><span class="p">)</span>                   <span class="mf">3.790378</span>  <span class="mf">2.959596</span> <span class="o">-</span><span class="mf">0.830782</span>
</span></span><span class="line"><span class="cl"><span class="n">Jumpin</span><span class="s1">&#39; Jack Flash (1986)              3.254717  2.578358 -0.676359</span>
</span></span><span class="line"><span class="cl"><span class="n">Grease</span> <span class="p">(</span><span class="mi">1978</span><span class="p">)</span>                          <span class="mf">3.975265</span>  <span class="mf">3.367041</span> <span class="o">-</span><span class="mf">0.608224</span>
</span></span><span class="line"><span class="cl"><span class="n">Little</span> <span class="n">Women</span> <span class="p">(</span><span class="mi">1994</span><span class="p">)</span>                    <span class="mf">3.870588</span>  <span class="mf">3.321739</span> <span class="o">-</span><span class="mf">0.548849</span>
</span></span><span class="line"><span class="cl"><span class="n">Steel</span> <span class="n">Magnolias</span> <span class="p">(</span><span class="mi">1989</span><span class="p">)</span>                 <span class="mf">3.901734</span>  <span class="mf">3.365957</span> <span class="o">-</span><span class="mf">0.535777</span>
</span></span><span class="line"><span class="cl"><span class="n">Anastasia</span> <span class="p">(</span><span class="mi">1997</span><span class="p">)</span>                       <span class="mf">3.800000</span>  <span class="mf">3.281609</span> <span class="o">-</span><span class="mf">0.518391</span>
</span></span><span class="line"><span class="cl"><span class="n">Rocky</span> <span class="n">Horror</span> <span class="n">Picture</span> <span class="n">Show</span><span class="p">,</span> <span class="n">The</span> <span class="p">(</span><span class="mi">1975</span><span class="p">)</span>  <span class="mf">3.673016</span>  <span class="mf">3.160131</span> <span class="o">-</span><span class="mf">0.512885</span>
</span></span><span class="line"><span class="cl"><span class="n">Color</span> <span class="n">Purple</span><span class="p">,</span> <span class="n">The</span> <span class="p">(</span><span class="mi">1985</span><span class="p">)</span>               <span class="mf">4.158192</span>  <span class="mf">3.659341</span> <span class="o">-</span><span class="mf">0.498851</span>
</span></span><span class="line"><span class="cl"><span class="n">Age</span> <span class="n">of</span> <span class="n">Innocence</span><span class="p">,</span> <span class="n">The</span> <span class="p">(</span><span class="mi">1993</span><span class="p">)</span>           <span class="mf">3.827068</span>  <span class="mf">3.339506</span> <span class="o">-</span><span class="mf">0.487561</span>
</span></span><span class="line"><span class="cl"><span class="n">Free</span> <span class="n">Willy</span> <span class="p">(</span><span class="mi">1993</span><span class="p">)</span>                      <span class="mf">2.921348</span>  <span class="mf">2.438776</span> <span class="o">-</span><span class="mf">0.482573</span>
</span></span></code></pre></div><p>对排序结果反序并取出前 10 行，得到的则是男性观众更喜欢的电影：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Reverse order of rows, take first 10 rows</span>
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">90</span><span class="p">]:</span> <span class="n">sorted_by_diff</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="mi">10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">90</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">gender</span>                                         <span class="n">F</span>         <span class="n">M</span>      <span class="n">diff</span>
</span></span><span class="line"><span class="cl"><span class="n">title</span>                                                               
</span></span><span class="line"><span class="cl"><span class="n">Good</span><span class="p">,</span> <span class="n">The</span> <span class="n">Bad</span> <span class="ow">and</span> <span class="n">The</span> <span class="n">Ugly</span><span class="p">,</span> <span class="n">The</span> <span class="p">(</span><span class="mi">1966</span><span class="p">)</span>  <span class="mf">3.494949</span>  <span class="mf">4.221300</span>  <span class="mf">0.726351</span>
</span></span><span class="line"><span class="cl"><span class="n">Kentucky</span> <span class="n">Fried</span> <span class="n">Movie</span><span class="p">,</span> <span class="n">The</span> <span class="p">(</span><span class="mi">1977</span><span class="p">)</span>        <span class="mf">2.878788</span>  <span class="mf">3.555147</span>  <span class="mf">0.676359</span>
</span></span><span class="line"><span class="cl"><span class="n">Dumb</span> <span class="o">&amp;</span> <span class="n">Dumber</span> <span class="p">(</span><span class="mi">1994</span><span class="p">)</span>                    <span class="mf">2.697987</span>  <span class="mf">3.336595</span>  <span class="mf">0.638608</span>
</span></span><span class="line"><span class="cl"><span class="n">Longest</span> <span class="n">Day</span><span class="p">,</span> <span class="n">The</span> <span class="p">(</span><span class="mi">1962</span><span class="p">)</span>                 <span class="mf">3.411765</span>  <span class="mf">4.031447</span>  <span class="mf">0.619682</span>
</span></span><span class="line"><span class="cl"><span class="n">Cable</span> <span class="n">Guy</span><span class="p">,</span> <span class="n">The</span> <span class="p">(</span><span class="mi">1996</span><span class="p">)</span>                   <span class="mf">2.250000</span>  <span class="mf">2.863787</span>  <span class="mf">0.613787</span>
</span></span><span class="line"><span class="cl"><span class="n">Evil</span> <span class="n">Dead</span> <span class="n">II</span> <span class="p">(</span><span class="n">Dead</span> <span class="n">By</span> <span class="n">Dawn</span><span class="p">)</span> <span class="p">(</span><span class="mi">1987</span><span class="p">)</span>      <span class="mf">3.297297</span>  <span class="mf">3.909283</span>  <span class="mf">0.611985</span>
</span></span><span class="line"><span class="cl"><span class="n">Hidden</span><span class="p">,</span> <span class="n">The</span> <span class="p">(</span><span class="mi">1987</span><span class="p">)</span>                      <span class="mf">3.137931</span>  <span class="mf">3.745098</span>  <span class="mf">0.607167</span>
</span></span><span class="line"><span class="cl"><span class="n">Rocky</span> <span class="n">III</span> <span class="p">(</span><span class="mi">1982</span><span class="p">)</span>                        <span class="mf">2.361702</span>  <span class="mf">2.943503</span>  <span class="mf">0.581801</span>
</span></span><span class="line"><span class="cl"><span class="n">Caddyshack</span> <span class="p">(</span><span class="mi">1980</span><span class="p">)</span>                       <span class="mf">3.396135</span>  <span class="mf">3.969737</span>  <span class="mf">0.573602</span>
</span></span><span class="line"><span class="cl"><span class="n">For</span> <span class="n">a</span> <span class="n">Few</span> <span class="n">Dollars</span> <span class="n">More</span> <span class="p">(</span><span class="mi">1965</span><span class="p">)</span>           <span class="mf">3.409091</span>  <span class="mf">3.953795</span>  <span class="mf">0.544704</span>
</span></span></code></pre></div><p>如果只是想要找出分歧最大的电影（不考虑性别因素），则可以计算得分数据的方差或标准差：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Standard deviation of rating grouped by title</span>
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">91</span><span class="p">]:</span> <span class="n">rating_std_by_title</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Filter down to active_titles</span>
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">92</span><span class="p">]:</span> <span class="n">rating_std_by_title</span> <span class="o">=</span> <span class="n">rating_std_by_title</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">active_titles</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Order Series by value in descending order</span>
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">93</span><span class="p">]:</span> <span class="n">rating_std_by_title</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">93</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">title</span>
</span></span><span class="line"><span class="cl"><span class="n">Dumb</span> <span class="o">&amp;</span> <span class="n">Dumber</span> <span class="p">(</span><span class="mi">1994</span><span class="p">)</span>                     <span class="mf">1.321333</span>
</span></span><span class="line"><span class="cl"><span class="n">Blair</span> <span class="n">Witch</span> <span class="n">Project</span><span class="p">,</span> <span class="n">The</span> <span class="p">(</span><span class="mi">1999</span><span class="p">)</span>          <span class="mf">1.316368</span>
</span></span><span class="line"><span class="cl"><span class="n">Natural</span> <span class="n">Born</span> <span class="n">Killers</span> <span class="p">(</span><span class="mi">1994</span><span class="p">)</span>              <span class="mf">1.307198</span>
</span></span><span class="line"><span class="cl"><span class="n">Tank</span> <span class="n">Girl</span> <span class="p">(</span><span class="mi">1995</span><span class="p">)</span>                         <span class="mf">1.277695</span>
</span></span><span class="line"><span class="cl"><span class="n">Rocky</span> <span class="n">Horror</span> <span class="n">Picture</span> <span class="n">Show</span><span class="p">,</span> <span class="n">The</span> <span class="p">(</span><span class="mi">1975</span><span class="p">)</span>    <span class="mf">1.260177</span>
</span></span><span class="line"><span class="cl"><span class="n">Eyes</span> <span class="n">Wide</span> <span class="n">Shut</span> <span class="p">(</span><span class="mi">1999</span><span class="p">)</span>                    <span class="mf">1.259624</span>
</span></span><span class="line"><span class="cl"><span class="n">Evita</span> <span class="p">(</span><span class="mi">1996</span><span class="p">)</span>                             <span class="mf">1.253631</span>
</span></span><span class="line"><span class="cl"><span class="n">Billy</span> <span class="n">Madison</span> <span class="p">(</span><span class="mi">1995</span><span class="p">)</span>                     <span class="mf">1.249970</span>
</span></span><span class="line"><span class="cl"><span class="n">Fear</span> <span class="ow">and</span> <span class="n">Loathing</span> <span class="ow">in</span> <span class="n">Las</span> <span class="n">Vegas</span> <span class="p">(</span><span class="mi">1998</span><span class="p">)</span>    <span class="mf">1.246408</span>
</span></span><span class="line"><span class="cl"><span class="n">Bicentennial</span> <span class="n">Man</span> <span class="p">(</span><span class="mi">1999</span><span class="p">)</span>                  <span class="mf">1.245533</span>
</span></span><span class="line"><span class="cl"><span class="n">Name</span><span class="p">:</span> <span class="n">rating</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span></code></pre></div><p>可能你已经注意到了，电影分类是以竖线（|）分隔的字符串形式给出的。如果想对电影分类进行分析的话，就需要先将其转换成更有用的形式才行。</p>
<h1 id="143-1880-2010-年间全美婴儿姓名">14.3 1880-2010 年间全美婴儿姓名</h1>
<p>美国社会保障总署（SSA）提供了一份从 1880 年到现在的婴儿名字频率数据。Hadley Wickham（许多流行 R 包的作者）经常用这份数据来演示 R 的数据处理功能。</p>
<p>我们要做一些数据规整才能加载这个数据集，这么做就会产生一个如下的<code>DataFrame</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="n">names</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">name</span> <span class="n">sex</span>  <span class="n">births</span>  <span class="n">year</span>
</span></span><span class="line"><span class="cl"><span class="mi">0</span>       <span class="n">Mary</span>   <span class="n">F</span>    <span class="mi">7065</span>  <span class="mi">1880</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span>       <span class="n">Anna</span>   <span class="n">F</span>    <span class="mi">2604</span>  <span class="mi">1880</span>
</span></span><span class="line"><span class="cl"><span class="mi">2</span>       <span class="n">Emma</span>   <span class="n">F</span>    <span class="mi">2003</span>  <span class="mi">1880</span>
</span></span><span class="line"><span class="cl"><span class="mi">3</span>  <span class="n">Elizabeth</span>   <span class="n">F</span>    <span class="mi">1939</span>  <span class="mi">1880</span>
</span></span><span class="line"><span class="cl"><span class="mi">4</span>     <span class="n">Minnie</span>   <span class="n">F</span>    <span class="mi">1746</span>  <span class="mi">1880</span>
</span></span><span class="line"><span class="cl"><span class="mi">5</span>   <span class="n">Margaret</span>   <span class="n">F</span>    <span class="mi">1578</span>  <span class="mi">1880</span>
</span></span><span class="line"><span class="cl"><span class="mi">6</span>        <span class="n">Ida</span>   <span class="n">F</span>    <span class="mi">1472</span>  <span class="mi">1880</span>
</span></span><span class="line"><span class="cl"><span class="mi">7</span>      <span class="n">Alice</span>   <span class="n">F</span>    <span class="mi">1414</span>  <span class="mi">1880</span>
</span></span><span class="line"><span class="cl"><span class="mi">8</span>     <span class="n">Bertha</span>   <span class="n">F</span>    <span class="mi">1320</span>  <span class="mi">1880</span>
</span></span><span class="line"><span class="cl"><span class="mi">9</span>      <span class="n">Sarah</span>   <span class="n">F</span>    <span class="mi">1288</span>  <span class="mi">1880</span>
</span></span></code></pre></div><p>你可以用这个数据集做很多事，例如：</p>
<ul>
<li>计算指定名字（可以是你自己的，也可以是别人的）的年度比例。</li>
<li>计算某个名字的相对排名。</li>
<li>计算各年度最流行的名字，以及增长或减少最快的名字。</li>
<li>分析名字趋势：元音、辅音、长度、总体多样性、拼写变化、首尾字母等。</li>
<li>分析外源性趋势：圣经中的名字、名人、人口结构变化等。</li>
</ul>
<p>利用前面介绍过的那些工具，这些分析工作都能很轻松地完成，我会讲解其中的一些。</p>
<p>到编写本书时为止，美国社会保障总署将该数据库按年度制成了多个数据文件，其中给出了每个性别/名字组合的出生总数。<a href="http://www.ssa.gov/oact/babynames/limits.html" target="_blank" rel="noopener noreffer ">这些文件的原始档案可以在这里获取</a>。</p>
<p>如果你在阅读本书的时候这个页面已经不见了，也可以用搜索引擎找找。</p>
<p>下载<code>&quot;National data&quot;</code>文件<code>names.zip</code>，解压后的目录中含有一组文件（如<code>yob1880.txt</code>）。我用 UNIX 的<code>head</code>命令查看了其中一个文件的前 10 行（在 Windows 上，你可以用<code>more</code>命令，或直接在文本编辑器中打开）：</p>
<pre tabindex="0"><code>In [94]: !head -n 10 datasets/babynames/yob1880.txt
Mary,F,7065
Anna,F,2604
Emma,F,2003
Elizabeth,F,1939
Minnie,F,1746
Margaret,F,1578
Ida,F,1472
Alice,F,1414
Bertha,F,1320
Sarah,F,1288
</code></pre><p>由于这是一个非常标准的以逗号隔开的格式，所以可以用<code>pandas.read_csv</code>将其加载到<code>DataFrame</code>中：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">95</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">96</span><span class="p">]:</span> <span class="n">names1880</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl"><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;datasets/babynames/yob1880.txt&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="o">....</span><span class="p">:</span>                         <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="s1">&#39;births&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">97</span><span class="p">]:</span> <span class="n">names1880</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">97</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl">           <span class="n">name</span> <span class="n">sex</span>  <span class="n">births</span>
</span></span><span class="line"><span class="cl"><span class="mi">0</span>          <span class="n">Mary</span>   <span class="n">F</span>    <span class="mi">7065</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span>          <span class="n">Anna</span>   <span class="n">F</span>    <span class="mi">2604</span>
</span></span><span class="line"><span class="cl"><span class="mi">2</span>          <span class="n">Emma</span>   <span class="n">F</span>    <span class="mi">2003</span>
</span></span><span class="line"><span class="cl"><span class="mi">3</span>     <span class="n">Elizabeth</span>   <span class="n">F</span>    <span class="mi">1939</span>
</span></span><span class="line"><span class="cl"><span class="mi">4</span>        <span class="n">Minnie</span>   <span class="n">F</span>    <span class="mi">1746</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>         <span class="o">...</span>  <span class="o">..</span>     <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="mi">1995</span>     <span class="n">Woodie</span>   <span class="n">M</span>       <span class="mi">5</span>
</span></span><span class="line"><span class="cl"><span class="mi">1996</span>     <span class="n">Worthy</span>   <span class="n">M</span>       <span class="mi">5</span>
</span></span><span class="line"><span class="cl"><span class="mi">1997</span>     <span class="n">Wright</span>   <span class="n">M</span>       <span class="mi">5</span>
</span></span><span class="line"><span class="cl"><span class="mi">1998</span>       <span class="n">York</span>   <span class="n">M</span>       <span class="mi">5</span>
</span></span><span class="line"><span class="cl"><span class="mi">1999</span>  <span class="n">Zachariah</span>   <span class="n">M</span>       <span class="mi">5</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">2000</span> <span class="n">rows</span> <span class="n">x</span> <span class="mi">3</span> <span class="n">columns</span><span class="p">]</span>
</span></span></code></pre></div><p>这些文件中仅含有当年出现超过 5 次的名字。为了简单起见，我们可以用<code>births</code>列的<code>sex</code>分组小计表示该年度的<code>births</code>总计：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">98</span><span class="p">]:</span> <span class="n">names1880</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;sex&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">births</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">98</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">sex</span>
</span></span><span class="line"><span class="cl"><span class="n">F</span>     <span class="mi">90993</span>
</span></span><span class="line"><span class="cl"><span class="n">M</span>    <span class="mi">110493</span>
</span></span><span class="line"><span class="cl"><span class="n">Name</span><span class="p">:</span> <span class="n">births</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</span></span></code></pre></div><p>由于该数据集按年度被分隔成了多个文件，所以第一件事情就是要将所有数据都组装到一个<code>DataFrame</code>里面，并加上一个<code>year</code>字段。使用<code>pandas.concat</code>即可达到这个目的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">years</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1880</span><span class="p">,</span> <span class="mi">2011</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">pieces</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="s1">&#39;births&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">years</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;datasets/babynames/yob</span><span class="si">%d</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="n">year</span>
</span></span><span class="line"><span class="cl">    <span class="n">frame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">frame</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">year</span>
</span></span><span class="line"><span class="cl">    <span class="n">pieces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Concatenate everything into a single DataFrame</span>
</span></span><span class="line"><span class="cl"><span class="n">names</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">pieces</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></div><p>这里需要注意几件事情。第一，<code>concat</code>默认是按行将多个<code>DataFrame</code>组合到一起的；第二，必须指定<code>ignore_index=True</code>，因为我们不希望保留<code>read_csv</code>所返回的原始行号。现在我们得到了一个非常大的<code>DataFrame</code>，它含有全部的名字数据：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">100</span><span class="p">]:</span> <span class="n">names</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">100</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl">              <span class="n">name</span> <span class="n">sex</span>  <span class="n">births</span>  <span class="n">year</span>
</span></span><span class="line"><span class="cl"><span class="mi">0</span>             <span class="n">Mary</span>   <span class="n">F</span>    <span class="mi">7065</span>  <span class="mi">1880</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span>             <span class="n">Anna</span>   <span class="n">F</span>    <span class="mi">2604</span>  <span class="mi">1880</span>
</span></span><span class="line"><span class="cl"><span class="mi">2</span>             <span class="n">Emma</span>   <span class="n">F</span>    <span class="mi">2003</span>  <span class="mi">1880</span>
</span></span><span class="line"><span class="cl"><span class="mi">3</span>        <span class="n">Elizabeth</span>   <span class="n">F</span>    <span class="mi">1939</span>  <span class="mi">1880</span>
</span></span><span class="line"><span class="cl"><span class="mi">4</span>           <span class="n">Minnie</span>   <span class="n">F</span>    <span class="mi">1746</span>  <span class="mi">1880</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>            <span class="o">...</span>  <span class="o">..</span>     <span class="o">...</span>   <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="mi">1690779</span>    <span class="n">Zymaire</span>   <span class="n">M</span>       <span class="mi">5</span>  <span class="mi">2010</span>
</span></span><span class="line"><span class="cl"><span class="mi">1690780</span>     <span class="n">Zyonne</span>   <span class="n">M</span>       <span class="mi">5</span>  <span class="mi">2010</span>
</span></span><span class="line"><span class="cl"><span class="mi">1690781</span>  <span class="n">Zyquarius</span>   <span class="n">M</span>       <span class="mi">5</span>  <span class="mi">2010</span>
</span></span><span class="line"><span class="cl"><span class="mi">1690782</span>      <span class="n">Zyran</span>   <span class="n">M</span>       <span class="mi">5</span>  <span class="mi">2010</span>
</span></span><span class="line"><span class="cl"><span class="mi">1690783</span>      <span class="n">Zzyzx</span>   <span class="n">M</span>       <span class="mi">5</span>  <span class="mi">2010</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">1690784</span> <span class="n">rows</span> <span class="n">x</span> <span class="mi">4</span> <span class="n">columns</span><span class="p">]</span>
</span></span></code></pre></div><p>有了这些数据之后，我们就可以利用<code>groupby</code>或<code>pivot_table</code>在<code>year</code>和<code>sex</code>级别上对其进行聚合了，如图 14-4 所示：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">101</span><span class="p">]:</span> <span class="n">total_births</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="s1">&#39;births&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="o">.....</span><span class="p">:</span>                                  <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="nb">sum</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">102</span><span class="p">]:</span> <span class="n">total_births</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">102</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">sex</span>         <span class="n">F</span>        <span class="n">M</span>
</span></span><span class="line"><span class="cl"><span class="n">year</span>                  
</span></span><span class="line"><span class="cl"><span class="mi">2006</span>  <span class="mi">1896468</span>  <span class="mi">2050234</span>
</span></span><span class="line"><span class="cl"><span class="mi">2007</span>  <span class="mi">1916888</span>  <span class="mi">2069242</span>
</span></span><span class="line"><span class="cl"><span class="mi">2008</span>  <span class="mi">1883645</span>  <span class="mi">2032310</span>
</span></span><span class="line"><span class="cl"><span class="mi">2009</span>  <span class="mi">1827643</span>  <span class="mi">1973359</span>
</span></span><span class="line"><span class="cl"><span class="mi">2010</span>  <span class="mi">1759010</span>  <span class="mi">1898382</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">103</span><span class="p">]:</span> <span class="n">total_births</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Total births by sex and year&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-7643b150d88aae11.png"
        data-srcset="img/7178691-7643b150d88aae11.png, img/7178691-7643b150d88aae11.png 1.5x, img/7178691-7643b150d88aae11.png 2x"
        data-sizes="auto"
        alt="img/7178691-7643b150d88aae11.png"
        title="图 14-4 按性别和年度统计的总出生数" /></p>
<p>下面我们来插入一个<code>prop</code>列，用于存放指定名字的婴儿数相对于总出生数的比例。<code>prop</code>值为 0.02 表示每 100 名婴儿中有 2 名取了当前这个名字。因此，我们先按<code>year</code>和<code>sex</code>分组，然后再将新列加到各个分组上：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">add_prop</span><span class="p">(</span><span class="n">group</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">group</span><span class="p">[</span><span class="s1">&#39;prop&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">births</span> <span class="o">/</span> <span class="n">group</span><span class="o">.</span><span class="n">births</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">group</span>
</span></span><span class="line"><span class="cl"><span class="n">names</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">add_prop</span><span class="p">)</span>
</span></span></code></pre></div><p>现在，完整的数据集就有了下面这些列：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">105</span><span class="p">]:</span> <span class="n">names</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">105</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl">              <span class="n">name</span> <span class="n">sex</span>  <span class="n">births</span>  <span class="n">year</span>      <span class="n">prop</span>
</span></span><span class="line"><span class="cl"><span class="mi">0</span>             <span class="n">Mary</span>   <span class="n">F</span>    <span class="mi">7065</span>  <span class="mi">1880</span>  <span class="mf">0.077643</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span>             <span class="n">Anna</span>   <span class="n">F</span>    <span class="mi">2604</span>  <span class="mi">1880</span>  <span class="mf">0.028618</span>
</span></span><span class="line"><span class="cl"><span class="mi">2</span>             <span class="n">Emma</span>   <span class="n">F</span>    <span class="mi">2003</span>  <span class="mi">1880</span>  <span class="mf">0.022013</span>
</span></span><span class="line"><span class="cl"><span class="mi">3</span>        <span class="n">Elizabeth</span>   <span class="n">F</span>    <span class="mi">1939</span>  <span class="mi">1880</span>  <span class="mf">0.021309</span>
</span></span><span class="line"><span class="cl"><span class="mi">4</span>           <span class="n">Minnie</span>   <span class="n">F</span>    <span class="mi">1746</span>  <span class="mi">1880</span>  <span class="mf">0.019188</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>            <span class="o">...</span>  <span class="o">..</span>     <span class="o">...</span>   <span class="o">...</span>       <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="mi">1690779</span>    <span class="n">Zymaire</span>   <span class="n">M</span>       <span class="mi">5</span>  <span class="mi">2010</span>  <span class="mf">0.000003</span>
</span></span><span class="line"><span class="cl"><span class="mi">1690780</span>     <span class="n">Zyonne</span>   <span class="n">M</span>       <span class="mi">5</span>  <span class="mi">2010</span>  <span class="mf">0.000003</span>
</span></span><span class="line"><span class="cl"><span class="mi">1690781</span>  <span class="n">Zyquarius</span>   <span class="n">M</span>       <span class="mi">5</span>  <span class="mi">2010</span>  <span class="mf">0.000003</span>
</span></span><span class="line"><span class="cl"><span class="mi">1690782</span>      <span class="n">Zyran</span>   <span class="n">M</span>       <span class="mi">5</span>  <span class="mi">2010</span>  <span class="mf">0.000003</span>
</span></span><span class="line"><span class="cl"><span class="mi">1690783</span>      <span class="n">Zzyzx</span>   <span class="n">M</span>       <span class="mi">5</span>  <span class="mi">2010</span>  <span class="mf">0.000003</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">1690784</span> <span class="n">rows</span> <span class="n">x</span> <span class="mi">5</span> <span class="n">columns</span><span class="p">]</span>
</span></span></code></pre></div><p>在执行这样的分组处理时，一般都应该做一些有效性检查，比如验证所有分组的<code>prop</code>的总和是否为 1：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">106</span><span class="p">]:</span> <span class="n">names</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">106</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">year</span>  <span class="n">sex</span>
</span></span><span class="line"><span class="cl"><span class="mi">1880</span>  <span class="n">F</span>      <span class="mf">1.0</span>
</span></span><span class="line"><span class="cl">      <span class="n">M</span>      <span class="mf">1.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">1881</span>  <span class="n">F</span>      <span class="mf">1.0</span>
</span></span><span class="line"><span class="cl">      <span class="n">M</span>      <span class="mf">1.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">1882</span>  <span class="n">F</span>      <span class="mf">1.0</span>
</span></span><span class="line"><span class="cl">            <span class="o">...</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2008</span>  <span class="n">M</span>      <span class="mf">1.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">2009</span>  <span class="n">F</span>      <span class="mf">1.0</span>
</span></span><span class="line"><span class="cl">      <span class="n">M</span>      <span class="mf">1.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">2010</span>  <span class="n">F</span>      <span class="mf">1.0</span>
</span></span><span class="line"><span class="cl">      <span class="n">M</span>      <span class="mf">1.0</span>
</span></span><span class="line"><span class="cl"><span class="n">Name</span><span class="p">:</span> <span class="n">prop</span><span class="p">,</span> <span class="n">Length</span><span class="p">:</span> <span class="mi">262</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span></code></pre></div><p>工作完成。为了便于实现更进一步的分析，我需要取出该数据的一个子集：每对<code>sex/year</code>组合的前 1000 个名字。这又是一个分组操作：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_top1000</span><span class="p">(</span><span class="n">group</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">group</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;births&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:</span><span class="mi">1000</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">grouped</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">top1000</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_top1000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Drop the group index, not needed</span>
</span></span><span class="line"><span class="cl"><span class="n">top1000</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></div><p>如果你喜欢 DIY 的话，也可以这样：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">pieces</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">year</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">names</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">]):</span>
</span></span><span class="line"><span class="cl">    <span class="n">pieces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;births&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:</span><span class="mi">1000</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">top1000</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">pieces</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></div><p>现在的结果数据集就小多了：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">108</span><span class="p">]:</span> <span class="n">top1000</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">108</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl">             <span class="n">name</span> <span class="n">sex</span>  <span class="n">births</span>  <span class="n">year</span>      <span class="n">prop</span>
</span></span><span class="line"><span class="cl"><span class="mi">0</span>            <span class="n">Mary</span>   <span class="n">F</span>    <span class="mi">7065</span>  <span class="mi">1880</span>  <span class="mf">0.077643</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span>            <span class="n">Anna</span>   <span class="n">F</span>    <span class="mi">2604</span>  <span class="mi">1880</span>  <span class="mf">0.028618</span>
</span></span><span class="line"><span class="cl"><span class="mi">2</span>            <span class="n">Emma</span>   <span class="n">F</span>    <span class="mi">2003</span>  <span class="mi">1880</span>  <span class="mf">0.022013</span>
</span></span><span class="line"><span class="cl"><span class="mi">3</span>       <span class="n">Elizabeth</span>   <span class="n">F</span>    <span class="mi">1939</span>  <span class="mi">1880</span>  <span class="mf">0.021309</span>
</span></span><span class="line"><span class="cl"><span class="mi">4</span>          <span class="n">Minnie</span>   <span class="n">F</span>    <span class="mi">1746</span>  <span class="mi">1880</span>  <span class="mf">0.019188</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>           <span class="o">...</span>  <span class="o">..</span>     <span class="o">...</span>   <span class="o">...</span>       <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="mi">261872</span>     <span class="n">Camilo</span>   <span class="n">M</span>     <span class="mi">194</span>  <span class="mi">2010</span>  <span class="mf">0.000102</span>
</span></span><span class="line"><span class="cl"><span class="mi">261873</span>     <span class="n">Destin</span>   <span class="n">M</span>     <span class="mi">194</span>  <span class="mi">2010</span>  <span class="mf">0.000102</span>
</span></span><span class="line"><span class="cl"><span class="mi">261874</span>     <span class="n">Jaquan</span>   <span class="n">M</span>     <span class="mi">194</span>  <span class="mi">2010</span>  <span class="mf">0.000102</span>
</span></span><span class="line"><span class="cl"><span class="mi">261875</span>     <span class="n">Jaydan</span>   <span class="n">M</span>     <span class="mi">194</span>  <span class="mi">2010</span>  <span class="mf">0.000102</span>
</span></span><span class="line"><span class="cl"><span class="mi">261876</span>     <span class="n">Maxton</span>   <span class="n">M</span>     <span class="mi">193</span>  <span class="mi">2010</span>  <span class="mf">0.000102</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">261877</span> <span class="n">rows</span> <span class="n">x</span> <span class="mi">5</span> <span class="n">columns</span><span class="p">]</span>
</span></span></code></pre></div><p>接下来的数据分析工作就针对这个<code>top1000</code>数据集了。</p>
<h2 id="分析命名趋势">分析命名趋势</h2>
<p>有了完整的数据集和刚才生成的<code>top1000</code>数据集，我们就可以开始分析各种命名趋势了。首先将前 1000 个名字分为男女两个部分：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">109</span><span class="p">]:</span> <span class="n">boys</span> <span class="o">=</span> <span class="n">top1000</span><span class="p">[</span><span class="n">top1000</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s1">&#39;M&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">110</span><span class="p">]:</span> <span class="n">girls</span> <span class="o">=</span> <span class="n">top1000</span><span class="p">[</span><span class="n">top1000</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s1">&#39;F&#39;</span><span class="p">]</span>
</span></span></code></pre></div><p>这是两个简单的时间序列，只需稍作整理即可绘制出相应的图表（比如每年叫做 John 和 Mary 的婴儿数）。我们先生成一张按<code>year</code>和<code>name</code>统计的总出生数透视表：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">111</span><span class="p">]:</span> <span class="n">total_births</span> <span class="o">=</span> <span class="n">top1000</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="s1">&#39;births&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="o">.....</span><span class="p">:</span>                                    <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="o">.....</span><span class="p">:</span>                                    <span class="n">aggfunc</span><span class="o">=</span><span class="nb">sum</span><span class="p">)</span>
</span></span></code></pre></div><p>现在，我们用<code>DataFrame</code>的<code>plot</code>方法绘制几个名字的曲线图（见图 14-5）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">112</span><span class="p">]:</span> <span class="n">total_births</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="s1">&#39;&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n">Int64Index</span><span class="p">:</span> <span class="mi">131</span> <span class="n">entries</span><span class="p">,</span> <span class="mi">1880</span> <span class="n">to</span> <span class="mi">2010</span>
</span></span><span class="line"><span class="cl"><span class="n">Columns</span><span class="p">:</span> <span class="mi">6868</span> <span class="n">entries</span><span class="p">,</span> <span class="n">Aaden</span> <span class="n">to</span> <span class="n">Zuri</span>
</span></span><span class="line"><span class="cl"><span class="n">dtypes</span><span class="p">:</span> <span class="n">float64</span><span class="p">(</span><span class="mi">6868</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">memory</span> <span class="n">usage</span><span class="p">:</span> <span class="mf">6.9</span> <span class="n">MB</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">113</span><span class="p">]:</span> <span class="n">subset</span> <span class="o">=</span> <span class="n">total_births</span><span class="p">[[</span><span class="s1">&#39;John&#39;</span><span class="p">,</span> <span class="s1">&#39;Harry&#39;</span><span class="p">,</span> <span class="s1">&#39;Mary&#39;</span><span class="p">,</span> <span class="s1">&#39;Marilyn&#39;</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">114</span><span class="p">]:</span> <span class="n">subset</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">subplots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="o">.....</span><span class="p">:</span>             <span class="n">title</span><span class="o">=</span><span class="s2">&#34;Number of births per year&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-33f0f97656367a53.png"
        data-srcset="img/7178691-33f0f97656367a53.png, img/7178691-33f0f97656367a53.png 1.5x, img/7178691-33f0f97656367a53.png 2x"
        data-sizes="auto"
        alt="img/7178691-33f0f97656367a53.png"
        title="图 14-5 几个男孩和女孩名字随时间变化的使用数量" /></p>
<p>从图中可以看出，这几个名字在美国人民的心目中已经风光不再了。但事实并非如此简单，我们在下一节中就能知道是怎么一回事了。</p>
<h2 id="评估命名多样性的增长">评估命名多样性的增长</h2>
<p>一种解释是父母愿意给小孩起常见的名字越来越少。这个假设可以从数据中得到验证。一个办法是计算最流行的 1000 个名字所占的比例，我按<code>year</code>和<code>sex</code>进行聚合并绘图（见图 14-6）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">116</span><span class="p">]:</span> <span class="n">table</span> <span class="o">=</span> <span class="n">top1000</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="s1">&#39;prop&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="o">.....</span><span class="p">:</span>                             <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="nb">sum</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">117</span><span class="p">]:</span> <span class="n">table</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Sum of table1000.prop by year and sex&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="o">.....</span><span class="p">:</span>            <span class="n">yticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span> <span class="n">xticks</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">1880</span><span class="p">,</span> <span class="mi">2020</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-63e1ddc326a033b9.png"
        data-srcset="img/7178691-63e1ddc326a033b9.png, img/7178691-63e1ddc326a033b9.png 1.5x, img/7178691-63e1ddc326a033b9.png 2x"
        data-sizes="auto"
        alt="img/7178691-63e1ddc326a033b9.png"
        title="图 14-6 分性别统计的前 1000 个名字在总出生人数中的比例" /></p>
<p>从图中可以看出，名字的多样性确实出现了增长（前 1000 项的比例降低）。另一个办法是计算占总出生人数前 50%的不同名字的数量，这个数字不太好计算。我们只考虑 2010 年男孩的名字：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">118</span><span class="p">]:</span> <span class="n">df</span> <span class="o">=</span> <span class="n">boys</span><span class="p">[</span><span class="n">boys</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="mi">2010</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">119</span><span class="p">]:</span> <span class="n">df</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">119</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl">           <span class="n">name</span> <span class="n">sex</span>  <span class="n">births</span>  <span class="n">year</span>      <span class="n">prop</span>
</span></span><span class="line"><span class="cl"><span class="mi">260877</span>    <span class="n">Jacob</span>   <span class="n">M</span>   <span class="mi">21875</span>  <span class="mi">2010</span>  <span class="mf">0.011523</span>
</span></span><span class="line"><span class="cl"><span class="mi">260878</span>    <span class="n">Ethan</span>   <span class="n">M</span>   <span class="mi">17866</span>  <span class="mi">2010</span>  <span class="mf">0.009411</span>
</span></span><span class="line"><span class="cl"><span class="mi">260879</span>  <span class="n">Michael</span>   <span class="n">M</span>   <span class="mi">17133</span>  <span class="mi">2010</span>  <span class="mf">0.009025</span>
</span></span><span class="line"><span class="cl"><span class="mi">260880</span>   <span class="n">Jayden</span>   <span class="n">M</span>   <span class="mi">17030</span>  <span class="mi">2010</span>  <span class="mf">0.008971</span>
</span></span><span class="line"><span class="cl"><span class="mi">260881</span>  <span class="n">William</span>   <span class="n">M</span>   <span class="mi">16870</span>  <span class="mi">2010</span>  <span class="mf">0.008887</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>         <span class="o">...</span>  <span class="o">..</span>     <span class="o">...</span>   <span class="o">...</span>       <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="mi">261872</span>   <span class="n">Camilo</span>   <span class="n">M</span>     <span class="mi">194</span>  <span class="mi">2010</span>  <span class="mf">0.000102</span>
</span></span><span class="line"><span class="cl"><span class="mi">261873</span>   <span class="n">Destin</span>   <span class="n">M</span>     <span class="mi">194</span>  <span class="mi">2010</span>  <span class="mf">0.000102</span>
</span></span><span class="line"><span class="cl"><span class="mi">261874</span>   <span class="n">Jaquan</span>   <span class="n">M</span>     <span class="mi">194</span>  <span class="mi">2010</span>  <span class="mf">0.000102</span>
</span></span><span class="line"><span class="cl"><span class="mi">261875</span>   <span class="n">Jaydan</span>   <span class="n">M</span>     <span class="mi">194</span>  <span class="mi">2010</span>  <span class="mf">0.000102</span>
</span></span><span class="line"><span class="cl"><span class="mi">261876</span>   <span class="n">Maxton</span>   <span class="n">M</span>     <span class="mi">193</span>  <span class="mi">2010</span>  <span class="mf">0.000102</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">1000</span> <span class="n">rows</span> <span class="n">x</span> <span class="mi">5</span> <span class="n">columns</span><span class="p">]</span>
</span></span></code></pre></div><p>在对<code>prop</code>降序排列之后，我们想知道前面多少个名字的人数加起来才够 50%。虽然编写一个<code>for</code>循环确实也能达到目的，但 NumPy 有一种更聪明的向量方式。先计算<code>prop</code>的累计和<code>cumsum</code>，然后再通过<code>searchsorted</code>方法找出 0.5 应该被插入在哪个位置才能保证不破坏顺序：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">120</span><span class="p">]:</span> <span class="n">prop_cumsum</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;prop&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">121</span><span class="p">]:</span> <span class="n">prop_cumsum</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">121</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">260877</span>    <span class="mf">0.011523</span>
</span></span><span class="line"><span class="cl"><span class="mi">260878</span>    <span class="mf">0.020934</span>
</span></span><span class="line"><span class="cl"><span class="mi">260879</span>    <span class="mf">0.029959</span>
</span></span><span class="line"><span class="cl"><span class="mi">260880</span>    <span class="mf">0.038930</span>
</span></span><span class="line"><span class="cl"><span class="mi">260881</span>    <span class="mf">0.047817</span>
</span></span><span class="line"><span class="cl"><span class="mi">260882</span>    <span class="mf">0.056579</span>
</span></span><span class="line"><span class="cl"><span class="mi">260883</span>    <span class="mf">0.065155</span>
</span></span><span class="line"><span class="cl"><span class="mi">260884</span>    <span class="mf">0.073414</span>
</span></span><span class="line"><span class="cl"><span class="mi">260885</span>    <span class="mf">0.081528</span>
</span></span><span class="line"><span class="cl"><span class="mi">260886</span>    <span class="mf">0.089621</span>
</span></span><span class="line"><span class="cl"><span class="n">Name</span><span class="p">:</span> <span class="n">prop</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">122</span><span class="p">]:</span> <span class="n">prop_cumsum</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">122</span><span class="p">]:</span> <span class="mi">116</span>
</span></span></code></pre></div><p>由于数组索引是从 0 开始的，因此我们要给这个结果加 1，即最终结果为 117。拿 1900 年的数据来做个比较，这个数字要小得多：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">123</span><span class="p">]:</span> <span class="n">df</span> <span class="o">=</span> <span class="n">boys</span><span class="p">[</span><span class="n">boys</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="mi">1900</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">124</span><span class="p">]:</span> <span class="n">in1900</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;prop&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">125</span><span class="p">]:</span> <span class="n">in1900</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">125</span><span class="p">]:</span> <span class="mi">25</span>
</span></span></code></pre></div><p>现在就可以对所有<code>year/sex</code>组合执行这个计算了。按这两个字段进行<code>groupby</code>处理，然后用一个函数计算各分组的这个值：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_quantile_count</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">group</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;prop&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">group</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">diversity</span> <span class="o">=</span> <span class="n">top1000</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_quantile_count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">diversity</span> <span class="o">=</span> <span class="n">diversity</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;sex&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>现在，<code>diversity</code>这个<code>DataFrame</code>拥有两个时间序列（每个性别各一个，按年度索引）。通过 IPython，你可以查看其内容，还可以像之前那样绘制图表（如图 14-7 所示）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">128</span><span class="p">]:</span> <span class="n">diversity</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">128</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">sex</span>    <span class="n">F</span>   <span class="n">M</span>
</span></span><span class="line"><span class="cl"><span class="n">year</span>        
</span></span><span class="line"><span class="cl"><span class="mi">1880</span>  <span class="mi">38</span>  <span class="mi">14</span>
</span></span><span class="line"><span class="cl"><span class="mi">1881</span>  <span class="mi">38</span>  <span class="mi">14</span>
</span></span><span class="line"><span class="cl"><span class="mi">1882</span>  <span class="mi">38</span>  <span class="mi">15</span>
</span></span><span class="line"><span class="cl"><span class="mi">1883</span>  <span class="mi">39</span>  <span class="mi">15</span>
</span></span><span class="line"><span class="cl"><span class="mi">1884</span>  <span class="mi">39</span>  <span class="mi">16</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">129</span><span class="p">]:</span> <span class="n">diversity</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&#34;Number of popular names in top 50%&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-574b53a383cad681.png"
        data-srcset="img/7178691-574b53a383cad681.png, img/7178691-574b53a383cad681.png 1.5x, img/7178691-574b53a383cad681.png 2x"
        data-sizes="auto"
        alt="img/7178691-574b53a383cad681.png"
        title="图 14-7 按年度统计的密度表" /></p>
<p>从图中可以看出，女孩名字的多样性总是比男孩的高，而且还在变得越来越高。读者们可以自己分析一下具体是什么在驱动这个多样性（比如拼写形式的变化）。</p>
<h2 id="最后一个字母的变革">“最后一个字母”的变革</h2>
<p>2007 年，一名婴儿姓名研究人员 Laura Wattenberg 在她<a href="http://www.babynamewizard.com" target="_blank" rel="noopener noreffer ">自己的网站</a>上指出：近百年来，男孩名字在最后一个字母上的分布发生了显著的变化。为了了解具体的情况，我首先将全部出生数据在年度、性别以及末字母上进行了聚合：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># extract last letter from name column</span>
</span></span><span class="line"><span class="cl"><span class="n">get_last_letter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">last_letters</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">get_last_letter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">last_letters</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;last_letter&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">table</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="s1">&#39;births&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">last_letters</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">],</span> <span class="n">aggfunc</span><span class="o">=</span><span class="nb">sum</span><span class="p">)</span>
</span></span></code></pre></div><p>然后，我选出具有一定代表性的三年，并输出前面几行：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">131</span><span class="p">]:</span> <span class="n">subtable</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="mi">1910</span><span class="p">,</span> <span class="mi">1960</span><span class="p">,</span> <span class="mi">2010</span><span class="p">],</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">132</span><span class="p">]:</span> <span class="n">subtable</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">132</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">sex</span>                 <span class="n">F</span>                            <span class="n">M</span>                    
</span></span><span class="line"><span class="cl"><span class="n">year</span>             <span class="mi">1910</span>      <span class="mi">1960</span>      <span class="mi">2010</span>     <span class="mi">1910</span>      <span class="mi">1960</span>      <span class="mi">2010</span>
</span></span><span class="line"><span class="cl"><span class="n">last_letter</span>                                                           
</span></span><span class="line"><span class="cl"><span class="n">a</span>            <span class="mf">108376.0</span>  <span class="mf">691247.0</span>  <span class="mf">670605.0</span>    <span class="mf">977.0</span>    <span class="mf">5204.0</span>   <span class="mf">28438.0</span>
</span></span><span class="line"><span class="cl"><span class="n">b</span>                 <span class="n">NaN</span>     <span class="mf">694.0</span>     <span class="mf">450.0</span>    <span class="mf">411.0</span>    <span class="mf">3912.0</span>   <span class="mf">38859.0</span>
</span></span><span class="line"><span class="cl"><span class="n">c</span>                 <span class="mf">5.0</span>      <span class="mf">49.0</span>     <span class="mf">946.0</span>    <span class="mf">482.0</span>   <span class="mf">15476.0</span>   <span class="mf">23125.0</span>
</span></span><span class="line"><span class="cl"><span class="n">d</span>              <span class="mf">6750.0</span>    <span class="mf">3729.0</span>    <span class="mf">2607.0</span>  <span class="mf">22111.0</span>  <span class="mf">262112.0</span>   <span class="mf">44398.0</span>
</span></span><span class="line"><span class="cl"><span class="n">e</span>            <span class="mf">133569.0</span>  <span class="mf">435013.0</span>  <span class="mf">313833.0</span>  <span class="mf">28655.0</span>  <span class="mf">178823.0</span>  <span class="mf">129012.0</span>
</span></span></code></pre></div><p>接下来我们需要按总出生数对该表进行规范化处理，以便计算出各性别各末字母占总出生人数的比例：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">133</span><span class="p">]:</span> <span class="n">subtable</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">133</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">sex</span>  <span class="n">year</span>
</span></span><span class="line"><span class="cl"><span class="n">F</span>    <span class="mi">1910</span>     <span class="mf">396416.0</span>
</span></span><span class="line"><span class="cl">     <span class="mi">1960</span>    <span class="mf">2022062.0</span>
</span></span><span class="line"><span class="cl">     <span class="mi">2010</span>    <span class="mf">1759010.0</span>
</span></span><span class="line"><span class="cl"><span class="n">M</span>    <span class="mi">1910</span>     <span class="mf">194198.0</span>
</span></span><span class="line"><span class="cl">     <span class="mi">1960</span>    <span class="mf">2132588.0</span>
</span></span><span class="line"><span class="cl"><span class="mi">2010</span>    <span class="mf">1898382.0</span>
</span></span><span class="line"><span class="cl"><span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">134</span><span class="p">]:</span> <span class="n">letter_prop</span> <span class="o">=</span> <span class="n">subtable</span> <span class="o">/</span> <span class="n">subtable</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">135</span><span class="p">]:</span> <span class="n">letter_prop</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">135</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">sex</span>                 <span class="n">F</span>                             <span class="n">M</span>                    
</span></span><span class="line"><span class="cl"><span class="n">year</span>             <span class="mi">1910</span>      <span class="mi">1960</span>      <span class="mi">2010</span>      <span class="mi">1910</span>      <span class="mi">1960</span>      <span class="mi">2010</span>
</span></span><span class="line"><span class="cl"><span class="n">last_letter</span>                                                            
</span></span><span class="line"><span class="cl"><span class="n">a</span>            <span class="mf">0.273390</span>  <span class="mf">0.341853</span>  <span class="mf">0.381240</span>  <span class="mf">0.005031</span>  <span class="mf">0.002440</span>  <span class="mf">0.014980</span>
</span></span><span class="line"><span class="cl"><span class="n">b</span>                 <span class="n">NaN</span>  <span class="mf">0.000343</span>  <span class="mf">0.000256</span>  <span class="mf">0.002116</span>  <span class="mf">0.001834</span>  <span class="mf">0.020470</span>
</span></span><span class="line"><span class="cl"><span class="n">c</span>            <span class="mf">0.000013</span>  <span class="mf">0.000024</span>  <span class="mf">0.000538</span>  <span class="mf">0.002482</span>  <span class="mf">0.007257</span>  <span class="mf">0.012181</span>
</span></span><span class="line"><span class="cl"><span class="n">d</span>            <span class="mf">0.017028</span>  <span class="mf">0.001844</span>  <span class="mf">0.001482</span>  <span class="mf">0.113858</span>  <span class="mf">0.122908</span>  <span class="mf">0.023387</span>
</span></span><span class="line"><span class="cl"><span class="n">e</span>            <span class="mf">0.336941</span>  <span class="mf">0.215133</span>  <span class="mf">0.178415</span>  <span class="mf">0.147556</span>  <span class="mf">0.083853</span>  <span class="mf">0.067959</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>               <span class="o">...</span>       <span class="o">...</span>       <span class="o">...</span>       <span class="o">...</span>       <span class="o">...</span>       <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">v</span>                 <span class="n">NaN</span>  <span class="mf">0.000060</span>  <span class="mf">0.000117</span>  <span class="mf">0.000113</span>
</span></span><span class="line"><span class="cl"><span class="mf">0.000037</span>  <span class="mf">0.001434</span>
</span></span><span class="line"><span class="cl"><span class="n">w</span>            <span class="mf">0.000020</span>  <span class="mf">0.000031</span>  <span class="mf">0.001182</span>  <span class="mf">0.006329</span>  <span class="mf">0.007711</span>  <span class="mf">0.016148</span>
</span></span><span class="line"><span class="cl"><span class="n">x</span>            <span class="mf">0.000015</span>  <span class="mf">0.000037</span>  <span class="mf">0.000727</span>  <span class="mf">0.003965</span>  <span class="mf">0.001851</span>  <span class="mf">0.008614</span>
</span></span><span class="line"><span class="cl"><span class="n">y</span>            <span class="mf">0.110972</span>  <span class="mf">0.152569</span>  <span class="mf">0.116828</span>  <span class="mf">0.077349</span>  <span class="mf">0.160987</span>  <span class="mf">0.058168</span>
</span></span><span class="line"><span class="cl"><span class="n">z</span>            <span class="mf">0.002439</span>  <span class="mf">0.000659</span>  <span class="mf">0.000704</span>  <span class="mf">0.000170</span>  <span class="mf">0.000184</span>  <span class="mf">0.001831</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">26</span> <span class="n">rows</span> <span class="n">x</span> <span class="mi">6</span> <span class="n">columns</span><span class="p">]</span>
</span></span></code></pre></div><p>有了这个字母比例数据之后，就可以生成一张各年度各性别的条形图了，如图 14-8 所示：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">letter_prop</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">rot</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Male&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">letter_prop</span><span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">rot</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Female&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span></code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-67686f38e66ef5f1.png"
        data-srcset="img/7178691-67686f38e66ef5f1.png, img/7178691-67686f38e66ef5f1.png 1.5x, img/7178691-67686f38e66ef5f1.png 2x"
        data-sizes="auto"
        alt="img/7178691-67686f38e66ef5f1.png"
        title="图 14-8 男孩女孩名字中各个末字母的比例" /></p>
<p>可以看出，从 20 世纪 60 年代开始，以字母<code>&quot;n&quot;</code>结尾的男孩名字出现了显著的增长。回到之前创建的那个完整表，按年度和性别对其进行规范化处理，并在男孩名字中选取几个字母，最后进行转置以便将各个列做成一个时间序列：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">138</span><span class="p">]:</span> <span class="n">letter_prop</span> <span class="o">=</span> <span class="n">table</span> <span class="o">/</span> <span class="n">table</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">139</span><span class="p">]:</span> <span class="n">dny_ts</span> <span class="o">=</span> <span class="n">letter_prop</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="s1">&#39;M&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">140</span><span class="p">]:</span> <span class="n">dny_ts</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">140</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">last_letter</span>         <span class="n">d</span>         <span class="n">n</span>         <span class="n">y</span>
</span></span><span class="line"><span class="cl"><span class="n">year</span>                                     
</span></span><span class="line"><span class="cl"><span class="mi">1880</span>         <span class="mf">0.083055</span>  <span class="mf">0.153213</span>  <span class="mf">0.075760</span>
</span></span><span class="line"><span class="cl"><span class="mi">1881</span>         <span class="mf">0.083247</span>  <span class="mf">0.153214</span>  <span class="mf">0.077451</span>
</span></span><span class="line"><span class="cl"><span class="mi">1882</span>         <span class="mf">0.085340</span>  <span class="mf">0.149560</span>  <span class="mf">0.077537</span>
</span></span><span class="line"><span class="cl"><span class="mi">1883</span>         <span class="mf">0.084066</span>  <span class="mf">0.151646</span>  <span class="mf">0.079144</span>
</span></span><span class="line"><span class="cl"><span class="mi">1884</span>         <span class="mf">0.086120</span>  <span class="mf">0.149915</span>  <span class="mf">0.080405</span>
</span></span></code></pre></div><p>有了这个时间序列的<code>DataFrame</code>之后，就可以通过其<code>plot</code>方法绘制出一张趋势图了（如图 14-9 所示）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">143</span><span class="p">]:</span> <span class="n">dny_ts</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</span></span></code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-51c431b2490424c2.png"
        data-srcset="img/7178691-51c431b2490424c2.png, img/7178691-51c431b2490424c2.png 1.5x, img/7178691-51c431b2490424c2.png 2x"
        data-sizes="auto"
        alt="img/7178691-51c431b2490424c2.png"
        title="图 14-9 各年出生的男孩中名字以&lt;code&gt;d/n/y&lt;/code&gt;结尾的人数比例" /></p>
<h2 id="变成女孩名字的男孩名字以及相反的情况">变成女孩名字的男孩名字（以及相反的情况）</h2>
<p>另一个有趣的趋势是，早年流行于男孩的名字近年来“变性了”，例如 Lesley 或 Leslie。回到<code>top1000</code>数据集，找出其中以<code>&quot;lesl&quot;</code>开头的一组名字：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">144</span><span class="p">]:</span> <span class="n">all_names</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">top1000</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">145</span><span class="p">]:</span> <span class="n">lesley_like</span> <span class="o">=</span> <span class="n">all_names</span><span class="p">[</span><span class="n">all_names</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;lesl&#39;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">146</span><span class="p">]:</span> <span class="n">lesley_like</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">146</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">632</span>     <span class="n">Leslie</span>
</span></span><span class="line"><span class="cl"><span class="mi">2294</span>    <span class="n">Lesley</span>
</span></span><span class="line"><span class="cl"><span class="mi">4262</span>    <span class="n">Leslee</span>
</span></span><span class="line"><span class="cl"><span class="mi">4728</span>     <span class="n">Lesli</span>
</span></span><span class="line"><span class="cl"><span class="mi">6103</span>     <span class="n">Lesly</span>
</span></span><span class="line"><span class="cl"><span class="n">dtype</span><span class="p">:</span> <span class="nb">object</span>
</span></span></code></pre></div><p>然后利用这个结果过滤其他的名字，并按名字分组计算出生数以查看相对频率：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">147</span><span class="p">]:</span> <span class="n">filtered</span> <span class="o">=</span> <span class="n">top1000</span><span class="p">[</span><span class="n">top1000</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">lesley_like</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">148</span><span class="p">]:</span> <span class="n">filtered</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">births</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">148</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">name</span>
</span></span><span class="line"><span class="cl"><span class="n">Leslee</span>      <span class="mi">1082</span>
</span></span><span class="line"><span class="cl"><span class="n">Lesley</span>     <span class="mi">35022</span>
</span></span><span class="line"><span class="cl"><span class="n">Lesli</span>        <span class="mi">929</span>
</span></span><span class="line"><span class="cl"><span class="n">Leslie</span>    <span class="mi">370429</span>
</span></span><span class="line"><span class="cl"><span class="n">Lesly</span>      <span class="mi">10067</span>
</span></span><span class="line"><span class="cl"><span class="n">Name</span><span class="p">:</span> <span class="n">births</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</span></span></code></pre></div><p>接下来，我们按性别和年度进行聚合，并按年度进行规范化处理：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">149</span><span class="p">]:</span> <span class="n">table</span> <span class="o">=</span> <span class="n">filtered</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="s1">&#39;births&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="o">.....</span><span class="p">:</span>                              <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;sum&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">150</span><span class="p">]:</span> <span class="n">table</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">151</span><span class="p">]:</span> <span class="n">table</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">151</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">sex</span>     <span class="n">F</span>   <span class="n">M</span>
</span></span><span class="line"><span class="cl"><span class="n">year</span>         
</span></span><span class="line"><span class="cl"><span class="mi">2006</span>  <span class="mf">1.0</span> <span class="n">NaN</span>
</span></span><span class="line"><span class="cl"><span class="mi">2007</span>  <span class="mf">1.0</span> <span class="n">NaN</span>
</span></span><span class="line"><span class="cl"><span class="mi">2008</span>  <span class="mf">1.0</span> <span class="n">NaN</span>
</span></span><span class="line"><span class="cl"><span class="mi">2009</span>  <span class="mf">1.0</span> <span class="n">NaN</span>
</span></span><span class="line"><span class="cl"><span class="mi">2010</span>  <span class="mf">1.0</span> <span class="n">NaN</span>
</span></span></code></pre></div><p>最后，就可以轻松绘制一张分性别的年度曲线图了（如图 2-10 所示）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">153</span><span class="p">]:</span> <span class="n">table</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;M&#39;</span><span class="p">:</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">:</span> <span class="s1">&#39;k--&#39;</span><span class="p">})</span>
</span></span></code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-b99d98f8bb5fc695.png"
        data-srcset="img/7178691-b99d98f8bb5fc695.png, img/7178691-b99d98f8bb5fc695.png 1.5x, img/7178691-b99d98f8bb5fc695.png 2x"
        data-sizes="auto"
        alt="img/7178691-b99d98f8bb5fc695.png"
        title="图 14-10 各年度使用“Lesley 型”名字的男女比例" /></p>
<h1 id="144-usda-食品数据库">14.4 USDA 食品数据库</h1>
<p>美国农业部（USDA）制作了一份有关食物营养信息的数据库。Ashley Williams 制作了<a href="http://ashleyw.co.uk/project/food-nutrient-database" target="_blank" rel="noopener noreffer ">该数据的 JSON 版</a>。其中的记录如下所示：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">21441</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;KENTUCKY FRIED CHICKEN, Fried Chicken, EXTRA CRISPY,</span>
</span></span><span class="line"><span class="cl"><span class="n">Wing</span><span class="p">,</span> <span class="n">meat</span> <span class="ow">and</span> <span class="n">skin</span> <span class="k">with</span> <span class="n">breading</span><span class="s2">&#34;,</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;tags&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;KFC&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;manufacturer&#34;</span><span class="p">:</span> <span class="s2">&#34;Kentucky Fried Chicken&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;group&#34;</span><span class="p">:</span> <span class="s2">&#34;Fast Foods&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;portions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;amount&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;unit&#34;</span><span class="p">:</span> <span class="s2">&#34;wing, with skin&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;grams&#34;</span><span class="p">:</span> <span class="mf">68.0</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;nutrients&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;value&#34;</span><span class="p">:</span> <span class="mf">20.8</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;units&#34;</span><span class="p">:</span> <span class="s2">&#34;g&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Protein&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;group&#34;</span><span class="p">:</span> <span class="s2">&#34;Composition&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>每种食物都带有若干标识性属性以及两个有关营养成分和分量的列表。这种形式的数据不是很适合分析工作，因此我们需要做一些规整化以使其具有更好用的形式。</p>
<p>从上面列举的那个网址下载并解压数据之后，你可以用任何喜欢的 JSON 库将其加载到 Python 中。我用的是 Python 内置的<code>json</code>模块：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">154</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">155</span><span class="p">]:</span> <span class="n">db</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;datasets/usda_food/database.json&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">156</span><span class="p">]:</span> <span class="nb">len</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">156</span><span class="p">]:</span> <span class="mi">6636</span>
</span></span></code></pre></div><p><code>db</code>中的每个条目都是一个含有某种食物全部数据的字典。<code>nutrients</code>字段是一个字典列表，其中的每个字典对应一种营养成分：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">157</span><span class="p">]:</span> <span class="n">db</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">157</span><span class="p">]:</span> <span class="n">dict_keys</span><span class="p">([</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="s1">&#39;manufacturer&#39;</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;porti</span>
</span></span><span class="line"><span class="cl"><span class="n">ons</span><span class="s1">&#39;, &#39;</span><span class="n">nutrients</span><span class="s1">&#39;])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">158</span><span class="p">]:</span> <span class="n">db</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;nutrients&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">158</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Protein&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;Composition&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mf">25.18</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">159</span><span class="p">]:</span> <span class="n">nutrients</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;nutrients&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">160</span><span class="p">]:</span> <span class="n">nutrients</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">160</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl">                   <span class="n">description</span>        <span class="n">group</span> <span class="n">units</span>    <span class="n">value</span>
</span></span><span class="line"><span class="cl"><span class="mi">0</span>                      <span class="n">Protein</span>  <span class="n">Composition</span>     <span class="n">g</span>    <span class="mf">25.18</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span>            <span class="n">Total</span> <span class="n">lipid</span> <span class="p">(</span><span class="n">fat</span><span class="p">)</span>  <span class="n">Composition</span>     <span class="n">g</span>    <span class="mf">29.20</span>
</span></span><span class="line"><span class="cl"><span class="mi">2</span>  <span class="n">Carbohydrate</span><span class="p">,</span> <span class="n">by</span> <span class="n">difference</span>  <span class="n">Composition</span>     <span class="n">g</span>     <span class="mf">3.06</span>
</span></span><span class="line"><span class="cl"><span class="mi">3</span>                          <span class="n">Ash</span>        <span class="n">Other</span>     <span class="n">g</span>     <span class="mf">3.28</span>
</span></span><span class="line"><span class="cl"><span class="mi">4</span>                       <span class="n">Energy</span>       <span class="n">Energy</span>  <span class="n">kcal</span>   <span class="mf">376.00</span>
</span></span><span class="line"><span class="cl"><span class="mi">5</span>                        <span class="n">Water</span>  <span class="n">Composition</span>     <span class="n">g</span>    <span class="mf">39.28</span>
</span></span><span class="line"><span class="cl"><span class="mi">6</span>                       <span class="n">Energy</span>       <span class="n">Energy</span>    <span class="n">kJ</span>  <span class="mf">1573.00</span>
</span></span></code></pre></div><p>在将字典列表转换为<code>DataFrame</code>时，可以只抽取其中的一部分字段。这里，我们将取出食物的名称、分类、编号以及制造商等信息：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">161</span><span class="p">]:</span> <span class="n">info_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;manufacturer&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">162</span><span class="p">]:</span> <span class="n">info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">info_keys</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">163</span><span class="p">]:</span> <span class="n">info</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">163</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl">                          <span class="n">description</span>                   <span class="n">group</span>    <span class="nb">id</span>  \
</span></span><span class="line"><span class="cl"><span class="mi">0</span>                     <span class="n">Cheese</span><span class="p">,</span> <span class="n">caraway</span>  <span class="n">Dairy</span> <span class="ow">and</span> <span class="n">Egg</span> <span class="n">Products</span>  <span class="mi">1008</span>   
</span></span><span class="line"><span class="cl"><span class="mi">1</span>                     <span class="n">Cheese</span><span class="p">,</span> <span class="n">cheddar</span>  <span class="n">Dairy</span> <span class="ow">and</span> <span class="n">Egg</span> <span class="n">Products</span>  <span class="mi">1009</span>
</span></span><span class="line"><span class="cl"><span class="mi">2</span>                        <span class="n">Cheese</span><span class="p">,</span> <span class="n">edam</span>  <span class="n">Dairy</span> <span class="ow">and</span> <span class="n">Egg</span> <span class="n">Products</span>  <span class="mi">1018</span>   
</span></span><span class="line"><span class="cl"><span class="mi">3</span>                        <span class="n">Cheese</span><span class="p">,</span> <span class="n">feta</span>  <span class="n">Dairy</span> <span class="ow">and</span> <span class="n">Egg</span> <span class="n">Products</span>  <span class="mi">1019</span>   
</span></span><span class="line"><span class="cl"><span class="mi">4</span>  <span class="n">Cheese</span><span class="p">,</span> <span class="n">mozzarella</span><span class="p">,</span> <span class="n">part</span> <span class="n">skim</span> <span class="n">milk</span>  <span class="n">Dairy</span> <span class="ow">and</span> <span class="n">Egg</span> <span class="n">Products</span>  <span class="mi">1028</span>   
</span></span><span class="line"><span class="cl">  <span class="n">manufacturer</span>  
</span></span><span class="line"><span class="cl"><span class="mi">0</span>               
</span></span><span class="line"><span class="cl"><span class="mi">1</span>               
</span></span><span class="line"><span class="cl"><span class="mi">2</span>               
</span></span><span class="line"><span class="cl"><span class="mi">3</span>               
</span></span><span class="line"><span class="cl"><span class="mi">4</span>               
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">164</span><span class="p">]:</span> <span class="n">info</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="s1">&#39;&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n">RangeIndex</span><span class="p">:</span> <span class="mi">6636</span> <span class="n">entries</span><span class="p">,</span> <span class="mi">0</span> <span class="n">to</span> <span class="mi">6635</span>
</span></span><span class="line"><span class="cl"><span class="n">Data</span> <span class="n">columns</span> <span class="p">(</span><span class="n">total</span> <span class="mi">4</span> <span class="n">columns</span><span class="p">):</span>
</span></span><span class="line"><span class="cl"><span class="n">description</span>     <span class="mi">6636</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">group</span>           <span class="mi">6636</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="nb">id</span>              <span class="mi">6636</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="n">int64</span>
</span></span><span class="line"><span class="cl"><span class="n">manufacturer</span>    <span class="mi">5195</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">dtypes</span><span class="p">:</span> <span class="n">int64</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nb">object</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">memory</span> <span class="n">usage</span><span class="p">:</span> <span class="mf">207.5</span><span class="o">+</span> <span class="n">KB</span>
</span></span></code></pre></div><p>通过<code>value_counts</code>，你可以查看食物类别的分布情况：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">165</span><span class="p">]:</span> <span class="n">pd</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">group</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">165</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">Vegetables</span> <span class="ow">and</span> <span class="n">Vegetable</span> <span class="n">Products</span>    <span class="mi">812</span>
</span></span><span class="line"><span class="cl"><span class="n">Beef</span> <span class="n">Products</span>                        <span class="mi">618</span>
</span></span><span class="line"><span class="cl"><span class="n">Baked</span> <span class="n">Products</span>                       <span class="mi">496</span>
</span></span><span class="line"><span class="cl"><span class="n">Breakfast</span> <span class="n">Cereals</span>                    <span class="mi">403</span>
</span></span><span class="line"><span class="cl"><span class="n">Fast</span> <span class="n">Foods</span>                           <span class="mi">365</span>
</span></span><span class="line"><span class="cl"><span class="n">Legumes</span> <span class="ow">and</span> <span class="n">Legume</span> <span class="n">Products</span>          <span class="mi">365</span>
</span></span><span class="line"><span class="cl"><span class="n">Lamb</span><span class="p">,</span> <span class="n">Veal</span><span class="p">,</span> <span class="ow">and</span> <span class="n">Game</span> <span class="n">Products</span>        <span class="mi">345</span>
</span></span><span class="line"><span class="cl"><span class="n">Sweets</span>                               <span class="mi">341</span>
</span></span><span class="line"><span class="cl"><span class="n">Pork</span> <span class="n">Products</span>                        <span class="mi">328</span>
</span></span><span class="line"><span class="cl"><span class="n">Fruits</span> <span class="ow">and</span> <span class="n">Fruit</span> <span class="n">Juices</span>              <span class="mi">328</span>
</span></span><span class="line"><span class="cl"><span class="n">Name</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</span></span></code></pre></div><p>现在，为了对全部营养数据做一些分析，最简单的办法是将所有食物的营养成分整合到一个大表中。我们分几个步骤来实现该目的。首先，将各食物的营养成分列表转换为一个<code>DataFrame</code>，并添加一个表示编号的列，然后将该<code>DataFrame</code>添加到一个列表中。最后通过<code>concat</code>将这些东西连接起来就可以了：</p>
<p>顺利的话，<code>nutrients</code>的结果是：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">167</span><span class="p">]:</span> <span class="n">nutrients</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">167</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl">                               <span class="n">description</span>        <span class="n">group</span> <span class="n">units</span>    <span class="n">value</span>     <span class="nb">id</span>
</span></span><span class="line"><span class="cl"><span class="mi">0</span>                                  <span class="n">Protein</span>  <span class="n">Composition</span>     <span class="n">g</span>   <span class="mf">25.180</span>   <span class="mi">1008</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span>                        <span class="n">Total</span> <span class="n">lipid</span> <span class="p">(</span><span class="n">fat</span><span class="p">)</span>  <span class="n">Composition</span>     <span class="n">g</span>   <span class="mf">29.200</span>   <span class="mi">1008</span>
</span></span><span class="line"><span class="cl"><span class="mi">2</span>              <span class="n">Carbohydrate</span><span class="p">,</span> <span class="n">by</span> <span class="n">difference</span>  <span class="n">Composition</span>     <span class="n">g</span>    <span class="mf">3.060</span>   <span class="mi">1008</span>
</span></span><span class="line"><span class="cl"><span class="mi">3</span>                                      <span class="n">Ash</span>        <span class="n">Other</span>     <span class="n">g</span>    <span class="mf">3.280</span>   <span class="mi">1008</span>
</span></span><span class="line"><span class="cl"><span class="mi">4</span>                                   <span class="n">Energy</span>       <span class="n">Energy</span>  <span class="n">kcal</span>  <span class="mf">376.000</span>   <span class="mi">1008</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>                                    <span class="o">...</span>          <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>      <span class="o">...</span>    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="mi">389350</span>                 <span class="n">Vitamin</span> <span class="n">B</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span> <span class="n">added</span>     <span class="n">Vitamins</span>   <span class="n">mcg</span>    <span class="mf">0.000</span>  <span class="mi">43546</span>
</span></span><span class="line"><span class="cl"><span class="mi">389351</span>                         <span class="n">Cholesterol</span>        <span class="n">Other</span>    <span class="n">mg</span>    <span class="mf">0.000</span>  <span class="mi">43546</span>
</span></span><span class="line"><span class="cl"><span class="mi">389352</span>        <span class="n">Fatty</span> <span class="n">acids</span><span class="p">,</span> <span class="n">total</span> <span class="n">saturated</span>        <span class="n">Other</span>     <span class="n">g</span>    <span class="mf">0.072</span>  <span class="mi">43546</span>
</span></span><span class="line"><span class="cl"><span class="mi">389353</span>  <span class="n">Fatty</span> <span class="n">acids</span><span class="p">,</span> <span class="n">total</span> <span class="n">monounsaturated</span>        <span class="n">Other</span>     <span class="n">g</span>    <span class="mf">0.028</span>  <span class="mi">43546</span>
</span></span><span class="line"><span class="cl"><span class="mi">389354</span>  <span class="n">Fatty</span> <span class="n">acids</span><span class="p">,</span> <span class="n">total</span> <span class="n">polyunsaturated</span>        <span class="n">Other</span>     <span class="n">g</span>    <span class="mf">0.041</span>  <span class="mi">43546</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">389355</span> <span class="n">rows</span> <span class="n">x</span> <span class="mi">5</span> <span class="n">columns</span><span class="p">]</span>
</span></span></code></pre></div><p>我发现这个<code>DataFrame</code>中无论如何都会有一些重复项，所以直接丢弃就可以了：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">168</span><span class="p">]:</span> <span class="n">nutrients</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># number of duplicates</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">168</span><span class="p">]:</span> <span class="mi">14179</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">169</span><span class="p">]:</span> <span class="n">nutrients</span> <span class="o">=</span> <span class="n">nutrients</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
</span></span></code></pre></div><p>由于两个<code>DataFrame</code>对象中都有&quot;group&quot;和&quot;description&quot;，所以为了明确到底谁是谁，我们需要对它们进行重命名：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">170</span><span class="p">]:</span> <span class="n">col_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;description&#39;</span> <span class="p">:</span> <span class="s1">&#39;food&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="o">.....</span><span class="p">:</span>                <span class="s1">&#39;group&#39;</span>       <span class="p">:</span> <span class="s1">&#39;fgroup&#39;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">171</span><span class="p">]:</span> <span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">col_mapping</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">172</span><span class="p">]:</span> <span class="n">info</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="s1">&#39;&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n">RangeIndex</span><span class="p">:</span> <span class="mi">6636</span> <span class="n">entries</span><span class="p">,</span> <span class="mi">0</span> <span class="n">to</span> <span class="mi">6635</span>
</span></span><span class="line"><span class="cl"><span class="n">Data</span> <span class="n">columns</span> <span class="p">(</span><span class="n">total</span> <span class="mi">4</span> <span class="n">columns</span><span class="p">):</span>
</span></span><span class="line"><span class="cl"><span class="n">food</span>            <span class="mi">6636</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">fgroup</span>          <span class="mi">6636</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="nb">id</span>              <span class="mi">6636</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="n">int64</span>
</span></span><span class="line"><span class="cl"><span class="n">manufacturer</span>    <span class="mi">5195</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">dtypes</span><span class="p">:</span> <span class="n">int64</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nb">object</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">memory</span> <span class="n">usage</span><span class="p">:</span> <span class="mf">207.5</span><span class="o">+</span> <span class="n">KB</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">173</span><span class="p">]:</span> <span class="n">col_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;description&#39;</span> <span class="p">:</span> <span class="s1">&#39;nutrient&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="o">.....</span><span class="p">:</span>                <span class="s1">&#39;group&#39;</span> <span class="p">:</span> <span class="s1">&#39;nutgroup&#39;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">174</span><span class="p">]:</span> <span class="n">nutrients</span> <span class="o">=</span> <span class="n">nutrients</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">col_mapping</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">175</span><span class="p">]:</span> <span class="n">nutrients</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">175</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl">                                  <span class="n">nutrient</span>     <span class="n">nutgroup</span> <span class="n">units</span>    <span class="n">value</span>     <span class="nb">id</span>
</span></span><span class="line"><span class="cl"><span class="mi">0</span>                                  <span class="n">Protein</span>  <span class="n">Composition</span>     <span class="n">g</span>   <span class="mf">25.180</span>   <span class="mi">1008</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span>                        <span class="n">Total</span> <span class="n">lipid</span> <span class="p">(</span><span class="n">fat</span><span class="p">)</span>  <span class="n">Composition</span>     <span class="n">g</span>   <span class="mf">29.200</span>   <span class="mi">1008</span>
</span></span><span class="line"><span class="cl"><span class="mi">2</span>              <span class="n">Carbohydrate</span><span class="p">,</span> <span class="n">by</span> <span class="n">difference</span>  <span class="n">Composition</span>     <span class="n">g</span>    <span class="mf">3.060</span>   <span class="mi">1008</span>
</span></span><span class="line"><span class="cl"><span class="mi">3</span>                                      <span class="n">Ash</span>        <span class="n">Other</span>     <span class="n">g</span>    <span class="mf">3.280</span>   <span class="mi">1008</span>
</span></span><span class="line"><span class="cl"><span class="mi">4</span>                                   <span class="n">Energy</span>       <span class="n">Energy</span>  <span class="n">kcal</span>  <span class="mf">376.000</span>   <span class="mi">1008</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>                                    <span class="o">...</span>          <span class="o">...</span>   <span class="o">...</span>      <span class="o">...</span>    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="mi">389350</span>                 <span class="n">Vitamin</span> <span class="n">B</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span> <span class="n">added</span>     <span class="n">Vitamins</span>   <span class="n">mcg</span>    <span class="mf">0.000</span>  <span class="mi">43546</span>
</span></span><span class="line"><span class="cl"><span class="mi">389351</span>                         <span class="n">Cholesterol</span>        <span class="n">Other</span>    <span class="n">mg</span>    <span class="mf">0.000</span>  <span class="mi">43546</span>
</span></span><span class="line"><span class="cl"><span class="mi">389352</span>        <span class="n">Fatty</span> <span class="n">acids</span><span class="p">,</span> <span class="n">total</span> <span class="n">saturated</span>        <span class="n">Other</span>     <span class="n">g</span>    <span class="mf">0.072</span>  <span class="mi">43546</span>
</span></span><span class="line"><span class="cl"><span class="mi">389353</span>  <span class="n">Fatty</span> <span class="n">acids</span><span class="p">,</span> <span class="n">total</span> <span class="n">monounsaturated</span>        <span class="n">Other</span>     <span class="n">g</span>    <span class="mf">0.028</span>  <span class="mi">43546</span>
</span></span><span class="line"><span class="cl"><span class="mi">389354</span>  <span class="n">Fatty</span> <span class="n">acids</span><span class="p">,</span> <span class="n">total</span> <span class="n">polyunsaturated</span>        <span class="n">Other</span>     <span class="n">g</span>    <span class="mf">0.041</span>  <span class="mi">43546</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">375176</span> <span class="n">rows</span> <span class="n">x</span> <span class="mi">5</span> <span class="n">columns</span><span class="p">]</span>
</span></span></code></pre></div><p>做完这些，就可以将<code>info</code>跟<code>nutrients</code>合并起来：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">176</span><span class="p">]:</span> <span class="n">ndata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">nutrients</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">177</span><span class="p">]:</span> <span class="n">ndata</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="s1">&#39;&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n">Int64Index</span><span class="p">:</span> <span class="mi">375176</span> <span class="n">entries</span><span class="p">,</span> <span class="mi">0</span> <span class="n">to</span> <span class="mi">375175</span>
</span></span><span class="line"><span class="cl"><span class="n">Data</span> <span class="n">columns</span> <span class="p">(</span><span class="n">total</span> <span class="mi">8</span> <span class="n">columns</span><span class="p">):</span>
</span></span><span class="line"><span class="cl"><span class="n">nutrient</span>        <span class="mi">375176</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">nutgroup</span>        <span class="mi">375176</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">units</span>           <span class="mi">375176</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">value</span>           <span class="mi">375176</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="n">float64</span>
</span></span><span class="line"><span class="cl"><span class="nb">id</span>              <span class="mi">375176</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="n">int64</span>
</span></span><span class="line"><span class="cl"><span class="n">food</span>            <span class="mi">375176</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">fgroup</span>          <span class="mi">375176</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">manufacturer</span>    <span class="mi">293054</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">dtypes</span><span class="p">:</span> <span class="n">float64</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">int64</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nb">object</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">memory</span> <span class="n">usage</span><span class="p">:</span> <span class="mf">25.8</span><span class="o">+</span> <span class="n">MB</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">178</span><span class="p">]:</span> <span class="n">ndata</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">30000</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">178</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">nutrient</span>                                       <span class="n">Glycine</span>
</span></span><span class="line"><span class="cl"><span class="n">nutgroup</span>                                   <span class="n">Amino</span> <span class="n">Acids</span>
</span></span><span class="line"><span class="cl"><span class="n">units</span>                                                <span class="n">g</span>
</span></span><span class="line"><span class="cl"><span class="n">value</span>                                             <span class="mf">0.04</span>
</span></span><span class="line"><span class="cl"><span class="nb">id</span>                                                <span class="mi">6158</span>
</span></span><span class="line"><span class="cl"><span class="n">food</span>            <span class="n">Soup</span><span class="p">,</span> <span class="n">tomato</span> <span class="n">bisque</span><span class="p">,</span> <span class="n">canned</span><span class="p">,</span> <span class="n">condensed</span>
</span></span><span class="line"><span class="cl"><span class="n">fgroup</span>                      <span class="n">Soups</span><span class="p">,</span> <span class="n">Sauces</span><span class="p">,</span> <span class="ow">and</span> <span class="n">Gravies</span>
</span></span><span class="line"><span class="cl"><span class="n">manufacturer</span>                                          
</span></span><span class="line"><span class="cl"><span class="n">Name</span><span class="p">:</span> <span class="mi">30000</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">object</span>
</span></span></code></pre></div><p>我们现在可以根据食物分类和营养类型画出一张中位值图（如图 14-11 所示）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">180</span><span class="p">]:</span> <span class="n">result</span> <span class="o">=</span> <span class="n">ndata</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;nutrient&#39;</span><span class="p">,</span> <span class="s1">&#39;fgroup&#39;</span><span class="p">])[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">181</span><span class="p">]:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Zinc, Zn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;barh&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-99b176d022a444c0.png"
        data-srcset="img/7178691-99b176d022a444c0.png, img/7178691-99b176d022a444c0.png 1.5x, img/7178691-99b176d022a444c0.png 2x"
        data-sizes="auto"
        alt="img/7178691-99b176d022a444c0.png"
        title="图片 14-11 根据营养分类得出的锌中位值" /></p>
<p>只要稍微动一动脑子，就可以发现各营养成分最为丰富的食物是什么了：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">by_nutrient</span> <span class="o">=</span> <span class="n">ndata</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;nutgroup&#39;</span><span class="p">,</span> <span class="s1">&#39;nutrient&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">get_maximum</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()]</span>
</span></span><span class="line"><span class="cl"><span class="n">get_minimum</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">max_foods</span> <span class="o">=</span> <span class="n">by_nutrient</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_maximum</span><span class="p">)[[</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;food&#39;</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># make the food a little smaller</span>
</span></span><span class="line"><span class="cl"><span class="n">max_foods</span><span class="o">.</span><span class="n">food</span> <span class="o">=</span> <span class="n">max_foods</span><span class="o">.</span><span class="n">food</span><span class="o">.</span><span class="n">str</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span>
</span></span></code></pre></div><p>由于得到的<code>DataFrame</code>很大，所以不方便在书里面全部打印出来。这里只给出&quot;Amino Acids&quot;营养分组：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">183</span><span class="p">]:</span> <span class="n">max_foods</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Amino Acids&#39;</span><span class="p">][</span><span class="s1">&#39;food&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">183</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">nutrient</span>
</span></span><span class="line"><span class="cl"><span class="n">Alanine</span>                          <span class="n">Gelatins</span><span class="p">,</span> <span class="n">dry</span> <span class="n">powder</span><span class="p">,</span> <span class="n">unsweetened</span>
</span></span><span class="line"><span class="cl"><span class="n">Arginine</span>                              <span class="n">Seeds</span><span class="p">,</span> <span class="n">sesame</span> <span class="n">flour</span><span class="p">,</span> <span class="n">low</span><span class="o">-</span><span class="n">fat</span>
</span></span><span class="line"><span class="cl"><span class="n">Aspartic</span> <span class="n">acid</span>                                  <span class="n">Soy</span> <span class="n">protein</span> <span class="n">isolate</span>
</span></span><span class="line"><span class="cl"><span class="n">Cystine</span>               <span class="n">Seeds</span><span class="p">,</span> <span class="n">cottonseed</span> <span class="n">flour</span><span class="p">,</span> <span class="n">low</span> <span class="n">fat</span> <span class="p">(</span><span class="n">glandless</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Glutamic</span> <span class="n">acid</span>                                  <span class="n">Soy</span> <span class="n">protein</span> <span class="n">isolate</span>
</span></span><span class="line"><span class="cl">                                       <span class="o">...</span>                        
</span></span><span class="line"><span class="cl"><span class="n">Serine</span>           <span class="n">Soy</span> <span class="n">protein</span> <span class="n">isolate</span><span class="p">,</span> <span class="n">PROTEIN</span> <span class="n">TECHNOLOGIES</span> <span class="n">INTE</span><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">Threonine</span>        <span class="n">Soy</span> <span class="n">protein</span> <span class="n">isolate</span><span class="p">,</span> <span class="n">PROTEIN</span> <span class="n">TECHNOLOGIES</span> <span class="n">INTE</span><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">Tryptophan</span>        <span class="n">Sea</span> <span class="n">lion</span><span class="p">,</span> <span class="n">Steller</span><span class="p">,</span> <span class="n">meat</span> <span class="k">with</span> <span class="n">fat</span> <span class="p">(</span><span class="n">Alaska</span> <span class="n">Native</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Tyrosine</span>         <span class="n">Soy</span> <span class="n">protein</span> <span class="n">isolate</span><span class="p">,</span> <span class="n">PROTEIN</span> <span class="n">TECHNOLOGIES</span> <span class="n">INTE</span><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">Valine</span>           <span class="n">Soy</span> <span class="n">protein</span> <span class="n">isolate</span><span class="p">,</span> <span class="n">PROTEIN</span> <span class="n">TECHNOLOGIES</span> <span class="n">INTE</span><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">Name</span><span class="p">:</span> <span class="n">food</span><span class="p">,</span> <span class="n">Length</span><span class="p">:</span> <span class="mi">19</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">object</span>
</span></span></code></pre></div><h1 id="145-2012-联邦选举委员会数据库">14.5 2012 联邦选举委员会数据库</h1>
<p>美国联邦选举委员会发布了有关政治竞选赞助方面的数据。其中包括赞助者的姓名、职业、雇主、地址以及出资额等信息。我们对 2012 年<a href="http://www.fec.gov/disclosurep/PDownload.do" target="_blank" rel="noopener noreffer ">美国总统大选的数据集</a>比较感兴趣。我在 2012 年 6 月下载的数据集是一个 150MB 的 CSV 文件（<code>P00000001-ALL.csv</code>），我们先用<code>pandas.read_csv</code>将其加载进来：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">184</span><span class="p">]:</span> <span class="n">fec</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;datasets/fec/P00000001-ALL.csv&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">185</span><span class="p">]:</span> <span class="n">fec</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="s1">&#39;&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n">RangeIndex</span><span class="p">:</span> <span class="mi">1001731</span> <span class="n">entries</span><span class="p">,</span> <span class="mi">0</span> <span class="n">to</span> <span class="mi">1001730</span>
</span></span><span class="line"><span class="cl"><span class="n">Data</span> <span class="n">columns</span> <span class="p">(</span><span class="n">total</span> <span class="mi">16</span> <span class="n">columns</span><span class="p">):</span>
</span></span><span class="line"><span class="cl"><span class="n">cmte_id</span>              <span class="mi">1001731</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">cand_id</span>              <span class="mi">1001731</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">cand_nm</span>              <span class="mi">1001731</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">contbr_nm</span>            <span class="mi">1001731</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">contbr_city</span>          <span class="mi">1001712</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">contbr_st</span>            <span class="mi">1001727</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">contbr_zip</span>           <span class="mi">1001620</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">contbr_employer</span>      <span class="mi">988002</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">contbr_occupation</span>    <span class="mi">993301</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">contb_receipt_amt</span>    <span class="mi">1001731</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="n">float64</span>
</span></span><span class="line"><span class="cl"><span class="n">contb_receipt_dt</span>     <span class="mi">1001731</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">receipt_desc</span>         <span class="mi">14166</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">memo_cd</span>              <span class="mi">92482</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">memo_text</span>            <span class="mi">97770</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">form_tp</span>              <span class="mi">1001731</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl"><span class="n">file_num</span>             <span class="mi">1001731</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="n">int64</span>
</span></span><span class="line"><span class="cl"><span class="n">dtypes</span><span class="p">:</span> <span class="n">float64</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">int64</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nb">object</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">memory</span> <span class="n">usage</span><span class="p">:</span> <span class="mf">122.3</span><span class="o">+</span> <span class="n">MB</span>
</span></span></code></pre></div><p>该<code>DataFrame</code>中的记录如下所示：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">186</span><span class="p">]:</span> <span class="n">fec</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">123456</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">186</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">cmte_id</span>             <span class="n">C00431445</span>
</span></span><span class="line"><span class="cl"><span class="n">cand_id</span>             <span class="n">P80003338</span>
</span></span><span class="line"><span class="cl"><span class="n">cand_nm</span>         <span class="n">Obama</span><span class="p">,</span> <span class="n">Barack</span>
</span></span><span class="line"><span class="cl"><span class="n">contbr_nm</span>         <span class="n">ELLMAN</span><span class="p">,</span> <span class="n">IRA</span>
</span></span><span class="line"><span class="cl"><span class="n">contbr_city</span>             <span class="n">TEMPE</span>
</span></span><span class="line"><span class="cl">                    <span class="o">...</span>      
</span></span><span class="line"><span class="cl"><span class="n">receipt_desc</span>              <span class="n">NaN</span>
</span></span><span class="line"><span class="cl"><span class="n">memo_cd</span>                   <span class="n">NaN</span>
</span></span><span class="line"><span class="cl"><span class="n">memo_text</span>                 <span class="n">NaN</span>
</span></span><span class="line"><span class="cl"><span class="n">form_tp</span>                 <span class="n">SA17A</span>
</span></span><span class="line"><span class="cl"><span class="n">file_num</span>               <span class="mi">772372</span>
</span></span><span class="line"><span class="cl"><span class="n">Name</span><span class="p">:</span> <span class="mi">123456</span><span class="p">,</span> <span class="n">Length</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">object</span>
</span></span></code></pre></div><p>你可能已经想出了许多办法从这些竞选赞助数据中抽取有关赞助人和赞助模式的统计信息。我将在接下来的内容中介绍几种不同的分析工作（运用到目前为止已经学到的方法）。</p>
<p>不难看出，该数据中没有党派信息，因此最好把它加进去。通过<code>unique</code>，你可以获取全部的候选人名单：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">187</span><span class="p">]:</span> <span class="n">unique_cands</span> <span class="o">=</span> <span class="n">fec</span><span class="o">.</span><span class="n">cand_nm</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">188</span><span class="p">]:</span> <span class="n">unique_cands</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">188</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([</span><span class="s1">&#39;Bachmann, Michelle&#39;</span><span class="p">,</span> <span class="s1">&#39;Romney, Mitt&#39;</span><span class="p">,</span> <span class="s1">&#39;Obama, Barack&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="s2">&#34;Roemer, Charles E. &#39;Buddy&#39; III&#34;</span><span class="p">,</span> <span class="s1">&#39;Pawlenty, Timothy&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="s1">&#39;Johnson, Gary Earl&#39;</span><span class="p">,</span> <span class="s1">&#39;Paul, Ron&#39;</span><span class="p">,</span> <span class="s1">&#39;Santorum, Rick&#39;</span><span class="p">,</span> <span class="s1">&#39;Cain, Herman&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="s1">&#39;Gingrich, Newt&#39;</span><span class="p">,</span> <span class="s1">&#39;McCotter, Thaddeus G&#39;</span><span class="p">,</span> <span class="s1">&#39;Huntsman, Jon&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="s1">&#39;Perry, Rick&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">189</span><span class="p">]:</span> <span class="n">unique_cands</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">189</span><span class="p">]:</span> <span class="s1">&#39;Obama, Barack&#39;</span>
</span></span></code></pre></div><p>指明党派信息的方法之一是使用字典：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">parties</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Bachmann, Michelle&#39;</span><span class="p">:</span> <span class="s1">&#39;Republican&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="s1">&#39;Cain, Herman&#39;</span><span class="p">:</span> <span class="s1">&#39;Republican&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="s1">&#39;Gingrich, Newt&#39;</span><span class="p">:</span> <span class="s1">&#39;Republican&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="s1">&#39;Huntsman, Jon&#39;</span><span class="p">:</span> <span class="s1">&#39;Republican&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="s1">&#39;Johnson, Gary Earl&#39;</span><span class="p">:</span> <span class="s1">&#39;Republican&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="s1">&#39;McCotter, Thaddeus G&#39;</span><span class="p">:</span> <span class="s1">&#39;Republican&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="s1">&#39;Obama, Barack&#39;</span><span class="p">:</span> <span class="s1">&#39;Democrat&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="s1">&#39;Paul, Ron&#39;</span><span class="p">:</span> <span class="s1">&#39;Republican&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="s1">&#39;Pawlenty, Timothy&#39;</span><span class="p">:</span> <span class="s1">&#39;Republican&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="s1">&#39;Perry, Rick&#39;</span><span class="p">:</span> <span class="s1">&#39;Republican&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="s2">&#34;Roemer, Charles E. &#39;Buddy&#39; III&#34;</span><span class="p">:</span> <span class="s1">&#39;Republican&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="s1">&#39;Romney, Mitt&#39;</span><span class="p">:</span> <span class="s1">&#39;Republican&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="s1">&#39;Santorum, Rick&#39;</span><span class="p">:</span> <span class="s1">&#39;Republican&#39;</span><span class="p">}</span>
</span></span></code></pre></div><p>现在，通过这个映射以及<code>Series</code>对象的<code>map</code>方法，你可以根据候选人姓名得到一组党派信息：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">191</span><span class="p">]:</span> <span class="n">fec</span><span class="o">.</span><span class="n">cand_nm</span><span class="p">[</span><span class="mi">123456</span><span class="p">:</span><span class="mi">123461</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">191</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">123456</span>    <span class="n">Obama</span><span class="p">,</span> <span class="n">Barack</span>
</span></span><span class="line"><span class="cl"><span class="mi">123457</span>    <span class="n">Obama</span><span class="p">,</span> <span class="n">Barack</span>
</span></span><span class="line"><span class="cl"><span class="mi">123458</span>    <span class="n">Obama</span><span class="p">,</span> <span class="n">Barack</span>
</span></span><span class="line"><span class="cl"><span class="mi">123459</span>    <span class="n">Obama</span><span class="p">,</span> <span class="n">Barack</span>
</span></span><span class="line"><span class="cl"><span class="mi">123460</span>    <span class="n">Obama</span><span class="p">,</span> <span class="n">Barack</span>
</span></span><span class="line"><span class="cl"><span class="n">Name</span><span class="p">:</span> <span class="n">cand_nm</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">192</span><span class="p">]:</span> <span class="n">fec</span><span class="o">.</span><span class="n">cand_nm</span><span class="p">[</span><span class="mi">123456</span><span class="p">:</span><span class="mi">123461</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">parties</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">192</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">123456</span>    <span class="n">Democrat</span>
</span></span><span class="line"><span class="cl"><span class="mi">123457</span>    <span class="n">Democrat</span>
</span></span><span class="line"><span class="cl"><span class="mi">123458</span>    <span class="n">Democrat</span>
</span></span><span class="line"><span class="cl"><span class="mi">123459</span>    <span class="n">Democrat</span>
</span></span><span class="line"><span class="cl"><span class="mi">123460</span>    <span class="n">Democrat</span>
</span></span><span class="line"><span class="cl"><span class="n">Name</span><span class="p">:</span> <span class="n">cand_nm</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">object</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add it as a column</span>
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">193</span><span class="p">]:</span> <span class="n">fec</span><span class="p">[</span><span class="s1">&#39;party&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fec</span><span class="o">.</span><span class="n">cand_nm</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">parties</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">194</span><span class="p">]:</span> <span class="n">fec</span><span class="p">[</span><span class="s1">&#39;party&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">194</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">Democrat</span>      <span class="mi">593746</span>
</span></span><span class="line"><span class="cl"><span class="n">Republican</span>    <span class="mi">407985</span>
</span></span><span class="line"><span class="cl"><span class="n">Name</span><span class="p">:</span> <span class="n">party</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</span></span></code></pre></div><p>这里有两个需要注意的地方。第一，该数据既包括赞助也包括退款（负的出资额）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">195</span><span class="p">]:</span> <span class="p">(</span><span class="n">fec</span><span class="o">.</span><span class="n">contb_receipt_amt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">195</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="kc">True</span>     <span class="mi">991475</span>
</span></span><span class="line"><span class="cl"><span class="kc">False</span>     <span class="mi">10256</span>
</span></span><span class="line"><span class="cl"><span class="n">Name</span><span class="p">:</span> <span class="n">contb_receipt_amt</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</span></span></code></pre></div><p>为了简化分析过程，我限定该数据集只能有正的出资额：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">196</span><span class="p">]:</span> <span class="n">fec</span> <span class="o">=</span> <span class="n">fec</span><span class="p">[</span><span class="n">fec</span><span class="o">.</span><span class="n">contb_receipt_amt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</span></span></code></pre></div><p>由于 Barack Obama 和 Mitt Romney 是最主要的两名候选人，所以我还专门准备了一个子集，只包含针对他们两人的竞选活动的赞助信息：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">197</span><span class="p">]:</span> <span class="n">fec_mrbo</span> <span class="o">=</span> <span class="n">fec</span><span class="p">[</span><span class="n">fec</span><span class="o">.</span><span class="n">cand_nm</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;Obama, Barack&#39;</span><span class="p">,</span><span class="s1">&#39;Romney, Mitt&#39;</span><span class="p">])]</span>
</span></span></code></pre></div><h2 id="根据职业和雇主统计赞助信息">根据职业和雇主统计赞助信息</h2>
<p>基于职业的赞助信息统计是另一种经常被研究的统计任务。例如，律师们更倾向于资助民主党，而企业主则更倾向于资助共和党。你可以不相信我，自己看那些数据就知道了。首先，根据职业计算出资总额，这很简单：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">198</span><span class="p">]:</span> <span class="n">fec</span><span class="o">.</span><span class="n">contbr_occupation</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()[:</span><span class="mi">10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">198</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">RETIRED</span>                                   <span class="mi">233990</span>
</span></span><span class="line"><span class="cl"><span class="n">INFORMATION</span> <span class="n">REQUESTED</span>                      <span class="mi">35107</span>
</span></span><span class="line"><span class="cl"><span class="n">ATTORNEY</span>                                   <span class="mi">34286</span>
</span></span><span class="line"><span class="cl"><span class="n">HOMEMAKER</span>                                  <span class="mi">29931</span>
</span></span><span class="line"><span class="cl"><span class="n">PHYSICIAN</span>                                  <span class="mi">23432</span>
</span></span><span class="line"><span class="cl"><span class="n">INFORMATION</span> <span class="n">REQUESTED</span> <span class="n">PER</span> <span class="n">BEST</span> <span class="n">EFFORTS</span>     <span class="mi">21138</span>
</span></span><span class="line"><span class="cl"><span class="n">ENGINEER</span>                                   <span class="mi">14334</span>
</span></span><span class="line"><span class="cl"><span class="n">TEACHER</span>                                    <span class="mi">13990</span>
</span></span><span class="line"><span class="cl"><span class="n">CONSULTANT</span>                                 <span class="mi">13273</span>
</span></span><span class="line"><span class="cl"><span class="n">PROFESSOR</span>                                  <span class="mi">12555</span>
</span></span><span class="line"><span class="cl"><span class="n">Name</span><span class="p">:</span> <span class="n">contbr_occupation</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</span></span></code></pre></div><p>不难看出，许多职业都涉及相同的基本工作类型，或者同一样东西有多种变体。下面的代码片段可以清理一些这样的数据（将一个职业信息映射到另一个）。注意，这里巧妙地利用了<code>dict.get</code>，它允许没有映射关系的职业也能“通过”：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">occ_mapping</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="s1">&#39;INFORMATION REQUESTED PER BEST EFFORTS&#39;</span> <span class="p">:</span> <span class="s1">&#39;NOT PROVIDED&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="s1">&#39;INFORMATION REQUESTED&#39;</span> <span class="p">:</span> <span class="s1">&#39;NOT PROVIDED&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="s1">&#39;INFORMATION REQUESTED (BEST EFFORTS)&#39;</span> <span class="p">:</span> <span class="s1">&#39;NOT PROVIDED&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="s1">&#39;C.E.O.&#39;</span><span class="p">:</span> <span class="s1">&#39;CEO&#39;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># If no mapping provided, return x</span>
</span></span><span class="line"><span class="cl"><span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">occ_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fec</span><span class="o">.</span><span class="n">contbr_occupation</span> <span class="o">=</span> <span class="n">fec</span><span class="o">.</span><span class="n">contbr_occupation</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span></span></code></pre></div><p>我对雇主信息也进行了同样的处理：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">emp_mapping</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="s1">&#39;INFORMATION REQUESTED PER BEST EFFORTS&#39;</span> <span class="p">:</span> <span class="s1">&#39;NOT PROVIDED&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="s1">&#39;INFORMATION REQUESTED&#39;</span> <span class="p">:</span> <span class="s1">&#39;NOT PROVIDED&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="s1">&#39;SELF&#39;</span> <span class="p">:</span> <span class="s1">&#39;SELF-EMPLOYED&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="s1">&#39;SELF EMPLOYED&#39;</span> <span class="p">:</span> <span class="s1">&#39;SELF-EMPLOYED&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># If no mapping provided, return x</span>
</span></span><span class="line"><span class="cl"><span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">emp_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fec</span><span class="o">.</span><span class="n">contbr_employer</span> <span class="o">=</span> <span class="n">fec</span><span class="o">.</span><span class="n">contbr_employer</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span></span></code></pre></div><p>现在，你可以通过<code>pivot_table</code>根据党派和职业对数据进行聚合，然后过滤掉总出资额不足 200 万美元的数据：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">201</span><span class="p">]:</span> <span class="n">by_occupation</span> <span class="o">=</span> <span class="n">fec</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="s1">&#39;contb_receipt_amt&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="o">.....</span><span class="p">:</span>                                 <span class="n">index</span><span class="o">=</span><span class="s1">&#39;contbr_occupation&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="o">.....</span><span class="p">:</span>                                 <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;party&#39;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;sum&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">202</span><span class="p">]:</span> <span class="n">over_2mm</span> <span class="o">=</span> <span class="n">by_occupation</span><span class="p">[</span><span class="n">by_occupation</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2000000</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">203</span><span class="p">]:</span> <span class="n">over_2mm</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">203</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">party</span>                 <span class="n">Democrat</span>    <span class="n">Republican</span>
</span></span><span class="line"><span class="cl"><span class="n">contbr_occupation</span>                           
</span></span><span class="line"><span class="cl"><span class="n">ATTORNEY</span>           <span class="mf">11141982.97</span>  <span class="mf">7.477194e+06</span>
</span></span><span class="line"><span class="cl"><span class="n">CEO</span>                 <span class="mf">2074974.79</span>  <span class="mf">4.211041e+06</span>
</span></span><span class="line"><span class="cl"><span class="n">CONSULTANT</span>          <span class="mf">2459912.71</span>  <span class="mf">2.544725e+06</span>
</span></span><span class="line"><span class="cl"><span class="n">ENGINEER</span>             <span class="mf">951525.55</span>  <span class="mf">1.818374e+06</span>
</span></span><span class="line"><span class="cl"><span class="n">EXECUTIVE</span>           <span class="mf">1355161.05</span>  <span class="mf">4.138850e+06</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>                        <span class="o">...</span>           <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">PRESIDENT</span>           <span class="mf">1878509.95</span>  <span class="mf">4.720924e+06</span>
</span></span><span class="line"><span class="cl"><span class="n">PROFESSOR</span>           <span class="mf">2165071.08</span>  <span class="mf">2.967027e+05</span>
</span></span><span class="line"><span class="cl"><span class="n">REAL</span> <span class="n">ESTATE</span>          <span class="mf">528902.09</span>  <span class="mf">1.625902e+06</span>
</span></span><span class="line"><span class="cl"><span class="n">RETIRED</span>            <span class="mf">25305116.38</span>  <span class="mf">2.356124e+07</span>
</span></span><span class="line"><span class="cl"><span class="n">SELF</span><span class="o">-</span><span class="n">EMPLOYED</span>        <span class="mf">672393.40</span>  <span class="mf">1.640253e+06</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">17</span> <span class="n">rows</span> <span class="n">x</span> <span class="mi">2</span> <span class="n">columns</span><span class="p">]</span>
</span></span></code></pre></div><p>把这些数据做成柱状图看起来会更加清楚（<code>'barh'</code>表示水平柱状图，如图 14-12 所示）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">205</span><span class="p">]:</span> <span class="n">over_2mm</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;barh&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-d2254e547c6ce537.png"
        data-srcset="img/7178691-d2254e547c6ce537.png, img/7178691-d2254e547c6ce537.png 1.5x, img/7178691-d2254e547c6ce537.png 2x"
        data-sizes="auto"
        alt="img/7178691-d2254e547c6ce537.png"
        title="图 14-12 对各党派总出资额最高的职业" /></p>
<p>你可能还想了解一下对 Obama 和 Romney 总出资额最高的职业和企业。为此，我们先对候选人进行分组，然后使用本章前面介绍的类似<code>top</code>的方法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_top_amounts</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">totals</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">key</span><span class="p">)[</span><span class="s1">&#39;contb_receipt_amt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">totals</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span></span></code></pre></div><p>然后根据职业和雇主进行聚合：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">207</span><span class="p">]:</span> <span class="n">grouped</span> <span class="o">=</span> <span class="n">fec_mrbo</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;cand_nm&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">208</span><span class="p">]:</span> <span class="n">grouped</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_top_amounts</span><span class="p">,</span> <span class="s1">&#39;contbr_occupation&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">208</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">cand_nm</span>        <span class="n">contbr_occupation</span>    
</span></span><span class="line"><span class="cl"><span class="n">Obama</span><span class="p">,</span> <span class="n">Barack</span>  <span class="n">RETIRED</span>                  <span class="mf">25305116.38</span>
</span></span><span class="line"><span class="cl">               <span class="n">ATTORNEY</span>                 <span class="mf">11141982.97</span>
</span></span><span class="line"><span class="cl">               <span class="n">INFORMATION</span> <span class="n">REQUESTED</span>     <span class="mf">4866973.96</span>
</span></span><span class="line"><span class="cl">               <span class="n">HOMEMAKER</span>                 <span class="mf">4248875.80</span>
</span></span><span class="line"><span class="cl">               <span class="n">PHYSICIAN</span>                 <span class="mf">3735124.94</span>
</span></span><span class="line"><span class="cl">                                           <span class="o">...</span>     
</span></span><span class="line"><span class="cl"><span class="n">Romney</span><span class="p">,</span> <span class="n">Mitt</span>   <span class="n">HOMEMAKER</span>                 <span class="mf">8147446.22</span>
</span></span><span class="line"><span class="cl">               <span class="n">ATTORNEY</span>                  <span class="mf">5364718.82</span>
</span></span><span class="line"><span class="cl">               <span class="n">PRESIDENT</span>                 <span class="mf">2491244.89</span>
</span></span><span class="line"><span class="cl">               <span class="n">EXECUTIVE</span>                 <span class="mf">2300947.03</span>
</span></span><span class="line"><span class="cl">               <span class="n">C</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">O</span><span class="o">.</span>                    <span class="mf">1968386.11</span>
</span></span><span class="line"><span class="cl"><span class="n">Name</span><span class="p">:</span> <span class="n">contb_receipt_amt</span><span class="p">,</span> <span class="n">Length</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">209</span><span class="p">]:</span> <span class="n">grouped</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_top_amounts</span><span class="p">,</span> <span class="s1">&#39;contbr_employer&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">209</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">cand_nm</span>        <span class="n">contbr_employer</span>      
</span></span><span class="line"><span class="cl"><span class="n">Obama</span><span class="p">,</span> <span class="n">Barack</span>  <span class="n">RETIRED</span>                  <span class="mf">22694358.85</span>
</span></span><span class="line"><span class="cl">               <span class="n">SELF</span><span class="o">-</span><span class="n">EMPLOYED</span>            <span class="mf">17080985.96</span>
</span></span><span class="line"><span class="cl">               <span class="n">NOT</span> <span class="n">EMPLOYED</span>              <span class="mf">8586308.70</span>
</span></span><span class="line"><span class="cl">               <span class="n">INFORMATION</span> <span class="n">REQUESTED</span>     <span class="mf">5053480.37</span>
</span></span><span class="line"><span class="cl">               <span class="n">HOMEMAKER</span>                 <span class="mf">2605408.54</span>
</span></span><span class="line"><span class="cl">                                           <span class="o">...</span>     
</span></span><span class="line"><span class="cl"><span class="n">Romney</span><span class="p">,</span> <span class="n">Mitt</span>   <span class="n">CREDIT</span> <span class="n">SUISSE</span>              <span class="mf">281150.00</span>
</span></span><span class="line"><span class="cl">               <span class="n">MORGAN</span> <span class="n">STANLEY</span>             <span class="mf">267266.00</span>
</span></span><span class="line"><span class="cl">               <span class="n">GOLDMAN</span> <span class="n">SACH</span> <span class="o">&amp;</span> <span class="n">CO</span><span class="o">.</span>         <span class="mf">238250.00</span>
</span></span><span class="line"><span class="cl">               <span class="n">BARCLAYS</span> <span class="n">CAPITAL</span>           <span class="mf">162750.00</span>
</span></span><span class="line"><span class="cl">               <span class="n">H</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">G</span><span class="o">.</span> <span class="n">CAPITAL</span>             <span class="mf">139500.00</span>
</span></span><span class="line"><span class="cl"><span class="n">Name</span><span class="p">:</span> <span class="n">contb_receipt_amt</span><span class="p">,</span> <span class="n">Length</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span></code></pre></div><h2 id="对出资额分组">对出资额分组</h2>
<p>还可以对该数据做另一种非常实用的分析：利用<code>cut</code>函数根据出资额的大小将数据离散化到多个面元中：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">210</span><span class="p">]:</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="o">.....</span><span class="p">:</span>                  <span class="mi">100000</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">,</span> <span class="mi">10000000</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">211</span><span class="p">]:</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">fec_mrbo</span><span class="o">.</span><span class="n">contb_receipt_amt</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">212</span><span class="p">]:</span> <span class="n">labels</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">212</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">411</span>         <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="mi">412</span>       <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="mi">413</span>       <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="mi">414</span>         <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="mi">415</span>         <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">             <span class="o">...</span>     
</span></span><span class="line"><span class="cl"><span class="mi">701381</span>      <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="mi">701382</span>    <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="mi">701383</span>        <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="mi">701384</span>      <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="mi">701385</span>    <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Name</span><span class="p">:</span> <span class="n">contb_receipt_amt</span><span class="p">,</span> <span class="n">Length</span><span class="p">:</span> <span class="mi">694282</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">category</span>
</span></span><span class="line"><span class="cl"><span class="n">Categories</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">interval</span><span class="p">[</span><span class="n">int64</span><span class="p">]):</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="mi">000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">]</span> <span class="o">&lt;</span>
</span></span><span class="line"><span class="cl">                                  <span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">100000</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">100000</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1000000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="mi">10000000</span><span class="p">]]</span>
</span></span></code></pre></div><p>现在可以根据候选人姓名以及面元标签对奥巴马和罗姆尼数据进行分组，以得到一个柱状图：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">213</span><span class="p">]:</span> <span class="n">grouped</span> <span class="o">=</span> <span class="n">fec_mrbo</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;cand_nm&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">214</span><span class="p">]:</span> <span class="n">grouped</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">214</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">cand_nm</span>              <span class="n">Obama</span><span class="p">,</span> <span class="n">Barack</span>  <span class="n">Romney</span><span class="p">,</span> <span class="n">Mitt</span>
</span></span><span class="line"><span class="cl"><span class="n">contb_receipt_amt</span>                               
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>                       <span class="mf">493.0</span>          <span class="mf">77.0</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>                    <span class="mf">40070.0</span>        <span class="mf">3681.0</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>                 <span class="mf">372280.0</span>       <span class="mf">31853.0</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]</span>               <span class="mf">153991.0</span>       <span class="mf">43357.0</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">]</span>              <span class="mf">22284.0</span>       <span class="mf">26186.0</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">100000</span><span class="p">]</span>                <span class="mf">2.0</span>           <span class="mf">1.0</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="mi">100000</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">]</span>              <span class="mf">3.0</span>           <span class="n">NaN</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="mi">1000000</span><span class="p">,</span> <span class="mi">10000000</span><span class="p">]</span>            <span class="mf">4.0</span>           <span class="n">NaN</span>
</span></span></code></pre></div><p>从这个数据中可以看出，在小额赞助方面，Obama 获得的数量比 Romney 多得多。你还可以对出资额求和并在面元内规格化，以便图形化显示两位候选人各种赞助额度的比例（见图 14-13）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">216</span><span class="p">]:</span> <span class="n">bucket_sums</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">contb_receipt_amt</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">217</span><span class="p">]:</span> <span class="n">normed_sums</span> <span class="o">=</span> <span class="n">bucket_sums</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">bucket_sums</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">218</span><span class="p">]:</span> <span class="n">normed_sums</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">218</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">cand_nm</span>              <span class="n">Obama</span><span class="p">,</span> <span class="n">Barack</span>  <span class="n">Romney</span><span class="p">,</span> <span class="n">Mitt</span>
</span></span><span class="line"><span class="cl"><span class="n">contb_receipt_amt</span>                               
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>                    <span class="mf">0.805182</span>      <span class="mf">0.194818</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>                   <span class="mf">0.918767</span>      <span class="mf">0.081233</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>                 <span class="mf">0.910769</span>      <span class="mf">0.089231</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]</span>               <span class="mf">0.710176</span>      <span class="mf">0.289824</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">]</span>             <span class="mf">0.447326</span>      <span class="mf">0.552674</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">100000</span><span class="p">]</span>           <span class="mf">0.823120</span>      <span class="mf">0.176880</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="mi">100000</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">]</span>         <span class="mf">1.000000</span>           <span class="n">NaN</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="mi">1000000</span><span class="p">,</span> <span class="mi">10000000</span><span class="p">]</span>       <span class="mf">1.000000</span>           <span class="n">NaN</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">219</span><span class="p">]:</span> <span class="n">normed_sums</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;barh&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-77e8c8d3c784692b.png"
        data-srcset="img/7178691-77e8c8d3c784692b.png, img/7178691-77e8c8d3c784692b.png 1.5x, img/7178691-77e8c8d3c784692b.png 2x"
        data-sizes="auto"
        alt="img/7178691-77e8c8d3c784692b.png"
        title="图 14-13 两位候选人收到的各种捐赠额度的总额比例" /></p>
<p>我排除了两个最大的面元，因为这些不是由个人捐赠的。</p>
<p>还可以对该分析过程做许多的提炼和改进。比如说，可以根据赞助人的姓名和邮编对数据进行聚合，以便找出哪些人进行了多次小额捐款，哪些人又进行了一次或多次大额捐款。我强烈建议你下载这些数据并自己摸索一下。</p>
<h2 id="根据州统计赞助信息">根据州统计赞助信息</h2>
<p>根据候选人和州对数据进行聚合是常规操作：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">220</span><span class="p">]:</span> <span class="n">grouped</span> <span class="o">=</span> <span class="n">fec_mrbo</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;cand_nm&#39;</span><span class="p">,</span> <span class="s1">&#39;contbr_st&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">221</span><span class="p">]:</span> <span class="n">totals</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">contb_receipt_amt</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">222</span><span class="p">]:</span> <span class="n">totals</span> <span class="o">=</span> <span class="n">totals</span><span class="p">[</span><span class="n">totals</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100000</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">223</span><span class="p">]:</span> <span class="n">totals</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">223</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">cand_nm</span>    <span class="n">Obama</span><span class="p">,</span> <span class="n">Barack</span>  <span class="n">Romney</span><span class="p">,</span> <span class="n">Mitt</span>
</span></span><span class="line"><span class="cl"><span class="n">contbr_st</span>                             
</span></span><span class="line"><span class="cl"><span class="n">AK</span>             <span class="mf">281840.15</span>      <span class="mf">86204.24</span>
</span></span><span class="line"><span class="cl"><span class="n">AL</span>             <span class="mf">543123.48</span>     <span class="mf">527303.51</span>
</span></span><span class="line"><span class="cl"><span class="n">AR</span>             <span class="mf">359247.28</span>     <span class="mf">105556.00</span>
</span></span><span class="line"><span class="cl"><span class="n">AZ</span>            <span class="mf">1506476.98</span>    <span class="mf">1888436.23</span>
</span></span><span class="line"><span class="cl"><span class="n">CA</span>           <span class="mf">23824984.24</span>   <span class="mf">11237636.60</span>
</span></span><span class="line"><span class="cl"><span class="n">CO</span>            <span class="mf">2132429.49</span>    <span class="mf">1506714.12</span>
</span></span><span class="line"><span class="cl"><span class="n">CT</span>            <span class="mf">2068291.26</span>    <span class="mf">3499475.45</span>
</span></span><span class="line"><span class="cl"><span class="n">DC</span>            <span class="mf">4373538.80</span>    <span class="mf">1025137.50</span>
</span></span><span class="line"><span class="cl"><span class="n">DE</span>             <span class="mf">336669.14</span>      <span class="mf">82712.00</span>
</span></span><span class="line"><span class="cl"><span class="n">FL</span>            <span class="mf">7318178.58</span>    <span class="mf">8338458.81</span>
</span></span></code></pre></div><p>如果对各行除以总赞助额，就会得到各候选人在各州的总赞助额比例：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">224</span><span class="p">]:</span> <span class="n">percent</span> <span class="o">=</span> <span class="n">totals</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">totals</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">225</span><span class="p">]:</span> <span class="n">percent</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">225</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">cand_nm</span>    <span class="n">Obama</span><span class="p">,</span> <span class="n">Barack</span>  <span class="n">Romney</span><span class="p">,</span> <span class="n">Mitt</span>
</span></span><span class="line"><span class="cl"><span class="n">contbr_st</span>                             
</span></span><span class="line"><span class="cl"><span class="n">AK</span>              <span class="mf">0.765778</span>      <span class="mf">0.234222</span>
</span></span><span class="line"><span class="cl"><span class="n">AL</span>              <span class="mf">0.507390</span>      <span class="mf">0.492610</span>
</span></span><span class="line"><span class="cl"><span class="n">AR</span>              <span class="mf">0.772902</span>      <span class="mf">0.227098</span>
</span></span><span class="line"><span class="cl"><span class="n">AZ</span>              <span class="mf">0.443745</span>      <span class="mf">0.556255</span>
</span></span><span class="line"><span class="cl"><span class="n">CA</span>              <span class="mf">0.679498</span>      <span class="mf">0.320502</span>
</span></span><span class="line"><span class="cl"><span class="n">CO</span>              <span class="mf">0.585970</span>      <span class="mf">0.414030</span>
</span></span><span class="line"><span class="cl"><span class="n">CT</span>              <span class="mf">0.371476</span>      <span class="mf">0.628524</span>
</span></span><span class="line"><span class="cl"><span class="n">DC</span>              <span class="mf">0.810113</span>      <span class="mf">0.189887</span>
</span></span><span class="line"><span class="cl"><span class="n">DE</span>              <span class="mf">0.802776</span>      <span class="mf">0.197224</span>
</span></span><span class="line"><span class="cl"><span class="n">FL</span>              <span class="mf">0.467417</span>      <span class="mf">0.532583</span>
</span></span></code></pre></div><h1 id="146-总结">14.6 总结</h1>
<p>我们已经完成了正文的最后一章。附录中有一些额外的内容，可能对你有用。</p>
<p>本书第一版出版已经有 5 年了，Python 已经成为了一个流行的、广泛使用的数据分析语言。你从本书中学到的方法，在相当长的一段时间都是可用的。我希望本书介绍的工具和库对你的工作有用。</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 0001-01-01</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="http://localhost:1313/posts/pyda-2e-zh/14/" data-title=""><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://localhost:1313/posts/pyda-2e-zh/14/"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="http://localhost:1313/posts/pyda-2e-zh/14/" data-title=""><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="http://localhost:1313/posts/pyda-2e-zh/14/" data-title=""><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="http://localhost:1313/posts/pyda-2e-zh/14/" data-title=""><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/pyda-2e-zh/2/" class="prev" rel="prev" title=""><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i></a>
            <a href="/posts/pyda-2e-zh/13/" class="next" rel="next" title=""><i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.118.2">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2022 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Aphros</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>

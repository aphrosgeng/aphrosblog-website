<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title> - Aphros的个人博客</title><meta name="Description" content="This is my cool site"><meta property="og:title" content="" />
<meta property="og:description" content="附录 A NumPy 高级应用 在这篇附录中，我会深入 NumPy 库的数组计算。这会包括ndarray更内部的细节，和更高级的数组操作和算法。 本章包括了一些杂乱的章节" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/pyda-2e-zh/a/" /><meta property="article:section" content="posts" />

<meta property="og:site_name" content="Aphros的博客" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content=""/>
<meta name="twitter:description" content="附录 A NumPy 高级应用 在这篇附录中，我会深入 NumPy 库的数组计算。这会包括ndarray更内部的细节，和更高级的数组操作和算法。 本章包括了一些杂乱的章节"/>
<meta name="application-name" content="Aphros的博客">
<meta name="apple-mobile-web-app-title" content="Aphros的博客"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://localhost:1313/posts/pyda-2e-zh/a/" /><link rel="prev" href="http://localhost:1313/posts/pyda-2e-zh/b/" /><link rel="next" href="http://localhost:1313/posts/pyda-2e-zh/9/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/localhost:1313\/posts\/pyda-2e-zh\/a\/"
        },"genre": "posts","wordcount":  12111 ,
        "url": "http:\/\/localhost:1313\/posts\/pyda-2e-zh\/a\/","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "Aphros"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Aphros的个人博客">Aphros的博客</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Aphros的个人博客">Aphros的博客</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX"></h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Aphros</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="0001-01-01">0001-01-01</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;12111 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;25 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#numpy-数据类型体系">NumPy 数据类型体系</a></li>
  </ul>

  <ul>
    <li><a href="#数组重塑">数组重塑</a></li>
    <li><a href="#c-和-fortran-顺序">C 和 Fortran 顺序</a></li>
    <li><a href="#数组的合并和拆分">数组的合并和拆分</a></li>
    <li><a href="#堆叠辅助类r_和c_">堆叠辅助类：<code>r_</code>和<code>c_</code></a></li>
    <li><a href="#元素的重复操作tile和repeat">元素的重复操作：<code>tile</code>和<code>repeat</code></a></li>
    <li><a href="#花式索引的等价函数take和put">花式索引的等价函数：<code>take</code>和<code>put</code></a></li>
  </ul>

  <ul>
    <li><a href="#沿其它轴向广播">沿其它轴向广播</a></li>
    <li><a href="#通过广播设置数组的值">通过广播设置数组的值</a></li>
  </ul>

  <ul>
    <li><a href="#ufunc实例方法"><code>ufunc</code>实例方法</a></li>
    <li><a href="#编写新的ufunc">编写新的<code>ufunc</code></a></li>
  </ul>

  <ul>
    <li><a href="#嵌套dtype和多维字段">嵌套<code>dtype</code>和多维字段</a></li>
    <li><a href="#为什么要用结构化数组">为什么要用结构化数组</a></li>
  </ul>

  <ul>
    <li><a href="#间接排序argsort和lexsort">间接排序：<code>argsort</code>和<code>lexsort</code></a></li>
    <li><a href="#其他排序算法">其他排序算法</a></li>
    <li><a href="#部分排序数组">部分排序数组</a></li>
    <li><a href="#numpysearchsorted在有序数组中查找元素"><code>numpy.searchsorted</code>：在有序数组中查找元素</a></li>
  </ul>

  <ul>
    <li><a href="#用-numba-创建自定义numpyufunc对象">用 Numba 创建自定义<code>numpy.ufunc</code>对象</a></li>
  </ul>

  <ul>
    <li><a href="#内存映像文件">内存映像文件</a></li>
    <li><a href="#hdf5-及其他数组存储方式">HDF5 及其他数组存储方式</a></li>
  </ul>

  <ul>
    <li><a href="#连续内存的重要性">连续内存的重要性</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="附录-a-numpy-高级应用">附录 A NumPy 高级应用</h1>
<p>在这篇附录中，我会深入 NumPy 库的数组计算。这会包括<code>ndarray</code>更内部的细节，和更高级的数组操作和算法。</p>
<p>本章包括了一些杂乱的章节，不需要仔细研究。</p>
<h1 id="a1-ndarray对象的内部机理">A.1 <code>ndarray</code>对象的内部机理</h1>
<p>NumPy 的<code>ndarray</code>提供了一种将同质数据块（可以是连续或跨越）解释为多维数组对象的方式。正如你之前所看到的那样，数据类型（<code>dtype</code>）决定了数据的解释方式，比如浮点数、整数、布尔值等。</p>
<p><code>ndarray</code>如此强大的部分原因是所有数组对象都是数据块的一个跨度视图（strided view）。你可能想知道数组视图<code>arr[::2,::-1]</code>不复制任何数据的原因是什么。简单地说，<code>ndarray</code>不只是一块内存和一个<code>dtype</code>，它还有跨度信息，这使得数组能以各种步幅（step size）在内存中移动。更准确地讲，<code>ndarray</code>内部由以下内容组成：</p>
<ul>
<li>一个指向数据（内存或内存映射文件中的一块数据）的指针。</li>
<li>数据类型或<code>dtype</code>，描述在数组中的固定大小值的格子。</li>
<li>一个表示数组形状（<code>shape</code>）的元组。</li>
<li>一个跨度元组（<code>stride</code>），其中的整数指的是为了前进到当前维度下一个元素需要“跨过”的字节数。</li>
</ul>
<p>图 A-1 简单地说明了<code>ndarray</code> 的内部结构。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-43452f2f413e5094.png"
        data-srcset="img/7178691-43452f2f413e5094.png, img/7178691-43452f2f413e5094.png 1.5x, img/7178691-43452f2f413e5094.png 2x"
        data-sizes="auto"
        alt="img/7178691-43452f2f413e5094.png"
        title="图 A-1 Numpy 的&lt;code&gt;ndarray&lt;/code&gt;对象" /></p>
<p>例如，一个<code>10×5</code>的数组，其形状为<code>(10,5)</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">10</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span><span class="o">.</span><span class="n">shape</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">10</span><span class="p">]:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span></span></code></pre></div><p>一个典型的（C 顺序，稍后将详细讲解）<code>3×4×5</code>的<code>float64</code>（8 个字节）数组，其跨度为<code>(160,40,8)</code> —— 知道跨度是非常有用的，通常，跨度在一个轴上越大，沿这个轴进行计算的开销就越大：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">11</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">strides</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">11</span><span class="p">]:</span> <span class="p">(</span><span class="mi">160</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span></span></code></pre></div><p>虽然 NumPy 用户很少会对数组的跨度信息感兴趣，但它们却是构建非复制式数组视图的重要因素。跨度甚至可以是负数，这样会使数组在内存中后向移动，比如在切片<code>obj[::-1]</code>或<code>obj[:,::-1]</code>中就是这样的。</p>
<h2 id="numpy-数据类型体系">NumPy 数据类型体系</h2>
<p>你可能偶尔需要检查数组中所包含的是否是整数、浮点数、字符串或 Python 对象。因为浮点数的种类很多（从<code>float16</code>到<code>float128</code>），判断<code>dtype</code>是否属于某个大类的工作非常繁琐。幸运的是，<code>dtype</code>都有一个超类（比如<code>np.integer</code>和<code>np.floating</code>），它们可以跟<code>np.issubdtype</code>函数结合使用：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">12</span><span class="p">]:</span> <span class="n">ints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">13</span><span class="p">]:</span> <span class="n">floats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">14</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">ints</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">14</span><span class="p">]:</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">15</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">floats</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">15</span><span class="p">]:</span> <span class="kc">True</span>
</span></span></code></pre></div><p>调用<code>dtype</code>的<code>mro</code>方法即可查看其所有的父类：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">16</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="o">.</span><span class="n">mro</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">16</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="n">numpy</span><span class="o">.</span><span class="n">floating</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="n">numpy</span><span class="o">.</span><span class="n">inexact</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="n">numpy</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="n">numpy</span><span class="o">.</span><span class="n">generic</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="nb">float</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="nb">object</span><span class="p">]</span>
</span></span></code></pre></div><p>然后得到：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">17</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">ints</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">17</span><span class="p">]:</span> <span class="kc">True</span>
</span></span></code></pre></div><p>大部分 NumPy 用户完全不需要了解这些知识，但是这些知识偶尔还是能派上用场的。图 A-2 说明了<code>dtype</code>体系以及父子类关系。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-b8996bf943a06ab9.png"
        data-srcset="img/7178691-b8996bf943a06ab9.png, img/7178691-b8996bf943a06ab9.png 1.5x, img/7178691-b8996bf943a06ab9.png 2x"
        data-sizes="auto"
        alt="img/7178691-b8996bf943a06ab9.png"
        title="图 A-2 NumPy 的&lt;code&gt;dtype&lt;/code&gt;体系" /></p>
<h1 id="a2-高级数组操作">A.2 高级数组操作</h1>
<p>除花式索引、切片、布尔条件取子集等操作之外，数组的操作方式还有很多。虽然 pandas 中的高级函数可以处理数据分析工作中的许多重型任务，但有时你还是需要编写一些在现有库中找不到的数据算法。</p>
<h2 id="数组重塑">数组重塑</h2>
<p>多数情况下，你可以无需复制任何数据，就将数组从一个形状转换为另一个形状。只需向数组的实例方法<code>reshape</code>传入一个表示新形状的元组即可实现该目的。例如，假设有一个一维数组，我们希望将其重新排列为一个矩阵（结果见图 A-3）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">18</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">19</span><span class="p">]:</span> <span class="n">arr</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">19</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">20</span><span class="p">]:</span> <span class="n">arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">20</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">]])</span>
</span></span></code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-95bbca6d8d04e4c7.png"
        data-srcset="img/7178691-95bbca6d8d04e4c7.png, img/7178691-95bbca6d8d04e4c7.png 1.5x, img/7178691-95bbca6d8d04e4c7.png 2x"
        data-sizes="auto"
        alt="img/7178691-95bbca6d8d04e4c7.png"
        title="图 A-3 按 C 顺序（按行）和按 Fortran 顺序（按列）进行重塑" /></p>
<p>多维数组也能被重塑：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">21</span><span class="p">]:</span> <span class="n">arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">21</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">]])</span>
</span></span></code></pre></div><p>作为参数的形状的其中一维可以是 -1，它表示该维度的大小由数据本身推断而来：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">22</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">23</span><span class="p">]:</span> <span class="n">arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">23</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">2</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mi">3</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">5</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mi">6</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">8</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">]])</span>
</span></span></code></pre></div><p>与<code>reshape</code>将一维数组转换为多维数组的运算过程相反的运算通常称为扁平化（flattening）或散开（raveling）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">27</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">28</span><span class="p">]:</span> <span class="n">arr</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">28</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">2</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mi">3</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">5</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mi">6</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">8</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">29</span><span class="p">]:</span> <span class="n">arr</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">29</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">])</span>
</span></span></code></pre></div><p>如果结果中的值与原始数组相同，<code>ravel</code>不会产生源数据的副本。<code>flatten</code>方法的行为类似于<code>ravel</code>，只不过它总是返回数据的副本：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">30</span><span class="p">]:</span> <span class="n">arr</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">30</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">])</span>
</span></span></code></pre></div><p>数组可以被重塑或散开为别的顺序。这对 NumPy 新手来说是一个比较微妙的问题，所以在下一小节中我们将专门讲解这个问题。</p>
<h2 id="c-和-fortran-顺序">C 和 Fortran 顺序</h2>
<p>NumPy 允许你更为灵活地控制数据在内存中的布局。默认情况下，NumPy 数组是按行优先顺序创建的。在空间方面，这就意味着，对于一个二维数组，每行中的数据项是被存放在相邻内存位置上的。另一种顺序是列优先顺序，它意味着每列中的数据项是被存放在相邻内存位置上的。</p>
<p>由于一些历史原因，行和列优先顺序又分别称为 C 和 Fortran 顺序。在 FORTRAN 77 中，矩阵全都是列优先的。</p>
<p>像<code>reshape</code>和<code>reval</code>这样的函数，都可以接受一个表示数组数据存放顺序的<code>order</code>参数。一般可以是<code>'C'</code>或<code>'F'</code>（还有<code>'A'</code>和<code>'K'</code>等不常用的选项，具体请参考 NumPy 的文档）。图 A-3 对此进行了说明：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">31</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">32</span><span class="p">]:</span> <span class="n">arr</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">32</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">3</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mi">4</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>  <span class="mi">7</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mi">8</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">33</span><span class="p">]:</span> <span class="n">arr</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">33</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">34</span><span class="p">]:</span> <span class="n">arr</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">34</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span> <span class="mi">11</span><span class="p">])</span>
</span></span></code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-f486e7c41d7e0eec.png"
        data-srcset="img/7178691-f486e7c41d7e0eec.png, img/7178691-f486e7c41d7e0eec.png 1.5x, img/7178691-f486e7c41d7e0eec.png 2x"
        data-sizes="auto"
        alt="img/7178691-f486e7c41d7e0eec.png"
        title="图 A-3 按 C（行优先）或 Fortran（列优先）顺序进行重塑" /></p>
<p>二维或更高维数组的重塑过程比较令人费解（见图 A-3）。C 和 Fortran 顺序的关键区别就是维度的行进顺序：</p>
<ul>
<li>C /行优先顺序：先经过更高的维度（例如，轴 1 会先于轴 0 被处理）。</li>
<li>Fortran /列优先顺序：后经过更高的维度（例如，轴 0 会先于轴 1 被处理）。</li>
</ul>
<h2 id="数组的合并和拆分">数组的合并和拆分</h2>
<p><code>numpy.concatenate</code>可以按指定轴将一个由数组组成的序列（如元组、列表等）连接到一起：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">35</span><span class="p">]:</span> <span class="n">arr1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">36</span><span class="p">]:</span> <span class="n">arr2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">37</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">arr1</span><span class="p">,</span> <span class="n">arr2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">37</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">3</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mi">4</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>  <span class="mi">6</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mi">7</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="mi">9</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">38</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">arr1</span><span class="p">,</span> <span class="n">arr2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">38</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="mi">9</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mi">4</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">]])</span>
</span></span></code></pre></div><p>对于常见的连接操作，NumPy 提供了一些比较方便的方法（如<code>vstack</code>和<code>hstack</code>）。因此，上面的运算还可以表达为：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">39</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">arr1</span><span class="p">,</span> <span class="n">arr2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">39</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">3</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mi">4</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>  <span class="mi">6</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mi">7</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="mi">9</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">40</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">arr1</span><span class="p">,</span> <span class="n">arr2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">40</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="mi">9</span><span class="p">],</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="mi">4</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">]])</span>
</span></span></code></pre></div><p>与此相反，<code>split</code>用于将一个数组沿指定轴拆分为多个数组：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">41</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">42</span><span class="p">]:</span> <span class="n">arr</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">42</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">0.2047</span><span class="p">,</span>  <span class="mf">0.4789</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="o">-</span><span class="mf">0.5194</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5557</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">1.9658</span><span class="p">,</span>  <span class="mf">1.3934</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">0.0929</span><span class="p">,</span>  <span class="mf">0.2817</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">0.769</span> <span class="p">,</span>  <span class="mf">1.2464</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">43</span><span class="p">]:</span> <span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">third</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">44</span><span class="p">]:</span> <span class="n">first</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">44</span><span class="p">]:</span> <span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">0.2047</span><span class="p">,</span>  <span class="mf">0.4789</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">45</span><span class="p">]:</span> <span class="n">second</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">45</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">0.5194</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5557</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">1.9658</span><span class="p">,</span>  <span class="mf">1.3934</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">46</span><span class="p">]:</span> <span class="n">third</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">46</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span> <span class="mf">0.0929</span><span class="p">,</span>  <span class="mf">0.2817</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">0.769</span> <span class="p">,</span>  <span class="mf">1.2464</span><span class="p">]])</span>
</span></span></code></pre></div><p>传入到<code>np.split</code>的值<code>[1,3]</code>指示在哪个索引处分割数组。</p>
<p>表 A-1 中列出了所有关于数组连接和拆分的函数，其中有些是专门为了方便常见的连接运算而提供的。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-c597246722a6bb01.png"
        data-srcset="img/7178691-c597246722a6bb01.png, img/7178691-c597246722a6bb01.png 1.5x, img/7178691-c597246722a6bb01.png 2x"
        data-sizes="auto"
        alt="img/7178691-c597246722a6bb01.png"
        title="表 A-1 数组连接函数" /></p>
<h2 id="堆叠辅助类r_和c_">堆叠辅助类：<code>r_</code>和<code>c_</code></h2>
<p>NumPy 命名空间中有两个特殊的对象——<code>r_</code>和<code>c_</code>，它们可以使数组的堆叠操作更为简洁：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">47</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">48</span><span class="p">]:</span> <span class="n">arr1</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">49</span><span class="p">]:</span> <span class="n">arr2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">50</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">arr1</span><span class="p">,</span> <span class="n">arr2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">50</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span> <span class="mf">0.</span>    <span class="p">,</span>  <span class="mf">1.</span>    <span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">2.</span>    <span class="p">,</span>  <span class="mf">3.</span>    <span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">4.</span>    <span class="p">,</span>  <span class="mf">5.</span>    <span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">1.0072</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.2962</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">0.275</span> <span class="p">,</span>  <span class="mf">0.2289</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">1.3529</span><span class="p">,</span>  <span class="mf">0.8864</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">51</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">arr1</span><span class="p">,</span> <span class="n">arr2</span><span class="p">],</span> <span class="n">arr</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">51</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span> <span class="mf">0.</span>    <span class="p">,</span>  <span class="mf">1.</span>    <span class="p">,</span>  <span class="mf">0.</span>    <span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">2.</span>    <span class="p">,</span>  <span class="mf">3.</span>    <span class="p">,</span>  <span class="mf">1.</span>    <span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">4.</span>    <span class="p">,</span>  <span class="mf">5.</span>    <span class="p">,</span>  <span class="mf">2.</span>    <span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">1.0072</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.2962</span><span class="p">,</span>  <span class="mf">3.</span>    <span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">0.275</span> <span class="p">,</span>  <span class="mf">0.2289</span><span class="p">,</span>  <span class="mf">4.</span>    <span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">1.3529</span><span class="p">,</span>  <span class="mf">0.8864</span><span class="p">,</span>  <span class="mf">5.</span>    <span class="p">]])</span>
</span></span></code></pre></div><p>它还可以将切片转换成数组：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">52</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">52</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span>  <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span>  <span class="mi">2</span><span class="p">,</span>  <span class="o">-</span><span class="mi">9</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span>  <span class="mi">3</span><span class="p">,</span>  <span class="o">-</span><span class="mi">8</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span>  <span class="mi">4</span><span class="p">,</span>  <span class="o">-</span><span class="mi">7</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span>  <span class="mi">5</span><span class="p">,</span>  <span class="o">-</span><span class="mi">6</span><span class="p">]])</span>
</span></span></code></pre></div><p><code>r_</code>和<code>c_</code>的具体功能请参考其文档。</p>
<h2 id="元素的重复操作tile和repeat">元素的重复操作：<code>tile</code>和<code>repeat</code></h2>
<p>对数组进行重复以产生更大数组的工具主要是<code>repeat</code>和<code>tile</code>这两个函数。<code>repeat</code>会将数组中的各个元素重复一定次数，从而产生一个更大的数组：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">53</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">54</span><span class="p">]:</span> <span class="n">arr</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">54</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">55</span><span class="p">]:</span> <span class="n">arr</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">55</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</span></span></code></pre></div><blockquote>
<p>笔记：跟其他流行的数组编程语言（如 MATLAB）不同，NumPy 中很少需要对数组进行重复（replicate）。这主要是因为广播（broadcasting，我们将在下一节中讲解该技术）能更好地满足该需求。</p>
</blockquote>
<p>默认情况下，如果传入的是一个整数，则各元素就都会重复那么多次。如果传入的是一组整数，则各元素就可以重复不同的次数：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">56</span><span class="p">]:</span> <span class="n">arr</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">56</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</span></span></code></pre></div><p>对于多维数组，还可以让它们的元素沿指定轴重复：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">57</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">58</span><span class="p">]:</span> <span class="n">arr</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">58</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">2.0016</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3718</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">1.669</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.4386</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">59</span><span class="p">]:</span> <span class="n">arr</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">59</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">2.0016</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3718</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="o">-</span><span class="mf">2.0016</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3718</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">1.669</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.4386</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">1.669</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.4386</span><span class="p">]])</span>
</span></span></code></pre></div><p>注意，如果没有设置轴向，则数组会被扁平化，这可能不会是你想要的结果。同样，在对多维进行重复时，也可以传入一组整数，这样就会使各切片重复不同的次数：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">60</span><span class="p">]:</span> <span class="n">arr</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">60</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">2.0016</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3718</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="o">-</span><span class="mf">2.0016</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3718</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">1.669</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.4386</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">1.669</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.4386</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">1.669</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.4386</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">61</span><span class="p">]:</span> <span class="n">arr</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">61</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">2.0016</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0016</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3718</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3718</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3718</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">1.669</span> <span class="p">,</span>  <span class="mf">1.669</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.4386</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4386</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4386</span><span class="p">]])</span>
</span></span></code></pre></div><p><code>tile</code>的功能是沿指定轴向堆叠数组的副本。你可以形象地将其想象成“铺瓷砖”：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">62</span><span class="p">]:</span> <span class="n">arr</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">62</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">2.0016</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3718</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">1.669</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.4386</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">63</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">63</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">2.0016</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3718</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0016</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3718</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">1.669</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.4386</span><span class="p">,</span>  <span class="mf">1.669</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.4386</span><span class="p">]])</span>
</span></span></code></pre></div><p>第二个参数是瓷砖的数量。对于标量，瓷砖是水平铺设的，而不是垂直铺设。它可以是一个表示“铺设”布局的元组：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">64</span><span class="p">]:</span> <span class="n">arr</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">64</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">2.0016</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3718</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">1.669</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.4386</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">65</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">65</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">2.0016</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3718</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">1.669</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.4386</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="o">-</span><span class="mf">2.0016</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3718</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">1.669</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.4386</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">66</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">66</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">2.0016</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3718</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0016</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3718</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">1.669</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.4386</span><span class="p">,</span>  <span class="mf">1.669</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.4386</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="o">-</span><span class="mf">2.0016</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3718</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0016</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3718</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">1.669</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.4386</span><span class="p">,</span>  <span class="mf">1.669</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.4386</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="o">-</span><span class="mf">2.0016</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3718</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0016</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3718</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">1.669</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.4386</span><span class="p">,</span>  <span class="mf">1.669</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.4386</span><span class="p">]])</span>
</span></span></code></pre></div><h2 id="花式索引的等价函数take和put">花式索引的等价函数：<code>take</code>和<code>put</code></h2>
<p>在第 4 章中我们讲过，获取和设置数组子集的一个办法是通过整数数组使用花式索引：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">67</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">68</span><span class="p">]:</span> <span class="n">inds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">69</span><span class="p">]:</span> <span class="n">arr</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">69</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span><span class="mi">700</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">600</span><span class="p">])</span>
</span></span></code></pre></div><p><code>ndarray</code>还有其它方法用于获取单个轴向上的选区：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">70</span><span class="p">]:</span> <span class="n">arr</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">70</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span><span class="mi">700</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">600</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">71</span><span class="p">]:</span> <span class="n">arr</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">inds</span><span class="p">,</span> <span class="mi">42</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">72</span><span class="p">]:</span> <span class="n">arr</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">72</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">42</span><span class="p">,</span>  <span class="mi">42</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span>  <span class="mi">42</span><span class="p">,</span>  <span class="mi">42</span><span class="p">,</span><span class="mi">800</span><span class="p">,</span> <span class="mi">900</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">73</span><span class="p">]:</span> <span class="n">arr</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">inds</span><span class="p">,</span> <span class="p">[</span><span class="mi">40</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">43</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">74</span><span class="p">]:</span> <span class="n">arr</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">74</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">41</span><span class="p">,</span>  <span class="mi">42</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span>  <span class="mi">43</span><span class="p">,</span>  <span class="mi">40</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">900</span><span class="p">])</span>
</span></span></code></pre></div><p>要在其它轴上使用<code>take</code>，只需传入<code>axis</code>关键字即可：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">75</span><span class="p">]:</span> <span class="n">inds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">76</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">77</span><span class="p">]:</span> <span class="n">arr</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">77</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">0.5397</span><span class="p">,</span>  <span class="mf">0.477</span> <span class="p">,</span>  <span class="mf">3.2489</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0212</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="o">-</span><span class="mf">0.5771</span><span class="p">,</span>  <span class="mf">0.1241</span><span class="p">,</span>  <span class="mf">0.3026</span><span class="p">,</span>  <span class="mf">0.5238</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">78</span><span class="p">]:</span> <span class="n">arr</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">inds</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">78</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span> <span class="mf">3.2489</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5397</span><span class="p">,</span>  <span class="mf">3.2489</span><span class="p">,</span>  <span class="mf">0.477</span> <span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">0.3026</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5771</span><span class="p">,</span>  <span class="mf">0.3026</span><span class="p">,</span>  <span class="mf">0.1241</span><span class="p">]])</span>
</span></span></code></pre></div><p><code>put</code>不接受<code>axis</code>参数，它只会在数组的扁平化版本（一维，C 顺序）上进行索引。因此，在需要用其他轴向的索引设置元素时，最好还是使用花式索引。</p>
<h1 id="a3-广播">A.3 广播</h1>
<p>广播（broadcasting）指的是不同形状的数组之间的算术运算的执行方式。它是一种非常强大的功能，但也容易令人误解，即使是经验丰富的老手也是如此。将标量值跟数组合并时就会发生最简单的广播：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">79</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">80</span><span class="p">]:</span> <span class="n">arr</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">80</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">81</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">*</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">81</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">])</span>
</span></span></code></pre></div><p>这里我们说：在这个乘法运算中，标量值 4 被广播到了其他所有的元素上。</p>
<p>看一个例子，我们可以通过减去列平均值的方式对数组的每一列进行距平化处理。这个问题解决起来非常简单：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">82</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">83</span><span class="p">]:</span> <span class="n">arr</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">83</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.3928</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3824</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8768</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">84</span><span class="p">]:</span> <span class="n">demeaned</span> <span class="o">=</span> <span class="n">arr</span> <span class="o">-</span> <span class="n">arr</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">85</span><span class="p">]:</span> <span class="n">demeaned</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">85</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span> <span class="mf">0.3937</span><span class="p">,</span>  <span class="mf">1.7263</span><span class="p">,</span>  <span class="mf">0.1633</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="o">-</span><span class="mf">0.4384</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.9878</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.9839</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="o">-</span><span class="mf">0.468</span> <span class="p">,</span>  <span class="mf">0.9426</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3891</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">0.5126</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6811</span><span class="p">,</span>  <span class="mf">1.2097</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">86</span><span class="p">]:</span> <span class="n">demeaned</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">86</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.</span><span class="p">])</span>
</span></span></code></pre></div><p>图 A-4 形象地展示了该过程。用广播的方式对行进行距平化处理会稍微麻烦一些。幸运的是，只要遵循一定的规则，低维度的值是可以被广播到数组的任意维度的（比如对二维数组各列减去行平均值）。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-6aaf022ab88452a9.png"
        data-srcset="img/7178691-6aaf022ab88452a9.png, img/7178691-6aaf022ab88452a9.png 1.5x, img/7178691-6aaf022ab88452a9.png 2x"
        data-sizes="auto"
        alt="img/7178691-6aaf022ab88452a9.png"
        title="图 A-4 一维数组在轴 0 上的广播" /></p>
<p>于是就得到了：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-fcaba8455960862a.png"
        data-srcset="img/7178691-fcaba8455960862a.png, img/7178691-fcaba8455960862a.png 1.5x, img/7178691-fcaba8455960862a.png 2x"
        data-sizes="auto"
        alt="img/7178691-fcaba8455960862a.png"
        title="img/7178691-fcaba8455960862a.png" /></p>
<p>虽然我是一名经验丰富的 NumPy 老手，但经常还是得停下来画张图并想想广播的原则。再来看一下最后那个例子，假设你希望对各行减去那个平均值。由于<code>arr.mean(0)</code>的长度为 3，所以它可以在 0 轴向上进行广播：因为<code>arr</code>的后缘维度是 3，所以它们是兼容的。根据该原则，要在 1 轴向上做减法（即各行减去行平均值），较小的那个数组的形状必须是<code>(4,1)</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">87</span><span class="p">]:</span> <span class="n">arr</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">87</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span> <span class="mf">0.0009</span><span class="p">,</span>  <span class="mf">1.3438</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.7135</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="o">-</span><span class="mf">0.8312</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.3702</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.8608</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="o">-</span><span class="mf">0.8608</span><span class="p">,</span>  <span class="mf">0.5601</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.2659</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">0.1198</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0635</span><span class="p">,</span>  <span class="mf">0.3329</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">88</span><span class="p">]:</span> <span class="n">row_means</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">89</span><span class="p">]:</span> <span class="n">row_means</span><span class="o">.</span><span class="n">shape</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">89</span><span class="p">]:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">90</span><span class="p">]:</span> <span class="n">row_means</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">90</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span> <span class="mf">0.2104</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="o">-</span><span class="mf">1.6874</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="o">-</span><span class="mf">0.5222</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="o">-</span><span class="mf">0.2036</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">91</span><span class="p">]:</span> <span class="n">demeaned</span> <span class="o">=</span> <span class="n">arr</span> <span class="o">-</span> <span class="n">row_means</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">92</span><span class="p">]:</span> <span class="n">demeaned</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">92</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span> <span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">])</span>
</span></span></code></pre></div><p>图 A-5 说明了该运算的过程。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-9b0310d6773c3d38.png"
        data-srcset="img/7178691-9b0310d6773c3d38.png, img/7178691-9b0310d6773c3d38.png 1.5x, img/7178691-9b0310d6773c3d38.png 2x"
        data-sizes="auto"
        alt="img/7178691-9b0310d6773c3d38.png"
        title="图 A-5 二维数组在轴 1 上的广播" /></p>
<p>图 A-6 展示了另外一种情况，这次是在一个三维数组上沿 0 轴向加上一个二维数组。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-965eb28b60046cd9.png"
        data-srcset="img/7178691-965eb28b60046cd9.png, img/7178691-965eb28b60046cd9.png 1.5x, img/7178691-965eb28b60046cd9.png 2x"
        data-sizes="auto"
        alt="img/7178691-965eb28b60046cd9.png"
        title="图 A-6 三维数组在轴 0 上的广播" /></p>
<h2 id="沿其它轴向广播">沿其它轴向广播</h2>
<p>高维度数组的广播似乎更难以理解，而实际上它也是遵循广播原则的。如果不然，你就会得到下面这样一个错误：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">93</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">-</span> <span class="n">arr</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">---------------------------------------------------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="ne">ValueError</span>                                <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">93</span><span class="o">-</span><span class="mi">7</span><span class="n">b87b85a20b2</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="o">----&gt;</span> <span class="mi">1</span> <span class="n">arr</span> <span class="o">-</span> <span class="n">arr</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="ne">ValueError</span><span class="p">:</span> <span class="n">operands</span> <span class="n">could</span> <span class="ow">not</span> <span class="n">be</span> <span class="n">broadcast</span> <span class="n">together</span> <span class="k">with</span> <span class="n">shapes</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="mi">4</span><span class="p">,)</span>
</span></span></code></pre></div><p>人们经常需要通过算术运算过程将较低维度的数组在除 0 轴以外的其他轴向上广播。根据广播的原则，较小数组的“广播维”必须为 1。在上面那个行距平化的例子中，这就意味着要将行平均值的形状变成<code>(4,1)</code>而不是<code>(4,)</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">94</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">-</span> <span class="n">arr</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">94</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">0.2095</span><span class="p">,</span>  <span class="mf">1.1334</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.9239</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">0.8562</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6828</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1734</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="o">-</span><span class="mf">0.3386</span><span class="p">,</span>  <span class="mf">1.0823</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.7438</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">0.3234</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8599</span><span class="p">,</span>  <span class="mf">0.5365</span><span class="p">]])</span>
</span></span></code></pre></div><p>对于三维的情况，在三维中的任何一维上广播其实也就是将数据重塑为兼容的形状而已。图 A-7 说明了要在三维数组各维度上广播的形状需求。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-b40936aab8e757d0.png"
        data-srcset="img/7178691-b40936aab8e757d0.png, img/7178691-b40936aab8e757d0.png 1.5x, img/7178691-b40936aab8e757d0.png 2x"
        data-sizes="auto"
        alt="img/7178691-b40936aab8e757d0.png"
        title="图 A-7：能在该三维数组上广播的二维数组的形状" /></p>
<p>于是就有了一个非常普遍的问题（尤其是在通用算法中），即专门为了广播而添加一个长度为 1 的新轴。虽然<code>reshape</code>是一个办法，但插入轴需要构造一个表示新形状的元组。这是一个很郁闷的过程。因此，NumPy 数组提供了一种通过索引机制插入轴的特殊语法。下面这段代码通过特殊的<code>np.newaxis</code>属性以及“全”切片来插入新轴：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">95</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">96</span><span class="p">]:</span> <span class="n">arr_3d</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">97</span><span class="p">]:</span> <span class="n">arr_3d</span><span class="o">.</span><span class="n">shape</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">97</span><span class="p">]:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">98</span><span class="p">]:</span> <span class="n">arr_1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">99</span><span class="p">]:</span> <span class="n">arr_1d</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">99</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">2.3594</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="o">-</span><span class="mf">0.1995</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="o">-</span><span class="mf">1.542</span> <span class="p">]])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">100</span><span class="p">]:</span> <span class="n">arr_1d</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">100</span><span class="p">]:</span> <span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">2.3594</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1995</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.542</span> <span class="p">]])</span>
</span></span></code></pre></div><p>因此，如果我们有一个三维数组，并希望对轴 2 进行距平化，那么只需要编写下面这样的代码就可以了：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">101</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">102</span><span class="p">]:</span> <span class="n">depth_means</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">103</span><span class="p">]:</span> <span class="n">depth_means</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">103</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">0.4735</span><span class="p">,</span>  <span class="mf">0.3971</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0228</span><span class="p">,</span>  <span class="mf">0.2001</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="o">-</span><span class="mf">0.3521</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.281</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.071</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.1586</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">0.6245</span><span class="p">,</span>  <span class="mf">0.6047</span><span class="p">,</span>  <span class="mf">0.4396</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2846</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">104</span><span class="p">]:</span> <span class="n">depth_means</span><span class="o">.</span><span class="n">shape</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">104</span><span class="p">]:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">105</span><span class="p">]:</span> <span class="n">demeaned</span> <span class="o">=</span> <span class="n">arr</span> <span class="o">-</span> <span class="n">depth_means</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">106</span><span class="p">]:</span> <span class="n">demeaned</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">106</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span> <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.</span><span class="p">]])</span>
</span></span></code></pre></div><p>有些读者可能会想，在对指定轴进行距平化时，有没有一种既通用又不牺牲性能的方法呢？实际上是有的，但需要一些索引方面的技巧：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">demean_axis</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">means</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># This generalizes things like [:, :, np.newaxis] to N dimensions</span>
</span></span><span class="line"><span class="cl">    <span class="n">indexer</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="n">arr</span><span class="o">.</span><span class="n">ndim</span>
</span></span><span class="line"><span class="cl">    <span class="n">indexer</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">arr</span> <span class="o">-</span> <span class="n">means</span><span class="p">[</span><span class="n">indexer</span><span class="p">]</span>
</span></span></code></pre></div><h2 id="通过广播设置数组的值">通过广播设置数组的值</h2>
<p>算术运算所遵循的广播原则同样也适用于通过索引机制设置数组值的操作。对于最简单的情况，我们可以这样做：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">107</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">108</span><span class="p">]:</span> <span class="n">arr</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">5</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">109</span><span class="p">]:</span> <span class="n">arr</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">109</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span> <span class="mf">5.</span><span class="p">,</span>  <span class="mf">5.</span><span class="p">,</span>  <span class="mf">5.</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">5.</span><span class="p">,</span>  <span class="mf">5.</span><span class="p">,</span>  <span class="mf">5.</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">5.</span><span class="p">,</span>  <span class="mf">5.</span><span class="p">,</span>  <span class="mf">5.</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">5.</span><span class="p">,</span>  <span class="mf">5.</span><span class="p">,</span>  <span class="mf">5.</span><span class="p">]])</span>
</span></span></code></pre></div><p>但是，假设我们想要用一个一维数组来设置目标数组的各列，只要保证形状兼容就可以了：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">110</span><span class="p">]:</span> <span class="n">col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.28</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.42</span><span class="p">,</span> <span class="mf">0.44</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">111</span><span class="p">]:</span> <span class="n">arr</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">col</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">112</span><span class="p">]:</span> <span class="n">arr</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">112</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span> <span class="mf">1.28</span><span class="p">,</span>  <span class="mf">1.28</span><span class="p">,</span>  <span class="mf">1.28</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="o">-</span><span class="mf">0.42</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.42</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.42</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">0.44</span><span class="p">,</span>  <span class="mf">0.44</span><span class="p">,</span>  <span class="mf">0.44</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">1.6</span> <span class="p">,</span>  <span class="mf">1.6</span> <span class="p">,</span>  <span class="mf">1.6</span> <span class="p">]])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">113</span><span class="p">]:</span> <span class="n">arr</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="mf">1.37</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.509</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">114</span><span class="p">]:</span> <span class="n">arr</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">114</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">1.37</span> <span class="p">,</span> <span class="o">-</span><span class="mf">1.37</span> <span class="p">,</span> <span class="o">-</span><span class="mf">1.37</span> <span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">0.509</span><span class="p">,</span>  <span class="mf">0.509</span><span class="p">,</span>  <span class="mf">0.509</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">0.44</span> <span class="p">,</span>  <span class="mf">0.44</span> <span class="p">,</span>  <span class="mf">0.44</span> <span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">1.6</span>  <span class="p">,</span>  <span class="mf">1.6</span>  <span class="p">,</span>  <span class="mf">1.6</span>  <span class="p">]])</span>
</span></span></code></pre></div><h1 id="a4-ufunc高级应用">A.4 <code>ufunc</code>高级应用</h1>
<p>虽然许多 NumPy 用户只会用到通用函数所提供的快速的元素级运算，但通用函数实际上还有一些高级用法能使我们丢开循环而编写出更为简洁的代码。</p>
<h2 id="ufunc实例方法"><code>ufunc</code>实例方法</h2>
<p>NumPy 的各个二元<code>ufunc</code>都有一些用于执行特定向量化运算的特殊方法。表 A-2 汇总了这些方法，下面我将通过几个具体的例子对它们进行说明。</p>
<p><code>reduce</code>接受一个数组参数，并通过一系列的二元运算对其值进行聚合（可指明轴向）。例如，我们可以用<code>np.add.reduce</code>对数组中各个元素进行求和：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">115</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">116</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">116</span><span class="p">]:</span> <span class="mi">45</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">117</span><span class="p">]:</span> <span class="n">arr</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">117</span><span class="p">]:</span> <span class="mi">45</span>
</span></span></code></pre></div><p>起始值取决于<code>ufunc</code>（对于<code>add</code>的情况，就是 0）。如果设置了轴号，约简运算就会沿该轴向执行。这就使你能用一种比较简洁的方式得到某些问题的答案。在下面这个例子中，我们用<code>np.logical_and</code>检查数组各行中的值是否是有序的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">118</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">12346</span><span class="p">)</span>  <span class="c1"># for reproducibility</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">119</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">120</span><span class="p">]:</span> <span class="n">arr</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># sort a few rows</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">121</span><span class="p">]:</span> <span class="n">arr</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">arr</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">121</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span> <span class="kc">True</span><span class="p">,</span>  <span class="kc">True</span><span class="p">,</span>  <span class="kc">True</span><span class="p">,</span>  <span class="kc">True</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="kc">False</span><span class="p">,</span>  <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="kc">True</span><span class="p">,</span>  <span class="kc">True</span><span class="p">,</span>  <span class="kc">True</span><span class="p">,</span>  <span class="kc">True</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>  <span class="kc">True</span><span class="p">,</span>  <span class="kc">True</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="kc">True</span><span class="p">,</span>  <span class="kc">True</span><span class="p">,</span>  <span class="kc">True</span><span class="p">,</span>  <span class="kc">True</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">122</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">arr</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">arr</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">122</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>  <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>  <span class="kc">True</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
</span></span></code></pre></div><p>注意，<code>logical_and.reduce</code>跟<code>all</code>方法是等价的。</p>
<p><code>ccumulate</code>跟<code>reduce</code>的关系就像<code>cumsum</code>跟<code>sum</code>的关系那样。它产生一个跟原数组大小相同的中间“累计”值数组：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">123</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">124</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">124</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">35</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">60</span><span class="p">]])</span>
</span></span></code></pre></div><p><code>outer</code>用于计算两个数组的叉积：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">125</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">126</span><span class="p">]:</span> <span class="n">arr</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">126</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">127</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">127</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">]])</span>
</span></span></code></pre></div><p><code>outer</code>输出结果的维度是两个输入数据的维度之和：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">128</span><span class="p">]:</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">129</span><span class="p">]:</span> <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">130</span><span class="p">]:</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">130</span><span class="p">]:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span></span></code></pre></div><p>最后一个方法<code>reduceat</code>用于计算“局部约简”，其实就是一个对数据各切片进行聚合的<code>groupby</code>运算。它接受一组用于指示如何对值进行拆分和聚合的“面元边界”：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">131</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">132</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduceat</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">132</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">17</span><span class="p">])</span>
</span></span></code></pre></div><p>最终结果是在<code>arr[0:5]</code>、<code>arr[5:8]</code>以及<code>arr[8:]</code>上执行的约简。跟其他方法一样，这里也可以传入一个<code>axis</code>参数：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">133</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">134</span><span class="p">]:</span> <span class="n">arr</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">134</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>  <span class="mi">4</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>  <span class="mi">8</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span> <span class="mi">12</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">135</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduceat</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">135</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>  <span class="mi">4</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>  <span class="mi">8</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">]])</span>
</span></span></code></pre></div><p>表 A-2 总结了部分的<code>ufunc</code>方法。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-c997bd45000f7b72.png"
        data-srcset="img/7178691-c997bd45000f7b72.png, img/7178691-c997bd45000f7b72.png 1.5x, img/7178691-c997bd45000f7b72.png 2x"
        data-sizes="auto"
        alt="img/7178691-c997bd45000f7b72.png"
        title="表 A &lt;code&gt;ufunc&lt;/code&gt;方法" /></p>
<h2 id="编写新的ufunc">编写新的<code>ufunc</code></h2>
<p>有多种方法可以让你编写自己的 NumPy <code>ufunc</code>。最常见的是使用 NumPy C API，但它超越了本书的范围。在本节，我们讲纯粹的 Python <code>ufunc</code>。</p>
<p><code>numpy.frompyfunc</code>接受一个 Python 函数以及两个分别表示输入输出参数数量的参数。例如，下面是一个能够实现元素级加法的简单函数：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">136</span><span class="p">]:</span> <span class="k">def</span> <span class="nf">add_elements</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">   <span class="o">.....</span><span class="p">:</span>     <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">137</span><span class="p">]:</span> <span class="n">add_them</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frompyfunc</span><span class="p">(</span><span class="n">add_elements</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">138</span><span class="p">]:</span> <span class="n">add_them</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">138</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
</span></span></code></pre></div><p>用<code>frompyfunc</code>创建的函数总是返回 Python 对象数组，这一点很不方便。幸运的是，还有另一个办法，即<code>numpy.vectorize</code>。虽然没有<code>frompyfunc</code>那么强大，但可以让你指定输出类型：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">139</span><span class="p">]:</span> <span class="n">add_them</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">add_elements</span><span class="p">,</span> <span class="n">otypes</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">140</span><span class="p">]:</span> <span class="n">add_them</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">140</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span>  <span class="mf">0.</span><span class="p">,</span>   <span class="mf">2.</span><span class="p">,</span>   <span class="mf">4.</span><span class="p">,</span>   <span class="mf">6.</span><span class="p">,</span>   <span class="mf">8.</span><span class="p">,</span>  <span class="mf">10.</span><span class="p">,</span>  <span class="mf">12.</span><span class="p">,</span>  <span class="mf">14.</span><span class="p">])</span>
</span></span></code></pre></div><p>虽然这两个函数提供了一种创建<code>ufunc</code>型函数的手段，但它们非常慢，因为它们在计算每个元素时都要执行一次 Python 函数调用，这就会比 NumPy 自带的基于 C 的<code>ufunc</code>慢很多：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">141</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">142</span><span class="p">]:</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">add_them</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">arr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">4.12</span> <span class="n">ms</span> <span class="o">+-</span> <span class="mi">182</span> <span class="n">us</span> <span class="n">per</span> <span class="n">loop</span> <span class="p">(</span><span class="n">mean</span> <span class="o">+-</span> <span class="n">std</span><span class="o">.</span> <span class="n">dev</span><span class="o">.</span> <span class="n">of</span> <span class="mi">7</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">100</span> <span class="n">loops</span> <span class="n">each</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">143</span><span class="p">]:</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">arr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mf">6.89</span> <span class="n">us</span> <span class="o">+-</span> <span class="mi">504</span> <span class="n">ns</span> <span class="n">per</span> <span class="n">loop</span> <span class="p">(</span><span class="n">mean</span> <span class="o">+-</span> <span class="n">std</span><span class="o">.</span> <span class="n">dev</span><span class="o">.</span> <span class="n">of</span> <span class="mi">7</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">100000</span> <span class="n">loops</span> <span class="n">each</span><span class="p">)</span>
</span></span></code></pre></div><p>本章的后面，我会介绍使用 <a href="http://numba.pydata.org/" target="_blank" rel="noopener noreffer ">Numba</a>，创建快速 Python ufuncs。</p>
<h1 id="a5-结构化和记录式数组">A.5 结构化和记录式数组</h1>
<p>你可能已经注意到了，到目前为止我们所讨论的<code>ndarray</code>都是一种同质数据容器，也就是说，在它所表示的内存块中，各元素占用的字节数相同（具体根据<code>dtype</code>而定）。从表面上看，它似乎不能用于表示异质或表格型的数据。结构化数组是一种特殊的<code>ndarray</code>，其中的各个元素可以被看做 C 语言中的结构体（<code>struct</code>，这就是“结构化”的由来）或 SQL 表中带有多个命名字段的行：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">144</span><span class="p">]:</span> <span class="n">dtype</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">145</span><span class="p">]:</span> <span class="n">sarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">146</span><span class="p">]:</span> <span class="n">sarr</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">146</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([(</span> <span class="mf">1.5</span>   <span class="p">,</span>  <span class="mi">6</span><span class="p">),</span> <span class="p">(</span> <span class="mf">3.1416</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)],</span>
</span></span><span class="line"><span class="cl">      <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f8&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;i4&#39;</span><span class="p">)])</span>
</span></span></code></pre></div><p>定义结构化<code>dtype</code>（请参考 NumPy 的在线文档）的方式有很多。最典型的办法是元组列表，各元组的格式为<code>(field_name,field_data_type)</code>。这样，数组的元素就成了元组式的对象，该对象中各个元素可以像字典那样进行访问：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">147</span><span class="p">]:</span> <span class="n">sarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">147</span><span class="p">]:</span> <span class="p">(</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">148</span><span class="p">]:</span> <span class="n">sarr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">148</span><span class="p">]:</span> <span class="mi">6</span>
</span></span></code></pre></div><p>字段名保存在<code>dtype.names</code>属性中。在访问结构化数组的某个字段时，返回的是该数据的视图，所以不会发生数据复制：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">149</span><span class="p">]:</span> <span class="n">sarr</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">149</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span> <span class="mf">1.5</span>   <span class="p">,</span>  <span class="mf">3.1416</span><span class="p">])</span>
</span></span></code></pre></div><h2 id="嵌套dtype和多维字段">嵌套<code>dtype</code>和多维字段</h2>
<p>在定义结构化<code>dtype</code>时，你可以再设置一个形状（可以是一个整数，也可以是一个元组）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">150</span><span class="p">]:</span> <span class="n">dtype</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">151</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">152</span><span class="p">]:</span> <span class="n">arr</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">152</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span> <span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span> <span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span> <span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)],</span>
</span></span><span class="line"><span class="cl">      <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;i8&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)),</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;i4&#39;</span><span class="p">)])</span>
</span></span></code></pre></div><p>在这种情况下，各个记录的<code>x</code>字段所表示的是一个长度为 3 的数组：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">153</span><span class="p">]:</span> <span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">153</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
</span></span></code></pre></div><p>这样，访问<code>arr['x']</code>即可得到一个二维数组，而不是前面那个例子中的一维数组：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">154</span><span class="p">]:</span> <span class="n">arr</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">154</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
</span></span></code></pre></div><p>这就使你能用单个数组的内存块存放复杂的嵌套结构。你还可以嵌套<code>dtype</code>，作出更复杂的结构。下面是一个简单的例子：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">155</span><span class="p">]:</span> <span class="n">dtype</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">)]),</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">156</span><span class="p">]:</span> <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">5</span><span class="p">),</span> <span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="mi">6</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">157</span><span class="p">]:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">157</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([(</span> <span class="mf">1.</span><span class="p">,</span>  <span class="mf">2.</span><span class="p">),</span> <span class="p">(</span> <span class="mf">3.</span><span class="p">,</span>  <span class="mf">4.</span><span class="p">)],</span>
</span></span><span class="line"><span class="cl">      <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f8&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f4&#39;</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">158</span><span class="p">]:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">158</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">int32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">159</span><span class="p">]:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="s1">&#39;a&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">159</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span> <span class="mf">1.</span><span class="p">,</span>  <span class="mf">3.</span><span class="p">])</span>
</span></span></code></pre></div><p>pandas 的<code>DataFrame</code>并不直接支持该功能，但它的分层索引机制跟这个差不多。</p>
<h2 id="为什么要用结构化数组">为什么要用结构化数组</h2>
<p>跟 pandas 的<code>DataFrame</code>相比，NumPy 的结构化数组是一种相对较低级的工具。它可以将单个内存块解释为带有任意复杂嵌套列的表格型结构。由于数组中的每个元素在内存中都被表示为固定的字节数，所以结构化数组能够提供非常快速高效的磁盘数据读写（包括内存映像）、网络传输等功能。</p>
<p>结构化数组的另一个常见用法是，将数据文件写成定长记录字节流，这是 C 和 C++ 代码中常见的数据序列化手段（业界许多历史系统中都能找得到）。只要知道文件的格式（记录的大小、元素的顺序、字节数以及数据类型等），就可以用<code>np.fromfile</code>将数据读入内存。这种用法超出了本书的范围，知道这点就可以了。</p>
<h1 id="a6-更多有关排序的话题">A.6 更多有关排序的话题</h1>
<p>跟 Python 内置的列表一样，<code>ndarray</code>的<code>sort</code>实例方法也是就地排序。也就是说，数组内容的重新排列是不会产生新数组的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">160</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">161</span><span class="p">]:</span> <span class="n">arr</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">162</span><span class="p">]:</span> <span class="n">arr</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">162</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.082</span> <span class="p">,</span>  <span class="mf">0.3759</span><span class="p">,</span>  <span class="mf">0.8014</span><span class="p">,</span>  <span class="mf">1.1397</span><span class="p">,</span>  <span class="mf">1.2888</span><span class="p">,</span>  <span class="mf">1.8413</span><span class="p">])</span>
</span></span></code></pre></div><p>在对数组进行就地排序时要注意一点，如果目标数组只是一个视图，则原始数组将会被修改：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">163</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">164</span><span class="p">]:</span> <span class="n">arr</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">164</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">0.3318</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.4711</span><span class="p">,</span>  <span class="mf">0.8705</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0847</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.1329</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="o">-</span><span class="mf">1.0111</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3436</span><span class="p">,</span>  <span class="mf">2.1714</span><span class="p">,</span>  <span class="mf">0.1234</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0189</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">0.1773</span><span class="p">,</span>  <span class="mf">0.7424</span><span class="p">,</span>  <span class="mf">0.8548</span><span class="p">,</span>  <span class="mf">1.038</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.329</span> <span class="p">]])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">165</span><span class="p">]:</span> <span class="n">arr</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>  <span class="c1"># Sort first column values in-place</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">166</span><span class="p">]:</span> <span class="n">arr</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">166</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">1.0111</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.4711</span><span class="p">,</span>  <span class="mf">0.8705</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0847</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.1329</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="o">-</span><span class="mf">0.3318</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3436</span><span class="p">,</span>  <span class="mf">2.1714</span><span class="p">,</span>  <span class="mf">0.1234</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0189</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">0.1773</span><span class="p">,</span>  <span class="mf">0.7424</span><span class="p">,</span>  <span class="mf">0.8548</span><span class="p">,</span>  <span class="mf">1.038</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.329</span> <span class="p">]])</span>
</span></span></code></pre></div><p>相反，<code>numpy.sort</code>会为原数组创建一个已排序副本。另外，它所接受的参数（比如<code>kind</code>）跟<code>ndarray.sort</code>一样：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">167</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">168</span><span class="p">]:</span> <span class="n">arr</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">168</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.1181</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2415</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0051</span><span class="p">,</span>  <span class="mf">0.7379</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0614</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">169</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">169</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">2.0051</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.1181</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0614</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2415</span><span class="p">,</span>  <span class="mf">0.7379</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">170</span><span class="p">]:</span> <span class="n">arr</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">170</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.1181</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2415</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0051</span><span class="p">,</span>  <span class="mf">0.7379</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0614</span><span class="p">])</span>
</span></span></code></pre></div><p>这两个排序方法都可以接受一个<code>axis</code>参数，以便沿指定轴向对各块数据进行单独排序：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">171</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">172</span><span class="p">]:</span> <span class="n">arr</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">172</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span> <span class="mf">0.5955</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2682</span><span class="p">,</span>  <span class="mf">1.3389</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1872</span><span class="p">,</span>  <span class="mf">0.9111</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="o">-</span><span class="mf">0.3215</span><span class="p">,</span>  <span class="mf">1.0054</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5168</span><span class="p">,</span>  <span class="mf">1.1925</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1989</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">0.3969</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.7638</span><span class="p">,</span>  <span class="mf">0.6071</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2222</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2171</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">173</span><span class="p">]:</span> <span class="n">arr</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">174</span><span class="p">]:</span> <span class="n">arr</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">174</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">0.2682</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1872</span><span class="p">,</span>  <span class="mf">0.5955</span><span class="p">,</span>  <span class="mf">0.9111</span><span class="p">,</span>  <span class="mf">1.3389</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="o">-</span><span class="mf">0.5168</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3215</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1989</span><span class="p">,</span>  <span class="mf">1.0054</span><span class="p">,</span>  <span class="mf">1.1925</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="o">-</span><span class="mf">1.7638</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2222</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2171</span><span class="p">,</span>  <span class="mf">0.3969</span><span class="p">,</span>  <span class="mf">0.6071</span><span class="p">]])</span>
</span></span></code></pre></div><p>你可能注意到了，这两个排序方法都不可以被设置为降序。其实这也无所谓，因为数组切片会产生视图（也就是说，不会产生副本，也不需要任何其他的计算工作）。许多 Python 用户都很熟悉一个有关列表的小技巧：<code>values[::-1]</code>可以返回一个反序的列表。对<code>ndarray</code>也是如此：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">175</span><span class="p">]:</span> <span class="n">arr</span><span class="p">[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">175</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span> <span class="mf">1.3389</span><span class="p">,</span>  <span class="mf">0.9111</span><span class="p">,</span>  <span class="mf">0.5955</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1872</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2682</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">1.1925</span><span class="p">,</span>  <span class="mf">1.0054</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1989</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3215</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5168</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">0.6071</span><span class="p">,</span>  <span class="mf">0.3969</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2171</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2222</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.7638</span><span class="p">]])</span>
</span></span></code></pre></div><h2 id="间接排序argsort和lexsort">间接排序：<code>argsort</code>和<code>lexsort</code></h2>
<p>在数据分析工作中，常常需要根据一个或多个键对数据集进行排序。例如，一个有关学生信息的数据表可能需要以姓和名进行排序（先姓后名）。这就是间接排序的一个例子，如果你阅读过有关 pandas 的章节，那就已经见过不少高级例子了。给定一个或多个键，你就可以得到一个由整数组成的索引数组（我亲切地称之为索引器），其中的索引值说明了数据在新顺序下的位置。<code>argsort</code>和<code>numpy.lexsort</code>就是实现该功能的两个主要方法。下面是一个简单的例子：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">176</span><span class="p">]:</span> <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">177</span><span class="p">]:</span> <span class="n">indexer</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">178</span><span class="p">]:</span> <span class="n">indexer</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">178</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">179</span><span class="p">]:</span> <span class="n">values</span><span class="p">[</span><span class="n">indexer</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">179</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
</span></span></code></pre></div><p>一个更复杂的例子，下面这段代码根据数组的第一行对其进行排序：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">180</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">181</span><span class="p">]:</span> <span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">182</span><span class="p">]:</span> <span class="n">arr</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">182</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span> <span class="mf">5.</span>    <span class="p">,</span>  <span class="mf">0.</span>    <span class="p">,</span>  <span class="mf">1.</span>    <span class="p">,</span>  <span class="mf">3.</span>    <span class="p">,</span>  <span class="mf">2.</span>    <span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="o">-</span><span class="mf">0.3636</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1378</span><span class="p">,</span>  <span class="mf">2.1777</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4728</span><span class="p">,</span>  <span class="mf">0.8356</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="o">-</span><span class="mf">0.2089</span><span class="p">,</span>  <span class="mf">0.2316</span><span class="p">,</span>  <span class="mf">0.728</span> <span class="p">,</span> <span class="o">-</span><span class="mf">1.3918</span><span class="p">,</span>  <span class="mf">1.9956</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">183</span><span class="p">]:</span> <span class="n">arr</span><span class="p">[:,</span> <span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()]</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">183</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([[</span> <span class="mf">0.</span>    <span class="p">,</span>  <span class="mf">1.</span>    <span class="p">,</span>  <span class="mf">2.</span>    <span class="p">,</span>  <span class="mf">3.</span>    <span class="p">,</span>  <span class="mf">5.</span>    <span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span><span class="o">-</span><span class="mf">0.1378</span><span class="p">,</span>  <span class="mf">2.1777</span><span class="p">,</span>  <span class="mf">0.8356</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4728</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3636</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="p">[</span> <span class="mf">0.2316</span><span class="p">,</span>  <span class="mf">0.728</span> <span class="p">,</span>  <span class="mf">1.9956</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.3918</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2089</span><span class="p">]])</span>
</span></span></code></pre></div><p><code>lexsort</code>跟<code>argsort</code>差不多，只不过它可以一次性对多个键数组执行间接排序（字典序）。假设我们想对一些以姓和名标识的数据进行排序：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">184</span><span class="p">]:</span> <span class="n">first_name</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;Bob&#39;</span><span class="p">,</span> <span class="s1">&#39;Jane&#39;</span><span class="p">,</span> <span class="s1">&#39;Steve&#39;</span><span class="p">,</span> <span class="s1">&#39;Bill&#39;</span><span class="p">,</span> <span class="s1">&#39;Barbara&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">185</span><span class="p">]:</span> <span class="n">last_name</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;Jones&#39;</span><span class="p">,</span> <span class="s1">&#39;Arnold&#39;</span><span class="p">,</span> <span class="s1">&#39;Arnold&#39;</span><span class="p">,</span> <span class="s1">&#39;Jones&#39;</span><span class="p">,</span> <span class="s1">&#39;Walters&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">186</span><span class="p">]:</span> <span class="n">sorter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lexsort</span><span class="p">((</span><span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">187</span><span class="p">]:</span> <span class="n">sorter</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">187</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">188</span><span class="p">]:</span> <span class="nb">zip</span><span class="p">(</span><span class="n">last_name</span><span class="p">[</span><span class="n">sorter</span><span class="p">],</span> <span class="n">first_name</span><span class="p">[</span><span class="n">sorter</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">188</span><span class="p">]:</span> <span class="o">&lt;</span><span class="nb">zip</span> <span class="n">at</span> <span class="mh">0x7fa203eda1c8</span><span class="o">&gt;</span>
</span></span></code></pre></div><p>刚开始使用<code>lexsort</code>的时候可能会比较容易头晕，这是因为键的应用顺序是从最后一个传入的算起的。不难看出，<code>last_name</code>是先于<code>first_name</code>被应用的。</p>
<blockquote>
<p>笔记：<code>Series</code>和<code>DataFrame</code>的<code>sort_index</code>以及<code>Series</code>的<code>order</code>方法就是通过这些函数的变体（它们还必须考虑缺失值）实现的。</p>
</blockquote>
<h2 id="其他排序算法">其他排序算法</h2>
<p>稳定的（stable）排序算法会保持等价元素的相对位置。对于相对位置具有实际意义的那些间接排序而言，这一点非常重要：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">189</span><span class="p">]:</span> <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;2:first&#39;</span><span class="p">,</span> <span class="s1">&#39;2:second&#39;</span><span class="p">,</span> <span class="s1">&#39;1:first&#39;</span><span class="p">,</span> <span class="s1">&#39;1:second&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="o">.....</span><span class="p">:</span>                    <span class="s1">&#39;1:third&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">190</span><span class="p">]:</span> <span class="n">key</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">191</span><span class="p">]:</span> <span class="n">indexer</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;mergesort&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">192</span><span class="p">]:</span> <span class="n">indexer</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">192</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">193</span><span class="p">]:</span> <span class="n">values</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">indexer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">193</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([</span><span class="s1">&#39;1:first&#39;</span><span class="p">,</span> <span class="s1">&#39;1:second&#39;</span><span class="p">,</span> <span class="s1">&#39;1:third&#39;</span><span class="p">,</span> <span class="s1">&#39;2:first&#39;</span><span class="p">,</span> <span class="s1">&#39;2:second&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;&lt;U8&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>合并排序（MergeSort）是唯一的稳定排序，它保证有<code>O(n log n)</code>的性能（空间复杂度），但是其平均性能比默认的快速排序（QuickSort）要差。表 A-3 列出了可用的排序算法及其相关的性能指标。大部分用户完全不需要知道这些东西，但了解一下总是好的。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-970f54f58b6b3356.png"
        data-srcset="img/7178691-970f54f58b6b3356.png, img/7178691-970f54f58b6b3356.png 1.5x, img/7178691-970f54f58b6b3356.png 2x"
        data-sizes="auto"
        alt="img/7178691-970f54f58b6b3356.png"
        title="表 A-3 数组排序算法" /></p>
<h2 id="部分排序数组">部分排序数组</h2>
<p>排序的目的之一可能是确定数组中最大或最小的元素。NumPy 有两个优化方法，<code>numpy.partition</code>和<code>np.argpartition</code>，可以在第 k 个最小元素划分的数组：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">194</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">12345</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">195</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">196</span><span class="p">]:</span> <span class="n">arr</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">196</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.2047</span><span class="p">,</span>  <span class="mf">0.4789</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5194</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5557</span><span class="p">,</span>  <span class="mf">1.9658</span><span class="p">,</span>  <span class="mf">1.3934</span><span class="p">,</span>  <span class="mf">0.0929</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mf">0.2817</span><span class="p">,</span>  <span class="mf">0.769</span> <span class="p">,</span>  <span class="mf">1.2464</span><span class="p">,</span>  <span class="mf">1.0072</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.2962</span><span class="p">,</span>  <span class="mf">0.275</span> <span class="p">,</span>  <span class="mf">0.2289</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mf">1.3529</span><span class="p">,</span>  <span class="mf">0.8864</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0016</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3718</span><span class="p">,</span>  <span class="mf">1.669</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.4386</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">197</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">197</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">2.0016</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.2962</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5557</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5194</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3718</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4386</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2047</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mf">0.2817</span><span class="p">,</span>  <span class="mf">0.769</span> <span class="p">,</span>  <span class="mf">0.4789</span><span class="p">,</span>  <span class="mf">1.0072</span><span class="p">,</span>  <span class="mf">0.0929</span><span class="p">,</span>  <span class="mf">0.275</span> <span class="p">,</span>  <span class="mf">0.2289</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mf">1.3529</span><span class="p">,</span>  <span class="mf">0.8864</span><span class="p">,</span>  <span class="mf">1.3934</span><span class="p">,</span>  <span class="mf">1.9658</span><span class="p">,</span>  <span class="mf">1.669</span> <span class="p">,</span>  <span class="mf">1.2464</span><span class="p">])</span>
</span></span></code></pre></div><p>当你调用<code>partition(arr, 3)</code>，结果中的头三个元素是最小的三个，没有特定的顺序。<code>numpy.argpartition</code>与<code>numpy.argsort</code>相似，会返回索引，重排数据为等价的顺序：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">198</span><span class="p">]:</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argpartition</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">199</span><span class="p">]:</span> <span class="n">indices</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">199</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([</span><span class="mi">16</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">4</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span>  <span class="mi">9</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">200</span><span class="p">]:</span> <span class="n">arr</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">200</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">2.0016</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.2962</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5557</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5194</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3718</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4386</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2047</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mf">0.2817</span><span class="p">,</span>  <span class="mf">0.769</span> <span class="p">,</span>  <span class="mf">0.4789</span><span class="p">,</span>  <span class="mf">1.0072</span><span class="p">,</span>  <span class="mf">0.0929</span><span class="p">,</span>  <span class="mf">0.275</span> <span class="p">,</span>  <span class="mf">0.2289</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mf">1.3529</span><span class="p">,</span>  <span class="mf">0.8864</span><span class="p">,</span>  <span class="mf">1.3934</span><span class="p">,</span>  <span class="mf">1.9658</span><span class="p">,</span>  <span class="mf">1.669</span> <span class="p">,</span>  <span class="mf">1.2464</span><span class="p">])</span>
</span></span></code></pre></div><h2 id="numpysearchsorted在有序数组中查找元素"><code>numpy.searchsorted</code>：在有序数组中查找元素</h2>
<p><code>searchsorted</code>是一个在有序数组上执行二分查找的数组方法，只要将值插入到它返回的那个位置就能维持数组的有序性：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">201</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">15</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">202</span><span class="p">]:</span> <span class="n">arr</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">202</span><span class="p">]:</span> <span class="mi">3</span>
</span></span></code></pre></div><p>你可以传入一组值就能得到一组索引：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">203</span><span class="p">]:</span> <span class="n">arr</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">16</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">203</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
</span></span></code></pre></div><p>从上面的结果中可以看出，对于元素 0，<code>searchsorted</code>会返回 0。这是因为其默认行为是返回相等值组的左侧索引：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">204</span><span class="p">]:</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">205</span><span class="p">]:</span> <span class="n">arr</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">205</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">206</span><span class="p">]:</span> <span class="n">arr</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">206</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>
</span></span></code></pre></div><p>再来看<code>searchsorted</code>的另一个用法，假设我们有一个数据数组（其中的值在 0 到 10000 之间），还有一个表示“面元边界”的数组，我们希望用它将数据数组拆分开：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">207</span><span class="p">]:</span> <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">50</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">208</span><span class="p">]:</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">209</span><span class="p">]:</span> <span class="n">data</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">209</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([</span> <span class="mf">9940.</span><span class="p">,</span>  <span class="mf">6768.</span><span class="p">,</span>  <span class="mf">7908.</span><span class="p">,</span>  <span class="mf">1709.</span><span class="p">,</span>   <span class="mf">268.</span><span class="p">,</span>  <span class="mf">8003.</span><span class="p">,</span> <span class="mf">9037.</span><span class="p">,</span>   <span class="mf">246.</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mf">4917.</span><span class="p">,</span>  <span class="mf">5262.</span><span class="p">,</span>  <span class="mf">5963.</span><span class="p">,</span>   <span class="mf">519.</span><span class="p">,</span>  <span class="mf">8950.</span><span class="p">,</span>  <span class="mf">7282.</span><span class="p">,</span>  <span class="mf">8183.</span><span class="p">,</span>  <span class="mf">5002.</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mf">8101.</span><span class="p">,</span>   <span class="mf">959.</span><span class="p">,</span>  <span class="mf">2189.</span><span class="p">,</span>  <span class="mf">2587.</span><span class="p">,</span>  <span class="mf">4681.</span><span class="p">,</span>  <span class="mf">4593.</span><span class="p">,</span>  <span class="mf">7095.</span><span class="p">,</span>  <span class="mf">1780.</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mf">5314.</span><span class="p">,</span>  <span class="mf">1677.</span><span class="p">,</span>  <span class="mf">7688.</span><span class="p">,</span>  <span class="mf">9281.</span><span class="p">,</span>  <span class="mf">6094.</span><span class="p">,</span>  <span class="mf">1501.</span><span class="p">,</span>  <span class="mf">4896.</span><span class="p">,</span>  <span class="mf">3773.</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mf">8486.</span><span class="p">,</span>  <span class="mf">9110.</span><span class="p">,</span>  <span class="mf">3838.</span><span class="p">,</span>  <span class="mf">3154.</span><span class="p">,</span>  <span class="mf">5683.</span><span class="p">,</span>  <span class="mf">1878.</span><span class="p">,</span>  <span class="mf">1258.</span><span class="p">,</span>  <span class="mf">6875.</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mf">7996.</span><span class="p">,</span>  <span class="mf">5735.</span><span class="p">,</span>  <span class="mf">9732.</span><span class="p">,</span>  <span class="mf">6340.</span><span class="p">,</span>  <span class="mf">8884.</span><span class="p">,</span>  <span class="mf">4954.</span><span class="p">,</span>  <span class="mf">3516.</span><span class="p">,</span>  <span class="mf">7142.</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mf">5039.</span><span class="p">,</span>  <span class="mf">2256.</span><span class="p">])</span>
</span></span></code></pre></div><p>然后，为了得到各数据点所属区间的编号（其中 1 表示面元<code>[0,100)</code>），我们可以直接使用<code>searchsorted</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">210</span><span class="p">]:</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">bins</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">211</span><span class="p">]:</span> <span class="n">labels</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">211</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">array</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</span></span></code></pre></div><p>通过 pandas 的<code>groupby</code>使用该结果即可非常轻松地对原数据集进行拆分：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">212</span><span class="p">]:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">212</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="mi">2</span>     <span class="mf">498.000000</span>
</span></span><span class="line"><span class="cl"><span class="mi">3</span>    <span class="mf">3064.277778</span>
</span></span><span class="line"><span class="cl"><span class="mi">4</span>    <span class="mf">7389.035714</span>
</span></span><span class="line"><span class="cl"><span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></span></code></pre></div><h1 id="a7-用-numba-编写快速-numpy-函数">A.7 用 Numba 编写快速 NumPy 函数</h1>
<p>Numba 是一个开源项目，它可以利用 CPUs、GPUs 或其它硬件为类似 NumPy 的数据创建快速函数。它使用了 <a href="http://llvm.org/" target="_blank" rel="noopener noreffer ">LLVM 项目</a>，将 Python 代码转换为机器代码。</p>
<p>为了介绍 Numba，来考虑一个纯粹的 Python 函数，它使用<code>for</code>循环计算表达式<code>(x - y).mean()</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mean_distance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">nx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="mf">0.0</span>
</span></span><span class="line"><span class="cl">    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span> <span class="o">/</span> <span class="n">count</span>
</span></span></code></pre></div><p>这个函数很慢：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">209</span><span class="p">]:</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">10000000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">210</span><span class="p">]:</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">10000000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">211</span><span class="p">]:</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">mean_distance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span> <span class="n">loop</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mi">3</span><span class="p">:</span> <span class="mi">2</span> <span class="n">s</span> <span class="n">per</span> <span class="n">loop</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">212</span><span class="p">]:</span> <span class="o">%</span><span class="n">timeit</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="mi">100</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">14.7</span> <span class="n">ms</span> <span class="n">per</span> <span class="n">loop</span>
</span></span></code></pre></div><p>NumPy 的版本要比它快过 100 倍。我们可以转换这个函数为编译的 Numba 函数，使用<code>numba.jit</code>函数：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">213</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">numba</span> <span class="k">as</span> <span class="nn">nb</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">214</span><span class="p">]:</span> <span class="n">numba_mean_distance</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">mean_distance</span><span class="p">)</span>
</span></span></code></pre></div><p>也可以写成装饰器：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nd">@nb.jit</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mean_distance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">nx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="mf">0.0</span>
</span></span><span class="line"><span class="cl">    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span> <span class="o">/</span> <span class="n">count</span>
</span></span></code></pre></div><p>它要比向量化的 NumPy 快：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">215</span><span class="p">]:</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">numba_mean_distance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">100</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">10.3</span> <span class="n">ms</span> <span class="n">per</span> <span class="n">loop</span>
</span></span></code></pre></div><p>Numba 不能编译 Python 代码，但它支持纯 Python 写的一个部分，可以编写数值算法。</p>
<p>Numba 是一个深厚的库，支持多种硬件、编译模式和用户插件。它还可以编译 NumPy Python API 的一部分，而不用<code>for</code>循环。Numba 也可以识别可以便以为机器编码的结构体，但是若调用 CPython API，它就不知道如何编译。Numba 的<code>jit</code>函数有一个选项，<code>nopython=True</code>，它限制了可以被转换为 Python 代码的代码，这些代码可以编译为 LLVM，但没有任何 Python C API 调用。<code>jit(nopython=True)</code>有一个简短的别名<code>numba.njit</code>。</p>
<p>前面的例子，我们还可以这样写：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">float64</span><span class="p">,</span> <span class="n">njit</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@njit</span><span class="p">(</span><span class="n">float64</span><span class="p">(</span><span class="n">float64</span><span class="p">[:],</span> <span class="n">float64</span><span class="p">[:]))</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mean_distance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span></code></pre></div><p>我建议你学习 <a href="http://numba.pydata.org/" target="_blank" rel="noopener noreffer ">Numba 的线上文档</a>。下一节介绍一个创建自定义 Numpy <code>ufunc</code>对象的例子。</p>
<h2 id="用-numba-创建自定义numpyufunc对象">用 Numba 创建自定义<code>numpy.ufunc</code>对象</h2>
<p><code>numba.vectorize</code>创建了一个编译的 NumPy <code>ufunc</code>，它与内置的<code>ufunc</code>很像。考虑一个<code>numpy.add</code>的 Python 例子：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">vectorize</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@vectorize</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">nb_add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</span></span></code></pre></div><p>现在有：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">13</span><span class="p">]:</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">14</span><span class="p">]:</span> <span class="n">nb_add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">14</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span>  <span class="mf">0.</span><span class="p">,</span>   <span class="mf">2.</span><span class="p">,</span>   <span class="mf">4.</span><span class="p">,</span>   <span class="mf">6.</span><span class="p">,</span>   <span class="mf">8.</span><span class="p">,</span>  <span class="mf">10.</span><span class="p">,</span>  <span class="mf">12.</span><span class="p">,</span>  <span class="mf">14.</span><span class="p">,</span>  <span class="mf">16.</span><span class="p">,</span>  <span class="mf">18.</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">15</span><span class="p">]:</span> <span class="n">nb_add</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">15</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span>  <span class="mf">0.</span><span class="p">,</span>   <span class="mf">1.</span><span class="p">,</span>   <span class="mf">3.</span><span class="p">,</span>   <span class="mf">6.</span><span class="p">,</span>  <span class="mf">10.</span><span class="p">,</span>  <span class="mf">15.</span><span class="p">,</span>  <span class="mf">21.</span><span class="p">,</span>  <span class="mf">28.</span><span class="p">,</span>  <span class="mf">36.</span><span class="p">,</span>  <span class="mf">45.</span><span class="p">])</span>
</span></span></code></pre></div><h1 id="a8-高级数组输入输出">A.8 高级数组输入输出</h1>
<p>我在第 4 章中讲过，<code>np.save</code>和<code>np.load</code>可用于读写磁盘上以二进制格式存储的数组。其实还有一些工具可用于更为复杂的场景。尤其是内存映像（memory map），它使你能处理在内存中放不下的数据集。</p>
<h2 id="内存映像文件">内存映像文件</h2>
<p>内存映像文件是一种将磁盘上的非常大的二进制数据文件当做内存中的数组进行处理的方式。NumPy 实现了一个类似于<code>ndarray</code>的<code>memmap</code>对象，它允许将大文件分成小段进行读写，而不是一次性将整个数组读入内存。另外，<code>memmap</code>也拥有跟普通数组一样的方法，因此，基本上只要是能用于<code>ndarray</code>的算法就也能用于<code>memmap</code>。</p>
<p>要创建一个内存映像，可以使用函数<code>np.memmap</code>并传入一个文件路径、数据类型、形状以及文件模式：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">214</span><span class="p">]:</span> <span class="n">mmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="s1">&#39;mymmap&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="o">.....</span><span class="p">:</span>                  <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">215</span><span class="p">]:</span> <span class="n">mmap</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">215</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">memmap</span><span class="p">([[</span> <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span> <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span> <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="p">[</span> <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span> <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span> <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">]])</span>
</span></span></code></pre></div><p>对<code>memmap</code>切片将会返回磁盘上的数据的视图：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">216</span><span class="p">]:</span> <span class="n">section</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</span></span></code></pre></div><p>如果将数据赋值给这些视图：数据会先被缓存在内存中（就像是 Python 的文件对象），调用<code>flush</code>即可将其写入磁盘：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">217</span><span class="p">]:</span> <span class="n">section</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">218</span><span class="p">]:</span> <span class="n">mmap</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">219</span><span class="p">]:</span> <span class="n">mmap</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">219</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">memmap</span><span class="p">([[</span> <span class="mf">0.7584</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6605</span><span class="p">,</span>  <span class="mf">0.8626</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span>  <span class="mf">0.6046</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6212</span><span class="p">,</span>  <span class="mf">2.0542</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="o">-</span><span class="mf">1.2113</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0375</span><span class="p">,</span>  <span class="mf">0.7093</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.4117</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1719</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8957</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="o">-</span><span class="mf">0.1419</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3375</span><span class="p">,</span>  <span class="mf">0.4329</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span>  <span class="mf">1.2914</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.752</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.44</span>  <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="p">[</span> <span class="mf">0.</span>    <span class="p">,</span>  <span class="mf">0.</span>    <span class="p">,</span>  <span class="mf">0.</span>    <span class="p">,</span> <span class="o">...</span><span class="p">,</span>  <span class="mf">0.</span>    <span class="p">,</span>  <span class="mf">0.</span>    <span class="p">,</span>  <span class="mf">0.</span>    <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span> <span class="mf">0.</span>    <span class="p">,</span>  <span class="mf">0.</span>    <span class="p">,</span>  <span class="mf">0.</span>    <span class="p">,</span> <span class="o">...</span><span class="p">,</span>  <span class="mf">0.</span>    <span class="p">,</span>  <span class="mf">0.</span>    <span class="p">,</span>  <span class="mf">0.</span>    <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span> <span class="mf">0.</span>    <span class="p">,</span>  <span class="mf">0.</span>    <span class="p">,</span>  <span class="mf">0.</span>    <span class="p">,</span> <span class="o">...</span><span class="p">,</span>  <span class="mf">0.</span>    <span class="p">,</span>  <span class="mf">0.</span>    <span class="p">,</span>  <span class="mf">0.</span>    <span class="p">]])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">220</span><span class="p">]:</span> <span class="k">del</span> <span class="n">mmap</span>
</span></span></code></pre></div><p>只要某个内存映像超出了作用域，它就会被垃圾回收器回收，之前对其所做的任何修改都会被写入磁盘。当打开一个已经存在的内存映像时，仍然需要指明数据类型和形状，因为磁盘上的那个文件只是一块二进制数据而已，没有任何元数据：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">221</span><span class="p">]:</span> <span class="n">mmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="s1">&#39;mymmap&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">222</span><span class="p">]:</span> <span class="n">mmap</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">222</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl"><span class="n">memmap</span><span class="p">([[</span> <span class="mf">0.7584</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6605</span><span class="p">,</span>  <span class="mf">0.8626</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span>  <span class="mf">0.6046</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6212</span><span class="p">,</span>  <span class="mf">2.0542</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="o">-</span><span class="mf">1.2113</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0375</span><span class="p">,</span>  <span class="mf">0.7093</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.4117</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1719</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8957</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="o">-</span><span class="mf">0.1419</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3375</span><span class="p">,</span>  <span class="mf">0.4329</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span>  <span class="mf">1.2914</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.752</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.44</span>  <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="p">[</span> <span class="mf">0.</span>    <span class="p">,</span>  <span class="mf">0.</span>    <span class="p">,</span>  <span class="mf">0.</span>    <span class="p">,</span> <span class="o">...</span><span class="p">,</span>  <span class="mf">0.</span>    <span class="p">,</span>  <span class="mf">0.</span>    <span class="p">,</span>  <span class="mf">0.</span>    <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span> <span class="mf">0.</span>    <span class="p">,</span>  <span class="mf">0.</span>    <span class="p">,</span>  <span class="mf">0.</span>    <span class="p">,</span> <span class="o">...</span><span class="p">,</span>  <span class="mf">0.</span>    <span class="p">,</span>  <span class="mf">0.</span>    <span class="p">,</span>  <span class="mf">0.</span>    <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span> <span class="mf">0.</span>    <span class="p">,</span>  <span class="mf">0.</span>    <span class="p">,</span>  <span class="mf">0.</span>    <span class="p">,</span> <span class="o">...</span><span class="p">,</span>  <span class="mf">0.</span>    <span class="p">,</span>  <span class="mf">0.</span>    <span class="p">,</span>  <span class="mf">0.</span>    <span class="p">]])</span>
</span></span></code></pre></div><p>内存映像可以使用前面介绍的结构化或嵌套<code>dtype</code>。</p>
<h2 id="hdf5-及其他数组存储方式">HDF5 及其他数组存储方式</h2>
<p>PyTables 和 H5Py 这两个 Python 项目可以将 NumPy 的数组数据存储为高效且可压缩的 HDF5 格式（HDF 意思是“层次化数据格式”）。你可以安全地将好几百 GB 甚至 TB 的数据存储为 HDF5 格式。要学习 Python 使用 HDF5，请参考 pandas 线上文档。</p>
<h1 id="a9-性能建议">A.9 性能建议</h1>
<p>使用 NumPy 的代码的性能一般都很不错，因为数组运算一般都比纯 Python 循环快得多。下面大致列出了一些需要注意的事项：</p>
<ul>
<li>将 Python 循环和条件逻辑转换为数组运算和布尔数组运算。</li>
<li>尽量使用广播。</li>
<li>避免复制数据，尽量使用数组视图（即切片）。</li>
<li>利用<code>ufunc</code>及其各种方法。</li>
</ul>
<p>如果单用 NumPy 无论如何都达不到所需的性能指标，就可以考虑一下用 C、Fortran 或 Cython（等下会稍微介绍一下）来编写代码。我自己在工作中经常会用到 <a href="http://cython.org" target="_blank" rel="noopener noreffer ">Cython</a>，因为它不用花费我太多精力就能得到 C 语言那样的性能。</p>
<h2 id="连续内存的重要性">连续内存的重要性</h2>
<p>虽然这个话题有点超出本书的范围，但还是要提一下，因为在某些应用场景中，数组的内存布局可以对计算速度造成极大的影响。这是因为性能差别在一定程度上跟 CPU 的高速缓存（cache）体系有关。运算过程中访问连续内存块（例如，对以 C 顺序存储的数组的行求和）一般是最快的，因为内存子系统会将适当的内存块缓存到超高速的 L1 或 L2 CPU Cache 中。此外，NumPy 的 C 语言基础代码（某些）对连续存储的情况进行了优化处理，这样就能避免一些跨越式的内存访问。</p>
<p>一个数组的内存布局是连续的，就是说元素是以它们在数组中出现的顺序（即 Fortran 型（列优先）或 C 型（行优先））存储在内存中的。默认情况下，NumPy 数组是以 C 型连续的方式创建的。列优先的数组（比如 C 型连续数组的转置）也被称为 Fortran 型连续。通过<code>ndarray</code>的<code>flags</code>属性即可查看这些信息：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">225</span><span class="p">]:</span> <span class="n">arr_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">226</span><span class="p">]:</span> <span class="n">arr_f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">227</span><span class="p">]:</span> <span class="n">arr_c</span><span class="o">.</span><span class="n">flags</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">227</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl">  <span class="n">C_CONTIGUOUS</span> <span class="p">:</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">  <span class="n">F_CONTIGUOUS</span> <span class="p">:</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">  <span class="n">OWNDATA</span> <span class="p">:</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">  <span class="n">WRITEABLE</span> <span class="p">:</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">  <span class="n">ALIGNED</span> <span class="p">:</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">  <span class="n">UPDATEIFCOPY</span> <span class="p">:</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">228</span><span class="p">]:</span> <span class="n">arr_f</span><span class="o">.</span><span class="n">flags</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">228</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl">  <span class="n">C_CONTIGUOUS</span> <span class="p">:</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">  <span class="n">F_CONTIGUOUS</span> <span class="p">:</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">  <span class="n">OWNDATA</span> <span class="p">:</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">  <span class="n">WRITEABLE</span> <span class="p">:</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">  <span class="n">ALIGNED</span> <span class="p">:</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">  <span class="n">UPDATEIFCOPY</span> <span class="p">:</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">229</span><span class="p">]:</span> <span class="n">arr_f</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">f_contiguous</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">229</span><span class="p">]:</span> <span class="kc">True</span>
</span></span></code></pre></div><p>在这个例子中，对两个数组的行进行求和计算，理论上说，<code>arr_c</code>会比<code>arr_f</code>快，因为<code>arr_c</code>的行在内存中是连续的。我们可以在 IPython 中用<code>%timeit</code>来确认一下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">230</span><span class="p">]:</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">arr_c</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">784</span> <span class="n">us</span> <span class="o">+-</span> <span class="mf">10.4</span> <span class="n">us</span> <span class="n">per</span> <span class="n">loop</span> <span class="p">(</span><span class="n">mean</span> <span class="o">+-</span> <span class="n">std</span><span class="o">.</span> <span class="n">dev</span><span class="o">.</span> <span class="n">of</span> <span class="mi">7</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">1000</span> <span class="n">loops</span> <span class="n">each</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">231</span><span class="p">]:</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">arr_f</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">934</span> <span class="n">us</span> <span class="o">+-</span> <span class="mi">29</span> <span class="n">us</span> <span class="n">per</span> <span class="n">loop</span> <span class="p">(</span><span class="n">mean</span> <span class="o">+-</span> <span class="n">std</span><span class="o">.</span> <span class="n">dev</span><span class="o">.</span> <span class="n">of</span> <span class="mi">7</span> <span class="n">runs</span><span class="p">,</span> <span class="mi">1000</span> <span class="n">loops</span> <span class="n">each</span><span class="p">)</span>
</span></span></code></pre></div><p>如果想从 NumPy 中提升性能，这里就应该是下手的地方。如果数组的内存顺序不符合你的要求，使用<code>copy</code>并传入<code>'C'</code>或<code>'F'</code>即可解决该问题：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">232</span><span class="p">]:</span> <span class="n">arr_f</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">flags</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">232</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl">  <span class="n">C_CONTIGUOUS</span> <span class="p">:</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">  <span class="n">F_CONTIGUOUS</span> <span class="p">:</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">  <span class="n">OWNDATA</span> <span class="p">:</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">  <span class="n">WRITEABLE</span> <span class="p">:</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">  <span class="n">ALIGNED</span> <span class="p">:</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">  <span class="n">UPDATEIFCOPY</span> <span class="p">:</span> <span class="kc">False</span>
</span></span></code></pre></div><p>注意，在构造数组的视图时，其结果不一定是连续的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">233</span><span class="p">]:</span> <span class="n">arr_c</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">contiguous</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">233</span><span class="p">]:</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">234</span><span class="p">]:</span> <span class="n">arr_c</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">50</span><span class="p">]</span><span class="o">.</span><span class="n">flags</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">234</span><span class="p">]:</span> 
</span></span><span class="line"><span class="cl">  <span class="n">C_CONTIGUOUS</span> <span class="p">:</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">  <span class="n">F_CONTIGUOUS</span> <span class="p">:</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">  <span class="n">OWNDATA</span> <span class="p">:</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">  <span class="n">WRITEABLE</span> <span class="p">:</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">  <span class="n">ALIGNED</span> <span class="p">:</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">  <span class="n">UPDATEIFCOPY</span> <span class="p">:</span> <span class="kc">False</span>
</span></span></code></pre></div></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 0001-01-01</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="http://localhost:1313/posts/pyda-2e-zh/a/" data-title=""><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://localhost:1313/posts/pyda-2e-zh/a/"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="http://localhost:1313/posts/pyda-2e-zh/a/" data-title=""><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="http://localhost:1313/posts/pyda-2e-zh/a/" data-title=""><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="http://localhost:1313/posts/pyda-2e-zh/a/" data-title=""><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/pyda-2e-zh/b/" class="prev" rel="prev" title=""><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i></a>
            <a href="/posts/pyda-2e-zh/9/" class="next" rel="next" title=""><i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.118.2">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2022 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Aphros</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title> - Aphros的个人博客</title><meta name="Description" content="This is my cool site"><meta property="og:title" content="" />
<meta property="og:description" content="附录 B 更多关于 IPython 的内容 第 2 章中，我们学习了 IPython shell 和 Jupyter 笔记本的基础。本章中，我们会探索 IPython 更深层次的功能，可以从控制台或在 jupyter 使用。 B.1 使用命令历史 Ipython" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/pyda-2e-zh/b/" /><meta property="article:section" content="posts" />

<meta property="og:site_name" content="Aphros的博客" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content=""/>
<meta name="twitter:description" content="附录 B 更多关于 IPython 的内容 第 2 章中，我们学习了 IPython shell 和 Jupyter 笔记本的基础。本章中，我们会探索 IPython 更深层次的功能，可以从控制台或在 jupyter 使用。 B.1 使用命令历史 Ipython"/>
<meta name="application-name" content="Aphros的博客">
<meta name="apple-mobile-web-app-title" content="Aphros的博客"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://localhost:1313/posts/pyda-2e-zh/b/" /><link rel="prev" href="http://localhost:1313/posts/typescript-tutorial/any/" /><link rel="next" href="http://localhost:1313/posts/pyda-2e-zh/a/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/localhost:1313\/posts\/pyda-2e-zh\/b\/"
        },"genre": "posts","wordcount":  8971 ,
        "url": "http:\/\/localhost:1313\/posts\/pyda-2e-zh\/b\/","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "Aphros"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Aphros的个人博客">Aphros的博客</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Aphros的个人博客">Aphros的博客</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX"></h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Aphros</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="0001-01-01">0001-01-01</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;8971 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;18 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#搜索和重复使用命令历史">搜索和重复使用命令历史</a></li>
    <li><a href="#输入和输出变量">输入和输出变量</a></li>
  </ul>

  <ul>
    <li><a href="#shell-命令和别名">Shell 命令和别名</a></li>
    <li><a href="#目录书签系统">目录书签系统</a></li>
  </ul>

  <ul>
    <li><a href="#交互调试器">交互调试器</a></li>
    <li><a href="#使用调试器的其它方式">使用调试器的其它方式</a></li>
    <li><a href="#代码计时time和timeit">代码计时：<code>%time</code>和<code>%timeit</code></a></li>
    <li><a href="#基础分析prun和run--p">基础分析：<code>%prun</code>和<code>%run -p</code></a></li>
    <li><a href="#逐行分析函数">逐行分析函数</a></li>
  </ul>

  <ul>
    <li><a href="#重载模块依赖">重载模块依赖</a></li>
    <li><a href="#代码设计技巧">代码设计技巧</a></li>
    <li><a href="#保持相关对象和数据活跃">保持相关对象和数据活跃</a></li>
    <li><a href="#扁平优于嵌套">扁平优于嵌套</a></li>
    <li><a href="#克服对大文件的恐惧">克服对大文件的恐惧</a></li>
  </ul>

  <ul>
    <li><a href="#让类是对-ipython-友好的">让类是对 IPython 友好的</a></li>
    <li><a href="#文件和配置">文件和配置</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="附录-b-更多关于-ipython-的内容">附录 B 更多关于 IPython 的内容</h1>
<p>第 2 章中，我们学习了 IPython shell 和 Jupyter 笔记本的基础。本章中，我们会探索 IPython 更深层次的功能，可以从控制台或在 jupyter 使用。</p>
<h1 id="b1-使用命令历史">B.1 使用命令历史</h1>
<p>Ipython 维护了一个位于磁盘的小型数据库，用于保存执行的每条指令。它的用途有：</p>
<ul>
<li>只用最少的输入，就能搜索、补全和执行先前运行过的指令；</li>
<li>在不同会话间保存命令历史；</li>
<li>将日志输入/输出历史到一个文件</li>
</ul>
<p>这些功能在 shell 中，要比笔记本更为有用，因为笔记本从设计上是将输入和输出的代码放到每个代码格子中。</p>
<h2 id="搜索和重复使用命令历史">搜索和重复使用命令历史</h2>
<p>Ipython 可以让你搜索和执行之前的代码或其他命令。这个功能非常有用，因为你可能需要重复执行同样的命令，例如<code>%run</code>命令，或其它代码。假设你必须要执行：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="o">%</span><span class="n">run</span> <span class="n">first</span><span class="o">/</span><span class="n">second</span><span class="o">/</span><span class="n">third</span><span class="o">/</span><span class="n">data_script</span><span class="o">.</span><span class="n">py</span>
</span></span></code></pre></div><p>运行成功，然后检查结果，发现计算有错。解决完问题，然后修改了<code>data_script.py</code>，你就可以输入一些<code>%run</code>命令，然后按<code>Ctrl+P</code>或上箭头。这样就可以搜索历史命令，匹配输入字符的命令。多次按<code>Ctrl+P</code>或上箭头，会继续搜索命令。如果你要执行你想要执行的命令，不要害怕。你可以按下<code>Ctrl-N</code>或下箭头，向前移动历史命令。这样做了几次后，你可以不假思索地按下这些键！</p>
<p><code>Ctrl-R</code>可以带来如同 Unix 风格 shell（比如 bash shell）的<code>readline</code>的部分增量搜索功能。在 Windows 上，<code>readline</code>功能是被 IPython 模仿的。要使用这个功能，先按<code>Ctrl-R</code>，然后输入一些包含于输入行的想要搜索的字符：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">a_command</span> <span class="o">=</span> <span class="n">foo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">reverse</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="n">search</span><span class="p">)</span><span class="err">`</span><span class="n">com</span><span class="s1">&#39;: a_command = foo(x, y, z)</span>
</span></span></code></pre></div><p><code>Ctrl-R</code>会循环历史，找到匹配字符的每一行。</p>
<h2 id="输入和输出变量">输入和输出变量</h2>
<p>忘记将函数调用的结果分配给变量是非常烦人的。IPython 的一个会话会在一个特殊变量，存储输入和输出 Python 对象的引用。前面两个输出会分别存储在<code>_</code>（一个下划线）和<code>__</code>（两个下划线）变量：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">24</span><span class="p">]:</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">27</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">24</span><span class="p">]:</span> <span class="mi">134217728</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">25</span><span class="p">]:</span> <span class="n">_</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">25</span><span class="p">]:</span> <span class="mi">134217728</span>
</span></span></code></pre></div><p>输入变量是存储在名字类似<code>_iX</code>的变量中，<code>X</code>是输入行的编号。对于每个输入变量，都有一个对应的输出变量<code>_X</code>。因此在输入第 27 行之后，会有两个新变量<code>_27</code>（输出）和<code>_i27</code>（输入）:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">26</span><span class="p">]:</span> <span class="n">foo</span> <span class="o">=</span> <span class="s1">&#39;bar&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">27</span><span class="p">]:</span> <span class="n">foo</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">27</span><span class="p">]:</span> <span class="s1">&#39;bar&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">28</span><span class="p">]:</span> <span class="n">_i27</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">28</span><span class="p">]:</span> <span class="sa">u</span><span class="s1">&#39;foo&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">29</span><span class="p">]:</span> <span class="n">_27</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">29</span><span class="p">]:</span> <span class="s1">&#39;bar&#39;</span>
</span></span></code></pre></div><p>因为输入变量是字符串，它们可以用 Python 的<code>exec</code>关键字再次执行：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">30</span><span class="p">]:</span> <span class="n">exec</span><span class="p">(</span><span class="n">_i27</span><span class="p">)</span>
</span></span></code></pre></div><p>这里，<code>_i27</code>是在<code>In [27]</code>输入的代码。</p>
<p>有几个魔术函数可以让你利用输入和输出历史。<code>%hist</code>可以打印所有或部分的输入历史，加上或不加上编号。<code>%reset</code>可以清理交互命名空间，或输入和输出缓存。<code>%xdel</code>魔术函数可以去除 IPython 中对一个特别对象的所有引用。对于关于这些魔术方法的更多内容，请查看文档。</p>
<blockquote>
<p>警告：当处理非常大的数据集时，要记住 IPython 的输入和输出的历史会造成被引用的对象不被垃圾回收（释放内存），即使你使用<code>del</code>关键字从交互命名空间删除变量。在这种情况下，小心使用<code>%xdel</code>和<code>%reset</code>可以帮助你避免陷入内存问题。</p>
</blockquote>
<h1 id="b2-与操作系统交互">B.2 与操作系统交互</h1>
<p>IPython 的另一个功能是无缝连接文件系统和操作系统。这意味着，在同时做其它事时，无需退出 IPython，就可以像 Windows 或 Unix 使用命令行操作，包括 shell 命令、更改目录、用 Python 对象（列表或字符串）存储结果。它还有简单的命令别名和目录书签功能。</p>
<p>表 B-1 总结了调用 shell 命令的魔术函数和语法。我会在下面几节介绍这些功能。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-4da7ee14be2da211.png"
        data-srcset="img/7178691-4da7ee14be2da211.png, img/7178691-4da7ee14be2da211.png 1.5x, img/7178691-4da7ee14be2da211.png 2x"
        data-sizes="auto"
        alt="img/7178691-4da7ee14be2da211.png"
        title="表 B-1 IPython 系统相关命令" /></p>
<h2 id="shell-命令和别名">Shell 命令和别名</h2>
<p>用叹号开始一行，是告诉 IPython 执行叹号后面的所有内容。这意味着你可以删除文件（取决于操作系统，用<code>rm</code>或<code>del</code>）、改变目录或执行任何其他命令。</p>
<p>通过给变量加上叹号，你可以在一个变量中存储命令的控制台输出。例如，在我联网的基于 Linux 的主机上，我可以获得 IP 地址为 Python 变量：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">ip_info</span> <span class="o">=</span> <span class="err">!</span><span class="n">ifconfig</span> <span class="n">wlan0</span> <span class="o">|</span> <span class="n">grep</span> <span class="s2">&#34;inet &#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">ip_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="s1">&#39;inet addr:10.0.0.11  Bcast:10.0.0.255  Mask:255.255.255.0&#39;</span>
</span></span></code></pre></div><p>返回的 Python 对象<code>ip_info</code>实际上是一个自定义的列表类型，它包含着多种版本的控制台输出。</p>
<p>当使用！，IPython 还可以替换定义在当前环境的 Python 值。要这么做，可以在变量名前面加上$符号：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">foo</span> <span class="o">=</span> <span class="s1">&#39;test*&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="err">!</span><span class="n">ls</span> <span class="err">$</span><span class="n">foo</span>
</span></span><span class="line"><span class="cl"><span class="n">test4</span><span class="o">.</span><span class="n">py</span>  <span class="n">test</span><span class="o">.</span><span class="n">py</span>  <span class="n">test</span><span class="o">.</span><span class="n">xml</span>
</span></span></code></pre></div><p><code>%alias</code>魔术函数可以自定义 shell 命令的快捷方式。看一个简单的例子：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="o">%</span><span class="n">alias</span> <span class="n">ll</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">ll</span> <span class="o">/</span><span class="n">usr</span>
</span></span><span class="line"><span class="cl"><span class="n">total</span> <span class="mi">332</span>
</span></span><span class="line"><span class="cl"><span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>   <span class="mi">2</span> <span class="n">root</span> <span class="n">root</span>  <span class="mi">69632</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">29</span> <span class="mi">20</span><span class="p">:</span><span class="mi">36</span> <span class="nb">bin</span><span class="o">/</span>
</span></span><span class="line"><span class="cl"><span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>   <span class="mi">2</span> <span class="n">root</span> <span class="n">root</span>   <span class="mi">4096</span> <span class="mi">2010</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">23</span> <span class="mi">12</span><span class="p">:</span><span class="mi">05</span> <span class="n">games</span><span class="o">/</span>
</span></span><span class="line"><span class="cl"><span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">123</span> <span class="n">root</span> <span class="n">root</span>  <span class="mi">20480</span> <span class="mi">2011</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">26</span> <span class="mi">18</span><span class="p">:</span><span class="mi">08</span> <span class="n">include</span><span class="o">/</span>
</span></span><span class="line"><span class="cl"><span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">265</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">126976</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">29</span> <span class="mi">20</span><span class="p">:</span><span class="mi">36</span> <span class="n">lib</span><span class="o">/</span>
</span></span><span class="line"><span class="cl"><span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">44</span> <span class="n">root</span> <span class="n">root</span>  <span class="mi">69632</span> <span class="mi">2011</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">26</span> <span class="mi">18</span><span class="p">:</span><span class="mi">08</span> <span class="n">lib32</span><span class="o">/</span>
</span></span><span class="line"><span class="cl"><span class="n">lrwxrwxrwx</span>   <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span>      <span class="mi">3</span> <span class="mi">2010</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">23</span> <span class="mi">16</span><span class="p">:</span><span class="mi">02</span> <span class="n">lib64</span> <span class="o">-&gt;</span> <span class="n">lib</span><span class="o">/</span>
</span></span><span class="line"><span class="cl"><span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">15</span> <span class="n">root</span> <span class="n">root</span>   <span class="mi">4096</span> <span class="mi">2011</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">13</span> <span class="mi">19</span><span class="p">:</span><span class="mi">03</span> <span class="n">local</span><span class="o">/</span>
</span></span><span class="line"><span class="cl"><span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>   <span class="mi">2</span> <span class="n">root</span> <span class="n">root</span>  <span class="mi">12288</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">09</span><span class="p">:</span><span class="mi">32</span> <span class="n">sbin</span><span class="o">/</span>
</span></span><span class="line"><span class="cl"><span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">387</span> <span class="n">root</span> <span class="n">root</span>  <span class="mi">12288</span> <span class="mi">2011</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">04</span> <span class="mi">22</span><span class="p">:</span><span class="mi">53</span> <span class="n">share</span><span class="o">/</span>
</span></span><span class="line"><span class="cl"><span class="n">drwxrwsr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">24</span> <span class="n">root</span> <span class="n">src</span>    <span class="mi">4096</span> <span class="mi">2011</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">17</span> <span class="mi">18</span><span class="p">:</span><span class="mi">38</span> <span class="n">src</span><span class="o">/</span>
</span></span></code></pre></div><p>你可以执行多个命令，就像在命令行中一样，只需用分号隔开：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">558</span><span class="p">]:</span> <span class="o">%</span><span class="n">alias</span> <span class="n">test_alias</span> <span class="p">(</span><span class="n">cd</span> <span class="n">examples</span><span class="p">;</span> <span class="n">ls</span><span class="p">;</span> <span class="n">cd</span> <span class="o">..</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">559</span><span class="p">]:</span> <span class="n">test_alias</span>
</span></span><span class="line"><span class="cl"><span class="n">macrodata</span><span class="o">.</span><span class="n">csv</span>  <span class="n">spx</span><span class="o">.</span><span class="n">csv</span>	<span class="n">tips</span><span class="o">.</span><span class="n">csv</span>
</span></span></code></pre></div><p>当会话结束，你定义的别名就会失效。要创建恒久的别名，需要使用配置。</p>
<h2 id="目录书签系统">目录书签系统</h2>
<p>IPython 有一个简单的目录书签系统，可以让你保存常用目录的别名，这样在跳来跳去的时候会非常方便。例如，假设你想创建一个书签，指向本书的补充内容：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="o">%</span><span class="n">bookmark</span> <span class="n">py4da</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">wesm</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">pydata</span><span class="o">-</span><span class="n">book</span>
</span></span></code></pre></div><p>这么做之后，当使用<code>%cd</code>魔术命令，就可以使用定义的书签：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="n">cd</span> <span class="n">py4da</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">bookmark</span><span class="p">:</span><span class="n">py4da</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">wesm</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">pydata</span><span class="o">-</span><span class="n">book</span>
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">wesm</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">pydata</span><span class="o">-</span><span class="n">book</span>
</span></span></code></pre></div><p>如果书签的名字，与当前工作目录的一个目录重名，你可以使用<code>-b</code>标志来覆写，使用书签的位置。使用<code>%bookmark</code>的<code>-l</code>选项，可以列出所有的书签：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="o">%</span><span class="n">bookmark</span> <span class="o">-</span><span class="n">l</span>
</span></span><span class="line"><span class="cl"><span class="n">Current</span> <span class="n">bookmarks</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="n">py4da</span> <span class="o">-&gt;</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">wesm</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">pydata</span><span class="o">-</span><span class="n">book</span><span class="o">-</span><span class="n">source</span>
</span></span></code></pre></div><p>书签，和别名不同，在会话之间是保持的。</p>
<h1 id="b3-软件开发工具">B.3 软件开发工具</h1>
<p>除了作为优秀的交互式计算和数据探索环境，IPython 也是有效的 Python 软件开发工具。在数据分析中，最重要的是要有正确的代码。幸运的是，IPython 紧密集成了和加强了 Python 内置的 pdb 调试器。第二，需要快速的代码。对于这点，IPython 有易于使用的代码计时和分析工具。我会详细介绍这些工具。</p>
<h2 id="交互调试器">交互调试器</h2>
<p>IPython 的调试器用<code>Tab</code>补全、语法增强、逐行异常追踪增强了 pdb。调试代码的最佳时间就是刚刚发生错误。异常发生之后就输入<code>%debug</code>，就启动了调试器，进入抛出异常的堆栈框架：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">run</span> <span class="n">examples</span><span class="o">/</span><span class="n">ipython_bug</span><span class="o">.</span><span class="n">py</span>
</span></span><span class="line"><span class="cl"><span class="o">---------------------------------------------------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="ne">AssertionError</span>                            <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">wesm</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">pydata</span><span class="o">-</span><span class="n">book</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">ipython_bug</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">     <span class="mi">13</span>     <span class="n">throws_an_exception</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">     <span class="mi">14</span>
</span></span><span class="line"><span class="cl"><span class="o">---&gt;</span> <span class="mi">15</span> <span class="n">calling_things</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">wesm</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">pydata</span><span class="o">-</span><span class="n">book</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">ipython_bug</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">calling_things</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="mi">11</span> <span class="k">def</span> <span class="nf">calling_things</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">     <span class="mi">12</span>     <span class="n">works_fine</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="o">---&gt;</span> <span class="mi">13</span>     <span class="n">throws_an_exception</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">     <span class="mi">14</span>
</span></span><span class="line"><span class="cl">     <span class="mi">15</span> <span class="n">calling_things</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">wesm</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">pydata</span><span class="o">-</span><span class="n">book</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">ipython_bug</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">throws_an_exception</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="mi">7</span>     <span class="n">a</span> <span class="o">=</span> <span class="mi">5</span>
</span></span><span class="line"><span class="cl">      <span class="mi">8</span>     <span class="n">b</span> <span class="o">=</span> <span class="mi">6</span>
</span></span><span class="line"><span class="cl"><span class="o">----&gt;</span> <span class="mi">9</span>     <span class="k">assert</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="mi">10</span>
</span></span><span class="line"><span class="cl">     <span class="mi">11</span> <span class="k">def</span> <span class="nf">calling_things</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="ne">AssertionError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="o">%</span><span class="n">debug</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">wesm</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">pydata</span><span class="o">-</span><span class="n">book</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">ipython_bug</span><span class="o">.</span><span class="n">py</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="n">throws_an_exception</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="mi">8</span>     <span class="n">b</span> <span class="o">=</span> <span class="mi">6</span>
</span></span><span class="line"><span class="cl"><span class="o">----&gt;</span> <span class="mi">9</span>     <span class="k">assert</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="mi">10</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ipdb</span><span class="o">&gt;</span>
</span></span></code></pre></div><p>一旦进入调试器，你就可以执行任意的 Python 代码，在每个堆栈框架中检查所有的对象和数据（解释器会保持它们活跃）。默认是从错误发生的最低级开始。通过<code>u</code>（up）和<code>d</code>（down），你可以在不同等级的堆栈踪迹切换：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">ipdb</span><span class="o">&gt;</span> <span class="n">u</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">wesm</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">pydata</span><span class="o">-</span><span class="n">book</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">ipython_bug</span><span class="o">.</span><span class="n">py</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span><span class="n">calling_things</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">     <span class="mi">12</span>     <span class="n">works_fine</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="o">---&gt;</span> <span class="mi">13</span>     <span class="n">throws_an_exception</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">     <span class="mi">14</span>
</span></span></code></pre></div><p>执行<code>%pdb</code>命令，可以在发生任何异常时让 IPython 自动启动调试器，许多用户会发现这个功能非常好用。</p>
<p>用调试器帮助开发代码也很容易，特别是当你希望设置断点或在函数和脚本间移动，以检查每个阶段的状态。有多种方法可以实现。第一种是使用<code>%run</code>和<code>-d</code>，它会在执行传入脚本的任何代码之前调用调试器。你必须马上按<code>s</code>（step）以进入脚本：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="n">run</span> <span class="o">-</span><span class="n">d</span> <span class="n">examples</span><span class="o">/</span><span class="n">ipython_bug</span><span class="o">.</span><span class="n">py</span>
</span></span><span class="line"><span class="cl"><span class="n">Breakpoint</span> <span class="mi">1</span> <span class="n">at</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">wesm</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">pydata</span><span class="o">-</span><span class="n">book</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">ipython_bug</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">NOTE</span><span class="p">:</span> <span class="n">Enter</span> <span class="s1">&#39;c&#39;</span> <span class="n">at</span> <span class="n">the</span> <span class="n">ipdb</span><span class="o">&gt;</span>  <span class="n">prompt</span> <span class="n">to</span> <span class="n">start</span> <span class="n">your</span> <span class="n">script</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ipdb</span><span class="o">&gt;</span> <span class="n">s</span>
</span></span><span class="line"><span class="cl"><span class="o">--</span><span class="n">Call</span><span class="o">--</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">wesm</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">pydata</span><span class="o">-</span><span class="n">book</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">ipython_bug</span><span class="o">.</span><span class="n">py</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span><span class="o">---&gt;</span> <span class="mi">1</span> <span class="k">def</span> <span class="nf">works_fine</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">      <span class="mi">2</span>     <span class="n">a</span> <span class="o">=</span> <span class="mi">5</span>
</span></span><span class="line"><span class="cl">      <span class="mi">3</span>     <span class="n">b</span> <span class="o">=</span> <span class="mi">6</span>
</span></span></code></pre></div><p>然后，你就可以决定如何工作。例如，在前面的异常，我们可以设置一个断点，就在调用<code>works_fine</code>之前，然后运行脚本，在遇到断点时按<code>c</code>（continue）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">ipdb</span><span class="o">&gt;</span> <span class="n">b</span> <span class="mi">12</span>
</span></span><span class="line"><span class="cl"><span class="n">ipdb</span><span class="o">&gt;</span> <span class="n">c</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">wesm</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">pydata</span><span class="o">-</span><span class="n">book</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">ipython_bug</span><span class="o">.</span><span class="n">py</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="n">calling_things</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">     <span class="mi">11</span> <span class="k">def</span> <span class="nf">calling_things</span><span class="p">():</span>
</span></span><span class="line"><span class="cl"><span class="mi">2</span><span class="o">--&gt;</span> <span class="mi">12</span>     <span class="n">works_fine</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">     <span class="mi">13</span>     <span class="n">throws_an_exception</span><span class="p">()</span>
</span></span></code></pre></div><p>这时，你可以<code>step</code>进入<code>works_fine()</code>，或通过按<code>n</code>（next）执行<code>works_fine()</code>，进入下一行：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">ipdb</span><span class="o">&gt;</span> <span class="n">n</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">wesm</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">pydata</span><span class="o">-</span><span class="n">book</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">ipython_bug</span><span class="o">.</span><span class="n">py</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span><span class="n">calling_things</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="mi">2</span>    <span class="mi">12</span>     <span class="n">works_fine</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="o">---&gt;</span> <span class="mi">13</span>     <span class="n">throws_an_exception</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">     <span class="mi">14</span>
</span></span></code></pre></div><p>然后，我们可以进入<code>throws_an_exception</code>，到达发生错误的一行，查看变量。注意，调试器的命令是在变量名之前，在变量名前面加叹号！可以查看内容：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">ipdb</span><span class="o">&gt;</span> <span class="n">s</span>
</span></span><span class="line"><span class="cl"><span class="o">--</span><span class="n">Call</span><span class="o">--</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">wesm</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">pydata</span><span class="o">-</span><span class="n">book</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">ipython_bug</span><span class="o">.</span><span class="n">py</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="n">throws_an_exception</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="mi">5</span>
</span></span><span class="line"><span class="cl"><span class="o">----&gt;</span> <span class="mi">6</span> <span class="k">def</span> <span class="nf">throws_an_exception</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">      <span class="mi">7</span>     <span class="n">a</span> <span class="o">=</span> <span class="mi">5</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ipdb</span><span class="o">&gt;</span> <span class="n">n</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">wesm</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">pydata</span><span class="o">-</span><span class="n">book</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">ipython_bug</span><span class="o">.</span><span class="n">py</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="n">throws_an_exception</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="mi">6</span> <span class="k">def</span> <span class="nf">throws_an_exception</span><span class="p">():</span>
</span></span><span class="line"><span class="cl"><span class="o">----&gt;</span> <span class="mi">7</span>     <span class="n">a</span> <span class="o">=</span> <span class="mi">5</span>
</span></span><span class="line"><span class="cl">      <span class="mi">8</span>     <span class="n">b</span> <span class="o">=</span> <span class="mi">6</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ipdb</span><span class="o">&gt;</span> <span class="n">n</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">wesm</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">pydata</span><span class="o">-</span><span class="n">book</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">ipython_bug</span><span class="o">.</span><span class="n">py</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="n">throws_an_exception</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="mi">7</span>     <span class="n">a</span> <span class="o">=</span> <span class="mi">5</span>
</span></span><span class="line"><span class="cl"><span class="o">----&gt;</span> <span class="mi">8</span>     <span class="n">b</span> <span class="o">=</span> <span class="mi">6</span>
</span></span><span class="line"><span class="cl">      <span class="mi">9</span>     <span class="k">assert</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ipdb</span><span class="o">&gt;</span> <span class="n">n</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">wesm</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">pydata</span><span class="o">-</span><span class="n">book</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">ipython_bug</span><span class="o">.</span><span class="n">py</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="n">throws_an_exception</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="mi">8</span>     <span class="n">b</span> <span class="o">=</span> <span class="mi">6</span>
</span></span><span class="line"><span class="cl"><span class="o">----&gt;</span> <span class="mi">9</span>     <span class="k">assert</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="mi">10</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ipdb</span><span class="o">&gt;</span> <span class="err">!</span><span class="n">a</span>
</span></span><span class="line"><span class="cl"><span class="mi">5</span>
</span></span><span class="line"><span class="cl"><span class="n">ipdb</span><span class="o">&gt;</span> <span class="err">!</span><span class="n">b</span>
</span></span><span class="line"><span class="cl"><span class="mi">6</span>
</span></span></code></pre></div><p>提高使用交互式调试器的熟练度需要练习和经验。表 B-2，列出了所有调试器命令。如果你习惯了 IDE，你可能觉得终端的调试器在一开始会不顺手，但会觉得越来越好用。一些 Python 的 IDEs 有很好的 GUI 调试器，选择顺手的就好。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="img/7178691-90a4b17e20b5b03a.png"
        data-srcset="img/7178691-90a4b17e20b5b03a.png, img/7178691-90a4b17e20b5b03a.png 1.5x, img/7178691-90a4b17e20b5b03a.png 2x"
        data-sizes="auto"
        alt="img/7178691-90a4b17e20b5b03a.png"
        title="表 B-2 IPython 调试器命令" /></p>
<h2 id="使用调试器的其它方式">使用调试器的其它方式</h2>
<p>还有一些其它工作可以用到调试器。第一个是使用特殊的<code>set_trace</code>函数（根据<code>pdb.set_trace</code>命名的），这是一个简装的断点。还有两种方法是你可能想用的（像我一样，将其添加到 IPython 的配置）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">IPython.core.debugger</span> <span class="kn">import</span> <span class="n">Pdb</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">set_trace</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">Pdb</span><span class="p">(</span><span class="n">color_scheme</span><span class="o">=</span><span class="s1">&#39;Linux&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_trace</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_back</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">pdb</span> <span class="o">=</span> <span class="n">Pdb</span><span class="p">(</span><span class="n">color_scheme</span><span class="o">=</span><span class="s1">&#39;Linux&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">pdb</span><span class="o">.</span><span class="n">runcall</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span></code></pre></div><p>第一个函数<code>set_trace</code>非常简单。如果你想暂时停下来进行仔细检查（比如发生异常之前），可以在代码的任何位置使用<code>set_trace</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="n">run</span> <span class="n">examples</span><span class="o">/</span><span class="n">ipython_bug</span><span class="o">.</span><span class="n">py</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">wesm</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">pydata</span><span class="o">-</span><span class="n">book</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">ipython_bug</span><span class="o">.</span><span class="n">py</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="n">calling_things</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">     <span class="mi">15</span>     <span class="n">set_trace</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="o">---&gt;</span> <span class="mi">16</span>     <span class="n">throws_an_exception</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">     <span class="mi">17</span>
</span></span></code></pre></div><p>按<code>c</code>（continue）可以让代码继续正常行进。</p>
<p>我们刚看的<code>debug</code>函数，可以让你方便的在调用任何函数时使用调试器。假设我们写了一个下面的函数，想逐步分析它的逻辑：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmp</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">tmp</span> <span class="o">/</span> <span class="n">z</span>
</span></span></code></pre></div><p>普通地使用<code>f</code>，就会像<code>f(1, 2, z=3)</code>。而要想进入<code>f</code>，将<code>f</code>作为第一个参数传递给<code>debug</code>，再将位置和关键词参数传递给<code>f</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="n">f</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="mi">1</span> <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
</span></span><span class="line"><span class="cl"><span class="o">----&gt;</span> <span class="mi">2</span>     <span class="n">tmp</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</span></span><span class="line"><span class="cl">      <span class="mi">3</span>     <span class="k">return</span> <span class="n">tmp</span> <span class="o">/</span> <span class="n">z</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ipdb</span><span class="o">&gt;</span>
</span></span></code></pre></div><p>这两个简单方法节省了我平时的大量时间。</p>
<p>最后，调试器可以和<code>%run</code>一起使用。脚本通过运行<code>%run -d</code>，就可以直接进入调试器，随意设置断点并启动脚本：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="o">%</span><span class="n">run</span> <span class="o">-</span><span class="n">d</span> <span class="n">examples</span><span class="o">/</span><span class="n">ipython_bug</span><span class="o">.</span><span class="n">py</span>
</span></span><span class="line"><span class="cl"><span class="n">Breakpoint</span> <span class="mi">1</span> <span class="n">at</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">wesm</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">pydata</span><span class="o">-</span><span class="n">book</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">ipython_bug</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">NOTE</span><span class="p">:</span> <span class="n">Enter</span> <span class="s1">&#39;c&#39;</span> <span class="n">at</span> <span class="n">the</span> <span class="n">ipdb</span><span class="o">&gt;</span>  <span class="n">prompt</span> <span class="n">to</span> <span class="n">start</span> <span class="n">your</span> <span class="n">script</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ipdb</span><span class="o">&gt;</span>
</span></span></code></pre></div><p>加上<code>-b</code>和行号，可以预设一个断点：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="o">%</span><span class="n">run</span> <span class="o">-</span><span class="n">d</span> <span class="o">-</span><span class="n">b2</span> <span class="n">examples</span><span class="o">/</span><span class="n">ipython_bug</span><span class="o">.</span><span class="n">py</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Breakpoint</span> <span class="mi">1</span> <span class="n">at</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">wesm</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">pydata</span><span class="o">-</span><span class="n">book</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">ipython_bug</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">NOTE</span><span class="p">:</span> <span class="n">Enter</span> <span class="s1">&#39;c&#39;</span> <span class="n">at</span> <span class="n">the</span> <span class="n">ipdb</span><span class="o">&gt;</span>  <span class="n">prompt</span> <span class="n">to</span> <span class="n">start</span> <span class="n">your</span> <span class="n">script</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ipdb</span><span class="o">&gt;</span> <span class="n">c</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">wesm</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">pydata</span><span class="o">-</span><span class="n">book</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">ipython_bug</span><span class="o">.</span><span class="n">py</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="n">works_fine</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="mi">1</span> <span class="k">def</span> <span class="nf">works_fine</span><span class="p">():</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span><span class="o">---&gt;</span> <span class="mi">2</span>     <span class="n">a</span> <span class="o">=</span> <span class="mi">5</span>
</span></span><span class="line"><span class="cl">      <span class="mi">3</span>     <span class="n">b</span> <span class="o">=</span> <span class="mi">6</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ipdb</span><span class="o">&gt;</span>
</span></span></code></pre></div><h2 id="代码计时time和timeit">代码计时：<code>%time</code>和<code>%timeit</code></h2>
<p>对于大型和长时间运行的数据分析应用，你可能希望测量不同组件或单独函数调用语句的执行时间。你可能想知道哪个函数占用的时间最长。幸运的是，IPython 可以让你开发和测试代码时，很容易地获得这些信息。</p>
<p>手动用<code>time</code>模块和它的函数<code>time.clock</code>和<code>time.time</code>给代码计时，既单调又重复，因为必须要写一些无趣的模板化代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl"><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># some code to run here</span>
</span></span><span class="line"><span class="cl"><span class="n">elapsed_per</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="n">iterations</span>
</span></span></code></pre></div><p>因为这是一个很普通的操作，IPython 有两个魔术函数，<code>%time</code>和<code>%timeit</code>，可以自动化这个过程。</p>
<p><code>%time</code>会运行一次语句，报告总共的执行时间。假设我们有一个大的字符串列表，我们想比较不同的可以挑选出特定开头字符串的方法。这里有一个含有 600000 字符串的列表，和两个方法，用以选出<code>foo</code>开头的字符串：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># a very large list of strings</span>
</span></span><span class="line"><span class="cl"><span class="n">strings</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;foobar&#39;</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="s1">&#39;qux&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="s1">&#39;Guido Van Rossum&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">method1</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">strings</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">method2</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">strings</span> <span class="k">if</span> <span class="n">x</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;foo&#39;</span><span class="p">]</span>
</span></span></code></pre></div><p>看起来它们的性能应该是同级别的，但事实呢？用<code>%time</code>进行一下测量：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">561</span><span class="p">]:</span> <span class="o">%</span><span class="n">time</span> <span class="n">method1</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">strings</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="n">CPU</span> <span class="n">times</span><span class="p">:</span> <span class="n">user</span> <span class="mf">0.19</span> <span class="n">s</span><span class="p">,</span> <span class="n">sys</span><span class="p">:</span> <span class="mf">0.00</span> <span class="n">s</span><span class="p">,</span> <span class="n">total</span><span class="p">:</span> <span class="mf">0.19</span> <span class="n">s</span>
</span></span><span class="line"><span class="cl"><span class="n">Wall</span> <span class="n">time</span><span class="p">:</span> <span class="mf">0.19</span> <span class="n">s</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">562</span><span class="p">]:</span> <span class="o">%</span><span class="n">time</span> <span class="n">method2</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">strings</span> <span class="k">if</span> <span class="n">x</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;foo&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">CPU</span> <span class="n">times</span><span class="p">:</span> <span class="n">user</span> <span class="mf">0.09</span> <span class="n">s</span><span class="p">,</span> <span class="n">sys</span><span class="p">:</span> <span class="mf">0.00</span> <span class="n">s</span><span class="p">,</span> <span class="n">total</span><span class="p">:</span> <span class="mf">0.09</span> <span class="n">s</span>
</span></span><span class="line"><span class="cl"><span class="n">Wall</span> <span class="n">time</span><span class="p">:</span> <span class="mf">0.09</span> <span class="n">s</span>
</span></span></code></pre></div><p>Wall time（wall-clock time 的简写）是主要关注的。第一个方法是第二个方法的两倍多，但是这种测量方法并不准确。如果用<code>%time</code>多次测量，你就会发现结果是变化的。要想更准确，可以使用<code>%timeit</code>魔术函数。给出任意一条语句，它能多次运行这条语句以得到一个更为准确的时间：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">563</span><span class="p">]:</span> <span class="o">%</span><span class="n">timeit</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">strings</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="mi">10</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mi">3</span><span class="p">:</span> <span class="mi">159</span> <span class="n">ms</span> <span class="n">per</span> <span class="n">loop</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">564</span><span class="p">]:</span> <span class="o">%</span><span class="n">timeit</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">strings</span> <span class="k">if</span> <span class="n">x</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;foo&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="mi">10</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">59.3</span> <span class="n">ms</span> <span class="n">per</span> <span class="n">loop</span>
</span></span></code></pre></div><p>这个例子说明了解 Python 标准库、NumPy、pandas 和其它库的性能是很有价值的。在大型数据分析中，这些毫秒的时间就会累积起来！</p>
<p><code>%timeit</code>特别适合分析执行时间短的语句和函数，即使是微秒或纳秒。这些时间可能看起来毫不重要，但是一个 20 微秒的函数执行 1 百万次就比一个 5 微秒的函数长 15 秒。在上一个例子中，我们可以直接比较两个字符串操作，以了解它们的性能特点：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">565</span><span class="p">]:</span> <span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;foobar&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">566</span><span class="p">]:</span> <span class="n">y</span> <span class="o">=</span> <span class="s1">&#39;foo&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">567</span><span class="p">]:</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">1000000</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mi">3</span><span class="p">:</span> <span class="mi">267</span> <span class="n">ns</span> <span class="n">per</span> <span class="n">loop</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">568</span><span class="p">]:</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">x</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">y</span>
</span></span><span class="line"><span class="cl"><span class="mi">10000000</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mi">3</span><span class="p">:</span> <span class="mi">147</span> <span class="n">ns</span> <span class="n">per</span> <span class="n">loop</span>
</span></span></code></pre></div><h2 id="基础分析prun和run--p">基础分析：<code>%prun</code>和<code>%run -p</code></h2>
<p>分析代码与代码计时关系很紧密，除了它关注的是“时间花在了哪里”。Python 主要的分析工具是 <code>cProfile</code>模块，它并不局限于 IPython。<code>cProfile</code>会执行一个程序或任意的代码块，并会跟踪每个函数执行的时间。</p>
<p>使用<code>cProfile</code>的通常方式是在命令行中运行一整段程序，输出每个函数的累积时间。假设我们有一个简单的在循环中进行线型代数运算的脚本（计算一系列的<code>100×100</code>矩阵的最大绝对特征值）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="kn">import</span> <span class="n">eigvals</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">run_experiment</span><span class="p">(</span><span class="n">niter</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">K</span> <span class="o">=</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl">    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">niter</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">max_eigenvalue</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">eigvals</span><span class="p">(</span><span class="n">mat</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_eigenvalue</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">results</span>
</span></span><span class="line"><span class="cl"><span class="n">some_results</span> <span class="o">=</span> <span class="n">run_experiment</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span> <span class="s1">&#39;Largest one we saw: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">some_results</span><span class="p">)</span>
</span></span></code></pre></div><p>你可以用<code>cProfile</code>运行这个脚本，使用下面的命令行：</p>
<pre tabindex="0"><code>python -m cProfile cprof_example.py
</code></pre><p>运行之后，你会发现输出是按函数名排序的。这样要看出谁耗费的时间多有点困难，最好用<code>-s</code>指定排序：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="err">$</span> <span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">cProfile</span> <span class="o">-</span><span class="n">s</span> <span class="n">cumulative</span> <span class="n">cprof_example</span><span class="o">.</span><span class="n">py</span>
</span></span><span class="line"><span class="cl"><span class="n">Largest</span> <span class="n">one</span> <span class="n">we</span> <span class="n">saw</span><span class="p">:</span> <span class="mf">11.923204422</span>
</span></span><span class="line"><span class="cl">    <span class="mi">15116</span> <span class="n">function</span> <span class="n">calls</span> <span class="p">(</span><span class="mi">14927</span> <span class="n">primitive</span> <span class="n">calls</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">0.720</span> <span class="n">seconds</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Ordered</span> <span class="n">by</span><span class="p">:</span> <span class="n">cumulative</span> <span class="n">time</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ncalls</span>  <span class="n">tottime</span>  <span class="n">percall</span>  <span class="n">cumtime</span>  <span class="n">percall</span> <span class="n">filename</span><span class="p">:</span><span class="n">lineno</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="mi">1</span>    <span class="mf">0.001</span>    <span class="mf">0.001</span>    <span class="mf">0.721</span>    <span class="mf">0.721</span> <span class="n">cprof_example</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">1</span><span class="p">(</span><span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="mi">100</span>    <span class="mf">0.003</span>    <span class="mf">0.000</span>    <span class="mf">0.586</span>    <span class="mf">0.006</span> <span class="n">linalg</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">702</span><span class="p">(</span><span class="n">eigvals</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="mi">200</span>    <span class="mf">0.572</span>    <span class="mf">0.003</span>    <span class="mf">0.572</span>    <span class="mf">0.003</span> <span class="p">{</span><span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lapack_lite</span><span class="o">.</span><span class="n">dgeev</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="mi">1</span>    <span class="mf">0.002</span>    <span class="mf">0.002</span>    <span class="mf">0.075</span>    <span class="mf">0.075</span> <span class="fm">__init__</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">106</span><span class="p">(</span><span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="mi">100</span>    <span class="mf">0.059</span>    <span class="mf">0.001</span>    <span class="mf">0.059</span>    <span class="mf">0.001</span> <span class="p">{</span><span class="n">method</span> <span class="s1">&#39;randn&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="mi">1</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.044</span>    <span class="mf">0.044</span> <span class="n">add_newdocs</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">9</span><span class="p">(</span><span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="mi">2</span>    <span class="mf">0.001</span>    <span class="mf">0.001</span>    <span class="mf">0.037</span>    <span class="mf">0.019</span> <span class="fm">__init__</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">1</span><span class="p">(</span><span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="mi">2</span>    <span class="mf">0.003</span>    <span class="mf">0.002</span>    <span class="mf">0.030</span>    <span class="mf">0.015</span> <span class="fm">__init__</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">2</span><span class="p">(</span><span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="mi">1</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.030</span>    <span class="mf">0.030</span> <span class="n">type_check</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">3</span><span class="p">(</span><span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="mi">1</span>    <span class="mf">0.001</span>    <span class="mf">0.001</span>    <span class="mf">0.021</span>    <span class="mf">0.021</span> <span class="fm">__init__</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">15</span><span class="p">(</span><span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="mi">1</span>    <span class="mf">0.013</span>    <span class="mf">0.013</span>    <span class="mf">0.013</span>    <span class="mf">0.013</span> <span class="n">numeric</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">1</span><span class="p">(</span><span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="mi">1</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.009</span>    <span class="mf">0.009</span> <span class="fm">__init__</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">6</span><span class="p">(</span><span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="mi">1</span>    <span class="mf">0.001</span>    <span class="mf">0.001</span>    <span class="mf">0.008</span>    <span class="mf">0.008</span> <span class="fm">__init__</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">45</span><span class="p">(</span><span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="mi">262</span>    <span class="mf">0.005</span>    <span class="mf">0.000</span>    <span class="mf">0.007</span>    <span class="mf">0.000</span> <span class="n">function_base</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">3178</span><span class="p">(</span><span class="n">add_newdoc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="mi">100</span>    <span class="mf">0.003</span>    <span class="mf">0.000</span>    <span class="mf">0.005</span>    <span class="mf">0.000</span> <span class="n">linalg</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">162</span><span class="p">(</span><span class="n">_assertFinite</span><span class="p">)</span>
</span></span></code></pre></div><p>只显示出前 15 行。扫描<code>cumtime</code>列，可以容易地看出每个函数用了多少时间。如果一个函数调用了其它函数，计时并不会停止。<code>cProfile</code>会记录每个函数的起始和结束时间，使用它们进行计时。</p>
<p>除了在命令行中使用，<code>cProfile</code>也可以在程序中使用，分析任意代码块，而不必运行新进程。Ipython 的<code>%prun</code>和<code>%run -p</code>，有便捷的接口实现这个功能。<code>%prun</code>使用类似<code>cProfile</code>的命令行选项，但是可以分析任意 Python 语句，而不用整个 Py 文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="o">%</span><span class="n">prun</span> <span class="o">-</span><span class="n">l</span> <span class="mi">7</span> <span class="o">-</span><span class="n">s</span> <span class="n">cumulative</span> <span class="n">run_experiment</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">         <span class="mi">4203</span> <span class="n">function</span> <span class="n">calls</span> <span class="ow">in</span> <span class="mf">0.643</span> <span class="n">seconds</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Ordered</span> <span class="n">by</span><span class="p">:</span> <span class="n">cumulative</span> <span class="n">time</span>
</span></span><span class="line"><span class="cl"><span class="n">List</span> <span class="n">reduced</span> <span class="kn">from</span> <span class="mi">32</span> <span class="n">to</span> <span class="mi">7</span> <span class="n">due</span> <span class="n">to</span> <span class="n">restriction</span> <span class="o">&lt;</span><span class="mi">7</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n">ncalls</span>  <span class="n">tottime</span>  <span class="n">percall</span>  <span class="n">cumtime</span>  <span class="n">percall</span> <span class="n">filename</span><span class="p">:</span><span class="n">lineno</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="mi">1</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.643</span>    <span class="mf">0.643</span> <span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">1</span><span class="p">(</span><span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="mi">1</span>    <span class="mf">0.001</span>    <span class="mf">0.001</span>    <span class="mf">0.643</span>    <span class="mf">0.643</span> <span class="n">cprof_example</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">4</span><span class="p">(</span><span class="n">run_experiment</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="mi">100</span>    <span class="mf">0.003</span>    <span class="mf">0.000</span>    <span class="mf">0.583</span>    <span class="mf">0.006</span> <span class="n">linalg</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">702</span><span class="p">(</span><span class="n">eigvals</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="mi">200</span>    <span class="mf">0.569</span>    <span class="mf">0.003</span>    <span class="mf">0.569</span>    <span class="mf">0.003</span> <span class="p">{</span><span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lapack_lite</span><span class="o">.</span><span class="n">dgeev</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="mi">100</span>    <span class="mf">0.058</span>    <span class="mf">0.001</span>    <span class="mf">0.058</span>    <span class="mf">0.001</span> <span class="p">{</span><span class="n">method</span> <span class="s1">&#39;randn&#39;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="mi">100</span>    <span class="mf">0.003</span>    <span class="mf">0.000</span>    <span class="mf">0.005</span>    <span class="mf">0.000</span> <span class="n">linalg</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">162</span><span class="p">(</span><span class="n">_assertFinite</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="mi">200</span>    <span class="mf">0.002</span>    <span class="mf">0.000</span>    <span class="mf">0.002</span>    <span class="mf">0.000</span> <span class="p">{</span><span class="n">method</span> <span class="s1">&#39;all&#39;</span> <span class="n">of</span> <span class="s1">&#39;numpy.ndarray&#39;</span><span class="p">}</span>
</span></span></code></pre></div><p>相似的，调用<code>%run -p -s cumulative cprof_example.py</code>有和命令行相似的作用，只是你不用离开 Ipython。</p>
<p>在 Jupyter 笔记本中，你可以使用<code>%%prun</code>魔术方法（两个<code>%</code>）来分析一整段代码。这会弹出一个带有分析输出的独立窗口。便于快速回答一些问题，比如“为什么这段代码用了这么长时间”？</p>
<p>使用 IPython 或 Jupyter，还有一些其它工具可以让分析工作更便于理解。其中之一是 <a href="https://github.com/jiffyclub/snakeviz/" target="_blank" rel="noopener noreffer ">SnakeViz</a>，它会使用 d3.js 产生一个分析结果的交互可视化界面。</p>
<h2 id="逐行分析函数">逐行分析函数</h2>
<p>有些情况下，用<code>%prun</code>（或其它基于<code>cProfile</code>的分析方法）得到的信息，不能获得函数执行时间的整个过程，或者结果过于复杂，加上函数名，很难进行解读。对于这种情况，有一个小库叫做<code>line_profiler</code>（可以通过 PyPI 或包管理工具获得）。它包含 IPython 插件，可以启用一个新的魔术函数<code>%lprun</code>，可以对一个函数或多个函数进行逐行分析。你可以通过修改 IPython 配置（查看 IPython 文档或本章后面的配置小节）加入下面这行，启用这个插件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># A list of dotted module names of IPython extensions to load.</span>
</span></span><span class="line"><span class="cl"><span class="n">c</span><span class="o">.</span><span class="n">TerminalIPythonApp</span><span class="o">.</span><span class="n">extensions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;line_profiler&#39;</span><span class="p">]</span>
</span></span></code></pre></div><p>你还可以运行命令：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%</span><span class="n">load_ext</span> <span class="n">line_profiler</span>
</span></span></code></pre></div><p><code>line_profiler</code>也可以在程序中使用（查看完整文档），但是在 IPython 中使用是最为强大的。假设你有一个带有下面代码的模块<code>prof_mod</code>，做一些 NumPy 数组操作：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">randn</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">add_and_sum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">added</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</span></span><span class="line"><span class="cl">    <span class="n">summed</span> <span class="o">=</span> <span class="n">added</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">summed</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">call_function</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="n">randn</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="n">randn</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">add_and_sum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span></span></code></pre></div><p>如果想了解<code>add_and_sum</code>函数的性能，<code>%prun</code>可以给出下面内容：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">569</span><span class="p">]:</span> <span class="o">%</span><span class="n">run</span> <span class="n">prof_mod</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">570</span><span class="p">]:</span> <span class="n">x</span> <span class="o">=</span> <span class="n">randn</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="mi">3000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">571</span><span class="p">]:</span> <span class="n">y</span> <span class="o">=</span> <span class="n">randn</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="mi">3000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">572</span><span class="p">]:</span> <span class="o">%</span><span class="n">prun</span> <span class="n">add_and_sum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="mi">4</span> <span class="n">function</span> <span class="n">calls</span> <span class="ow">in</span> <span class="mf">0.049</span> <span class="n">seconds</span>
</span></span><span class="line"><span class="cl">   <span class="n">Ordered</span> <span class="n">by</span><span class="p">:</span> <span class="n">internal</span> <span class="n">time</span>
</span></span><span class="line"><span class="cl">   <span class="n">ncalls</span>  <span class="n">tottime</span>  <span class="n">percall</span>  <span class="n">cumtime</span>  <span class="n">percall</span> <span class="n">filename</span><span class="p">:</span><span class="n">lineno</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="mi">1</span>    <span class="mf">0.036</span>    <span class="mf">0.036</span>    <span class="mf">0.046</span>    <span class="mf">0.046</span> <span class="n">prof_mod</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">3</span><span class="p">(</span><span class="n">add_and_sum</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="mi">1</span>    <span class="mf">0.009</span>    <span class="mf">0.009</span>    <span class="mf">0.009</span>    <span class="mf">0.009</span> <span class="p">{</span><span class="n">method</span> <span class="s1">&#39;sum&#39;</span> <span class="n">of</span> <span class="s1">&#39;numpy.ndarray&#39;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="mi">1</span>    <span class="mf">0.003</span>    <span class="mf">0.003</span>    <span class="mf">0.049</span>    <span class="mf">0.049</span> <span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">1</span><span class="p">(</span><span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span><span class="p">)</span>
</span></span></code></pre></div><p>上面的做法启发性不大。激活了 IPython 插件<code>line_profiler</code>，新的命令<code>%lprun</code>就能用了。使用中的不同点是，我们必须告诉<code>%lprun</code>要分析的函数是哪个。语法是：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%</span><span class="n">lprun</span> <span class="o">-</span><span class="n">f</span> <span class="n">func1</span> <span class="o">-</span><span class="n">f</span> <span class="n">func2</span> <span class="n">statement_to_profile</span>
</span></span></code></pre></div><p>我们想分析<code>add_and_sum</code>，运行：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">573</span><span class="p">]:</span> <span class="o">%</span><span class="n">lprun</span> <span class="o">-</span><span class="n">f</span> <span class="n">add_and_sum</span> <span class="n">add_and_sum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Timer</span> <span class="n">unit</span><span class="p">:</span> <span class="mf">1e-06</span> <span class="n">s</span>
</span></span><span class="line"><span class="cl"><span class="n">File</span><span class="p">:</span> <span class="n">prof_mod</span><span class="o">.</span><span class="n">py</span>
</span></span><span class="line"><span class="cl"><span class="n">Function</span><span class="p">:</span> <span class="n">add_and_sum</span> <span class="n">at</span> <span class="n">line</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">Total</span> <span class="n">time</span><span class="p">:</span> <span class="mf">0.045936</span> <span class="n">s</span>
</span></span><span class="line"><span class="cl"><span class="n">Line</span> <span class="c1">#      Hits         Time  Per Hit   % Time  Line Contents</span>
</span></span><span class="line"><span class="cl"><span class="o">==============================================================</span>
</span></span><span class="line"><span class="cl">     <span class="mi">3</span>                                           <span class="k">def</span> <span class="nf">add_and_sum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">     <span class="mi">4</span>         <span class="mi">1</span>        <span class="mi">36510</span>  <span class="mf">36510.0</span>     <span class="mf">79.5</span>      <span class="n">added</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</span></span><span class="line"><span class="cl">     <span class="mi">5</span>         <span class="mi">1</span>         <span class="mi">9425</span>   <span class="mf">9425.0</span>     <span class="mf">20.5</span>      <span class="n">summed</span> <span class="o">=</span> <span class="n">added</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="mi">6</span>         <span class="mi">1</span>            <span class="mi">1</span>      <span class="mf">1.0</span>      <span class="mf">0.0</span>      <span class="k">return</span> <span class="n">summed</span>
</span></span></code></pre></div><p>这样就容易诠释了。我们分析了和代码语句中一样的函数。看之前的模块代码，我们可以调用<code>call_function</code>并对它和<code>add_and_sum</code>进行分析，得到一个完整的代码性能概括：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">574</span><span class="p">]:</span> <span class="o">%</span><span class="n">lprun</span> <span class="o">-</span><span class="n">f</span> <span class="n">add_and_sum</span> <span class="o">-</span><span class="n">f</span> <span class="n">call_function</span> <span class="n">call_function</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">Timer</span> <span class="n">unit</span><span class="p">:</span> <span class="mf">1e-06</span> <span class="n">s</span>
</span></span><span class="line"><span class="cl"><span class="n">File</span><span class="p">:</span> <span class="n">prof_mod</span><span class="o">.</span><span class="n">py</span>
</span></span><span class="line"><span class="cl"><span class="n">Function</span><span class="p">:</span> <span class="n">add_and_sum</span> <span class="n">at</span> <span class="n">line</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">Total</span> <span class="n">time</span><span class="p">:</span> <span class="mf">0.005526</span> <span class="n">s</span>
</span></span><span class="line"><span class="cl"><span class="n">Line</span> <span class="c1">#      Hits         Time  Per Hit   % Time  Line Contents</span>
</span></span><span class="line"><span class="cl"><span class="o">==============================================================</span>
</span></span><span class="line"><span class="cl">     <span class="mi">3</span>                                           <span class="k">def</span> <span class="nf">add_and_sum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">     <span class="mi">4</span>         <span class="mi">1</span>         <span class="mi">4375</span>   <span class="mf">4375.0</span>     <span class="mf">79.2</span>      <span class="n">added</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</span></span><span class="line"><span class="cl">     <span class="mi">5</span>         <span class="mi">1</span>         <span class="mi">1149</span>   <span class="mf">1149.0</span>     <span class="mf">20.8</span>      <span class="n">summed</span> <span class="o">=</span> <span class="n">added</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="mi">6</span>         <span class="mi">1</span>            <span class="mi">2</span>      <span class="mf">2.0</span>      <span class="mf">0.0</span>      <span class="k">return</span> <span class="n">summed</span>
</span></span><span class="line"><span class="cl"><span class="n">File</span><span class="p">:</span> <span class="n">prof_mod</span><span class="o">.</span><span class="n">py</span>
</span></span><span class="line"><span class="cl"><span class="n">Function</span><span class="p">:</span> <span class="n">call_function</span> <span class="n">at</span> <span class="n">line</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl"><span class="n">Total</span> <span class="n">time</span><span class="p">:</span> <span class="mf">0.121016</span> <span class="n">s</span>
</span></span><span class="line"><span class="cl"><span class="n">Line</span> <span class="c1">#      Hits         Time  Per Hit   % Time  Line Contents</span>
</span></span><span class="line"><span class="cl"><span class="o">==============================================================</span>
</span></span><span class="line"><span class="cl">     <span class="mi">8</span>                                           <span class="k">def</span> <span class="nf">call_function</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">     <span class="mi">9</span>         <span class="mi">1</span>        <span class="mi">57169</span>  <span class="mf">57169.0</span>     <span class="mf">47.2</span>      <span class="n">x</span> <span class="o">=</span> <span class="n">randn</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="mi">10</span>         <span class="mi">1</span>        <span class="mi">58304</span>  <span class="mf">58304.0</span>     <span class="mf">48.2</span>      <span class="n">y</span> <span class="o">=</span> <span class="n">randn</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="mi">11</span>         <span class="mi">1</span>         <span class="mi">5543</span>   <span class="mf">5543.0</span>      <span class="mf">4.6</span>      <span class="k">return</span> <span class="n">add_and_sum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span></span></code></pre></div><p>我的经验是用<code>%prun (cProfile)</code>进行宏观分析，<code>%lprun (line_profiler)</code>做微观分析。最好对这两个工具都了解清楚。</p>
<blockquote>
<p>笔记：使用<code>%lprun</code>必须要指明函数名的原因是追踪每行的执行时间的损耗过多。追踪无用的函数会显著地改变结果。</p>
</blockquote>
<h1 id="b4-使用-ipython-高效开发的技巧">B.4 使用 IPython 高效开发的技巧</h1>
<p>方便快捷地写代码、调试和使用是每个人的目标。除了代码风格，流程细节（比如代码重载）也需要一些调整。</p>
<p>因此，这一节的内容更像是门艺术而不是科学，还需要你不断的试验，以达成高效。最终，你要能结构优化代码，并且能省时省力地检查程序或函数的结果。我发现用 IPython 设计的软件比起命令行，要更适合工作。尤其是当发生错误时，你需要检查自己或别人写的数月或数年前写的代码的错误。</p>
<h2 id="重载模块依赖">重载模块依赖</h2>
<p>在 Python 中，当你输入<code>import some_lib</code>，<code>some_lib</code>中的代码就会被执行，所有的变量、函数和定义的引入，就会被存入到新创建的<code>some_lib</code>模块命名空间。当下一次输入<code>some_lib</code>，就会得到一个已存在的模块命名空间的引用。潜在的问题是当你<code>%run</code>一个脚本，它依赖于另一个模块，而这个模块做过修改，就会产生问题。假设我在<code>test_script.py</code>中有如下代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">some_lib</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">x</span> <span class="o">=</span> <span class="mi">5</span>
</span></span><span class="line"><span class="cl"><span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">result</span> <span class="o">=</span> <span class="n">some_lib</span><span class="o">.</span><span class="n">get_answer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span></span></code></pre></div><p>如果你运行过了<code>%run test_script.py</code>，然后修改了<code>some_lib.py</code>，下一次再执行<code>%run test_script.py</code>，还会得到旧版本的<code>some_lib.py</code>，这是因为 Python 模块系统的“一次加载”机制。这一点区分了 Python 和其它数据分析环境，比如 MATLAB，它会自动传播代码修改。解决这个问题，有多种方法。第一种是在标准库<code>importlib</code>模块中使用<code>reload</code>函数：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">some_lib</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">importlib</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">importlib</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">some_lib</span><span class="p">)</span>
</span></span></code></pre></div><p>这可以保证每次运行<code>test_script.py</code>时可以加载最新的<code>some_lib.py</code>。很明显，如果依赖更深，在各处都使用<code>reload</code>是非常麻烦的。对于这个问题，IPython 有一个特殊的<code>dreload</code>函数（它不是魔术函数）重载深层的模块。如果我运行过<code>some_lib.py</code>，然后输入<code>dreload(some_lib)</code>，就会尝试重载<code>some_lib</code>和它的依赖。不过，这个方法不适用于所有场景，但比重启 IPython 强多了。</p>
<h2 id="代码设计技巧">代码设计技巧</h2>
<p>对于这单，没有简单的对策，但是有一些原则，是我在工作中发现很好用的。</p>
<h2 id="保持相关对象和数据活跃">保持相关对象和数据活跃</h2>
<p>为命令行写一个下面示例中的程序是很少见的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">my_functions</span> <span class="kn">import</span> <span class="n">g</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">g</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="mi">6</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="mf">7.5</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></div><p>在 IPython 中运行这个程序会发生问题，你发现是什么了吗？运行之后，任何定义在<code>main</code>函数中的结果和对象都不能在 IPython 中被访问到。更好的方法是将<code>main</code>中的代码直接在模块的命名空间中执行（或者在<code>__name__ == '__main__':</code>中，如果你想让这个模块可以被引用）。这样，当你<code>%rundiamante</code>，就可以查看所有定义在<code>main</code>中的变量。这等价于在 Jupyter 笔记本的代码格中定义一个顶级变量。</p>
<h2 id="扁平优于嵌套">扁平优于嵌套</h2>
<p>深层嵌套的代码总让我联想到洋葱皮。当测试或调试一个函数时，你需要剥多少层洋葱皮才能到达目标代码呢？“扁平优于嵌套”是 Python 之禅的一部分，它也适用于交互式代码开发。尽量将函数和类去耦合和模块化，有利于测试（如果你是在写单元测试）、调试和交互式使用。</p>
<h2 id="克服对大文件的恐惧">克服对大文件的恐惧</h2>
<p>如果你之前是写 JAVA（或者其它类似的语言），你可能被告知要让文件简短。在多数语言中，这都是合理的建议：太长会让人感觉是坏代码，意味着重构和重组是必要的。但是，在用 IPython 开发时，运行 10 个相关联的小文件（小于 100 行），比起两个或三个长文件，会让你更头疼。更少的文件意味着重载更少的模块和更少的编辑时在文件中跳转。我发现维护大模块，每个模块都是紧密组织的，会更实用和 Pythonic。经过方案迭代，有时会将大文件分解成小文件。</p>
<p>我不建议极端化这条建议，那样会形成一个单独的超大文件。找到一个合理和直观的大型代码模块库和封装结构往往需要一点工作，但这在团队工作中非常重要。每个模块都应该结构紧密，并且应该能直观地找到负责每个功能领域功能和类。</p>
<h1 id="b5-ipython-高级功能">B.5 IPython 高级功能</h1>
<p>要全面地使用 IPython 系统需要用另一种稍微不同的方式写代码，或深入 IPython 的配置。</p>
<h2 id="让类是对-ipython-友好的">让类是对 IPython 友好的</h2>
<p>IPython 会尽可能地在控制台美化展示每个字符串。对于许多对象，比如字典、列表和元组，内置的<code>pprint</code>模块可以用来美化格式。但是，在用户定义的类中，你必自己生成字符串。假设有一个下面的简单的类：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Message</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span>
</span></span></code></pre></div><p>如果这么写，就会发现默认的输出不够美观：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">576</span><span class="p">]:</span> <span class="n">x</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="s1">&#39;I have a secret&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">577</span><span class="p">]:</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">577</span><span class="p">]:</span> <span class="o">&lt;</span><span class="n">__main__</span><span class="o">.</span><span class="n">Message</span> <span class="n">instance</span> <span class="n">at</span> <span class="mh">0x60ebbd8</span><span class="o">&gt;</span>
</span></span></code></pre></div><p>IPython 会接收<code>__repr__</code>魔术方法返回的字符串（通过<code>output = repr(obj)</code>），并在控制台打印出来。因此，我们可以添加一个简单的<code>__repr__</code>方法到前面的类中，以得到一个更有用的输出：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Message</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;Message: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span>
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">579</span><span class="p">]:</span> <span class="n">x</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="s1">&#39;I have a secret&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">580</span><span class="p">]:</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">580</span><span class="p">]:</span> <span class="n">Message</span><span class="p">:</span> <span class="n">I</span> <span class="n">have</span> <span class="n">a</span> <span class="n">secret</span>
</span></span></code></pre></div><h2 id="文件和配置">文件和配置</h2>
<p>通过扩展配置系统，大多数 IPython 和 Jupyter 笔记本的外观（颜色、提示符、行间距等等）和动作都是可以配置的。通过配置，你可以做到：</p>
<ul>
<li>改变颜色主题</li>
<li>改变输入和输出提示符，或删除输出之后、输入之前的空行</li>
<li>执行任意 Python 语句（例如，引入总是要使用的代码或者每次加载 IPython 都要运行的内容）</li>
<li>启用 IPython 总是要运行的插件，比如<code>line_profiler</code>中的<code>%lprun</code>魔术函数</li>
<li>启用 Jupyter 插件</li>
<li>定义自己的魔术函数或系统别名</li>
</ul>
<p>IPython 的配置存储在特殊的<code>ipython_config.py</code>文件中，它通常是在用户<code>home</code>目录的<code>.ipython/</code>文件夹中。配置是通过一个特殊文件。当你启动 IPython，就会默认加载这个存储在<code>profile_default</code>文件夹中的默认文件。因此，在我的 Linux 系统，完整的 IPython 配置文件路径是：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">wesm</span><span class="o">/.</span><span class="n">ipython</span><span class="o">/</span><span class="n">profile_default</span><span class="o">/</span><span class="n">ipython_config</span><span class="o">.</span><span class="n">py</span>
</span></span></code></pre></div><p>要启动这个文件，运行下面的命令：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">ipython</span> <span class="n">profile</span> <span class="n">create</span>
</span></span></code></pre></div><p>这个文件中的内容留给读者自己探索。这个文件有注释，解释了每个配置选项的作用。另一点，可以有多个配置文件。假设你想要另一个 IPython 配置文件，专门是为另一个应用或项目的。创建一个新的配置文件很简单，如下所示：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">ipython</span> <span class="n">profile</span> <span class="n">create</span> <span class="n">secret_project</span>
</span></span></code></pre></div><p>做完之后，在新创建的<code>profile_secret_project</code>目录便捷配置文件，然后如下启动 IPython：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="err">$</span> <span class="n">ipython</span> <span class="o">--</span><span class="n">profile</span><span class="o">=</span><span class="n">secret_project</span>
</span></span><span class="line"><span class="cl"><span class="n">Python</span> <span class="mf">3.5.1</span> <span class="o">|</span> <span class="n">packaged</span> <span class="n">by</span> <span class="n">conda</span><span class="o">-</span><span class="n">forge</span> <span class="o">|</span> <span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">May</span> <span class="mi">20</span> <span class="mi">2016</span><span class="p">,</span> <span class="mi">05</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">56</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Type</span> <span class="s2">&#34;copyright&#34;</span><span class="p">,</span> <span class="s2">&#34;credits&#34;</span> <span class="ow">or</span> <span class="s2">&#34;license&#34;</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">IPython</span> <span class="mf">5.1.0</span> <span class="o">--</span> <span class="n">An</span> <span class="n">enhanced</span> <span class="n">Interactive</span> <span class="n">Python</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="err">?</span>         <span class="o">-&gt;</span> <span class="n">Introduction</span> <span class="ow">and</span> <span class="n">overview</span> <span class="n">of</span> <span class="n">IPython</span><span class="s1">&#39;s features.</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="n">quickref</span> <span class="o">-&gt;</span> <span class="n">Quick</span> <span class="n">reference</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="n">help</span>      <span class="o">-&gt;</span> <span class="n">Python</span><span class="s1">&#39;s own help system.</span>
</span></span><span class="line"><span class="cl"><span class="nb">object</span><span class="err">?</span>   <span class="o">-&gt;</span> <span class="n">Details</span> <span class="n">about</span> <span class="s1">&#39;object&#39;</span><span class="p">,</span> <span class="n">use</span> <span class="s1">&#39;object??&#39;</span> <span class="k">for</span> <span class="n">extra</span> <span class="n">details</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">IPython</span> <span class="n">profile</span><span class="p">:</span> <span class="n">secret_project</span>
</span></span></code></pre></div><p>和之前一样，IPython 的文档是一个极好的学习配置文件的资源。</p>
<p>配置 Jupyter 有些不同，因为你可以使用除了 Python 的其它语言。要创建一个类似的 Jupyter 配置文件，运行：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">jupyter</span> <span class="n">notebook</span> <span class="o">--</span><span class="n">generate</span><span class="o">-</span><span class="n">config</span>
</span></span></code></pre></div><p>这样会在<code>home</code>目录的<code>.jupyter/jupyter_notebook_config.py</code>创建配置文件。编辑完之后，可以将它重命名：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="err">$</span> <span class="n">mv</span> <span class="o">~/.</span><span class="n">jupyter</span><span class="o">/</span><span class="n">jupyter_notebook_config</span><span class="o">.</span><span class="n">py</span> <span class="o">~/.</span><span class="n">jupyter</span><span class="o">/</span><span class="n">my_custom_config</span><span class="o">.</span><span class="n">py</span>
</span></span></code></pre></div><p>打开 Jupyter 之后，你可以添加<code>--config</code>参数：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"> <span class="n">jupyter</span> <span class="n">notebook</span> <span class="o">--</span><span class="n">config</span><span class="o">=~/.</span><span class="n">jupyter</span><span class="o">/</span><span class="n">my_custom_config</span><span class="o">.</span><span class="n">py</span>
</span></span></code></pre></div><h1 id="b6-总结">B.6 总结</h1>
<p>学习过本书中的代码案例，你的 Python 技能得到了一定的提升，我建议你持续学习 IPython 和 Jupyter。因为这两个项目的设计初衷就是提高生产率的，你可能还会发现一些工具，可以让你更便捷地使用 Python 和计算库。</p>
<p>你可以在 <a href="https://nbviewer.jupyter.org/" target="_blank" rel="noopener noreffer ">nbviewer</a> 上找到更多有趣的 Jupyter 笔记本。</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 0001-01-01</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="http://localhost:1313/posts/pyda-2e-zh/b/" data-title=""><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://localhost:1313/posts/pyda-2e-zh/b/"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="http://localhost:1313/posts/pyda-2e-zh/b/" data-title=""><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="http://localhost:1313/posts/pyda-2e-zh/b/" data-title=""><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="http://localhost:1313/posts/pyda-2e-zh/b/" data-title=""><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/typescript-tutorial/any/" class="prev" rel="prev" title=""><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i></a>
            <a href="/posts/pyda-2e-zh/a/" class="next" rel="next" title=""><i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.118.2">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2022 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Aphros</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
